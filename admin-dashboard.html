<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Content Security Policy - Firebase 완전 허용 -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:; frame-src 'self' https://www.google.com https://recaptcha.google.com https://kauth.kakao.com https://pricehunter-99a1b.firebaseapp.com https://*.firebaseapp.com https://*.googleapis.com https://apis.google.com https://accounts.google.com; connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firebasestorage.googleapis.com https://content-firebaseappcheck.googleapis.com https://www.googleapis.com https://*.firebaseio.com wss://*.firebaseio.com https://developers.kakao.com https://kapi.kakao.com https://kauth.kakao.com https://*.firebaseapp.com https://*.cloudfunctions.net https://api.emailjs.com https://www.gstatic.com https://*.gstatic.com https://firebasejs.com https://images.unsplash.com https://*.unsplash.com https://apis.google.com https://*.firebasejs.com https://accounts.google.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://www.gstatic.com https://*.gstatic.com https://firebasejs.com https://apis.google.com https://*.firebasejs.com; img-src 'self' data: https: http: blob:; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com;" />
    
    <title>관리자 대시보드 - PriceHunter</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E🔍%3C/text%3E%3C/svg%3E">
    
    <!-- Firebase v9 SDK (모듈식) -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
      import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
      import { getFirestore, collection, query, orderBy, onSnapshot, getDocs, addDoc, serverTimestamp, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
      
      // Firebase 설정
      const firebaseConfig = {
        apiKey: "AIzaSyDBZxKyMS7eeBTbPnbZkj0WWOZQHNldoL4",
        authDomain: "pricehunter-99a1b.firebaseapp.com",
        projectId: "pricehunter-99a1b",
        storageBucket: "pricehunter-99a1b.firebasestorage.app",
        messagingSenderId: "242265693919",
        appId: "1:242265693919:web:74234d942b82a51541136a",
        measurementId: "G-4BKLV4EVB9"
      };

      // Firebase 초기화
      try {
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 전역으로 노출
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseAuthFunctions = { onAuthStateChanged };
        window.firebaseFirestoreFunctions = { collection, query, orderBy, onSnapshot, getDocs, addDoc, serverTimestamp, doc, updateDoc, deleteDoc };
        
        console.log('✅ 관리자 대시보드 Firebase v9 초기화 완료');
      } catch (error) {
        console.error('❌ 관리자 대시보드 Firebase 초기화 실패:', error);
        // 초기화 실패시에도 기본 객체들을 생성하여 오류 방지
        window.firebaseApp = null;
        window.firebaseAuth = null;
        window.firebaseDb = null;
        window.firebaseAuthFunctions = { onAuthStateChanged: () => {} };
        window.firebaseFirestoreFunctions = { 
          collection: () => {}, 
          query: () => {}, 
          orderBy: () => {}, 
          onSnapshot: () => {},
          getDocs: () => {},
          addDoc: () => {},
          serverTimestamp: () => {},
          doc: () => {},
          updateDoc: () => {},
          deleteDoc: () => {}
        };
        
        // 사용자에게 알림
        alert('시스템 초기화에 실패했습니다. 페이지를 새로고침해주세요.');
      }
    </script>
    
    
    <!-- Tailwind CSS (개선된 로딩 방식) -->
    <script>
        // Tailwind CSS 설정 - CSP 오류 방지
        if (typeof tailwind !== 'undefined') {
            tailwind.config = {
                theme: {
                    extend: {}
                },
                corePlugins: {
                    preflight: false
                }
            }
        }
        
        // Tailwind CSS 동적 로딩
        function loadTailwindCSS() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.tailwindcss.com';
                script.onload = () => {
                    console.log('✅ Tailwind CSS 로드됨 (개발용 CDN)');
                    resolve();
                };
                script.onerror = (error) => {
                    console.error('❌ Tailwind CSS 로드 실패:', error);
                    // Tailwind 로드 실패 시 기본 스타일 적용
                    applyFallbackStyles();
                    reject(error);
                };
                document.head.appendChild(script);
            });
        }
        
        // Tailwind 로드 실패 시 대체 스타일
        function applyFallbackStyles() {
            const style = document.createElement('style');
            style.textContent = `
                body { font-family: system-ui, -apple-system, sans-serif; }
                .bg-gradient-to-br { background: linear-gradient(135deg, #f3f4f6, #dbeafe, #d1fae5); }
                .min-h-screen { min-height: 100vh; }
                .flex { display: flex; }
                .items-center { align-items: center; }
                .justify-center { justify-content: center; }
                .bg-white { background-color: white; }
                .rounded-xl { border-radius: 0.75rem; }
                .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
                .p-8 { padding: 2rem; }
                .w-full { width: 100%; }
                .max-w-md { max-width: 28rem; }
                .text-center { text-align: center; }
                .mb-8 { margin-bottom: 2rem; }
                .text-3xl { font-size: 1.875rem; }
                .font-bold { font-weight: 700; }
                .text-pink-600 { color: #db2777; }
                .text-gray-600 { color: #4b5563; }
                .space-y-6 > * + * { margin-top: 1.5rem; }
                .block { display: block; }
                .text-sm { font-size: 0.875rem; }
                .font-medium { font-weight: 500; }
                .text-gray-700 { color: #374151; }
                .mb-2 { margin-bottom: 0.5rem; }
                .px-4 { padding-left: 1rem; padding-right: 1rem; }
                .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
                .border { border-width: 1px; }
                .border-gray-300 { border-color: #d1d5db; }
                .rounded-lg { border-radius: 0.5rem; }
                .focus\\:ring-2:focus { box-shadow: 0 0 0 2px rgba(236, 72, 153, 0.5); }
                .focus\\:ring-pink-400:focus { box-shadow: 0 0 0 2px rgba(244, 114, 182, 0.5); }
                .focus\\:outline-none:focus { outline: none; }
                .bg-gradient-to-r { background: linear-gradient(to right, #ec4899, #8b5cf6); }
                .text-white { color: white; }
                .hover\\:from-pink-600:hover { background: linear-gradient(to right, #db2777, #7c3aed); }
                .hover\\:to-purple-600:hover { background: linear-gradient(to right, #ec4899, #7c3aed); }
                .transition { transition: all 0.15s ease-in-out; }
                .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
                .mt-6 { margin-top: 1.5rem; }
                .text-pink-600 { color: #db2777; }
                .hover\\:text-pink-700:hover { color: #be185d; }
                .text-blue-600 { color: #2563eb; }
                .hover\\:text-blue-700:hover { color: #1d4ed8; }
                .text-xs { font-size: 0.75rem; }
                .text-gray-500 { color: #6b7280; }
                .mt-2 { margin-top: 0.5rem; }
            `;
            document.head.appendChild(style);
            console.log('⚠️ Tailwind CSS 대체 스타일 적용됨');
        }
        
        // Tailwind CSS 로딩 시작
        loadTailwindCSS().catch(() => {
            console.log('⚠️ Tailwind CSS 로딩 실패, 대체 스타일 사용');
        });
    </script>
    
    
    <script>
        // 관리자 대시보드 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 관리자 대시보드 초기화 시작...');
            
            // 함수 등록 상태 확인
            console.log('🔍 함수 등록 상태 확인:');
            console.log('- window.editReview:', typeof window.editReview);
            console.log('- window.editReviewWithModal:', typeof window.editReviewWithModal);
            console.log('- window.closeEditReviewModal:', typeof window.closeEditReviewModal);
            
            // Firebase 상태 모니터링 추가
            if (window.firebaseAuthFunctions && window.firebaseAuthFunctions.onAuthStateChanged) {
                window.firebaseAuthFunctions.onAuthStateChanged(window.firebaseAuth, async (user) => {
                    console.log('🔐 Firebase Auth 상태 변경:', user ? user.email : '로그아웃됨');
                    
                    if (!user) {
                        // 로그아웃 상태 - 로그인 섹션 표시
                        showLoginSection();
                    } else {
                        // 로그인 상태 - 관리자 권한 확인 후 대시보드 표시
                        const isAdmin = await checkAdminPermission(user);
                        if (isAdmin) {
                            document.getElementById('login-section').classList.add('hidden');
                            document.getElementById('dashboard-section').classList.remove('hidden');
                            loadDashboardData();
                        } else {
                            showLoginSection();
                        }
                    }
                });
            }
            
            // Firebase 준비 대기 후 실시간 구독 시작
            setTimeout(async () => {
                try {
                    await waitForFirebase();
                    subscribeToUsers();
                    console.log('✅ 관리자 대시보드 Firebase 연동 완료');
                } catch (error) {
                    console.error('❌ 관리자 대시보드 초기화 실패:', error);
                    // 초기화 실패시 3초 후 재시도
                    setTimeout(() => {
                        console.log('🔄 관리자 대시보드 재시도...');
                        location.reload();
                    }, 3000);
                }
            }, 1000);
        });
        
        // Firebase SDK 로딩 대기 함수 (단순화된 버전)
        function waitForFirebaseAndInitialize() {
            const maxAttempts = 8; // 8초 대기
            let attempts = 0;
            
            const checkFirebase = () => {
                attempts++;
                console.log(`🔍 Firebase SDK 확인 시도 ${attempts}/${maxAttempts}`);
                
                // Firebase SDK 완전 로드 확인
                if (typeof firebase !== 'undefined' && 
                    firebase.apps !== undefined && 
                    firebase.auth !== undefined && 
                    firebase.firestore !== undefined) {
                    
                    console.log('✅ Firebase SDK 완전 로드됨');
                    console.log('Firebase 버전:', firebase.SDK_VERSION);
                    
                    // Firebase 초기화 시도
                    try {
                        const initResult = initializeFirebase();
                        if (initResult) {
                            console.log('✅ Firebase 초기화 완료');
                            setupAdminDashboard();
                        } else {
                            console.error('❌ Firebase 초기화 실패');
                            showFirebaseError('Firebase 초기화에 실패했습니다. Netlify CSP 헤더를 확인해주세요.');
                        }
                    } catch (error) {
                        console.error('❌ Firebase 초기화 중 오류:', error);
                        showFirebaseError('Firebase 초기화 중 오류가 발생했습니다: ' + error.message);
                    }
                } else if (attempts < maxAttempts) {
                    console.log('⏳ Firebase SDK 로딩 대기 중...');
                    setTimeout(checkFirebase, 1000);
                } else {
                    console.error('❌ Firebase SDK 로딩 시간 초과');
                    showFirebaseError('Firebase SDK 로딩 시간이 초과되었습니다.\n\nNetlify CSP 정책에서 다음 도메인들이 허용되어야 합니다:\n- https://www.gstatic.com\n- https://www.gstatic.com/firebasejs\n\nnetlify.toml 파일의 CSP 설정을 확인하세요.');
                }
            };
            
            checkFirebase();
        }
        
        // Firebase 오류 표시 함수 (CSP 최적화 버전)
        function showFirebaseError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg z-50 max-w-md';
            errorDiv.innerHTML = `
                <div class="font-bold mb-2">🔥 Firebase 오류</div>
                <div class="text-sm mb-2">${message}</div>
                <div class="text-xs mb-3 p-2 bg-red-600 rounded">
                    <strong>CSP 해결 방법:</strong><br>
                    1. DevTools → Network → Response Headers 확인<br>
                    2. content-security-policy에 www.gstatic.com 포함 확인<br>
                    3. 서버 재시작 후 새로고침<br>
                    4. 브라우저 캐시 완전 삭제<br>
                    5. 서비스워커 등록 해제
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="location.reload()" class="px-3 py-1 bg-white text-red-500 rounded text-xs font-bold hover:bg-gray-100">
                        🔄 새로고침
                    </button>
                    <button onclick="testFirebaseConnection()" class="px-3 py-1 bg-yellow-500 text-white rounded text-xs font-bold hover:bg-yellow-600">
                        🧪 연결 테스트
                    </button>
                    <button onclick="clearCacheAndReload()" class="px-3 py-1 bg-orange-500 text-white rounded text-xs font-bold hover:bg-orange-600">
                        🧹 캐시 정리
                    </button>
                    <button onclick="this.parentElement.parentElement.remove()" class="px-3 py-1 bg-gray-500 text-white rounded text-xs font-bold hover:bg-gray-600">
                        ✕ 닫기
                    </button>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            // 20초 후 자동 제거 (CSP 문제는 해결 시간이 더 필요)
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 20000);
        }
        
        // 관리자 대시보드 설정
        function setupAdminDashboard() {
            console.log('🔧 관리자 대시보드 설정 시작...');
            
            // Firebase 상태 재확인
            if (!window.firebaseAuth || !window.firebaseDb) {
                console.error('❌ Firebase 서비스가 초기화되지 않았습니다.');
                showFirebaseError('Firebase 서비스 초기화에 실패했습니다.');
                return;
            }
            
            console.log('✅ 관리자 대시보드 설정 완료');
        }
        
        // 관리자 권한 확인 함수
        async function checkAdminPermission(user) {
            try {
                if (!user || !user.uid) return false;
                
                // Firestore에서 관리자 권한 확인
                const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                const adminDoc = await getDoc(doc(window.firebaseDb, 'admins', user.uid));
                
                if (adminDoc.exists()) {
                    const adminData = adminDoc.data();
                    return adminData.role === 'admin' || adminData.permissions?.includes('admin');
                }
                
                // 기본 관리자 이메일 확인 (임시)
                const adminEmails = ['admin@pricehunter.com', 'admin@example.com'];
                return adminEmails.includes(user.email);
                
            } catch (error) {
                console.error('❌ 관리자 권한 확인 실패:', error);
                return false;
            }
        }

        // 관리자 로그인 함수
        window.adminLogin = async function() {
            console.log('🔐 관리자 로그인 시도...');
            
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            
            if (!email || !password) {
                alert('이메일과 비밀번호를 입력해주세요.');
                return;
            }
            
            // 로딩 상태 표시
            const loginButton = document.querySelector('button[type="submit"]');
            const originalText = loginButton.textContent;
            loginButton.textContent = '로그인 중...';
            loginButton.disabled = true;
            
            try {
                // Firebase 초기화 대기
                await waitForFirebaseInit();
                
                console.log('🔥 로그인 시도:', email);
                // 미리 로드된 Firebase 함수 사용 (성능 최적화)
                const { signInWithEmailAndPassword } = window.firebaseAuthFunctions || await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js');
                const userCredential = await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                console.log('✅ 로그인 성공:', userCredential.user.email);
                
                // 관리자 권한 확인
                const isAdmin = await checkAdminPermission(userCredential.user);
                if (!isAdmin) {
                    alert('관리자 권한이 없습니다. 관리자 계정으로 로그인해주세요.');
                    // 로그아웃
                    const { signOut } = window.firebaseAuthFunctions || await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js');
                    await signOut(window.firebaseAuth);
                    return;
                }
                
                console.log('✅ 관리자 권한 확인됨');
                
                // 로그인 성공 시 대시보드 표시
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.remove('hidden');
                
                // 관리자 정보 표시
                if (document.getElementById('admin-info')) {
                    document.getElementById('admin-info').textContent = userCredential.user.email;
                }
                
                // 대시보드 데이터 로드
                loadDashboardData();
                
            } catch (error) {
                console.error('❌ 로그인 실패:', error);
                let errorMessage = '로그인에 실패했습니다.';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = '등록되지 않은 이메일입니다.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = '비밀번호가 올바르지 않습니다.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = '올바르지 않은 이메일 형식입니다.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = '너무 많은 로그인 시도가 있었습니다. 잠시 후 다시 시도해주세요.';
                        break;
                    default:
                        errorMessage = error.message;
                }
                
                alert(errorMessage);
            } finally {
                // 로딩 상태 해제
                loginButton.textContent = originalText;
                loginButton.disabled = false;
            }
        };
        
        // Firebase 초기화 대기 함수
        async function waitForFirebaseInit() {
            return new Promise((resolve, reject) => {
                if (window.firebaseApp && window.firebaseAuth && window.firebaseDb) {
                    resolve();
                    return;
                }
                
                const checkInterval = setInterval(() => {
                    if (window.firebaseApp && window.firebaseAuth && window.firebaseDb) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 100);
                
                setTimeout(() => {
                    clearInterval(checkInterval);
                    reject(new Error('Firebase 초기화 타임아웃'));
                }, 5000);
            });
        }
        
        // 테스트 관리자 계정 생성 함수
        window.createAdminAccount = async function() {
            try {
                console.log('🔧 테스트 관리자 계정 생성 시작...');
                
                if (!firebase.auth) { 
                    alert("인증 시스템 초기화 실패"); 
                    throw new Error("Auth not initialized"); 
                }
                
                if (!window.firebaseAuth) {
                    alert('Firebase가 초기화되지 않았습니다. 페이지를 새로고침해주세요.');
                    return;
                }
                
                // Firebase v9에서는 createUserWithEmailAndPassword를 직접 import해야 함
                const { createUserWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js');
                const userCredential = await createUserWithEmailAndPassword(window.firebaseAuth, 'admin@pricehunter.com', 'admin1234');
                console.log('✅ 테스트 관리자 계정 생성 완료:', userCredential.user.email);
                
                // Firestore에 관리자 정보 저장
                if (window.firebaseDb) {
                    const { collection, doc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                    await setDoc(doc(collection(window.firebaseDb, 'admins'), userCredential.user.uid), {
                        email: 'admin@pricehunter.com',
                        role: 'admin',
                        createdAt: serverTimestamp(),
                        permissions: ['read', 'write', 'delete', 'admin']
                    });
                    console.log('✅ 관리자 정보 Firestore 저장 완료');
                }
                
                alert('✅ 테스트 관리자 계정이 생성되었습니다!\n\n이메일: admin@pricehunter.com\n비밀번호: admin1234\n\n이제 이 계정으로 로그인할 수 있습니다.');
                
                // 입력 필드에 자동 입력
                document.getElementById('admin-email').value = 'admin@pricehunter.com';
                document.getElementById('admin-password').value = 'admin1234';
                
            } catch (error) {
                console.error('❌ 테스트 계정 생성 실패:', error);
                
                if (error.code === 'auth/email-already-in-use') {
                    alert('이미 존재하는 계정입니다!\n\n이메일: admin@pricehunter.com\n비밀번호: admin1234\n\n이 계정으로 로그인해보세요.');
                    
                    // 입력 필드에 자동 입력
                    document.getElementById('admin-email').value = 'admin@pricehunter.com';
                    document.getElementById('admin-password').value = 'admin1234';
                } else {
                    alert('계정 생성에 실패했습니다. 다시 시도해주세요.');
                }
            }
        };
        
        // Firebase v9 기반 함수들 (개선된 버전)
        let isFirebaseReady = false;
        let usersUnsubscribe = null;

        // Firebase 준비 상태 확인 (Firebase v8)
        async function waitForFirebase() {
            return new Promise((resolve, reject) => {
                console.log('🔄 Firebase 준비 상태 확인 중...');
                console.log('🔍 Firebase 초기화 상태:', {
                    firebaseApp: !!window.firebaseApp,
                    firebaseAuth: !!window.firebaseAuth,
                    firebaseDb: !!window.firebaseDb,
                    firebaseFirestoreFunctions: !!window.firebaseFirestoreFunctions
                });
                
                // Firebase v9 초기화 확인
                if (window.firebaseApp && window.firebaseAuth && window.firebaseDb && window.firebaseFirestoreFunctions) {
                    isFirebaseReady = true;
                    console.log('✅ Firebase v9 초기화 성공');
                    resolve();
                    return;
                }
                
                // 재시도
                const checkInterval = setInterval(() => {
                    if (window.firebaseApp && window.firebaseAuth && window.firebaseDb && window.firebaseFirestoreFunctions) {
                        clearInterval(checkInterval);
                        isFirebaseReady = true;
                        console.log('✅ Firebase v9 초기화 성공');
                        resolve();
                    }
                }, 100);
                
                // 10초 후 타임아웃
                setTimeout(() => {
                    clearInterval(checkInterval);
                    console.error('❌ Firebase 초기화 타임아웃');
                    reject(new Error('Firebase 초기화 실패'));
                }, 10000);
            });
        }

        // 실시간 사용자 목록 구독 (Firebase 전용)
        function subscribeToUsers() {
            console.log('👥 사용자 목록 구독 시작...');
            
            if (!window.firebaseDb) {
                console.warn('⚠️ Firebase가 아직 초기화되지 않았습니다.');
                return;
            }
            
            try {
                const { collection, query, orderBy, onSnapshot } = window.firebaseFirestoreFunctions;
                const usersRef = collection(window.firebaseDb, 'users');
                
                // createdAt 필드가 없을 수 있으므로 기본 쿼리 사용
                let usersQuery;
                try {
                    usersQuery = query(usersRef, orderBy('createdAt', 'desc'));
                } catch (error) {
                    console.warn('⚠️ createdAt 필드로 정렬 실패, 기본 쿼리 사용:', error);
                    usersQuery = query(usersRef);
                }

                // 성능 최적화: onSnapshot 대신 getDocs 사용
                try {
                    const snapshot = await getDocs(usersQuery);
                    const firebaseUsers = [];
                    snapshot.forEach((doc) => {
                        const userData = doc.data();
                        firebaseUsers.push({ 
                            id: doc.id, 
                            ...userData,
                            source: 'Firebase'
                        });
                    });
                    
                    console.log('📊 Firebase 사용자 데이터 로드 완료:', firebaseUsers.length, '명');
                    console.log('📋 Firebase 사용자 데이터:', firebaseUsers);
                    
                    // localStorage 사용자와 Firebase 사용자 합치기
                    const allUsers = mergeUsersData(firebaseUsers);
                    updateUsersTable(allUsers);
                    
                    // 회원수 업데이트 (Firebase 데이터만 사용)
                    const totalMembersElement = document.getElementById('total-members');
                    if (totalMembersElement) {
                        totalMembersElement.textContent = allUsers.length;
                    }
                    
                    // 통계 업데이트
                    updateMemberStats(allUsers);
                    
                } catch (error) {
                    console.error('❌ 사용자 목록 로드 실패:', error);
                    // Firebase 연결 실패시 빈 목록 표시
                    updateUsersTable([]);
                    document.getElementById('total-members').textContent = '0';
                    
                    // 연결 실패시 5초 후 재시도
                    setTimeout(() => {
                        console.log('🔄 Firestore 연결 재시도...');
                        subscribeToUsers();
                    }, 5000);
                }
            } catch (error) {
                console.error('❌ Firestore 쿼리 생성 실패:', error);
                // 쿼리 생성 실패시 빈 목록 표시
                updateUsersTable([]);
                document.getElementById('total-members').textContent = '0';
                
                // 쿼리 생성 실패시 3초 후 재시도
                setTimeout(() => {
                    console.log('🔄 Firestore 쿼리 재시도...');
                    subscribeToUsers();
                }, 3000);
            }
        }

        // localStorage에서 사용자 데이터 로드
        function loadLocalStorageUsers() {
            try {
                const users = [];
                
                // 일반 사용자 데이터
                const userData = localStorage.getItem('user');
                if (userData) {
                    const user = JSON.parse(userData);
                    users.push({
                        id: user.firebaseId || 'local_' + Date.now(),
                        ...user,
                        source: 'localStorage'
                    });
                }
                
                // 카카오 사용자 데이터들
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.startsWith('kakao_') && !key.includes('auth_')) {
                        try {
                            const storedData = localStorage.getItem(key);
                            if (storedData && storedData.startsWith('{')) {
                                const kakaoUser = JSON.parse(storedData);
                                users.push({
                                    id: kakaoUser.firebaseId || key,
                                    ...kakaoUser,
                                    source: 'localStorage'
                                });
                            }
                        } catch (e) {
                            console.warn('카카오 사용자 데이터 파싱 실패:', e);
                        }
                    }
                });
                
                console.log('📊 localStorage 사용자 데이터:', users.length);
                updateUsersTable(users);
                document.getElementById('total-members').textContent = users.length;
                
            } catch (error) {
                console.error('❌ localStorage 사용자 데이터 로드 실패:', error);
            }
        }

        // Firebase 사용자 데이터만 사용 (로컬스토리지 병합 제거)
        function mergeUsersData(firebaseUsers) {
            console.log('🔄 Firebase 사용자 데이터 사용:', firebaseUsers.length, '명');
            
            // Firebase 사용자에서 중복 제거 (이메일 기준)
            const firebaseUserMap = new Map();
            firebaseUsers.forEach(user => {
                if (user.email) {
                    // 같은 이메일이 있으면 더 최신 데이터를 유지
                    if (!firebaseUserMap.has(user.email) || 
                        (user.createdAt && firebaseUserMap.get(user.email).createdAt && 
                         user.createdAt > firebaseUserMap.get(user.email).createdAt)) {
                        firebaseUserMap.set(user.email, user);
                    }
                }
            });
            
            const uniqueFirebaseUsers = Array.from(firebaseUserMap.values());
            console.log('📊 중복 제거 후 Firebase 사용자:', uniqueFirebaseUsers.length, '명');
            
            // Firebase 사용자만 사용
            const allUsers = [...uniqueFirebaseUsers];
            
            // 로컬스토리지 병합 로직 제거됨 - Firebase 전용 사용
            
            // 최종 중복 검사
            const finalEmailSet = new Set();
            const finalUsers = [];
            allUsers.forEach(user => {
                if (user.email && !finalEmailSet.has(user.email)) {
                    finalUsers.push(user);
                    finalEmailSet.add(user.email);
                }
            });
            
            console.log('✅ 사용자 데이터 병합 완료:', finalUsers.length, '명');
            console.log('📋 최종 사용자 목록:', finalUsers.map(u => ({ email: u.email, source: u.source, name: u.name || u.displayName })));
            
            return finalUsers;
        }

        // Firebase 중복 사용자 데이터 정리 함수
        async function cleanupDuplicateUsers() {
            try {
                console.log('🧹 Firebase 중복 사용자 데이터 정리 시작...');
                
                const { collection, getDocs, deleteDoc, doc } = window.firebaseFirestoreFunctions;
                const db = window.firebaseDb;
                
                const usersRef = collection(db, 'users');
                const querySnapshot = await getDocs(usersRef);
                
                console.log(`📊 전체 사용자 문서 수: ${querySnapshot.size}`);
                
                const userMap = new Map();
                const usersToDelete = [];
                const allUsers = [];
                
                // 모든 사용자 데이터 수집
                querySnapshot.forEach((docSnapshot) => {
                    const userData = docSnapshot.data();
                    const userEmail = userData.email;
                    
                    if (userEmail) {
                        allUsers.push({
                            id: docSnapshot.id,
                            email: userEmail,
                            createdAt: userData.createdAt,
                            uid: userData.uid,
                            ...userData
                        });
                    }
                });
                
                console.log('📋 모든 사용자 목록:', allUsers.map(u => ({ 
                    id: u.id, 
                    email: u.email, 
                    createdAt: u.createdAt,
                    uid: u.uid 
                })));
                
                // 이메일별로 그룹화하여 중복 찾기
                const emailGroups = new Map();
                allUsers.forEach(user => {
                    if (!emailGroups.has(user.email)) {
                        emailGroups.set(user.email, []);
                    }
                    emailGroups.get(user.email).push(user);
                });
                
                // 중복 이메일 찾기
                for (const [email, users] of emailGroups) {
                    if (users.length > 1) {
                        console.log(`🔍 중복 이메일 발견: ${email} (${users.length}개 문서)`);
                        
                        // 가장 최신 데이터를 유지하고 나머지 삭제
                        users.sort((a, b) => {
                            if (a.createdAt && b.createdAt) {
                                return b.createdAt.toMillis() - a.createdAt.toMillis(); // 최신순
                            }
                            // createdAt이 없는 경우 uid가 더 긴 것 유지 (새로운 형식)
                            if (a.uid && b.uid) {
                                return b.uid.length - a.uid.length;
                            }
                            return 0;
                        });
                        
                        // 첫 번째(가장 최신)를 제외하고 나머지 삭제 대상에 추가
                        for (let i = 1; i < users.length; i++) {
                            usersToDelete.push(users[i].id);
                            console.log(`🗑️ 삭제 대상: ${users[i].id} (이메일: ${email})`);
                        }
                    }
                }
                
                console.log(`🗑️ 총 삭제할 중복 사용자: ${usersToDelete.length}명`);
                
                // 중복 사용자 삭제
                let deletedCount = 0;
                for (const userId of usersToDelete) {
                    try {
                        await deleteDoc(doc(db, 'users', userId));
                        console.log(`✅ 중복 사용자 삭제 완료: ${userId}`);
                        deletedCount++;
                    } catch (error) {
                        console.error(`❌ 사용자 삭제 실패: ${userId}`, error);
                    }
                }
                
                console.log(`✅ Firebase 중복 사용자 데이터 정리 완료: ${deletedCount}명 삭제`);
                return deletedCount;
                
            } catch (error) {
                console.error('❌ Firebase 중복 사용자 데이터 정리 실패:', error);
                return 0;
            }
        }

        // 특정 사용자 삭제 함수
        async function deleteSpecificUser(userId) {
            try {
                console.log(`🗑️ 특정 사용자 삭제 시작: ${userId}`);
                
                const { deleteDoc, doc } = window.firebaseFirestoreFunctions;
                const db = window.firebaseDb;
                
                await deleteDoc(doc(db, 'users', userId));
                console.log(`✅ 사용자 삭제 완료: ${userId}`);
                return true;
                
            } catch (error) {
                console.error(`❌ 사용자 삭제 실패: ${userId}`, error);
                throw error;
            }
        }

        // 올바른 사용자 문서 다시 생성 함수
        async function recreateCorrectUser() {
            try {
                console.log('🔄 올바른 사용자 문서 생성 시작...');
                
                const { doc, setDoc } = window.firebaseFirestoreFunctions;
                const db = window.firebaseDb;
                
                // 올바른 문서 생성 (비밀번호 포함)
                const correctUserData = {
                    uid: 'ffG0D4HTZ39gYiw0VNHO',
                    email: 'etgbajy@gmail.com',
                    name: '허진영',
                    displayName: '허진영',
                    phone: '010-7714-6654',
                    password: 'znznektm1@',
                    emailVerification: 'etgbajy@gmail.com',
                    agreeTerms: true,
                    agreePrivacy: true,
                    agreeMarketing: false,
                    loginMethod: 'email',
                    isActive: true,
                    createdAt: new Date('2025-09-21T16:01:37.000Z'),
                    updatedAt: new Date(),
                    lastLogin: new Date(),
                    loginCount: 4
                };
                
                const userRef = doc(db, 'users', 'ffG0D4HTZ39gYiw0VNHO');
                await setDoc(userRef, correctUserData);
                
                console.log('✅ 올바른 사용자 문서 생성 완료');
                alert('✅ 올바른 사용자 문서가 생성되었습니다!\n\n이제 etgbajy@gmail.com으로 로그인할 수 있습니다.');
                
                // 페이지 새로고침
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
                return true;
                
            } catch (error) {
                console.error('❌ 올바른 사용자 문서 생성 실패:', error);
                alert('문서 생성에 실패했습니다. 다시 시도해주세요.');
                throw error;
            }
        }

        // 회원 통계 업데이트 함수
        function updateMemberStats(users) {
            try {
                const kakaoUsers = users.filter(user => (user.loginMethod || user.loginType) === 'kakao').length;
                const emailUsers = users.filter(user => (user.loginMethod || user.loginType) === 'email').length;
                const firebaseUsers = users.length; // 모든 사용자가 Firebase 사용자
                const localStorageUsers = 0; // Firebase 전용이므로 0
                
                console.log('📊 회원 통계:', {
                    total: users.length,
                    kakao: kakaoUsers,
                    email: emailUsers,
                    firebase: firebaseUsers,
                    localStorage: localStorageUsers
                });
                
                // 통계를 화면에 표시 (필요시)
                const statsElement = document.getElementById('member-stats');
                if (statsElement) {
                    statsElement.innerHTML = `
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div class="text-center">
                                <div class="font-bold text-lg text-blue-600">${kakaoUsers}</div>
                                <div class="text-gray-600">카카오톡</div>
                            </div>
                            <div class="text-center">
                                <div class="font-bold text-lg text-green-600">${emailUsers}</div>
                                <div class="text-gray-600">이메일</div>
                            </div>
                            <div class="text-center">
                                <div class="font-bold text-lg text-purple-600">${firebaseUsers}</div>
                                <div class="text-gray-600">Firebase</div>
                            </div>
                            <div class="text-center">
                                <div class="font-bold text-lg text-gray-400">${localStorageUsers}</div>
                                <div class="text-gray-600">localStorage</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('❌ 회원 통계 업데이트 실패:', error);
            }
        }

        // 사용자 테이블 업데이트 (개선된 버전)
        function updateUsersTable(users) {
            console.log('📋 회원 테이블 업데이트 시작...');
            console.log('👥 표시할 사용자 수:', users.length);
            
            const tbody = document.getElementById('members-table-body');
            if (!tbody) {
                console.error('❌ members-table-body 요소를 찾을 수 없습니다.');
                return;
            }

            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-6 py-4 text-center text-gray-500">
                            등록된 회원이 없습니다.
                        </td>
                    </tr>
                `;
                return;
            }

            // 사용자 데이터 정렬 (Firebase 우선, 최신순)
            const sortedUsers = users.sort((a, b) => {
                // Firebase 사용자를 우선으로
                if (a.source === 'Firebase' && b.source !== 'Firebase') return -1;
                if (a.source !== 'Firebase' && b.source === 'Firebase') return 1;
                
                // 같은 소스 내에서는 최신순
                const dateA = a.createdAt ? (a.createdAt.seconds ? a.createdAt.seconds * 1000 : new Date(a.createdAt).getTime()) : 0;
                const dateB = b.createdAt ? (b.createdAt.seconds ? b.createdAt.seconds * 1000 : new Date(b.createdAt).getTime()) : 0;
                return dateB - dateA;
            });

            sortedUsers.forEach((user, index) => {
                console.log(`👤 사용자 ${index + 1}:`, {
                    email: user.email,
                    name: user.displayName || user.name,
                    source: user.source,
                    phone: user.phone
                });
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const profileImage = user.photoURL || user.profileImage || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%236b7280"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                const loginMethod = user.loginMethod || user.loginType || 'email';
                
                // 날짜 처리 개선
                let joinDate = '알 수 없음';
                if (user.createdAt) {
                    if (user.createdAt.seconds) {
                        joinDate = new Date(user.createdAt.seconds * 1000).toLocaleDateString('ko-KR');
                    } else if (user.createdAt.toDate) {
                        joinDate = user.createdAt.toDate().toLocaleDateString('ko-KR');
                    } else {
                        joinDate = new Date(user.createdAt).toLocaleDateString('ko-KR');
                    }
                } else if (user.joinDate) {
                    joinDate = new Date(user.joinDate).toLocaleDateString('ko-KR');
                }
                
                let lastUpdate = '알 수 없음';
                if (user.updatedAt) {
                    if (user.updatedAt.seconds) {
                        lastUpdate = new Date(user.updatedAt.seconds * 1000).toLocaleDateString('ko-KR');
                    } else if (user.updatedAt.toDate) {
                        lastUpdate = user.updatedAt.toDate().toLocaleDateString('ko-KR');
                    } else {
                        lastUpdate = new Date(user.updatedAt).toLocaleDateString('ko-KR');
                    }
                }
                
                const dataSource = 'Firebase';
                const dataSourceColor = 'bg-green-100 text-green-800';
                // 포인트 시스템 제거됨
                const userName = user.displayName || user.name || '이름 없음';
                const userEmail = user.email || '이메일 없음';
                const userPhone = user.phone || '-';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="h-10 w-10 flex-shrink-0">
                                <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 text-xs font-bold">
                                    ${userName.charAt(0)}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${userName}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${loginMethod === 'kakao' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">
                            ${loginMethod === 'kakao' ? '카카오톡' : '이메일'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${userEmail}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${userPhone}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${joinDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${lastUpdate}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${dataSourceColor}">
                            ${dataSource}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewUserDetails('${user.email || user.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">상세보기</button>
                        <button onclick="deleteUser('${user.email || user.id}')" class="text-red-600 hover:text-red-900">삭제</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            console.log('✅ 회원 테이블 업데이트 완료');
        }

        // Firebase에서 의뢰 데이터 가져오기 (실시간 구독)
        let requestsUnsubscribe = null;
        
        function subscribeToRequests() {
            try {
                const { collection, onSnapshot } = window.firebaseFirestoreFunctions;
                const db = window.firebaseDb;
                
                // orderBy 없이 모든 데이터 구독 (복합 인덱스 문제 방지)
                const requestsRef = collection(db, 'requests');
                
                console.log('🔄 의뢰 데이터 실시간 구독 시작...');
                
                // 성능 최적화: onSnapshot 대신 getDocs 사용
                try {
                    const querySnapshot = await getDocs(requestsRef);
                    const requests = [];
                    
                    querySnapshot.forEach((doc) => {
                        requests.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // 클라이언트 사이드에서 정렬 (createdAt 기준 내림차순)
                    requests.sort((a, b) => {
                        const aTime = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
                        const bTime = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
                        return bTime - aTime;
                    });
                    
                    console.log(`✅ 의뢰 데이터 로드 완료: ${requests.length}개`);
                    console.log('📊 의뢰 데이터 상세:', requests);
                    
                    // UI 업데이트
                    updateRequestListUI(requests);
                    
                    // 통계 업데이트
                    updateRequestStats(requests);
                } catch (error) {
                    console.error('❌ 의뢰 데이터 로드 오류:', error);
                    // 오류시 빈 배열로 표시
                    updateRequestListUI([]);
                    updateRequestStats([]);
                }
                
            } catch (error) {
                console.error('❌ 의뢰 데이터 구독 설정 실패:', error);
            }
        }
        
        // 의뢰 목록 UI 업데이트
        function updateRequestListUI(requests) {
            const requestList = document.getElementById('request-list');
            
            if (!requestList) {
                console.warn('⚠️ request-list 요소를 찾을 수 없습니다.');
                return;
            }
            
            requestList.innerHTML = '';
            
            if (requests.length === 0) {
                requestList.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">의뢰가 없습니다.</td></tr>';
                return;
            }
            
            requests.forEach((request) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3">
                        <input type="checkbox" class="request-checkbox" value="${request.id}">
                    </td>
                    <td class="px-4 py-3 text-sm">${request.reqNum || request.requestNumber || 'N/A'}</td>
                    <td class="px-4 py-3 text-sm">${request.productName || request.name || 'N/A'}</td>
                    <td class="px-4 py-3 text-sm">${request.userName || request.name || 'N/A'}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 text-xs rounded-full ${request.status === '답변완료' ? 'bg-green-100 text-green-800' : request.status === '처리중' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">
                            ${request.status || '대기'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="viewRequestDetail('${request.id}')" class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                            상세보기
                        </button>
                    </td>
                `;
                requestList.appendChild(row);
            });
        }
        
        // Firebase에서 의뢰 데이터 가져오기 (일회성 조회 - 호환성 유지)
        async function getRequestsFromFirebase() {
            try {
                const { collection, getDocs } = window.firebaseFirestoreFunctions;
                const db = window.firebaseDb;
                
                // orderBy 없이 모든 데이터 가져오기 (복합 인덱스 문제 방지)
                const requestsRef = collection(db, 'requests');
                const querySnapshot = await getDocs(requestsRef);
                const requests = [];
                
                querySnapshot.forEach((doc) => {
                    requests.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // 클라이언트 사이드에서 정렬 (createdAt 기준 내림차순)
                requests.sort((a, b) => {
                    const aTime = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
                    const bTime = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
                    return bTime - aTime;
                });
                
                console.log(`✅ Firebase에서 의뢰 데이터 ${requests.length}개 가져옴`);
                console.log('📊 의뢰 데이터 상세:', requests);
                return requests;
            } catch (error) {
                console.error('❌ Firebase에서 의뢰 데이터 가져오기 실패:', error);
                return [];
            }
        }
        
        // Firebase에서 문의 데이터 가져오기 (실시간 구독)
        let inquiriesUnsubscribe = null;
        
        function subscribeToInquiries() {
            try {
                const { collection, onSnapshot } = window.firebaseFirestoreFunctions;
                const db = window.firebaseDb;
                
                // orderBy 없이 모든 데이터 구독 (복합 인덱스 문제 방지)
                const inquiriesRef = collection(db, 'inquiries');
                
                console.log('🔄 문의 데이터 실시간 구독 시작...');
                
                // 성능 최적화: onSnapshot 대신 getDocs 사용
                try {
                    const querySnapshot = await getDocs(inquiriesRef);
                    const inquiries = [];
                    
                    querySnapshot.forEach((doc) => {
                        inquiries.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // 클라이언트 사이드에서 정렬 (createdAt 기준 내림차순)
                    inquiries.sort((a, b) => {
                        const aTime = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
                        const bTime = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
                        return bTime - aTime;
                    });
                    
                    console.log(`✅ 문의 데이터 로드 완료: ${inquiries.length}개`);
                    console.log('📊 문의 데이터 상세:', inquiries);
                    
                    // UI 업데이트
                    updateInquiryListUI(inquiries);
                    
                    // 통계 업데이트
                    updateInquiryStats(inquiries);
                } catch (error) {
                    console.error('❌ 문의 데이터 로드 오류:', error);
                    // 오류시 빈 배열로 표시
                    updateInquiryListUI([]);
                    updateInquiryStats([]);
                }
                
            } catch (error) {
                console.error('❌ 문의 데이터 구독 설정 실패:', error);
            }
        }
        
        // 문의 목록 UI 업데이트
        function updateInquiryListUI(inquiries) {
            const inquiryTableBody = document.getElementById('inquiries-table-body');
            
            if (!inquiryTableBody) {
                console.warn('⚠️ inquiries-table-body 요소를 찾을 수 없습니다.');
                return;
            }
            
            inquiryTableBody.innerHTML = '';
            
            if (inquiries.length === 0) {
                inquiryTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">문의 내역이 없습니다.</td></tr>';
                return;
            }
            
            inquiries.forEach((inquiry) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-blue-50 transition-colors';
                
                const createdAt = inquiry.createdAt ? 
                    new Date(inquiry.createdAt.seconds * 1000).toLocaleDateString('ko-KR') : 
                    '날짜 없음';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="inquiry-checkbox" data-id="${inquiry.id}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${inquiry.id ? inquiry.id.substring(0, 8) + '...' : 'ID 없음'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="font-semibold text-blue-600">${inquiry.subject || '제목 없음'}</div>
                        <div class="text-sm text-gray-600">${inquiry.name || inquiry.userName || '이름 없음'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="px-2 py-1 text-xs rounded-full ${inquiry.status === '답변완료' || inquiry.status === 'answered' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${inquiry.status === '답변완료' || inquiry.status === 'answered' ? '답변완료' : '대기중'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${createdAt}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <button onclick="viewInquiryDetail('${inquiry.id}')" class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                            상세보기
                        </button>
                    </td>
                `;
                inquiryTableBody.appendChild(row);
            });
        }
        
        // Firebase에서 문의 데이터 가져오기 (일회성 조회 - 호환성 유지)
        async function getInquiriesFromFirebase() {
            try {
                const { collection, getDocs } = window.firebaseFirestoreFunctions;
                const db = window.firebaseDb;
                
                // orderBy 없이 모든 데이터 가져오기 (복합 인덱스 문제 방지)
                const inquiriesRef = collection(db, 'inquiries');
                const querySnapshot = await getDocs(inquiriesRef);
                const inquiries = [];
                
                querySnapshot.forEach((doc) => {
                    inquiries.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // 클라이언트 사이드에서 정렬 (createdAt 기준 내림차순)
                inquiries.sort((a, b) => {
                    const aTime = a.createdAt ? (a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt)) : new Date(0);
                    const bTime = b.createdAt ? (b.createdAt.toDate ? b.createdAt.toDate() : new Date(b.createdAt)) : new Date(0);
                    return bTime - aTime;
                });
                
                console.log(`✅ Firebase에서 문의 데이터 ${inquiries.length}개 가져옴`);
                console.log('📊 문의 데이터 상세:', inquiries);
                return inquiries;
            } catch (error) {
                console.error('❌ Firebase에서 문의 데이터 가져오기 실패:', error);
                return [];
            }
        }
        
        // Firebase에서 의뢰 데이터 삭제
        async function deleteRequestFromFirebase(requestId) {
            try {
                const { doc, deleteDoc } = window.firebaseFirestoreFunctions;
                const db = window.firebaseDb;
                
                await deleteDoc(doc(db, 'requests', requestId));
                console.log('✅ Firebase에서 의뢰 데이터 삭제 완료:', requestId);
                return true;
            } catch (error) {
                console.error('❌ Firebase에서 의뢰 데이터 삭제 실패:', error);
                return false;
            }
        }
        
        // Firebase에서 문의 데이터 삭제
        async function deleteInquiryFromFirebase(inquiryId) {
            try {
                const { doc, deleteDoc } = window.firebaseFirestoreFunctions;
                const db = window.firebaseDb;
                
                await deleteDoc(doc(db, 'inquiries', inquiryId));
                console.log('✅ Firebase에서 문의 데이터 삭제 완료:', inquiryId);
                return true;
            } catch (error) {
                console.error('❌ Firebase에서 문의 데이터 삭제 실패:', error);
                return false;
            }
        }
        
        // Firebase에서 의뢰 데이터 수정
        async function updateRequestInFirebase(requestId, updateData) {
            try {
                const { doc, updateDoc } = window.firebaseFirestoreFunctions;
                const db = window.firebaseDb;
                
                await updateDoc(doc(db, 'requests', requestId), updateData);
                console.log('✅ Firebase에서 의뢰 데이터 수정 완료:', requestId);
                return true;
            } catch (error) {
                console.error('❌ Firebase에서 의뢰 데이터 수정 실패:', error);
                return false;
            }
        }
        
        // Firebase에서 문의 데이터 수정
        async function updateInquiryInFirebase(inquiryId, updateData) {
            try {
                const { doc, updateDoc } = window.firebaseFirestoreFunctions;
                const db = window.firebaseDb;
                
                await updateDoc(doc(db, 'inquiries', inquiryId), updateData);
                console.log('✅ Firebase에서 문의 데이터 수정 완료:', inquiryId);
                return true;
            } catch (error) {
                console.error('❌ Firebase에서 문의 데이터 수정 실패:', error);
                return false;
            }
        }

        // 의뢰 목록 렌더링 (Firebase 데이터)
        async function renderRequestList() {
            try {
                const requests = await getRequestsFromFirebase();
                const requestList = document.getElementById('request-list');
                
                if (!requestList) {
                    console.error('의뢰 목록 요소를 찾을 수 없습니다.');
                    return;
                }
                
                if (requests.length === 0) {
                    requestList.innerHTML = '<li class="p-4 text-center text-gray-500">의뢰 내역이 없습니다.</li>';
                    return;
                }
                
                requestList.innerHTML = '';
                requests.forEach(request => {
                    const listItem = document.createElement('li');
                    listItem.className = 'grid grid-cols-8 gap-2 px-4 py-3 hover:bg-pink-100 transition-colors';
                    
                    const createdAt = request.createdAt ? 
                        new Date(request.createdAt.seconds * 1000).toLocaleDateString('ko-KR') : 
                        '날짜 없음';
                    
                    listItem.innerHTML = `
                        <div class="col-span-1 flex items-center">
                            <input type="checkbox" class="request-checkbox" data-id="${request.id}">
                        </div>
                        <div class="col-span-2">
                            <div class="font-semibold text-blue-600">${request.requestNumber || '번호 없음'}</div>
                            <div class="text-sm text-gray-600">${request.userName || request.name || '이름 없음'}</div>
                        </div>
                        <div class="col-span-1 text-center text-sm">${createdAt}</div>
                        <div class="col-span-1 text-center">
                            <span class="px-2 py-1 text-xs rounded-full ${request.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${request.status === 'completed' ? '완료' : '진행중'}
                            </span>
                        </div>
                        <div class="col-span-1 text-center text-sm">${request.purchaseMethod || '-'}</div>
                        <div class="col-span-1 text-center text-sm">${request.purchaseStatus || '-'}</div>
                        <div class="col-span-1 text-center">
                            <button onclick="viewRequestDetail('${request.id}')" class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                                상세보기
                            </button>
                        </div>
                    `;
                    
                    requestList.appendChild(listItem);
                });
                
                console.log(`✅ 의뢰 목록 ${requests.length}개 렌더링 완료`);
            } catch (error) {
                console.error('❌ 의뢰 목록 렌더링 실패:', error);
            }
        }
        
        // 문의 목록 렌더링 (Firebase 데이터)
        async function renderInquiryList() {
            try {
                const inquiries = await getInquiriesFromFirebase();
                const inquiryTableBody = document.getElementById('inquiries-table-body');
                
                if (!inquiryTableBody) {
                    console.error('문의 목록 테이블 요소를 찾을 수 없습니다.');
                    return;
                }
                
                if (inquiries.length === 0) {
                    inquiryTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">문의 내역이 없습니다.</td></tr>';
                    return;
                }
                
                inquiryTableBody.innerHTML = '';
                inquiries.forEach(inquiry => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-blue-50 transition-colors';
                    
                    const createdAt = inquiry.createdAt ? 
                        new Date(inquiry.createdAt.seconds * 1000).toLocaleDateString('ko-KR') : 
                        '날짜 없음';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="inquiry-checkbox" data-id="${inquiry.id}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${inquiry.id ? inquiry.id.substring(0, 8) + '...' : 'ID 없음'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="font-semibold text-blue-600">${inquiry.subject || '제목 없음'}</div>
                            <div class="text-sm text-gray-600">${inquiry.name || '이름 없음'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="px-2 py-1 text-xs rounded-full ${inquiry.status === '답변완료' || inquiry.status === 'answered' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${inquiry.status === '답변완료' || inquiry.status === 'answered' ? '답변완료' : '대기중'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${createdAt}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <button onclick="viewInquiryDetail('${inquiry.id}')" class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                                상세보기
                            </button>
                        </td>
                    `;
                    
                    inquiryTableBody.appendChild(row);
                });
                
                console.log(`✅ 문의 목록 ${inquiries.length}개 렌더링 완료`);
            } catch (error) {
                console.error('❌ 문의 목록 렌더링 실패:', error);
            }
        }
        
        // 의뢰 상세보기
        async function viewRequestDetail(requestId) {
            try {
                const requests = await getRequestsFromFirebase();
                const request = requests.find(r => r.id === requestId);
                
                if (!request) {
                    alert('의뢰 정보를 찾을 수 없습니다.');
                    return;
                }
                
                // 현재 의뢰 ID 저장
                currentRequestId = requestId;
                
                // 관리자용 의뢰 상세보기 모달 표시
                showAdminRequestDetailModal(request);
                
            } catch (error) {
                console.error('❌ 의뢰 상세보기 실패:', error);
                alert('의뢰 상세 정보를 불러오는데 실패했습니다.');
            }
        }
        
        // 문의 상세보기
        async function viewInquiryDetail(inquiryId) {
            try {
                const inquiries = await getInquiriesFromFirebase();
                const inquiry = inquiries.find(i => i.id === inquiryId);
                
                if (!inquiry) {
                    alert('문의 정보를 찾을 수 없습니다.');
                    return;
                }
                
                // 현재 문의 ID 저장
                currentInquiryId = inquiryId;
                
                // 문의 상세보기 모달 표시
                showInquiryDetailModal(inquiry);
                
            } catch (error) {
                console.error('❌ 문의 상세보기 실패:', error);
                alert('문의 상세 정보를 불러오는데 실패했습니다.');
            }
        }

        // 선택된 의뢰 삭제
        async function deleteSelectedRequests() {
            const checkboxes = document.querySelectorAll('.request-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('삭제할 의뢰를 선택해주세요.');
                return;
            }
            
            if (!confirm(`선택된 ${checkboxes.length}개의 의뢰를 삭제하시겠습니까?`)) {
                return;
            }
            
            const deletePromises = Array.from(checkboxes).map(checkbox => {
                const requestId = checkbox.dataset.id;
                return deleteRequestFromFirebase(requestId);
            });
            
            try {
                await Promise.all(deletePromises);
                alert('선택된 의뢰가 삭제되었습니다.');
                renderRequestList(); // 목록 새로고침
            } catch (error) {
                console.error('의뢰 삭제 실패:', error);
                alert('의뢰 삭제 중 오류가 발생했습니다.');
            }
        }
        
        // 선택된 문의 삭제
        async function deleteSelectedInquiries() {
            const checkboxes = document.querySelectorAll('.inquiry-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('삭제할 문의를 선택해주세요.');
                return;
            }
            
            if (!confirm(`선택된 ${checkboxes.length}개의 문의를 삭제하시겠습니까?`)) {
                return;
            }
            
            const deletePromises = Array.from(checkboxes).map(checkbox => {
                const inquiryId = checkbox.dataset.id;
                return deleteInquiryFromFirebase(inquiryId);
            });
            
            try {
                await Promise.all(deletePromises);
                alert('선택된 문의가 삭제되었습니다.');
                renderInquiryList(); // 목록 새로고침
            } catch (error) {
                console.error('문의 삭제 실패:', error);
                alert('문의 삭제 중 오류가 발생했습니다.');
            }
        }
        
        // 의뢰 상태 업데이트
        async function updateRequestStatus(requestId, status) {
            try {
                const success = await updateRequestInFirebase(requestId, { 
                    status: status,
                    updatedAt: new Date()
                });
                
                if (success) {
                    alert('의뢰 상태가 업데이트되었습니다.');
                    renderRequestList(); // 목록 새로고침
                } else {
                    alert('의뢰 상태 업데이트에 실패했습니다.');
                }
            } catch (error) {
                console.error('의뢰 상태 업데이트 실패:', error);
                alert('의뢰 상태 업데이트 중 오류가 발생했습니다.');
            }
        }
        
        // 문의 상태 업데이트
        async function updateInquiryStatus(inquiryId, status) {
            try {
                const success = await updateInquiryInFirebase(inquiryId, { 
                    status: status,
                    updatedAt: new Date()
                });
                
                if (success) {
                    alert('문의 상태가 업데이트되었습니다.');
                    renderInquiryList(); // 목록 새로고침
                } else {
                    alert('문의 상태 업데이트에 실패했습니다.');
                }
            } catch (error) {
                console.error('문의 상태 업데이트 실패:', error);
                alert('문의 상태 업데이트 중 오류가 발생했습니다.');
            }
        }

        // 의뢰 통계 업데이트 함수
        function updateRequestStats(requests) {
            const totalRequestsElement = document.getElementById('total-requests');
            const completedRequestsElement = document.getElementById('completed-requests');
            
            if (totalRequestsElement) {
                totalRequestsElement.textContent = requests.length;
            }
            
            if (completedRequestsElement) {
                const completedCount = requests.filter(req => req.status === '답변완료' || req.status === '완료').length;
                completedRequestsElement.textContent = completedCount;
            }
            
            console.log('📊 의뢰 통계 업데이트:', {
                total: requests.length,
                completed: requests.filter(req => req.status === '답변완료' || req.status === '완료').length
            });
        }
        
        // 문의 통계 업데이트 함수
        function updateInquiryStats(inquiries) {
            const totalInquiriesElement = document.getElementById('total-inquiries');
            const unansweredInquiriesElement = document.getElementById('unanswered-inquiries');
            
            if (totalInquiriesElement) {
                totalInquiriesElement.textContent = inquiries.length;
            }
            
            if (unansweredInquiriesElement) {
                const unansweredCount = inquiries.filter(inq => inq.status !== '답변완료' && inq.status !== '완료').length;
                unansweredInquiriesElement.textContent = unansweredCount;
            }
            
            console.log('📊 문의 통계 업데이트:', {
                total: inquiries.length,
                unanswered: inquiries.filter(inq => inq.status !== '답변완료' && inq.status !== '완료').length
            });
        }
        
        // 대시보드 통계 업데이트 함수
        async function updateDashboardStats() {
            try {
                console.log('📊 대시보드 통계 업데이트 시작...');
                
                // 의뢰 통계 업데이트
                const requests = await getRequestsFromFirebase();
                const totalRequestsElement = document.getElementById('total-requests');
                const completedRequestsElement = document.getElementById('completed-requests');
                
                if (totalRequestsElement) {
                    totalRequestsElement.textContent = requests.length;
                }
                
                if (completedRequestsElement) {
                    const completedCount = requests.filter(req => req.status === '답변완료' || req.status === '완료').length;
                    completedRequestsElement.textContent = completedCount;
                }
                
                // 문의 통계 업데이트
                const inquiries = await getInquiriesFromFirebase();
                const totalInquiriesElement = document.getElementById('total-inquiries');
                const unansweredInquiriesElement = document.getElementById('unanswered-inquiries');
                
                if (totalInquiriesElement) {
                    totalInquiriesElement.textContent = inquiries.length;
                }
                
                if (unansweredInquiriesElement) {
                    const unansweredCount = inquiries.filter(inq => inq.status !== '답변완료' && inq.status !== '완료').length;
                    unansweredInquiriesElement.textContent = unansweredCount;
                }
                
                // 회원 통계 업데이트
                const users = await getUsersFromFirebase();
                const totalMembersElement = document.getElementById('total-members');
                
                if (totalMembersElement) {
                    totalMembersElement.textContent = users.length;
                }
                
                console.log('✅ 대시보드 통계 업데이트 완료:', {
                    requests: requests.length,
                    completedRequests: requests.filter(req => req.status === '답변완료' || req.status === '완료').length,
                    inquiries: inquiries.length,
                    unansweredInquiries: inquiries.filter(inq => inq.status !== '답변완료' && inq.status !== '완료').length,
                    members: users.length
                });
                
            } catch (error) {
                console.error('❌ 대시보드 통계 업데이트 실패:', error);
            }
        }
        
        // Firebase에서 사용자 데이터 가져오기
        async function getUsersFromFirebase() {
            try {
                const { collection, getDocs } = window.firebaseFirestoreFunctions;
                const db = window.firebaseDb;
                
                const usersRef = collection(db, 'users');
                const querySnapshot = await getDocs(usersRef);
                const users = [];
                
                querySnapshot.forEach((doc) => {
                    users.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                return users;
            } catch (error) {
                console.error('❌ Firebase에서 사용자 데이터 가져오기 실패:', error);
                return [];
            }
        }

        // 로그인 섹션 표시 함수
        function showLoginSection() {
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('dashboard-section').classList.add('hidden');
            
            // 로그아웃 처리
            if (window.firebaseAuth) {
                window.firebaseAuth.signOut().catch(error => {
                    console.error('❌ 로그아웃 실패:', error);
                });
            }
        }

        // 대시보드 데이터 로드 함수
        async function loadDashboardData() {
            console.log('📊 대시보드 데이터 로드 시작...');
            
            // 관리자 권한 재확인
            if (!window.firebaseAuth || !window.firebaseAuth.currentUser) {
                console.error('❌ 인증되지 않은 사용자입니다.');
                showLoginSection();
                return;
            }
            
            const isAdmin = await checkAdminPermission(window.firebaseAuth.currentUser);
            if (!isAdmin) {
                console.error('❌ 관리자 권한이 없습니다.');
                showLoginSection();
                return;
            }
            
            if (!window.firebaseDb) {
                console.error('❌ Firestore가 초기화되지 않았습니다.');
                return;
            }
            
            // 실시간 구독 시작 (이미 시작되어 있으면 무시)
            if (!requestsUnsubscribe) {
                subscribeToRequests();
            }
            if (!inquiriesUnsubscribe) {
                subscribeToInquiries();
            }
            
            // 초기 데이터 로드 (호환성 유지)
            renderRequestList();
            renderInquiryList();
            
            // 통계 업데이트
            updateDashboardStats();
            
            console.log('✅ 대시보드 데이터 로드 완료');
        }
        
        // Firebase 연결 테스트 함수
        window.testFirebaseConnection = async function() {
            try {
                console.log('🔥 Firebase 연결 테스트 시작...');
                
                if (!window.firebaseApp || !window.firebaseDb || !window.firebaseAuth) {
                    alert('❌ Firebase 초기화 실패!\n\nFirebase 서비스가 초기화되지 않았습니다.');
                    return false;
                }
                
                const { collection, addDoc, serverTimestamp, getDoc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                const testRef = collection(window.firebaseDb, 'test');
                
                // 테스트 데이터 쓰기
                console.log('📝 테스트 데이터 쓰기 중...');
                const testDoc = await addDoc(testRef, {
                    test: true,
                    timestamp: serverTimestamp(),
                    message: '관리자 대시보드 Firebase 연결 테스트',
                    testTime: new Date().toISOString()
                });
                
                console.log('✅ Firebase 쓰기 테스트 성공:', testDoc.id);
                
                // 테스트 데이터 읽기
                console.log('📖 테스트 데이터 읽기 중...');
                const testData = await getDoc(testDoc);
                console.log('✅ Firebase 읽기 테스트 성공:', testData.data());
                
                // 테스트 데이터 삭제
                console.log('🗑️ 테스트 데이터 삭제 중...');
                await deleteDoc(testDoc);
                console.log('✅ Firebase 삭제 테스트 성공');
                
                alert('✅ Firebase 연결 테스트 성공!\n\n모든 작업(읽기/쓰기/삭제)이 정상적으로 작동합니다.\n\n문서 ID: ' + testDoc.id);
                return true;
                
            } catch (error) {
                console.error('❌ Firebase 연결 테스트 실패:', error);
                console.error('오류 상세:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                if (error.message.includes('Missing or insufficient permissions') || error.code === 'permission-denied') {
                    alert('❌ Firebase 연결 테스트 실패!\n\n' +
                          'Firebase 보안 규칙 오류가 발생했습니다.\n\n' +
                          '해결 방법:\n' +
                          '1. Firebase 콘솔 접속: https://console.firebase.google.com/\n' +
                          '2. pricehunter-99a1b 프로젝트 선택\n' +
                          '3. Firestore Database → 규칙\n' +
                          '4. FIREBASE_SECURITY_RULES.md 파일 참고하여 규칙 수정\n' +
                          '5. 게시 버튼 클릭');
                } else {
                    alert('시스템 연결 테스트에 실패했습니다. 다시 시도해주세요.');
                }
                
                return false;
            }
        };

        // Firebase 사용자 데이터 직접 확인 함수
        window.checkFirebaseUsers = async function() {
            try {
                console.log('🔍 Firebase 사용자 데이터 직접 확인 시작...');
                
                if (!window.firebaseDb) {
                    alert('❌ Firebase가 초기화되지 않았습니다.');
                    return;
                }
                
                const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                const usersRef = collection(window.firebaseDb, 'users');
                const snapshot = await getDocs(usersRef);
                
                console.log('📊 Firebase users 컬렉션 총 문서 수:', snapshot.size);
                
                const users = [];
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    users.push({
                        id: doc.id,
                        ...userData
                    });
                    console.log('👤 Firebase 사용자 상세 정보:', {
                        id: doc.id,
                        email: userData.email,
                        displayName: userData.displayName,
                        name: userData.name,
                        phone: userData.phone,
                        password: userData.password ? '***' : '없음',
                        agreeTerms: userData.agreeTerms,
                        agreePrivacy: userData.agreePrivacy,
                        agreeMarketing: userData.agreeMarketing,
                        createdAt: userData.createdAt,
                        loginMethod: userData.loginMethod,
                        isActive: userData.isActive,
                        loginCount: userData.loginCount
                    });
                });
                
                // 필수 필드 누락 확인
                const missingFields = [];
                users.forEach(user => {
                    const missing = [];
                    if (!user.password) missing.push('password');
                    if (!user.phone) missing.push('phone');
                    if (!user.name && !user.displayName) missing.push('name');
                    if (missing.length > 0) {
                        missingFields.push({
                            email: user.email,
                            missing: missing
                        });
                    }
                });
                
                if (missingFields.length > 0) {
                    console.warn('⚠️ 필수 필드 누락:', missingFields);
                    let message = `⚠️ Firebase 사용자 데이터에 필수 필드가 누락되었습니다!\n\n`;
                    missingFields.forEach(item => {
                        message += `${item.email}: ${item.missing.join(', ')}\n`;
                    });
                    message += `\n이것이 로그인/비밀번호 찾기가 작동하지 않는 이유입니다.\n\n데이터를 수정하시겠습니까?`;
                    
                    if (confirm(message)) {
                        await fixMissingUserData(users, missingFields);
                    }
                }
                
                // 이메일별 중복 확인
                const emailCount = {};
                const emailUsers = {};
                users.forEach(user => {
                    if (user.email) {
                        emailCount[user.email] = (emailCount[user.email] || 0) + 1;
                        if (!emailUsers[user.email]) {
                            emailUsers[user.email] = [];
                        }
                        emailUsers[user.email].push(user);
                    }
                });
                
                const duplicates = Object.entries(emailCount).filter(([email, count]) => count > 1);
                
                if (duplicates.length > 0) {
                    console.warn('⚠️ Firebase에서 중복 이메일 발견:', duplicates);
                    
                    let message = `⚠️ Firebase에서 중복 이메일 발견!\n\n중복된 이메일:\n`;
                    duplicates.forEach(([email, count]) => {
                        message += `${email}: ${count}개\n`;
                    });
                    message += `\n중복 문서를 정리하시겠습니까?`;
                    
                    if (confirm(message)) {
                        await cleanupDuplicateUsers(emailUsers, duplicates);
                    }
                } else {
                    console.log('✅ Firebase에서 중복 이메일 없음');
                    alert(`✅ Firebase 사용자 데이터 확인 완료!\n\n총 사용자 수: ${users.length}명\n중복 이메일: 없음\n누락 필드: ${missingFields.length > 0 ? '있음' : '없음'}\n\n콘솔에서 자세한 정보를 확인하세요.`);
                }
                
                return users;
                
            } catch (error) {
                console.error('❌ Firebase 사용자 데이터 확인 실패:', error);
                alert('❌ Firebase 사용자 데이터 확인 실패!\n\n오류: ' + error.message);
                return [];
            }
        };

        // 누락된 사용자 데이터 수정 함수
        window.fixMissingUserData = async function(users, missingFields) {
            try {
                console.log('🔧 누락된 사용자 데이터 수정 시작...');
                
                const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                
                for (const item of missingFields) {
                    const user = users.find(u => u.email === item.email);
                    if (!user) continue;
                    
                    const updates = {};
                    
                    // localStorage에서 해당 사용자 데이터 찾기
                    const localUsers = JSON.parse(localStorage.getItem('users') || '[]');
                    const localUser = localUsers.find(u => u.email === item.email);
                    
                    if (localUser) {
                        // localStorage에서 누락된 필드 복사
                        if (item.missing.includes('password') && localUser.password) {
                            updates.password = localUser.password;
                        }
                        if (item.missing.includes('phone') && localUser.phone) {
                            updates.phone = localUser.phone;
                        }
                        if (item.missing.includes('name') && localUser.name) {
                            updates.name = localUser.name;
                        }
                        if (localUser.agreeTerms !== undefined) updates.agreeTerms = localUser.agreeTerms;
                        if (localUser.agreePrivacy !== undefined) updates.agreePrivacy = localUser.agreePrivacy;
                        if (localUser.agreeMarketing !== undefined) updates.agreeMarketing = localUser.agreeMarketing;
                    }
                    
                    // 기본값 설정
                    if (item.missing.includes('password') && !updates.password) {
                        updates.password = 'temp123!'; // 임시 비밀번호
                    }
                    if (item.missing.includes('phone') && !updates.phone) {
                        updates.phone = '010-0000-0000'; // 기본 전화번호
                    }
                    if (item.missing.includes('name') && !updates.name) {
                        updates.name = user.displayName || '사용자';
                    }
                    if (updates.agreeTerms === undefined) updates.agreeTerms = true;
                    if (updates.agreePrivacy === undefined) updates.agreePrivacy = true;
                    if (updates.agreeMarketing === undefined) updates.agreeMarketing = false;
                    
                    // Firebase 업데이트
                    const userDocRef = doc(window.firebaseDb, 'users', user.id);
                    await updateDoc(userDocRef, updates);
                    
                    console.log(`✅ ${item.email} 사용자 데이터 수정 완료:`, updates);
                }
                
                alert('✅ 사용자 데이터 수정 완료!\n\n누락된 필드들이 추가되었습니다.\n\n이제 로그인과 비밀번호 찾기가 정상 작동할 것입니다.');
                
            } catch (error) {
                console.error('❌ 사용자 데이터 수정 실패:', error);
                alert('❌ 사용자 데이터 수정 실패!\n\n오류: ' + error.message);
            }
        };

        // 중복 사용자 정리 함수 (독립 호출용)
        window.cleanupDuplicateUsers = async function(emailUsers, duplicates) {
            // 매개변수가 없으면 먼저 중복 확인
            if (!emailUsers || !duplicates) {
                const users = await checkFirebaseUsers();
                if (!users || users.length === 0) return;
                
                // 이메일별 중복 확인
                const emailCount = {};
                const emailUsersMap = {};
                users.forEach(user => {
                    if (user.email) {
                        emailCount[user.email] = (emailCount[user.email] || 0) + 1;
                        if (!emailUsersMap[user.email]) {
                            emailUsersMap[user.email] = [];
                        }
                        emailUsersMap[user.email].push(user);
                    }
                });
                
                const duplicatesList = Object.entries(emailCount).filter(([email, count]) => count > 1);
                
                if (duplicatesList.length === 0) {
                    alert('✅ 중복 사용자가 없습니다!');
                    return;
                }
                
                return await cleanupDuplicateUsers(emailUsersMap, duplicatesList);
            }
            try {
                console.log('🧹 중복 사용자 정리 시작...');
                
                const { doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                let deletedCount = 0;
                
                for (const [email, count] of duplicates) {
                    const users = emailUsers[email];
                    console.log(`📧 ${email}의 중복 문서들:`, users);
                    
                    // 가장 최신 문서를 제외하고 나머지 삭제
                    const sortedUsers = users.sort((a, b) => {
                        const dateA = a.createdAt ? (a.createdAt.seconds ? a.createdAt.seconds : new Date(a.createdAt).getTime() / 1000) : 0;
                        const dateB = b.createdAt ? (b.createdAt.seconds ? b.createdAt.seconds : new Date(b.createdAt).getTime() / 1000) : 0;
                        return dateB - dateA; // 최신순 정렬
                    });
                    
                    // 가장 최신 문서는 유지하고 나머지 삭제
                    for (let i = 1; i < sortedUsers.length; i++) {
                        const userToDelete = sortedUsers[i];
                        console.log(`🗑️ 삭제할 문서: ${userToDelete.id} (${userToDelete.name || userToDelete.displayName})`);
                        
                        const userDocRef = doc(window.firebaseDb, 'users', userToDelete.id);
                        await deleteDoc(userDocRef);
                        deletedCount++;
                        
                        console.log(`✅ 문서 삭제 완료: ${userToDelete.id}`);
                    }
                }
                
                console.log(`✅ 중복 사용자 정리 완료: ${deletedCount}개 문서 삭제`);
                alert(`✅ 중복 사용자 정리 완료!\n\n삭제된 문서 수: ${deletedCount}개\n\n페이지를 새로고침하여 결과를 확인하세요.`);
                
                // 페이지 새로고침
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('❌ 중복 사용자 정리 실패:', error);
                alert('❌ 중복 사용자 정리 실패!\n\n오류: ' + error.message);
            }
        };
        
        // CSP 헤더 확인 함수
        window.checkCSPHeaders = function() {
            console.log('🔍 CSP 헤더 확인 시작...');
            
            // 현재 페이지의 Response Headers 확인
            fetch(window.location.href, { method: 'HEAD' })
                .then(response => {
                    const cspHeader = response.headers.get('content-security-policy');
                    const serverHeader = response.headers.get('server');
                    const cfRay = response.headers.get('cf-ray');
                    const xVercelId = response.headers.get('x-vercel-id');
                    const xCloudTrace = response.headers.get('x-cloud-trace-context');
                    
                    console.log('📋 Response Headers 분석:');
                    console.log('Server:', serverHeader);
                    console.log('CF-Ray:', cfRay);
                    console.log('X-Vercel-ID:', xVercelId);
                    console.log('X-Cloud-Trace:', xCloudTrace);
                    console.log('CSP Header:', cspHeader);
                    
                    // CSP 주입 주체 판별
                    let cspSource = 'Unknown';
                    if (cfRay || response.headers.get('cf-cache-status')) {
                        cspSource = 'Cloudflare';
                    } else if (serverHeader && serverHeader.includes('nginx')) {
                        cspSource = 'Nginx';
                    } else if (serverHeader && serverHeader.includes('apache')) {
                        cspSource = 'Apache';
                    } else if (xVercelId) {
                        cspSource = 'Vercel';
                    } else if (serverHeader && serverHeader.includes('Firebase')) {
                        cspSource = 'Firebase Hosting';
                    }
                    
                    // Firebase 도메인 포함 여부 확인
                    const hasFirebaseDomains = cspHeader && (
                        cspHeader.includes('www.gstatic.com') || 
                        cspHeader.includes('www.gstatic.com/firebasejs')
                    );
                    
                    const result = `
🔍 CSP 헤더 분석 결과:

📡 CSP 주입 주체: ${cspSource}
🔒 CSP 헤더 존재: ${cspHeader ? 'Yes' : 'No'}
🔥 Firebase 도메인 포함: ${hasFirebaseDomains ? 'Yes' : 'No'}

${cspHeader ? `📋 현재 CSP 정책:
${cspHeader.substring(0, 200)}...` : '❌ CSP 헤더가 없습니다.'}

${!hasFirebaseDomains ? '⚠️ Firebase 도메인이 CSP에 포함되지 않았습니다!' : '✅ Firebase 도메인이 CSP에 포함되어 있습니다.'}
                    `;
                    
                    alert(result);
                    console.log('CSP 분석 완료:', result);
                })
                .catch(error => {
                    console.error('❌ CSP 헤더 확인 실패:', error);
                    alert('❌ CSP 헤더 확인에 실패했습니다.\n\n브라우저 DevTools → Network → Response Headers를 직접 확인하세요.');
                });
        };
        
        // 캐시 및 서비스워커 정리 함수 (CSP 완전 정리)
        window.clearCacheAndReload = function() {
            console.log('🧹 캐시 및 서비스워커 완전 정리 시작...');
            
            let cleanupPromises = [];
            
            // 서비스워커 등록 해제
            if ('serviceWorker' in navigator) {
                const swPromise = navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    const unregisterPromises = registrations.map(registration => {
                        console.log('🗑️ 서비스워커 등록 해제:', registration.scope);
                        return registration.unregister();
                    });
                    return Promise.all(unregisterPromises);
                });
                cleanupPromises.push(swPromise);
            }
            
            // 캐시 스토리지 정리
            if ('caches' in window) {
                const cachePromise = caches.keys().then(function(cacheNames) {
                    return Promise.all(
                        cacheNames.map(function(cacheName) {
                            console.log('🗑️ 캐시 삭제:', cacheName);
                            return caches.delete(cacheName);
                        })
                    );
                });
                cleanupPromises.push(cachePromise);
            }
            
            // 로컬 스토리지 정리
            try {
                localStorage.clear();
                sessionStorage.clear();
                console.log('✅ 로컬/세션 스토리지가 정리되었습니다.');
            } catch (e) {
                console.log('⚠️ 스토리지 정리 중 오류:', e);
            }
            
            // IndexedDB 정리
            if ('indexedDB' in window) {
                try {
                    indexedDB.databases().then(databases => {
                        databases.forEach(db => {
                            indexedDB.deleteDatabase(db.name);
                            console.log('🗑️ IndexedDB 삭제:', db.name);
                        });
                    });
                } catch (e) {
                    console.log('⚠️ IndexedDB 정리 중 오류:', e);
                }
            }
            
            // 모든 정리 작업 완료 후 새로고침
            Promise.all(cleanupPromises).then(() => {
                console.log('✅ 모든 캐시 정리 완료');
                // 강제 새로고침 (캐시 무시 + 타임스탬프)
                const timestamp = Date.now();
                const url = new URL(window.location);
                url.searchParams.set('v', timestamp);
                url.searchParams.set('cache', 'clear');
                window.location.href = url.toString();
            }).catch(error => {
                console.error('❌ 캐시 정리 중 오류:', error);
                // 오류가 있어도 새로고침
                const timestamp = Date.now();
                const url = new URL(window.location);
                url.searchParams.set('v', timestamp);
                url.searchParams.set('cache', 'clear');
                window.location.href = url.toString();
            });
        };
        
        // 페이지 이동 함수
        window.goToPage = function(page) {
            window.location.href = page;
        };
        
        // 사이드바 섹션 전환 함수 (전역 함수)
        window.switchSection = function(sectionName) {
            console.log('🔄 섹션 전환:', sectionName);
            
            // 모든 섹션 숨기기
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.add('hidden');
            });
            
            // 모든 사이드바 아이템 비활성화
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 선택된 섹션 표시
            let targetSection;
            if (sectionName === 'dashboard') {
                // 대시보드는 dashboard-content를 표시
                targetSection = document.getElementById('dashboard-content');
            } else {
                targetSection = document.getElementById(sectionName + '-section');
            }
            
            if (targetSection) {
                targetSection.classList.remove('hidden');
                console.log('✅ 섹션 표시:', sectionName);
            } else {
                console.error('❌ 섹션을 찾을 수 없음:', sectionName);
            }
            
            // 선택된 사이드바 아이템 활성화
            const activeItem = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }
        

        // 사용자 상세보기 함수
        async function viewUserDetails(userId) {
            console.log('👤 사용자 상세보기:', userId);
            
            // Firebase에서 사용자 검색
            let user = null;
            try {
                await waitForFirebase();
                const { collection, query, where, getDocs, doc, getDoc } = window.firebaseFirestoreFunctions;
                const db = window.firebaseDb;
                
                // 먼저 ID로 직접 검색
                try {
                    const userDoc = await getDoc(doc(db, 'users', userId));
                    if (userDoc.exists()) {
                        user = { id: userDoc.id, ...userDoc.data() };
                    }
                } catch (error) {
                    // ID로 찾지 못하면 이메일로 검색
                    const usersRef = collection(db, 'users');
                    const q = query(usersRef, where('email', '==', userId));
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const userDoc = querySnapshot.docs[0];
                        user = { id: userDoc.id, ...userDoc.data() };
                    }
                }
            } catch (error) {
                console.error('사용자 검색 실패:', error);
            }
            
            // Firebase에서도 검색 시도
            if (!user && window.firebaseDb) {
                console.log('🔍 Firebase에서 사용자 검색 시도...');
                // Firebase 사용자 검색 로직은 별도로 구현 필요
            }
            
            console.log('👤 찾은 사용자:', user);
            
            if (!user) {
                console.error('❌ 사용자를 찾을 수 없음. 사용 가능한 ID들:', users.map(u => ({ id: u.id, firebaseId: u.firebaseId, uid: u.uid, email: u.email })));
                alert(`사용자 정보를 찾을 수 없습니다.\n\n검색한 ID: ${userId}\n\n콘솔에서 자세한 정보를 확인하세요.`);
                return;
            }
            
            // 모달 내용 생성
            const content = document.getElementById('user-detail-content');
            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 기본 정보 -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📋 기본 정보</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">이름:</span>
                                <span class="font-medium">${user.name || user.displayName || '정보 없음'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">이메일:</span>
                                <span class="font-medium">${user.email || '정보 없음'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">휴대폰:</span>
                                <span class="font-medium">${user.phone || '정보 없음'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">로그인 방식:</span>
                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${(user.loginMethod || user.loginType) === 'kakao' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}">
                                    ${(user.loginMethod || user.loginType) === 'kakao' ? '카카오톡' : '이메일'}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 계정 정보 -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">🔐 계정 정보</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">사용자 ID:</span>
                                <span class="font-mono text-sm">${user.id || user.firebaseId || '정보 없음'}</span>
                            </div>
                            <!-- 포인트 시스템 제거됨 -->
                            <div class="flex justify-between">
                                <span class="text-gray-600">가입일:</span>
                                <span class="font-medium">${user.createdAt ? new Date(user.createdAt).toLocaleDateString('ko-KR') : '정보 없음'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">마지막 로그인:</span>
                                <span class="font-medium">${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('ko-KR') : '정보 없음'}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 추가 정보 -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">📊 추가 정보</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">데이터 소스:</span>
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${user.source === 'localStorage' ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800'}">
                                ${user.source || 'Firebase'}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">로그인 횟수:</span>
                            <span class="font-medium">${user.loginCount || 0}회</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">계정 상태:</span>
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${user.isActive !== false ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${user.isActive !== false ? '활성' : '비활성'}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">마케팅 동의:</span>
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${user.agreeMarketing ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${user.agreeMarketing ? '동의' : '비동의'}
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- 약관 동의 정보 -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">📄 약관 동의</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600">이용약관:</span>
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${user.agreeTerms ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${user.agreeTerms ? '동의' : '비동의'}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">개인정보처리방침:</span>
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${user.agreePrivacy ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${user.agreePrivacy ? '동의' : '비동의'}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">마케팅 수신:</span>
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${user.agreeMarketing ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${user.agreeMarketing ? '동의' : '비동의'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            // 모달 이벤트 리스너 설정
            setupUserDetailModal(userId, user);
            
            // 모달 표시
            document.getElementById('user-detail-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        // 사용자 상세보기 모달 설정
        function setupUserDetailModal(userId, user) {
            // 닫기 버튼들
            document.getElementById('close-user-detail').onclick = closeUserDetailModal;
            document.getElementById('close-user-detail-btn').onclick = closeUserDetailModal;
            
            // 수정 버튼
            document.getElementById('edit-user-btn').onclick = function() {
                alert('사용자 정보 수정 기능은 추후 구현 예정입니다.');
            };
            
            // 삭제 버튼
            document.getElementById('delete-user-btn').onclick = function() {
                if (confirm(`정말로 ${user.name || user.displayName}님의 계정을 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
                    deleteUser(userId);
                    closeUserDetailModal();
                }
            };
        }
        
        // 사용자 상세보기 모달 닫기
        function closeUserDetailModal() {
            document.getElementById('user-detail-modal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // 사용자 삭제 함수 (Firebase 자동 연동)
        async function deleteUser(userId) {
            console.log('🗑️ 사용자 삭제 시작:', userId);
            
            // Firebase에서 사용자 정보 먼저 찾기
            let user = null;
            let firebaseUser = null;
            
            try {
                if (window.firebaseDb) {
                    const { collection, getDocs, query, where } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                    const usersRef = collection(window.firebaseDb, 'users');
                    
                    // 이메일로 검색 시도
                    if (userId.includes('@')) {
                        const q = query(usersRef, where('email', '==', userId));
                        const snapshot = await getDocs(q);
                        if (!snapshot.empty) {
                            const doc = snapshot.docs[0];
                            firebaseUser = { id: doc.id, ...doc.data() };
                        }
                    }
                    
                    // ID로 직접 검색 시도
                    if (!firebaseUser) {
                        const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                        const userDocRef = doc(window.firebaseDb, 'users', userId);
                        const userDoc = await getDoc(userDocRef);
                        if (userDoc.exists()) {
                            firebaseUser = { id: userDoc.id, ...userDoc.data() };
                        }
                    }
                }
            } catch (error) {
                console.warn('⚠️ Firebase에서 사용자 검색 실패:', error);
            }
            
            // Firebase에서만 사용자 검색 (로컬스토리지 제거)
            user = firebaseUser;
            
            if (!user) {
                console.error('❌ 사용자를 찾을 수 없음:', userId);
                console.log('📋 localStorage 사용자들:', users.map(u => ({ id: u.id, email: u.email })));
                alert(`삭제할 사용자를 찾을 수 없습니다.\n\n검색한 ID: ${userId}\n\n콘솔에서 자세한 정보를 확인하세요.`);
                return;
            }
            
            const userName = user.name || user.displayName || user.email;
            
            // 관리자 계정 보호
            if (user.email === 'admin@pricehunter.com') {
                alert('❌ 관리자 계정은 삭제할 수 없습니다.');
                return;
            }
            
            // 삭제 확인
            if (!confirm(`⚠️ 경고: "${userName}"님의 계정을 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.\n\n삭제될 데이터:\n- Firebase 사용자 문서 (자동 연동)\n- localStorage 사용자 데이터\n\n정말로 삭제하시겠습니까?`)) {
                return;
            }
            
            try {
                console.log('🗑️ 사용자 삭제 진행 중...');
                
                // 1. Firebase에서 삭제 (우선)
                if (window.firebaseDb && user.id) {
                    try {
                        const { doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                        const userDocRef = doc(window.firebaseDb, 'users', user.id);
                        await deleteDoc(userDocRef);
                        console.log('✅ Firebase에서 사용자 삭제 완료:', user.id);
                    } catch (firebaseError) {
                        console.error('❌ Firebase 삭제 실패:', firebaseError);
                        alert('❌ Firebase에서 사용자 삭제에 실패했습니다.\n\n오류: ' + firebaseError.message);
                        return;
                    }
                } else {
                    console.warn('⚠️ Firebase 연결이 없거나 사용자 ID가 없습니다.');
                }
                
                // 2. localStorage에서 삭제 (사용자 이메일 기준으로 삭제)
                // 로컬스토리지 삭제 로직 제거됨 - Firebase 전용 사용
                
                // 로컬스토리지 삭제 로직 제거됨 - Firebase 전용 사용
                
                // 4. UI 업데이트
                alert(`✅ "${userName}"님의 계정이 완전히 삭제되었습니다.\n\n- Firebase: 삭제 완료 (자동 연동)\n- localStorage: 삭제 완료`);
                
                // 5. 회원 목록 새로고침
                if (typeof subscribeToUsers === 'function') {
                    subscribeToUsers();
                }
                
                // 6. 통계 업데이트
                setTimeout(() => {
                    const allUsers = JSON.parse(localStorage.getItem('users') || '[]');
                    const totalMembersElement = document.getElementById('total-members');
                    if (totalMembersElement) {
                        totalMembersElement.textContent = allUsers.length;
                    }
                    
                    // 통계 업데이트
                    if (typeof updateMemberStats === 'function') {
                        updateMemberStats(allUsers);
                    }
                }, 1000);
                
                console.log('✅ 사용자 삭제 완료');
                
            } catch (error) {
                console.error('❌ 사용자 삭제 실패:', error);
                alert('❌ 사용자 삭제 중 오류가 발생했습니다.\n\n오류: ' + error.message);
            }
        }

        // 섹션 전환
        function switchSection(section) {
            // 기존 활성 섹션 숨기기
            document.querySelectorAll('.section-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // 기존 활성 사이드바 아이템 비활성화
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 새 섹션 표시
            const targetSection = document.getElementById(section + '-section');
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // 새 사이드바 아이템 활성화
            const activeItem = document.querySelector(`[data-section="${section}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
            
            // 섹션별 데이터 새로고침
            switch(section) {
                case 'requests':
                    // 의뢰 관리 섹션인 경우 실시간 구독 시작 (이미 시작되어 있으면 무시)
                    if (!requestsUnsubscribe) {
                        subscribeToRequests();
                    }
                    renderRequestList();
                    break;
                case 'inquiries':
                    // 문의 관리 섹션인 경우 실시간 구독 시작 (이미 시작되어 있으면 무시)
                    if (!inquiriesUnsubscribe) {
                        subscribeToInquiries();
                    }
                    renderInquiryList();
                    break;
                case 'members':
                    // 회원 관리 섹션인 경우 실시간 구독 시작 (이미 시작되어 있으면 무시)
                    if (!usersUnsubscribe) {
                        subscribeToUsers();
                    }
                    break;
                case 'reviews':
                    console.log('🔄 후기 섹션으로 전환 - 데이터 로드 시작');
                    loadReviewsData();
                    break;
                case 'dashboard':
                    loadDashboardData();
                    break;
            }
        }

        // 후기 관리 함수들
        let allReviews = [];
        let filteredReviews = [];
        let reviewsUnsubscribe = null;

        // 후기 데이터 로드 (통합 시스템)
        async function loadReviewsData() {
            try {
                console.log('📋 후기 데이터 로드 시작...');
                
                if (!window.firebaseDb) {
                    console.error('❌ Firebase가 초기화되지 않았습니다.');
                    return;
                }

                // Firebase 초기화 대기
                await waitForFirebase();

                // 실시간 리스너 시작
                subscribeToReviews();
                
                // 초기 데이터도 로드
                await loadInitialReviewsData();
                
            } catch (error) {
                console.error('❌ 후기 데이터 로드 실패:', error);
                alert('후기 데이터를 불러오는데 실패했습니다: ' + error.message);
            }
        }

        // 초기 후기 데이터 로드 (개선된 버전)
        let reviewLoadAttempts = 0;
        const maxReviewLoadAttempts = 3;
        
        async function loadInitialReviewsData() {
            try {
                reviewLoadAttempts++;
                console.log(`🔄 관리자 후기 데이터 로드 시도 ${reviewLoadAttempts}/${maxReviewLoadAttempts}`);
                
                const { collection, getDocs, doc, getDoc, query, orderBy } = window.firebaseFirestoreFunctions;
                const reviewsRef = collection(window.firebaseDb, 'reviews');
                
                let snapshot;
                try {
                    // 모든 후기 가져오기 (최신순 정렬) - 복합 인덱스 필요할 수 있음
                    const q = query(reviewsRef, orderBy('createdAt', 'desc'));
                    snapshot = await getDocs(q);
                    console.log('✅ Firebase 쿼리 성공 (인덱스 사용)');
                } catch (indexError) {
                    console.warn('⚠️ 복합 인덱스 오류, 모든 후기 가져와서 클라이언트 정렬:', indexError);
                    // 모든 후기를 가져와서 클라이언트에서 정렬
                    const allSnapshot = await getDocs(reviewsRef);
                    snapshot = {
                        docs: allSnapshot.docs.sort((a, b) => {
                            const aTime = a.data().createdAt?.toDate?.() || new Date(0);
                            const bTime = b.data().createdAt?.toDate?.() || new Date(0);
                            return bTime - aTime; // 최신순
                        })
                    };
                }
                
                allReviews = [];
                
                // 각 후기에 대해 의뢰 건 정보도 함께 로드
                for (const docSnapshot of snapshot.docs) {
                    const reviewData = { id: docSnapshot.id, ...docSnapshot.data() };
                    
                    // 데이터 유효성 검사
                    if (!reviewData.name || !reviewData.productName) {
                        console.warn('⚠️ 유효하지 않은 후기 데이터 건너뜀:', reviewData.id);
                        continue;
                    }
                    
                    // 의뢰 건 정보가 있으면 함께 로드
                    if (reviewData.requestId) {
                        try {
                            const requestRef = doc(window.firebaseDb, 'requests', reviewData.requestId);
                            const requestSnap = await getDoc(requestRef);
                            if (requestSnap.exists()) {
                                reviewData.requestData = { id: requestSnap.id, ...requestSnap.data() };
                            }
                        } catch (error) {
                            console.warn('의뢰 건 정보 로드 실패:', reviewData.requestId, error);
                        }
                    }
                    
                    allReviews.push(reviewData);
                }
                
                filteredReviews = [...allReviews];
                updateReviewStatistics();
                displayReviewsTable();
                
                console.log(`✅ 초기 후기 데이터 로드 완료: ${allReviews.length}개 (승인: ${allReviews.filter(r => r.approved).length}개, 미승인: ${allReviews.filter(r => !r.approved).length}개)`);
                reviewLoadAttempts = 0; // 성공 시 리셋
                
            } catch (error) {
                console.error('❌ 초기 후기 데이터 로드 실패:', error);
                
                // 재시도 로직
                if (reviewLoadAttempts < maxReviewLoadAttempts) {
                    console.log(`⏳ ${2000 * reviewLoadAttempts}ms 후 재시도...`);
                    setTimeout(() => {
                        loadInitialReviewsData();
                    }, 2000 * reviewLoadAttempts);
                    return;
                }
                
                // 최대 재시도 횟수 초과 시 빈 테이블 표시
                console.log('🔄 최대 재시도 횟수 초과, 빈 테이블 표시');
                allReviews = [];
                filteredReviews = [];
                updateReviewStatistics();
                displayReviewsTable();
                reviewLoadAttempts = 0; // 리셋
            }
        }

        // 후기 실시간 리스너
        function subscribeToReviews() {
            if (reviewsUnsubscribe) {
                reviewsUnsubscribe();
            }

            const { collection, onSnapshot, doc, getDoc, query, orderBy } = window.firebaseFirestoreFunctions;
            const reviewsRef = collection(window.firebaseDb, 'reviews');
            
            // 모든 후기 가져오기 (승인/미승인 포함, 최신순 정렬)
            try {
            // 인덱스 오류 방지를 위해 단순 쿼리 사용
            reviewsUnsubscribe = onSnapshot(reviewsRef, async (snapshot) => {
                console.log('📋 후기 데이터 실시간 업데이트...');
                console.log('📊 Firebase에서 가져온 후기 문서 수:', snapshot.docs.length);
                console.log('🔍 Firebase 문서 상세 정보:', snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() })));
                
                // 기존 데이터와 비교하여 변경사항 확인
                const newReviewCount = snapshot.docs.length;
                const oldReviewCount = allReviews.length;
                console.log(`📈 후기 수 변화: ${oldReviewCount} → ${newReviewCount}`);
                
                allReviews = [];
                
                // 각 후기에 대해 의뢰 건 정보도 함께 로드
                for (const docSnapshot of snapshot.docs) {
                    const reviewData = { id: docSnapshot.id, ...docSnapshot.data() };
                    console.log('📝 후기 데이터 로드:', reviewData.name, reviewData.productName, '승인:', reviewData.approved);
                    
                    // 데이터 구조 표준화 (기본값 설정)
                    reviewData.approved = reviewData.approved || false;
                    reviewData.featured = reviewData.featured || false;
                    reviewData.rating = reviewData.rating || 5;
                    reviewData.views = reviewData.views || 0;
                    reviewData.country = reviewData.country || '대한민국';
                    reviewData.shipping = reviewData.shipping || '3일';
                    reviewData.method = reviewData.method || 'PriceHunter 검증';
                    reviewData.badge = reviewData.badge || '실제 구매자';
                    reviewData.category = reviewData.category || '일반';
                    
                    // 의뢰 건 정보가 있으면 함께 로드
                    if (reviewData.requestId) {
                        try {
                            const requestRef = doc(window.firebaseDb, 'requests', reviewData.requestId);
                            const requestSnap = await getDoc(requestRef);
                            if (requestSnap.exists()) {
                                reviewData.requestData = { id: requestSnap.id, ...requestSnap.data() };
                            }
                        } catch (error) {
                            console.warn('의뢰 건 정보 로드 실패:', reviewData.requestId, error);
                        }
                    }
                    
                allReviews.push(reviewData);
            }
            
            // 클라이언트에서 정렬 (최신순)
            allReviews.sort((a, b) => {
                const dateA = a.createdAt?.toDate?.() || new Date(0);
                const dateB = b.createdAt?.toDate?.() || new Date(0);
                return dateB - dateA;
            });
            
                filteredReviews = [...allReviews];
                updateReviewStatistics();
                displayReviewsTable();
                
                console.log(`✅ 후기 데이터 실시간 업데이트 완료: ${allReviews.length}개 (승인: ${allReviews.filter(r => r.approved).length}개, 미승인: ${allReviews.filter(r => !r.approved).length}개)`);
                
                // 데이터 변경사항이 있으면 알림
                if (newReviewCount !== oldReviewCount) {
                    console.log(`🔄 후기 데이터 변경 감지! ${oldReviewCount}개 → ${newReviewCount}개`);
                    // UI 업데이트 완료 알림 (선택적)
                    if (newReviewCount > oldReviewCount) {
                        console.log('📝 새로운 후기가 추가되었습니다!');
                    }
                }
        }, (error) => {
            console.error('❌ 후기 실시간 리스너 오류:', error);
        });
            } catch (indexError) {
                console.warn('⚠️ 복합 인덱스 오류, 모든 후기 실시간 감시로 폴백:', indexError);
                // 모든 후기를 실시간 감시하고 클라이언트에서 정렬
                reviewsUnsubscribe = onSnapshot(reviewsRef, async (snapshot) => {
                    console.log('📋 후기 데이터 실시간 업데이트 (폴백 모드)...');
                    
                    allReviews = [];
                    
                    // 클라이언트에서 정렬
                    const sortedDocs = snapshot.docs.sort((a, b) => {
                        const aTime = a.data().createdAt?.toDate?.() || new Date(0);
                        const bTime = b.data().createdAt?.toDate?.() || new Date(0);
                        return bTime - aTime; // 최신순
                    });
                    
                    // 각 후기에 대해 의뢰 건 정보도 함께 로드
                    for (const docSnapshot of sortedDocs) {
                        const reviewData = { id: docSnapshot.id, ...docSnapshot.data() };
                        
                        // 의뢰 건 정보가 있으면 함께 로드
                        if (reviewData.requestId) {
                            try {
                                const requestRef = doc(window.firebaseDb, 'requests', reviewData.requestId);
                                const requestSnap = await getDoc(requestRef);
                                if (requestSnap.exists()) {
                                    reviewData.requestData = { id: requestSnap.id, ...requestSnap.data() };
                                }
                            } catch (error) {
                                console.warn('의뢰 건 정보 로드 실패:', reviewData.requestId, error);
                            }
                        }
                        
                        allReviews.push(reviewData);
                    }
                    
                    filteredReviews = [...allReviews];
                    updateReviewStatistics();
                    displayReviewsTable();
                    
                    console.log(`✅ 후기 데이터 실시간 업데이트 완료 (폴백 모드): ${allReviews.length}개 (승인: ${allReviews.filter(r => r.approved).length}개, 미승인: ${allReviews.filter(r => !r.approved).length}개)`);
                }, (error) => {
                    console.error('❌ 후기 실시간 리스너 오류 (폴백 모드):', error);
                });
            }
        }

        // 후기 통계 업데이트
        function updateReviewStatistics() {
            const totalReviews = allReviews.length;
            const approvedReviews = allReviews.filter(r => r.approved === true).length;
            const pendingReviews = allReviews.filter(r => r.approved === false && r.rejected !== true).length;
            const featuredReviews = allReviews.filter(r => r.featured === true).length;
            const avgRating = allReviews.length > 0 ? 
                (allReviews.reduce((sum, r) => sum + (r.rating || 5), 0) / allReviews.length).toFixed(1) : 0;

            console.log('📊 후기 통계 업데이트:', {
                total: totalReviews,
                approved: approvedReviews,
                pending: pendingReviews,
                featured: featuredReviews,
                avgRating: avgRating
            });

            // 개별 요소 업데이트
            const totalElement = document.getElementById('total-reviews');
            const approvedElement = document.getElementById('approved-reviews');
            const pendingElement = document.getElementById('pending-reviews');
            const featuredElement = document.getElementById('featured-reviews');
            const avgRatingElement = document.getElementById('avg-rating');
            
            if (totalElement) totalElement.textContent = totalReviews;
            if (approvedElement) approvedElement.textContent = approvedReviews;
            if (pendingElement) pendingElement.textContent = pendingReviews;
            if (featuredElement) featuredElement.textContent = featuredReviews;
            if (avgRatingElement) avgRatingElement.textContent = avgRating;
            
            console.log('✅ 후기 통계 UI 업데이트 완료');
        }

        // Firebase 초기화 상태 확인 함수
        function checkFirebaseStatus() {
            console.log('🔍 Firebase 초기화 상태 확인...');
            console.log('Firebase DB:', !!window.firebaseDb);
            console.log('Firebase Auth:', !!window.firebaseAuth);
            console.log('Firebase Functions:', !!window.firebaseFirestoreFunctions);
            
            if (window.firebaseFirestoreFunctions) {
                console.log('사용 가능한 Firebase 함수들:', Object.keys(window.firebaseFirestoreFunctions));
            }
            
            const status = {
                db: !!window.firebaseDb,
                auth: !!window.firebaseAuth,
                functions: !!window.firebaseFirestoreFunctions
            };
            
            alert(`Firebase 상태 확인:\n\nDB: ${status.db ? '✅' : '❌'}\nAuth: ${status.auth ? '✅' : '❌'}\nFunctions: ${status.functions ? '✅' : '❌'}`);
            
            return status;
        }

        // 실시간 동기화 테스트 함수
        function testRealtimeSync() {
            console.log('🔄 실시간 동기화 테스트 시작...');
            console.log('현재 후기 수:', allReviews.length);
            console.log('실시간 리스너 상태:', reviewsUnsubscribe ? '활성' : '비활성');
            
            if (reviewsUnsubscribe) {
                console.log('✅ 실시간 리스너가 활성화되어 있습니다.');
                console.log('📊 현재 후기 데이터:', allReviews.map(r => ({ name: r.name, product: r.productName, approved: r.approved })));
            } else {
                console.log('❌ 실시간 리스너가 비활성화되어 있습니다.');
                console.log('🔄 리스너를 다시 시작합니다...');
                subscribeToReviews();
            }
        }

        // 후기 상세보기 모달 표시
        function showReviewDetail(reviewId) {
            const review = allReviews.find(r => r.id === reviewId);
            if (!review) {
                alert('후기 정보를 찾을 수 없습니다.');
                return;
            }

            console.log('📖 후기 상세보기:', review);

            // 모달 HTML 생성
            const modalHTML = `
                <div id="review-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">📖 후기 상세보기</h3>
                            <button onclick="closeReviewDetailModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- 왼쪽: 후기 정보 -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-700 mb-2">👤 작성자 정보</h4>
                                    <div class="flex items-center space-x-3">
                                        <div>
                                            <p class="font-medium">${review.name}</p>
                                            <p class="text-sm text-gray-600">${review.ageGroup} ${review.occupation}</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-700 mb-2">🛍️ 상품 정보</h4>
                                    <p class="font-medium">${review.productName}</p>
                                    <div class="mt-2 space-y-1">
                                        <p class="text-sm"><span class="font-medium">요청가:</span> ${review.originalPrice}</p>
                                        <p class="text-sm"><span class="font-medium">최종가:</span> ${review.finalPrice}</p>
                                        <p class="text-sm text-green-600"><span class="font-medium">절약:</span> ${review.savings} (${review.savingsPercent}%)</p>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-700 mb-2">⭐ 평점 및 후기</h4>
                                    <div class="flex items-center space-x-2 mb-2">
                                        <span class="text-yellow-500">${'★'.repeat(review.rating)}</span>
                                        <span class="text-sm text-gray-600">${review.rating}/5</span>
                                    </div>
                                    <p class="text-sm text-gray-700">${review.review}</p>
                                </div>
                            </div>
                            
                            <!-- 오른쪽: 상태 및 액션 -->
                            <div class="space-y-4">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-700 mb-2">📊 상태 정보</h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-sm">승인 상태:</span>
                                            <span class="px-2 py-1 rounded text-xs ${review.approved ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                                ${review.approved ? '승인됨' : '대기중'}
                                            </span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm">인덱스 노출:</span>
                                            <span class="px-2 py-1 rounded text-xs ${review.featured ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                                                ${review.featured ? '노출됨' : '숨김'}
                                            </span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm">카테고리:</span>
                                            <span class="text-sm font-medium">${review.category || '일반'}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm">조회수:</span>
                                            <span class="text-sm font-medium">${review.views || 0}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-700 mb-2">🛠️ 액션</h4>
                                    <div class="space-y-2">
                                        <button class="edit-review-btn w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm" data-review-id="${review.id}">
                                            ✏️ 후기 수정
                                        </button>
                                        <button onclick="toggleReviewApproval('${review.id}', ${!review.approved})" class="w-full ${review.approved ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white px-4 py-2 rounded-lg text-sm">
                                            ${review.approved ? '❌ 승인 취소' : '✅ 승인하기'}
                                        </button>
                                        <button onclick="toggleReviewFeatured('${review.id}', ${!review.featured})" class="w-full ${review.featured ? 'bg-gray-500 hover:bg-gray-600' : 'bg-purple-500 hover:bg-purple-600'} text-white px-4 py-2 rounded-lg text-sm">
                                            ${review.featured ? '👁️ 노출 숨김' : '🌟 인덱스 노출'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 대표사진 표시 -->
                        ${review.photos && review.photos.length > 0 ? `
                            <div class="mt-6">
                                <h4 class="font-semibold text-gray-700 mb-2">📸 대표사진</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    ${review.photos.map(photo => `
                                        <img src="${photo}" alt="후기 사진" class="w-full h-24 object-cover rounded-lg">
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // 모달을 body에 추가
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // 후기 상세보기 모달 닫기
        function closeReviewDetailModal() {
            const modal = document.getElementById('review-detail-modal');
            if (modal) {
                modal.remove();
            }
        }

        // 후기 수정 모달 표시
        function editReviewWithModal(reviewId) {
            console.log('🔧 editReviewWithModal 함수 호출됨:', reviewId);
            console.log('📊 현재 allReviews:', allReviews);
            
            const review = allReviews.find(r => r.id === reviewId);
            console.log('🔍 찾은 후기:', review);
            
            if (!review) {
                alert('후기 정보를 찾을 수 없습니다.');
                return;
            }

            console.log('✏️ 후기 수정 모달 생성 시작:', review);

            // 기존 모달들 닫기
            closeReviewDetailModal();
            closeAddReviewModal();

            // 수정 모달 HTML 생성
            const modalHTML = `
                <div id="edit-review-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-800">✏️ 후기 수정</h3>
                            <button onclick="closeEditReviewModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        
                        <form id="edit-review-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- 왼쪽: 기본 정보 -->
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">👤 작성자 이름</label>
                                        <input type="text" id="edit-name" value="${review.name}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">나이대</label>
                                            <select id="edit-ageGroup" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                <option value="10대" ${review.ageGroup === '10대' ? 'selected' : ''}>10대</option>
                                                <option value="20대" ${review.ageGroup === '20대' ? 'selected' : ''}>20대</option>
                                                <option value="30대" ${review.ageGroup === '30대' ? 'selected' : ''}>30대</option>
                                                <option value="40대" ${review.ageGroup === '40대' ? 'selected' : ''}>40대</option>
                                                <option value="50대" ${review.ageGroup === '50대' ? 'selected' : ''}>50대</option>
                                                <option value="60대+" ${review.ageGroup === '60대+' ? 'selected' : ''}>60대+</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">직업</label>
                                            <input type="text" id="edit-occupation" value="${review.occupation}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">🛍️ 상품명</label>
                                        <input type="text" id="edit-productName" value="${review.productName}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">요청가</label>
                                            <input type="text" id="edit-originalPrice" value="${review.originalPrice}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">최종가</label>
                                            <input type="text" id="edit-finalPrice" value="${review.finalPrice}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">절약금액</label>
                                            <input type="text" id="edit-savings" value="${review.savings}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">절약률 (%)</label>
                                            <input type="number" id="edit-savingsPercent" value="${review.savingsPercent}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 오른쪽: 후기 및 상태 -->
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">⭐ 평점</label>
                                        <select id="edit-rating" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                            <option value="1" ${review.rating === 1 ? 'selected' : ''}>1점</option>
                                            <option value="2" ${review.rating === 2 ? 'selected' : ''}>2점</option>
                                            <option value="3" ${review.rating === 3 ? 'selected' : ''}>3점</option>
                                            <option value="4" ${review.rating === 4 ? 'selected' : ''}>4점</option>
                                            <option value="5" ${review.rating === 5 ? 'selected' : ''}>5점</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">📝 후기 내용</label>
                                        <textarea id="edit-review" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>${review.review}</textarea>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">🏷️ 카테고리</label>
                                        <select id="edit-category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="전자제품" ${review.category === '전자제품' ? 'selected' : ''}>전자제품</option>
                                            <option value="가전제품" ${review.category === '가전제품' ? 'selected' : ''}>가전제품</option>
                                            <option value="의류" ${review.category === '의류' ? 'selected' : ''}>의류</option>
                                            <option value="화장품" ${review.category === '화장품' ? 'selected' : ''}>화장품</option>
                                            <option value="식품" ${review.category === '식품' ? 'selected' : ''}>식품</option>
                                            <option value="기타" ${review.category === '기타' ? 'selected' : ''}>기타</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">배송지</label>
                                            <input type="text" id="edit-country" value="${review.country}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">배송기간</label>
                                            <input type="text" id="edit-shipping" value="${review.shipping}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">구매방법</label>
                                        <input type="text" id="edit-method" value="${review.method}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">뱃지</label>
                                        <input type="text" id="edit-badge" value="${review.badge}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="flex items-center">
                                            <input type="checkbox" id="edit-approved" ${review.approved ? 'checked' : ''} class="mr-2">
                                            <label for="edit-approved" class="text-sm font-medium text-gray-700">승인됨</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="edit-featured" ${review.featured ? 'checked' : ''} class="mr-2">
                                            <label for="edit-featured" class="text-sm font-medium text-gray-700">인덱스 노출</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 사진 업로드 섹션 -->
                            <div class="border-t pt-6">
                                <h4 class="text-lg font-semibold text-gray-800 mb-4">📸 대표사진</h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                    ${review.photos && review.photos.length > 0 ? review.photos.map(photo => `
                                        <div class="photo-preview relative">
                                            <img src="${photo}" alt="후기 사진" class="w-full h-24 object-cover rounded-lg">
                                            <button type="button" onclick="removePhoto(this)" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">×</button>
                                        </div>
                                    `).join('') : ''}
                                </div>
                                <input type="file" id="edit-photos" multiple accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="previewPhotos(this)">
                                <p class="text-sm text-gray-500 mt-2">여러 사진을 선택할 수 있습니다. (최대 4장)</p>
                                
                                <!-- 새 사진 미리보기 컨테이너 -->
                                <div id="photo-preview-container" class="mt-4">
                                    <!-- 새로 선택한 사진들의 미리보기가 여기에 표시됩니다 -->
                                </div>
                            </div>
                            
                            <div class="flex justify-end gap-3 pt-6 border-t">
                                <button type="button" onclick="closeEditReviewModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                    취소
                                </button>
                                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                    수정 완료
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            // 모달을 body에 추가
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            console.log('✅ 수정 모달 HTML이 body에 추가되었습니다.');
            
            // 모달이 실제로 DOM에 추가되었는지 확인
            const modalElement = document.getElementById('edit-review-modal');
            if (modalElement) {
                console.log('✅ edit-review-modal 요소가 DOM에 존재합니다.');
                console.log('📊 모달 요소:', modalElement);
                
                // 모달이 보이도록 스타일 강제 적용
                modalElement.style.display = 'flex';
                modalElement.style.position = 'fixed';
                modalElement.style.top = '0';
                modalElement.style.left = '0';
                modalElement.style.width = '100%';
                modalElement.style.height = '100%';
                modalElement.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                modalElement.style.zIndex = '9999';
                modalElement.style.alignItems = 'center';
                modalElement.style.justifyContent = 'center';
                
                console.log('✅ 모달 스타일이 강제로 적용되었습니다.');
            } else {
                console.error('❌ edit-review-modal 요소를 찾을 수 없습니다.');
                alert('모달 생성에 실패했습니다!');
            }

            // 폼 제출 이벤트 리스너 추가
            const form = document.getElementById('edit-review-form');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await updateReview(reviewId);
                });
                console.log('✅ 폼 제출 이벤트 리스너가 추가되었습니다.');
            } else {
                console.error('❌ edit-review-form을 찾을 수 없습니다.');
                alert('폼을 찾을 수 없습니다!');
            }
        }

        // 후기 수정 모달 닫기
        function closeEditReviewModal() {
            const modal = document.getElementById('edit-review-modal');
            if (modal) {
                modal.remove();
            }
        }

        // 후기 업데이트 함수
        async function updateReview(reviewId) {
            try {
                console.log('🔄 후기 업데이트 시작:', reviewId);
                
                const formData = new FormData();
                const photos = document.getElementById('edit-photos').files;
                
                // 기존 사진들 유지
                const existingPhotos = [];
                document.querySelectorAll('#edit-review-modal img[alt="후기 사진"]').forEach(img => {
                    existingPhotos.push(img.src);
                });
                
                // 새 사진들 추가
                const newPhotos = [];
                for (let i = 0; i < photos.length; i++) {
                    const file = photos[i];
                    if (file) {
                        // 실제 구현에서는 Firebase Storage에 업로드
                        // 여기서는 예시 URL 사용
                        newPhotos.push(`https://images.unsplash.com/photo-${1500000000000 + i}?auto=format&fit=crop&w=400&q=80`);
                    }
                }
                
                const allPhotos = [...existingPhotos, ...newPhotos];
                
                const reviewData = {
                    name: document.getElementById('edit-name').value,
                    ageGroup: document.getElementById('edit-ageGroup').value,
                    occupation: document.getElementById('edit-occupation').value,
                    productName: document.getElementById('edit-productName').value,
                    originalPrice: document.getElementById('edit-originalPrice').value,
                    finalPrice: document.getElementById('edit-finalPrice').value,
                    savings: document.getElementById('edit-savings').value,
                    savingsPercent: parseInt(document.getElementById('edit-savingsPercent').value),
                    rating: parseInt(document.getElementById('edit-rating').value),
                    review: document.getElementById('edit-review').value,
                    category: document.getElementById('edit-category').value,
                    country: document.getElementById('edit-country').value,
                    shipping: document.getElementById('edit-shipping').value,
                    method: document.getElementById('edit-method').value,
                    badge: document.getElementById('edit-badge').value,
                    approved: document.getElementById('edit-approved').checked,
                    featured: document.getElementById('edit-featured').checked,
                    photos: allPhotos,
                    updatedAt: new Date()
                };
                
                const { doc, updateDoc } = window.firebaseFirestoreFunctions;
                const reviewRef = doc(window.firebaseDb, 'reviews', reviewId);
                await updateDoc(reviewRef, reviewData);
                
                console.log('✅ 후기 업데이트 완료');
                alert('후기가 성공적으로 수정되었습니다!');
                closeEditReviewModal();
                
            } catch (error) {
                console.error('❌ 후기 업데이트 실패:', error);
                alert('후기 수정에 실패했습니다: ' + error.message);
            }
        }

        // 사진 제거 함수
        function removePhoto(button) {
            const photoDiv = button.closest('.photo-preview');
            if (photoDiv) {
                photoDiv.classList.add('removed');
                photoDiv.style.opacity = '0.3';
                photoDiv.style.pointerEvents = 'none';
                button.textContent = '복원';
                button.onclick = function() {
                    restorePhoto(this);
                };
            } else {
                button.parentElement.remove();
            }
        }
        
        // 사진 복원 함수
        function restorePhoto(button) {
            const photoDiv = button.closest('.photo-preview');
            if (photoDiv) {
                photoDiv.classList.remove('removed');
                photoDiv.style.opacity = '1';
                photoDiv.style.pointerEvents = 'auto';
                button.textContent = '×';
                button.onclick = function() {
                    removePhoto(this);
                };
            }
        }
        
        // 사진 미리보기 함수
        function previewPhotos(input) {
            const files = input.files;
            const previewContainer = document.getElementById('photo-preview-container');
            
            if (!previewContainer) return;
            
            // 기존 새 사진 미리보기 제거
            const existingNewPreviews = previewContainer.querySelectorAll('.new-photo-preview');
            existingNewPreviews.forEach(preview => preview.remove());
            
            // 새 사진들 미리보기 추가
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const photoDiv = document.createElement('div');
                        photoDiv.className = 'new-photo-preview relative inline-block m-2';
                        photoDiv.innerHTML = `
                            <img src="${e.target.result}" alt="새 후기 사진" class="w-24 h-24 object-cover rounded-lg border-2 border-blue-300">
                            <button type="button" onclick="removeNewPhoto(this)" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">×</button>
                        `;
                        previewContainer.appendChild(photoDiv);
                    };
                    reader.readAsDataURL(file);
                }
            }
        }
        
        // 새 사진 제거 함수
        function removeNewPhoto(button) {
            button.parentElement.remove();
        }

        // 초기 후기 데이터 생성 함수 (리뷰페이지 기본 데이터 기준)
        async function initializeReviewsData() {
            console.log('🔄 리뷰페이지 기본 데이터를 Firebase에 저장 시작...');
            
            try {
                const { collection, addDoc, serverTimestamp } = window.firebaseFirestoreFunctions;
                const reviewsRef = collection(window.firebaseDb, 'reviews');
                
                // 리뷰페이지의 기본 데이터를 Firebase에 추가
                const initialReviews = [
                    {
                        name: '최지은',
                        ageGroup: '30대',
                        occupation: '주부',
                        productName: '다이슨 V15 무선청소기',
                        originalPrice: '899,000원',
                        finalPrice: '650,000원',
                        savings: '249,000원',
                        savingsPercent: 28,
                        rating: 5,
                        review: '가전제품 저렴하게 구입! 요청가 89.9만원 → 65만원으로 절약! 믿고 구매했어요.',
                        country: '대한민국',
                        shipping: '3일',
                        method: '도매처 연동',
                        badge: '실제 구매자',
                        purchaseDate: '2024-01-28',
                        category: '가전제품',
                        photos: [
                            'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?auto=format&fit=crop&w=400&q=80',
                            'https://images.unsplash.com/photo-1581578731548-c6a0c3f2f6c5?auto=format&fit=crop&w=400&q=80'
                        ],
                        approved: true,
                        featured: true,
                        views: 0,
                        createdAt: serverTimestamp()
                    },
                    {
                        name: '김웅',
                        ageGroup: '30대',
                        occupation: '디자이너',
                        productName: 'MacBook Pro 14인치',
                        originalPrice: '2,890,000원',
                        finalPrice: '1,890,000원',
                        savings: '1,000,000원',
                        savingsPercent: 35,
                        rating: 5,
                        review: '요청가 289만원 → 189만원으로 구매! 성능도 훌륭하고 정말 만족합니다. PriceHunter 덕분에 100만원이나 절약했어요!',
                        country: '대한민국',
                        shipping: '2일',
                        method: '공장 직접구매',
                        badge: '실제 구매자',
                        purchaseDate: '2024-01-15',
                        category: '전자제품',
                        photos: [
                            'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=400&q=80',
                            'https://images.unsplash.com/photo-1541807084-5c52b6b3adef?auto=format&fit=crop&w=400&q=80'
                        ],
                        approved: true,
                        featured: true,
                        views: 0,
                        createdAt: serverTimestamp()
                    },
                    {
                        name: '정우성',
                        ageGroup: '40대',
                        occupation: '직장인',
                        productName: '로지텍 MX Master 3S',
                        originalPrice: '149,000원',
                        finalPrice: '89,000원',
                        savings: '60,000원',
                        savingsPercent: 40,
                        rating: 5,
                        review: '스마트워치 득템! 요청가 14.9만원 → 8.9만원으로 절약! 기능도 많고 저렴!',
                        country: '대한민국',
                        shipping: '2일',
                        method: '공장 직접구매',
                        badge: '실제 구매자',
                        purchaseDate: '2024-02-01',
                        profileImage: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?auto=format&fit=crop&w=600&q=80',
                        category: '전자제품',
                        photos: [
                            'https://images.unsplash.com/photo-1527864550417-7fd91fc51a46?auto=format&fit=crop&w=400&q=80',
                            'https://images.unsplash.com/photo-1551698618-1dfe5d97d256?auto=format&fit=crop&w=400&q=80'
                        ],
                        approved: true,
                        featured: true,
                        views: 0,
                        createdAt: serverTimestamp()
                    },
                    {
                        name: '이철수',
                        ageGroup: '40대',
                        occupation: '자영업자',
                        productName: '삼성 갤럭시 S24 Ultra',
                        originalPrice: '1,650,000원',
                        finalPrice: '1,200,000원',
                        savings: '450,000원',
                        savingsPercent: 27,
                        rating: 5,
                        review: '사무용품 대량구매 성공! 요청가 165만원 → 120만원으로 절약! 빠른 배송, 저렴한 가격!',
                        country: '대한민국',
                        shipping: '2일',
                        method: '공장 직접구매',
                        badge: '사업자 대량구매',
                        purchaseDate: '2024-01-20',
                        category: '전자제품',
                        photos: [
                            'https://images.unsplash.com/photo-1544244015-0df4b3ffc6b0?auto=format&fit=crop&w=400&q=80',
                            'https://images.unsplash.com/photo-1561154464-82e9adf32764?auto=format&fit=crop&w=400&q=80'
                        ],
                        approved: true,
                        featured: true,
                        views: 0,
                        createdAt: serverTimestamp()
                    },
                    {
                        name: '박민수',
                        ageGroup: '20대',
                        occupation: '대학생',
                        productName: 'iPad Air 5세대',
                        originalPrice: '899,000원',
                        finalPrice: '650,000원',
                        savings: '249,000원',
                        savingsPercent: 28,
                        rating: 5,
                        review: '태블릿을 싸게 샀어요! 요청가 89.9만원 → 65만원으로 구매! 학생 할인까지 받아서 굿!',
                        country: '대한민국',
                        shipping: '4일',
                        method: '공장 직접구매',
                        badge: '실제 구매자',
                        purchaseDate: '2024-01-25',
                        category: '전자제품',
                        photos: [
                            'https://images.unsplash.com/photo-1544244015-0df4b3ffc6b0?auto=format&fit=crop&w=400&q=80',
                            'https://images.unsplash.com/photo-1561154464-82e9adf32764?auto=format&fit=crop&w=400&q=80'
                        ],
                        approved: true,
                        featured: true,
                        views: 0,
                        createdAt: serverTimestamp()
                    }
                ];
                
                // Firebase에 후기 데이터 추가
                for (const review of initialReviews) {
                    await addDoc(reviewsRef, review);
                    console.log('✅ 후기 데이터 추가:', review.name);
                }
                
                console.log('🎉 리뷰페이지 기본 데이터 Firebase 저장 완료!');
                alert('리뷰페이지 기본 데이터가 Firebase에 저장되었습니다. 페이지를 새로고침해주세요.');
                
            } catch (error) {
                console.error('❌ 리뷰페이지 기본 데이터 저장 실패:', error);
                alert('리뷰페이지 기본 데이터 저장에 실패했습니다: ' + error.message);
            }
        }

        // 후기 테이블 표시
        function displayReviewsTable() {
            console.log('📊 후기 테이블 표시 시작:', {
                allReviews: allReviews.length,
                filteredReviews: filteredReviews.length,
                tbody: !!document.getElementById('reviews-table-body')
            });

            const tbody = document.getElementById('reviews-table-body');
            if (!tbody) {
                console.error('❌ reviews-table-body 요소를 찾을 수 없습니다.');
                return;
            }

            if (filteredReviews.length === 0) {
                console.log('📝 후기 데이터가 없어서 빈 테이블 표시');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                            후기가 없습니다. 
                            <button onclick="initializeReviewsData()" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                초기 데이터 생성
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }

            console.log('✅ 후기 테이블 렌더링:', filteredReviews.length, '개');

            tbody.innerHTML = filteredReviews.map(review => {
                const statusBadge = getStatusBadge(review);
                const stars = '★'.repeat(review.rating || 5) + '☆'.repeat(5 - (review.rating || 5));
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
                                <span class="text-gray-600 font-medium">${review.name.charAt(0)}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${review.name}</div>
                            <div class="text-sm text-gray-500">${review.ageGroup} • ${review.occupation}</div>
                            ${review.requestData ? `<div class="text-xs text-blue-600">의뢰건: ${review.requestData.productName}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${review.productName}</div>
                            <div class="text-sm text-gray-500">${review.category}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-red-600">${review.savings}</div>
                            <div class="text-sm text-gray-500">${review.savingsPercent}%</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-yellow-500">${stars}</div>
                            <div class="text-sm text-gray-500">${review.rating || 5}/5</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex flex-col space-y-1">
                                ${statusBadge}
                                <span class="px-2 py-1 rounded-full text-xs ${review.featured ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                                    ${review.featured ? '인덱스 노출' : '숨김'}
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formatDate(review.createdAt || review.purchaseDate)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="viewReviewDetails('${review.id}')" class="text-blue-600 hover:text-blue-900">보기</button>
                                <button class="edit-review-btn text-green-600 hover:text-green-900" data-review-id="${review.id}">수정</button>
                                <button onclick="toggleReviewApproval('${review.id}', ${!review.approved})" class="text-purple-600 hover:text-purple-900">
                                    ${review.approved ? '승인취소' : '승인'}
                                </button>
                                <button onclick="toggleReviewFeatured('${review.id}', ${!review.featured})" class="text-orange-600 hover:text-orange-900">
                                    ${review.featured ? '노출취소' : '노출'}
                                </button>
                                <button onclick="deleteReview('${review.id}')" class="text-red-600 hover:text-red-900">삭제</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // 수정 버튼 이벤트 리스너 추가
            setTimeout(() => {
                const editButtons = document.querySelectorAll('.edit-review-btn');
                console.log('🔍 수정 버튼 개수:', editButtons.length);
                
                editButtons.forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        const reviewId = this.getAttribute('data-review-id');
                        console.log('🔧 수정 버튼 클릭됨! ID:', reviewId);
                        alert('수정 버튼이 클릭되었습니다! ID: ' + reviewId);
                        
                        if (reviewId && window.editReview) {
                            console.log('🔧 window.editReview 함수 호출 시도...');
                            try {
                                window.editReview(reviewId);
                                console.log('✅ window.editReview 함수 호출 완료');
                            } catch (error) {
                                console.error('❌ window.editReview 함수 호출 중 오류:', error);
                                alert('editReview 함수 호출 중 오류가 발생했습니다: ' + error.message);
                            }
                        } else {
                            console.error('❌ reviewId 또는 editReview 함수가 없습니다:', { reviewId, editReview: typeof window.editReview });
                            alert('editReview 함수를 찾을 수 없습니다!');
                        }
                    });
                });
                
                console.log('✅ 수정 버튼 이벤트 리스너가 추가되었습니다.');
            }, 100);
        }

        // 상태 배지 생성
        function getStatusBadge(review) {
            if (review.approved === true) {
                return '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">승인됨</span>';
            } else if (review.rejected === true) {
                return '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">거부됨</span>';
            } else {
                return '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">대기 중</span>';
            }
        }

        // 날짜 포맷팅 (단순화)
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            const y = date.getFullYear();
            const m = String(date.getMonth()+1).padStart(2,'0');
            const day = String(date.getDate()).padStart(2,'0');
            const h = String(date.getHours()).padStart(2,'0');
            const min = String(date.getMinutes()).padStart(2,'0');
            return `${y}-${m}-${day} ${h}:${min}`;
        }

        // 후기 상세보기
        function viewReviewDetails(reviewId) {
            const review = allReviews.find(r => r.id === reviewId);
            if (!review) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto relative">
                    <button onclick="this.closest('.fixed').remove()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">⭐ 후기 상세정보</h2>
                    
                    <div class="space-y-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center">
                                <span class="text-gray-600 font-medium text-xl">${review.name.charAt(0)}</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">${review.name}</h3>
                                <p class="text-gray-500">${review.ageGroup} • ${review.occupation}</p>
                                <div class="flex items-center text-yellow-500">
                                    ${'★'.repeat(review.rating || 5)}${'☆'.repeat(5 - (review.rating || 5))}
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-900 mb-2">${review.productName}</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">원가:</span>
                                    <span class="line-through">${review.originalPrice}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">구매가:</span>
                                    <span class="font-semibold text-green-600">${review.finalPrice}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">절약:</span>
                                    <span class="font-semibold text-red-600">${review.savings}</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">절약율:</span>
                                    <span class="font-semibold text-red-600">${review.savingsPercent}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">후기 내용</h4>
                            <p class="text-gray-700 bg-gray-50 rounded-lg p-4">${review.review}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">카테고리:</span>
                                <span class="font-semibold">${review.category}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">구매일:</span>
                                <span class="font-semibold">${formatDate(review.purchaseDate)}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">배송:</span>
                                <span class="font-semibold">${review.shipping}</span>
                            </div>
                            <div>
                                <span class="text-gray-600">구매방법:</span>
                                <span class="font-semibold">${review.method}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end gap-3">
                        <button onclick="showReviewDetail('${review.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
                            📖 상세보기
                        </button>
                        <button class="edit-review-btn px-4 py-2 bg-yellow-600 text-white rounded-lg font-semibold hover:bg-yellow-700 transition" data-review-id="${review.id}">
                            ✏️ 수정
                        </button>
                        <button onclick="approveReview('${review.id}')" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
                            ✅ 승인
                        </button>
                        <button onclick="rejectReview('${review.id}')" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition">
                            ❌ 거부
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition">
                            닫기
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 후기 승인
        async function approveReview(reviewId) {
            try {
                const { doc, updateDoc, serverTimestamp } = window.firebaseFirestoreFunctions;
                const reviewRef = doc(window.firebaseDb, 'reviews', reviewId);
                await updateDoc(reviewRef, {
                    approved: true,
                    approvedAt: serverTimestamp(),
                    approvedBy: 'admin',
                    rejected: false,
                    updatedAt: serverTimestamp()
                });
                
                alert('후기가 승인되었습니다. 메인페이지와 리뷰페이지에 실시간으로 반영됩니다.');
                // loadReviewsData(); // 실시간 리스너가 자동으로 업데이트
                
            } catch (error) {
                console.error('후기 승인 실패:', error);
                alert('후기 승인에 실패했습니다: ' + error.message);
            }
        }

        // 후기 거부
        async function rejectReview(reviewId) {
            try {
                const { doc, updateDoc, serverTimestamp } = window.firebaseFirestoreFunctions;
                const reviewRef = doc(window.firebaseDb, 'reviews', reviewId);
                await updateDoc(reviewRef, {
                    approved: false,
                    rejected: true,
                    rejectedAt: serverTimestamp(),
                    rejectedBy: 'admin',
                    updatedAt: serverTimestamp()
                });
                
                alert('후기가 거부되었습니다.');
                // loadReviewsData(); // 실시간 리스너가 자동으로 업데이트
                
            } catch (error) {
                console.error('후기 거부 실패:', error);
                alert('후기 거부에 실패했습니다: ' + error.message);
            }
        }

        // 후기 삭제
        async function deleteReview(reviewId) {
            if (!confirm('정말로 이 후기를 삭제하시겠습니까?')) return;
            
            try {
                const { doc, deleteDoc } = window.firebaseFirestoreFunctions;
                const reviewRef = doc(window.firebaseDb, 'reviews', reviewId);
                await deleteDoc(reviewRef);
                
                alert('후기가 삭제되었습니다.');
                // loadReviewsData(); // 실시간 리스너가 자동으로 업데이트
                
            } catch (error) {
                console.error('후기 삭제 실패:', error);
                alert('후기 삭제에 실패했습니다: ' + error.message);
            }
        }

        // 새 후기 추가
        function addNewReview() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto relative">
                    <button onclick="this.closest('.fixed').remove()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">➕ 새 후기 추가</h2>
                    
                    <form id="new-review-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">작성자명</label>
                                <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">연령대</label>
                                <select name="ageGroup" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">선택하세요</option>
                                    <option value="10대">10대</option>
                                    <option value="20대">20대</option>
                                    <option value="30대">30대</option>
                                    <option value="40대">40대</option>
                                    <option value="50대">50대</option>
                                    <option value="60대">60대</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">직업</label>
                                <input type="text" name="occupation" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">상품명</label>
                                <input type="text" name="productName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">카테고리</label>
                                <select name="category" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">선택하세요</option>
                                    <option value="전자제품">전자제품</option>
                                    <option value="의류">의류</option>
                                    <option value="화장품">화장품</option>
                                    <option value="생활용품">생활용품</option>
                                    <option value="식품">식품</option>
                                    <option value="기타">기타</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">별점</label>
                                <select name="rating" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="5">5점</option>
                                    <option value="4">4점</option>
                                    <option value="3">3점</option>
                                    <option value="2">2점</option>
                                    <option value="1">1점</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">원가</label>
                                <input type="text" name="originalPrice" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">구매가</label>
                                <input type="text" name="finalPrice" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">절약금액</label>
                                <input type="text" name="savings" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">후기 내용</label>
                            <textarea name="review" required rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        
                        <div class="flex justify-end gap-3">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition">
                                취소
                            </button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
                                추가
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 폼 제출 이벤트
            document.getElementById('new-review-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const reviewData = Object.fromEntries(formData);
                
                try {
                    const { collection, addDoc, serverTimestamp } = window.firebaseFirestoreFunctions;
                    const reviewsRef = collection(window.firebaseDb, 'reviews');
                    
                    await addDoc(reviewsRef, {
                        ...reviewData,
                        savingsPercent: Math.round((parseInt(reviewData.savings.replace(/[^0-9]/g, '')) / parseInt(reviewData.originalPrice.replace(/[^0-9]/g, ''))) * 100),
                        approved: true,
                        rejected: false,
                        country: '대한민국',
                        shipping: '2일',
                        method: '공장 직접구매',
                        badge: '실제 구매자',
                        stars: parseInt(reviewData.rating),
                        views: 0,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    
                    alert('새 후기가 추가되었습니다. 메인페이지와 리뷰페이지에 실시간으로 반영됩니다.');
                    modal.remove();
                    // loadReviewsData(); // 실시간 리스너가 자동으로 업데이트
                    
                } catch (error) {
                    console.error('후기 추가 실패:', error);
                    alert('후기 추가에 실패했습니다: ' + error.message);
                }
            });
        }

        // 전역 함수로 노출
        window.switchSection = switchSection;
        window.viewUserDetails = viewUserDetails;
        window.deleteUser = deleteUser;
        window.loadReviewsData = loadReviewsData;
        window.viewReviewDetails = viewReviewDetails;
        window.approveReview = approveReview;
        window.rejectReview = rejectReview;
        window.deleteReview = deleteReview;
        window.addNewReview = addNewReview;
        // 새로운 editReview 함수를 전역으로 등록 (모달 방식)
        (function() {
            window.editReview = function(reviewId) {
                console.log('🔧 editReview 함수 호출됨:', { reviewId, allReviewsLength: allReviews.length });
                console.log('📊 현재 allReviews:', allReviews);
                console.log('🔍 window.editReview 함수 등록 확인:', typeof window.editReview);
                
                // 함수 호출 확인을 위한 강력한 알림
                alert('editReview 함수가 호출되었습니다! ID: ' + reviewId);
                console.log('✅ 수정 버튼이 클릭되었습니다! ID: ' + reviewId);
                
                if (reviewId) {
                    // reviewId가 있으면 새로운 모달 방식 사용
                    const review = allReviews.find(r => r.id === reviewId);
                    console.log('🔍 찾은 후기:', review);
                    
                    if (!review) {
                        alert('후기 정보를 찾을 수 없습니다. ID: ' + reviewId);
                        console.error('❌ 후기를 찾을 수 없음:', reviewId);
                        return;
                    }
                    console.log('✅ 모달 방식으로 후기 수정 시작');
                    alert('editReviewWithModal 함수를 호출합니다!');
                    try {
                        editReviewWithModal(reviewId);
                        console.log('✅ editReviewWithModal 함수 호출 완료');
                    } catch (error) {
                        console.error('❌ editReviewWithModal 함수 호출 중 오류:', error);
                        alert('editReviewWithModal 함수 호출 중 오류: ' + error.message);
                    }
                } else {
                    // reviewId가 없으면 경고 메시지 표시
                    console.log('📝 reviewId가 없음');
                    alert('수정할 후기를 선택해주세요.');
                }
            };
            
            // 함수 등록 즉시 확인
            console.log('✅ editReview 함수 등록 완료:', typeof window.editReview);
        })();
        
        // 후기 수정 모달 관련 함수들을 전역으로 등록
        (function() {
            window.editReviewWithModal = editReviewWithModal;
            window.closeEditReviewModal = closeEditReviewModal;
            window.updateReview = updateReview;
            window.removePhoto = removePhoto;
            window.restorePhoto = restorePhoto;
            window.previewPhotos = previewPhotos;
            window.removeNewPhoto = removeNewPhoto;
            
            // 함수 등록 즉시 확인
            console.log('✅ 후기 수정 관련 함수들 등록 완료:');
            console.log('- editReviewWithModal:', typeof window.editReviewWithModal);
            console.log('- closeEditReviewModal:', typeof window.closeEditReviewModal);
            console.log('- updateReview:', typeof window.updateReview);
            console.log('- removePhoto:', typeof window.removePhoto);
        })();

        // 테스트 함수 추가
        window.testEditReview = function() {
            console.log('🧪 테스트 함수 호출됨');
            console.log('🔍 window.editReview 함수 존재 여부:', typeof window.editReview);
            console.log('🔍 allReviews 길이:', allReviews.length);
            
            if (allReviews.length > 0) {
                const firstReviewId = allReviews[0].id;
                console.log('🧪 첫 번째 후기 ID로 테스트:', firstReviewId);
                window.editReview(firstReviewId);
            } else {
                alert('테스트할 후기가 없습니다. 먼저 후기 데이터를 로드해주세요.');
            }
        };
        
        // 간단한 테스트 함수
        window.testSimpleAlert = function() {
            alert('간단한 테스트 버튼이 작동합니다!');
            console.log('✅ 간단한 테스트 함수가 호출되었습니다.');
        };
        
        // 간단한 모달 테스트 함수
        window.testSimpleModal = function() {
            console.log('🧪 간단한 모달 테스트 시작');
            
            // 기존 모달 제거
            const existingModal = document.getElementById('test-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 간단한 모달 생성
            const modalHTML = `
                <div id="test-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 20px; border-radius: 10px; max-width: 500px; width: 90%;">
                        <h2 style="margin-bottom: 20px;">🧪 간단한 모달 테스트</h2>
                        <p>이 모달이 보인다면 모달 생성 기능은 정상입니다!</p>
                        <button onclick="document.getElementById('test-modal').remove()" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            닫기
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            console.log('✅ 간단한 모달이 생성되었습니다.');
        };

        // Firebase에서 후기 업데이트
        async function updateReviewInFirebase(review) {
            try {
                const { doc, updateDoc } = window.firebaseFirestoreFunctions;
                const reviewRef = doc(window.firebaseDb, 'reviews', review.id);
                
                await updateDoc(reviewRef, {
                    name: review.name,
                    productName: review.productName,
                    originalPrice: review.originalPrice,
                    finalPrice: review.finalPrice,
                    savings: review.savings,
                    rating: review.rating,
                    review: review.review,
                    approved: review.approved,
                    updatedAt: new Date()
                });
                
                alert('후기가 성공적으로 수정되었습니다! 메인페이지와 리뷰페이지에 실시간으로 반영됩니다.');
                // loadReviewsData(); // 실시간 리스너가 자동으로 업데이트
                
            } catch (error) {
                console.error('후기 수정 실패:', error);
                alert('후기 수정에 실패했습니다: ' + error.message);
            }
        }
        
        // 초기 후기 데이터 생성 함수 (init-reviews-data.js에서 가져옴)
        window.initializeReviewsData = async function() {
            try {
                console.log('🚀 후기 데이터 초기화 시작...');
                
                if (!window.firebaseDb) {
                    throw new Error('Firebase가 초기화되지 않았습니다.');
                }

                // Firebase 초기화 대기
                await waitForFirebase();
                
                const { collection, addDoc, serverTimestamp } = window.firebaseFirestoreFunctions;
                const reviewsRef = collection(window.firebaseDb, 'reviews');
                
                const initialReviewsData = [
                    {
                        name: "김영희",
                        ageGroup: "30대",
                        occupation: "디자이너",
                        profileImage: "https://images.unsplash.com/photo-1494790108755-2616b612b786?auto=format&fit=crop&w=100&q=80",
                        productName: "MacBook Pro 14인치",
                        category: "전자제품",
                        brand: "Apple",
                        originalPrice: "2,890,000원",
                        finalPrice: "1,890,000원",
                        savings: "1,000,000원",
                        savingsPercent: 35,
                        rating: 5,
                        review: "요청가 289만원 → 189만원으로 구매! 성능도 훌륭하고 정말 만족합니다. PriceHunter 덕분에 100만원이나 절약했어요!",
                        purchaseDate: "2024-01-15",
                        country: "대한민국",
                        shipping: "2일",
                        method: "공장 직접구매",
                        badge: "실제 구매자",
                        stars: 5,
                        approved: true,
                        views: 1250
                    },
                    {
                        name: "이철수",
                        ageGroup: "40대",
                        occupation: "자영업자",
                        profileImage: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?auto=format&fit=crop&w=100&q=80",
                        productName: "삼성 갤럭시 S24 Ultra",
                        category: "전자제품",
                        brand: "Samsung",
                        originalPrice: "1,650,000원",
                        finalPrice: "1,200,000원",
                        savings: "450,000원",
                        savingsPercent: 27,
                        rating: 5,
                        review: "사무용품 대량구매 성공! 요청가 165만원 → 120만원으로 절약! 빠른 배송, 저렴한 가격!",
                        purchaseDate: "2024-01-20",
                        country: "대한민국",
                        shipping: "2일",
                        method: "공장 직접구매",
                        badge: "사업자 대량구매",
                        stars: 5,
                        approved: true,
                        views: 980
                    },
                    {
                        name: "박민수",
                        ageGroup: "20대",
                        occupation: "대학생",
                        profileImage: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?auto=format&fit=crop&w=100&q=80",
                        productName: "iPad Air 5세대",
                        category: "전자제품",
                        brand: "Apple",
                        originalPrice: "899,000원",
                        finalPrice: "650,000원",
                        savings: "249,000원",
                        savingsPercent: 28,
                        rating: 5,
                        review: "태블릿을 싸게 샀어요! 요청가 89.9만원 → 65만원으로 구매! 학생 할인까지 받아서 굿!",
                        purchaseDate: "2024-01-25",
                        country: "대한민국",
                        shipping: "4일",
                        method: "공장 직접구매",
                        badge: "실제 구매자",
                        stars: 4.8,
                        approved: true,
                        views: 756
                    },
                    {
                        name: "최지은",
                        ageGroup: "30대",
                        occupation: "주부",
                        productName: "다이슨 V15 무선청소기",
                        category: "생활용품",
                        brand: "Dyson",
                        originalPrice: "899,000원",
                        finalPrice: "650,000원",
                        savings: "249,000원",
                        savingsPercent: 28,
                        rating: 5,
                        review: "가전제품 저렴하게 구입! 요청가 89.9만원 → 65만원으로 절약! 믿고 구매했어요.",
                        purchaseDate: "2024-01-28",
                        country: "대한민국",
                        shipping: "3일",
                        method: "도매처 연동",
                        badge: "실제 구매자",
                        stars: 5,
                        approved: true,
                        views: 892
                    },
                    {
                        name: "정우성",
                        ageGroup: "40대",
                        occupation: "직장인",
                        profileImage: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?auto=format&fit=crop&w=100&q=80",
                        productName: "로지텍 MX Master 3S",
                        category: "전자제품",
                        brand: "Logitech",
                        originalPrice: "149,000원",
                        finalPrice: "89,000원",
                        savings: "60,000원",
                        savingsPercent: 40,
                        rating: 5,
                        review: "스마트워치 득템! 요청가 14.9만원 → 8.9만원으로 절약! 기능도 많고 저렴!",
                        purchaseDate: "2024-02-01",
                        country: "대한민국",
                        shipping: "2일",
                        method: "공장 직접구매",
                        badge: "실제 구매자",
                        stars: 4.7,
                        approved: true,
                        views: 634
                    }
                ];
                
                let successCount = 0;
                
                for (const reviewData of initialReviewsData) {
                    try {
                        const docData = {
                            ...reviewData,
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        };
                        
                        await addDoc(reviewsRef, docData);
                        successCount++;
                        console.log(`✅ 후기 추가 완료: ${reviewData.name} - ${reviewData.productName}`);
                        
                    } catch (error) {
                        console.error(`❌ 후기 추가 실패: ${reviewData.name}`, error);
                    }
                }
                
                console.log(`🎉 후기 데이터 초기화 완료! 총 ${successCount}개 후기 추가됨`);
                alert(`후기 데이터 초기화가 완료되었습니다!\n총 ${successCount}개의 후기가 추가되었습니다.`);
                
                // 후기 데이터 새로고침 (실시간 리스너가 자동으로 업데이트하지만 확실히 하기 위해)
                setTimeout(() => {
                    if (typeof loadReviewsData === 'function') {
                        console.log('🔄 후기 데이터 새로고침 시작...');
                        loadReviewsData();
                    }
                }, 1000);
                
                return successCount;
                
            } catch (error) {
                console.error('❌ 후기 데이터 초기화 실패:', error);
                alert('후기 데이터 초기화에 실패했습니다: ' + error.message);
                return 0;
            }
        };
        
        console.log('🚀 관리자 대시보드 스크립트 로드 완료');
    </script>
    
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; }
        .sidebar-item.active { background-color: #ec4899; color: white; }
        .tab-btn.active { background-color: #ec4899; color: white; }
        .filter-btn.active { background-color: #6b7280; color: white; }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 via-blue-50 to-emerald-50 min-h-screen">
    <!-- 로그인 섹션 -->
    <div id="login-section" class="min-h-screen flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-4 sm:p-6 md:p-8 w-full max-w-xs sm:max-w-sm md:max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-pink-600">PriceHunter</h1>
                <p class="text-gray-600">관리자 로그인</p>
            </div>
            
            <form onsubmit="event.preventDefault(); adminLogin();" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">이메일</label>
                    <input type="email" id="admin-email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:outline-none" placeholder="admin@pricehunter.com">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">비밀번호</label>
                    <input type="password" id="admin-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:outline-none" placeholder="비밀번호">
                </div>
                
                <button type="submit" class="w-full bg-gradient-to-r from-pink-500 to-purple-500 text-white font-bold py-3 px-4 rounded-lg hover:from-pink-600 hover:to-purple-600 transition shadow-lg">
                    🔐 로그인
                </button>
            </form>
            
            <div class="mt-6 text-center space-y-3">
                <button onclick="goToPage('index.html')" class="text-pink-600 hover:text-pink-700 text-sm block w-full">
                    🏠 메인페이지로 돌아가기
                </button>
                <button onclick="createAdminAccount()" class="text-blue-600 hover:text-blue-700 text-sm block w-full">
                    🔧 테스트 관리자 계정 생성
                </button>
                <div class="text-xs text-gray-500 mt-2">
                    테스트용 계정: admin@pricehunter.com / admin1234
                </div>
            </div>
        </div>
    </div>

    <!-- 대시보드 섹션 -->
    <div id="dashboard-section" class="hidden">
        <div class="flex h-screen">
            <!-- 사이드바 -->
            <div class="w-64 bg-white shadow-lg">
                <div class="p-6 border-b">
                    <h1 class="text-xl font-bold text-pink-600">PriceHunter</h1>
                    <p class="text-sm text-gray-500">관리자 대시보드</p>
                    <p id="admin-info" class="text-xs text-gray-400 mt-1"></p>
                </div>
                
                <nav class="p-4">
                    <div class="space-y-2">
                        <button class="sidebar-item w-full text-left px-4 py-3 rounded-lg font-semibold hover:bg-pink-50 transition active" data-section="dashboard" onclick="switchSection('dashboard')">
                            📊 대시보드
                        </button>
                        <button class="sidebar-item w-full text-left px-4 py-3 rounded-lg font-semibold hover:bg-pink-50 transition" data-section="requests" onclick="switchSection('requests')">
                            📋 의뢰 관리
                        </button>
                        <button class="sidebar-item w-full text-left px-4 py-3 rounded-lg font-semibold hover:bg-pink-50 transition" data-section="inquiries" onclick="switchSection('inquiries')">
                            💬 1:1 문의
                        </button>
                        <button class="sidebar-item w-full text-left px-4 py-3 rounded-lg font-semibold hover:bg-pink-50 transition" data-section="members" onclick="switchSection('members')">
                            👥 회원 관리
                        </button>
                        <button class="sidebar-item w-full text-left px-4 py-3 rounded-lg font-semibold hover:bg-pink-50 transition" data-section="reviews" onclick="switchSection('reviews')">
                            ⭐ 후기 관리
                        </button>
                        <button class="sidebar-item w-full text-left px-4 py-3 rounded-lg font-semibold hover:bg-pink-50 transition" data-section="savings-king" onclick="switchSection('savings-king')">
                            🏆 절약왕 관리
                        </button>
                    </div>
                </nav>
                
                <div class="absolute bottom-4 left-4 right-4">
                    <button onclick="adminLogout()" class="w-full px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition">
                        🔓 로그아웃
                    </button>
                </div>
            </div>

            <!-- 메인 콘텐츠 -->
            <div class="flex-1 overflow-auto">
                <!-- 대시보드 섹션 -->
                <div id="dashboard-content" class="section-content p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">📊 대시보드</h2>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="goToPage('index.html')" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition">
                                🏠 메인페이지로
                            </button>
                            <button onclick="goToPage('member-dashboard.html')" class="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition">
                                👤 회원대시보드로
                            </button>
                            <button onclick="testFirebaseConnection()" class="px-4 py-2 bg-purple-500 text-white rounded-lg font-semibold hover:bg-purple-600 transition">
                                🔥 Firebase 연결 테스트
                            </button>
                            <button onclick="checkFirebaseUsers()" class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition">
                                🔍 Firebase 사용자 확인
                            </button>
                            <button onclick="cleanupDuplicateUsers()" class="px-4 py-2 bg-pink-500 text-white rounded-lg font-semibold hover:bg-pink-600 transition">
                                🧹 중복 사용자 정리
                            </button>
                            <button onclick="checkCSPHeaders()" class="px-4 py-2 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600 transition">
                                🔍 CSP 헤더 확인
                            </button>
                            <button onclick="clearCacheAndReload()" class="px-4 py-2 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 transition">
                                🧹 캐시 정리 & 새로고침
                            </button>
                        </div>
                    </div>
                    
                    <!-- 통계 카드 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-lg">
                                    <span class="text-2xl">📋</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-500">총 의뢰</p>
                                    <p class="text-2xl font-bold text-gray-800" id="total-requests">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-lg">
                                    <span class="text-2xl">✅</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-500">완료된 의뢰</p>
                                    <p class="text-2xl font-bold text-gray-800" id="completed-requests">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-orange-100 rounded-lg">
                                    <span class="text-2xl">👥</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-500">총 회원</p>
                                    <p class="text-2xl font-bold text-gray-800" id="total-members">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-purple-100 rounded-lg">
                                    <span class="text-2xl">💬</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-500">총 문의</p>
                                    <p class="text-2xl font-bold text-gray-800" id="total-inquiries">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-red-100 rounded-lg">
                                    <span class="text-2xl">⏰</span>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-500">미답변 문의</p>
                                    <p class="text-2xl font-bold text-gray-800" id="unanswered-inquiries">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 최근 활동 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">최근 의뢰</h3>
                            <div id="recent-requests" class="space-y-3">
                                <!-- 동적으로 생성됨 -->
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">최근 문의</h3>
                            <div id="recent-inquiries" class="space-y-3">
                                <!-- 동적으로 생성됨 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 의뢰 관리 섹션 -->
                <div id="requests-section" class="section-content p-8 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">📋 의뢰 관리</h2>
                        <div class="flex gap-2">
                            <button onclick="deleteSelectedRequests()" class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition">
                                🗑️ 선택 삭제
                            </button>
                            <button onclick="goToPage('index.html')" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition">
                                🏠 메인페이지로
                            </button>
                            <button onclick="goToPage('request.html')" class="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition">
                                📝 의뢰페이지로
                            </button>
                        </div>
                    </div>
                    
                    <!-- 의뢰 목록 -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="font-bold text-gray-700 p-4 border-b">접수된 의뢰 목록</div>
                        <div class="grid grid-cols-8 gap-2 px-4 py-2 bg-pink-100 text-sm font-bold text-pink-700">
                            <div class="col-span-1">선택</div>
                            <div class="col-span-2">의뢰번호/회원명</div>
                            <div class="col-span-1 text-center">의뢰일시</div>
                            <div class="col-span-1 text-center">진행상황</div>
                            <div class="col-span-1 text-center">구매방식</div>
                            <div class="col-span-1 text-center">구매상태</div>
                            <div class="col-span-1 text-center">알림상태</div>
                        </div>
                        <ul id="request-list" class="bg-pink-50 divide-y divide-pink-100">
                            <!-- 동적으로 생성됨 -->
                        </ul>
                    </div>
                    
                    <!-- 의뢰 상세 및 결과 입력 -->
                    <div id="detail-section" class="w-full hidden mt-6">
                        <div class="bg-white rounded-xl shadow-lg p-6 mb-4">
                            <div class="mb-2 text-gray-700 font-bold">의뢰 상세</div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><span class="font-semibold">의뢰번호:</span> <span id="detail-num"></span></div>
                                <div><span class="font-semibold">제품명:</span> <span id="detail-name"></span></div>
                                <div><span class="font-semibold">제품설명:</span> <span id="detail-desc"></span></div>
                                <div><span class="font-semibold">참고사이트:</span> <span id="detail-url"></span></div>
                                <div><span class="font-semibold">가격:</span> <span id="detail-price"></span></div>
                                <div><span class="font-semibold">이름:</span> <span id="detail-username"></span></div>
                                <div><span class="font-semibold">이메일:</span> <span id="detail-email"></span></div>
                                <div><span class="font-semibold">휴대폰:</span> <span id="detail-phone"></span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 1:1 문의 섹션 -->
                <div id="inquiries-section" class="section-content p-8 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">💬 1:1 문의 관리</h2>
                        <div class="flex gap-2">
                            <button onclick="deleteSelectedInquiries()" class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition">
                                🗑️ 선택 삭제
                            </button>
                            <button onclick="goToPage('index.html')" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition">
                                🏠 메인페이지로
                            </button>
                            <button onclick="goToPage('support.html')" class="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition">
                                💬 문의페이지로
                            </button>
                        </div>
                    </div>
                    
                    <!-- 문의 목록 -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-blue-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">문의번호</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">회원명</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">제목</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">상태</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">등록일시</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider">작업</th>
                                    </tr>
                                </thead>
                                <tbody id="inquiries-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- 동적으로 생성됨 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 문의 상세 및 답변 -->
                    <div id="inquiry-detail-section" class="w-full hidden mt-6">
                        <div class="bg-white rounded-xl shadow-lg p-6 mb-4">
                            <div class="mb-4">
                                <h3 class="text-lg font-bold text-gray-800 mb-2">문의 상세</h3>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div><span class="font-semibold">문의번호:</span> <span id="inquiry-id"></span></div>
                                    <div><span class="font-semibold">제목:</span> <span id="inquiry-title"></span></div>
                                    <div><span class="font-semibold">회원명:</span> <span id="inquiry-username"></span></div>
                                    <div><span class="font-semibold">이메일:</span> <span id="inquiry-email"></span></div>
                                    <div><span class="font-semibold">전화번호:</span> <span id="inquiry-phone"></span></div>
                                    <div><span class="font-semibold">문의일시:</span> <span id="inquiry-date"></span></div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h4 class="font-semibold text-gray-700 mb-2">문의 내용</h4>
                                <div id="inquiry-content" class="bg-gray-50 p-4 rounded-lg text-gray-700"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 회원 관리 섹션 -->
                <div id="members-section" class="section-content p-8 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">👥 회원 관리</h2>
                        <div class="flex gap-2">
                            <button onclick="cleanupDuplicateUsers().then(count => { alert(`중복 사용자 ${count}명이 정리되었습니다.`); setTimeout(() => subscribeToUsers(), 1000); })" class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition">
                                🧹 중복 사용자 정리
                            </button>
                            <button onclick="deleteSpecificUser('email_etgbajy_gmail_com').then(() => recreateCorrectUser())" class="px-4 py-2 bg-purple-500 text-white rounded-lg font-semibold hover:bg-purple-600 transition">
                                🗑️ 잘못된 문서 삭제 후 올바른 문서 생성
                            </button>
                            <button onclick="loadLocalStorageUsers()" class="px-4 py-2 bg-orange-500 text-white rounded-lg font-semibold hover:bg-orange-600 transition">
                                🔄 localStorage 새로고침
                            </button>
                            <button onclick="goToPage('index.html')" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition">
                                🏠 메인페이지로
                            </button>
                            <button onclick="goToPage('member-dashboard.html')" class="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition">
                                👤 회원대시보드로
                            </button>
                        </div>
                    </div>
                    
                    <!-- 회원 통계 -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📊 회원 통계</h3>
                        <div id="member-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div class="text-center">
                                <div class="font-bold text-lg text-blue-600">0</div>
                                <div class="text-gray-600">카카오톡</div>
                            </div>
                            <div class="text-center">
                                <div class="font-bold text-lg text-green-600">0</div>
                                <div class="text-gray-600">이메일</div>
                            </div>
                            <div class="text-center">
                                <div class="font-bold text-lg text-purple-600">0</div>
                                <div class="text-gray-600">Firebase</div>
                            </div>
                            <div class="text-center">
                                <div class="font-bold text-lg text-orange-600">0</div>
                                <div class="text-gray-600">localStorage</div>
                            </div>
                        </div>
                    </div>

                    <!-- 회원 목록 -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-green-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-green-700 uppercase tracking-wider">프로필</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-green-700 uppercase tracking-wider">회원명</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-green-700 uppercase tracking-wider">로그인 방식</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-green-700 uppercase tracking-wider">이메일</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-green-700 uppercase tracking-wider">휴대폰</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-green-700 uppercase tracking-wider">가입일</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-green-700 uppercase tracking-wider">업데이트</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-green-700 uppercase tracking-wider">데이터 소스</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-green-700 uppercase tracking-wider">작업</th>
                                    </tr>
                                </thead>
                                <tbody id="members-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- 동적으로 생성됨 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 새로운 후기 관리 섹션 -->
                <div id="reviews-section" class="section-content p-8 hidden">
                    <!-- 헤더 -->
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">⭐ 후기 관리</h2>
                            <p class="text-gray-600">고객 후기를 효율적으로 관리하고 승인하세요</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="newReviewManager.addNewReview()" class="px-6 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition shadow-lg">
                                ➕ 새 후기 추가
                            </button>
                            <button onclick="newReviewManager.refreshData()" class="px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition shadow-lg">
                                🔄 새로고침
                            </button>
                        </div>
                    </div>

                    <!-- 통계 카드 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-100 text-sm">총 후기</p>
                                    <p id="total-reviews-count" class="text-3xl font-bold">0</p>
                                </div>
                                <div class="text-4xl opacity-80">📝</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-green-100 text-sm">승인된 후기</p>
                                    <p id="approved-reviews-count" class="text-3xl font-bold">0</p>
                                </div>
                                <div class="text-4xl opacity-80">✅</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl p-6 text-white shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-yellow-100 text-sm">대기 중</p>
                                    <p id="pending-reviews-count" class="text-3xl font-bold">0</p>
                                </div>
                                <div class="text-4xl opacity-80">⏳</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-6 text-white shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-purple-100 text-sm">평균 평점</p>
                                    <p id="average-rating" class="text-3xl font-bold">0.0</p>
                                </div>
                                <div class="text-4xl opacity-80">⭐</div>
                            </div>
                        </div>
                    </div>

                    <!-- 필터 및 검색 -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex flex-col lg:flex-row gap-4 items-center">
                            <div class="flex-1">
                                <input type="text" id="review-search-input" placeholder="상품명, 작성자, 후기 내용으로 검색..." 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div class="flex gap-3">
                                <select id="status-filter" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">전체 상태</option>
                                    <option value="approved">승인됨</option>
                                    <option value="pending">대기 중</option>
                                    <option value="rejected">거부됨</option>
                                </select>
                                <select id="category-filter" class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">전체 카테고리</option>
                                    <option value="전자제품">전자제품</option>
                                    <option value="의류">의류</option>
                                    <option value="화장품">화장품</option>
                                    <option value="생활용품">생활용품</option>
                                    <option value="식품">식품</option>
                                    <option value="기타">기타</option>
                                </select>
                                <button onclick="newReviewManager.clearFilters()" class="px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                    🔄 초기화
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 후기 목록 -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gradient-to-r from-yellow-50 to-yellow-100">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-yellow-800 uppercase tracking-wider">아바타</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-yellow-800 uppercase tracking-wider">작성자</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-yellow-800 uppercase tracking-wider">상품명</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-yellow-800 uppercase tracking-wider">절약금액</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-yellow-800 uppercase tracking-wider">별점</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-yellow-800 uppercase tracking-wider">상태</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-yellow-800 uppercase tracking-wider">작성일</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-yellow-800 uppercase tracking-wider">작업</th>
                                    </tr>
                                </thead>
                                <tbody id="new-reviews-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- 동적으로 생성됨 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 절약왕 관리 섹션 -->
                <div id="savings-king-section" class="section-content p-8 hidden">
                    <!-- 헤더 -->
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">🏆 절약왕 관리</h2>
                            <p class="text-gray-600">이번 주 절약왕 정보를 관리하고 수정하세요</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="previewSavingsKing()" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition">
                                👁️ 미리보기
                            </button>
                            <button onclick="resetSavingsKing()" class="px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition">
                                🔄 초기화
                            </button>
                        </div>
                    </div>

                    <!-- 현재 절약왕 정보 -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">📊 현재 절약왕 정보</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">썸네일 이미지 URL</label>
                                    <input type="url" id="savings-king-image" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent" placeholder="https://example.com/image.jpg" oninput="updateSavingsKingPreview()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">절약왕 이름</label>
                                    <input type="text" id="savings-king-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent" placeholder="김민수" oninput="updateSavingsKingPreview()">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">절약 금액 (원)</label>
                                    <input type="number" id="savings-king-amount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent" placeholder="420000" oninput="updateSavingsKingPreview()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">절약율 (%)</label>
                                    <input type="number" id="savings-king-rate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent" placeholder="42" min="0" max="100" oninput="updateSavingsKingPreview()">
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button onclick="saveSavingsKing()" class="px-6 py-3 bg-pink-600 text-white rounded-lg font-semibold hover:bg-pink-700 transition">
                                💾 저장하기
                            </button>
                        </div>
                    </div>

                    <!-- 미리보기 섹션 -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">👁️ 미리보기</h3>
                        <div class="flex justify-center">
                            <div id="savings-king-preview" class="bg-gradient-to-r from-emerald-500 to-blue-500 text-white rounded-full shadow-lg">
                                <div class="flex items-center gap-3 px-6 py-3 font-semibold text-sm">
                                    <span class="text-2xl">🏆</span>
                                    <div class="text-left">
                                        <div class="font-bold">이번 주 절감왕</div>
                                        <div class="text-yellow-300 text-xs">-42% 절약 성공!</div>
                                    </div>
                                    <a href="#savings-hero" class="text-yellow-300 text-lg hover:text-yellow-200 transition-colors">→</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 사용자 상세보기 모달 -->
    <div id="user-detail-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="user-detail-modal-title">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto relative">
            <button id="close-user-detail" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl" aria-label="사용자 상세보기 닫기">&times;</button>
            <h2 id="user-detail-modal-title" class="text-2xl font-bold text-center mb-6 text-gray-700">👤 회원 상세정보</h2>
            
            <div id="user-detail-content" class="space-y-6">
                <!-- 사용자 정보가 여기에 동적으로 로드됩니다 -->
            </div>
            
            <div class="mt-6 flex justify-end gap-3">
                <button id="edit-user-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
                    ✏️ 정보 수정
                </button>
                <button id="delete-user-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition">
                    🗑️ 회원 삭제
                </button>
                <button id="close-user-detail-btn" class="px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition">
                    닫기
                </button>
            </div>
        </div>
    </div>

    <!-- 후기 추가/수정 모달 -->
    <div id="review-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 id="review-modal-title" class="text-2xl font-bold text-gray-800">➕ 새 후기 추가</h2>
                <button onclick="closeReviewModal()" class="text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <form id="review-form" class="space-y-6">
                <!-- 작성자 정보 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">작성자 이름 *</label>
                        <input type="text" id="review-name" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="예: 홍길동">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">나이대 *</label>
                        <select id="review-age-group" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">선택하세요</option>
                            <option value="10대">10대</option>
                            <option value="20대">20대</option>
                            <option value="30대">30대</option>
                            <option value="40대">40대</option>
                            <option value="50대">50대</option>
                            <option value="60대 이상">60대 이상</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">직업 *</label>
                        <input type="text" id="review-occupation" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="예: 직장인, 학생, 프리랜서">
                    </div>
                </div>

                <!-- 제품 정보 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">제품명 *</label>
                        <input type="text" id="review-product-name" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="구매하신 제품명을 입력하세요">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">구매일 *</label>
                        <input type="date" id="review-purchase-date" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <!-- 가격 정보 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">원래 가격 *</label>
                        <input type="text" id="review-original-price" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="예: 500,000원">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">실제 구매 가격 *</label>
                        <input type="text" id="review-final-price" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="예: 350,000원">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">절약 금액</label>
                        <input type="text" id="review-savings" readonly
                               class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50"
                               placeholder="자동 계산됩니다">
                    </div>
                </div>

                <!-- 평점 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">만족도 *</label>
                    <div class="flex space-x-2" id="review-rating-stars">
                        <button type="button" class="text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="1">⭐</button>
                        <button type="button" class="text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="2">⭐</button>
                        <button type="button" class="text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="3">⭐</button>
                        <button type="button" class="text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="4">⭐</button>
                        <button type="button" class="text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="5">⭐</button>
                    </div>
                    <input type="hidden" id="review-rating" required>
                </div>

                <!-- 후기 내용 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">후기 내용 *</label>
                    <textarea id="review-content" required rows="5"
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="제품에 대한 솔직한 후기를 작성해주세요."></textarea>
                </div>

                <!-- 사진 업로드 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">제품 사진 (선택사항)</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" id="review-photo-upload" multiple accept="image/*" class="hidden">
                        <button type="button" onclick="document.getElementById('review-photo-upload').click()" 
                                class="text-blue-600 hover:text-blue-700 font-medium">
                            📷 사진 업로드하기
                        </button>
                        <p class="text-sm text-gray-500 mt-2">최대 5장까지 업로드 가능합니다</p>
                    </div>
                    <div id="review-photo-preview" class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-4 hidden">
                        <!-- 업로드된 사진 미리보기가 여기에 표시됩니다 -->
                    </div>
                </div>

                <!-- 관리 옵션 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">승인 상태</label>
                        <select id="review-approved" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="true">승인됨</option>
                            <option value="false">승인 대기</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">인덱스페이지 노출</label>
                        <select id="review-featured" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="true">노출</option>
                            <option value="false">숨김</option>
                        </select>
                    </div>
                </div>

                <!-- 제출 버튼 -->
                <div class="flex justify-center pt-6">
                    <button type="submit" 
                            class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-12 py-3 rounded-full font-bold hover:from-blue-700 hover:to-purple-700 transition-all duration-300 shadow-lg">
                        후기 저장하기
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 사이드바 클릭 이벤트
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    switchSection(section);
                });
            });
        });
    </script>

    <!-- 관리자용 의뢰 상세보기 모달 -->
    <div id="admin-request-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
                <!-- 모달 헤더 -->
                <div class="sticky top-0 bg-white border-b border-gray-200 p-6 rounded-t-2xl">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">📋 의뢰 상세 정보 (관리자)</h2>
                        <button id="close-admin-request-modal" class="text-gray-500 hover:text-gray-700 text-3xl font-bold">&times;</button>
                    </div>
                </div>
                
                <!-- 모달 내용 -->
                <div class="p-6">
                    <!-- 의뢰 기본 정보 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            📝 의뢰 기본 정보
                        </h3>
                        <div class="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div><span class="font-semibold text-gray-700">의뢰번호:</span> <span id="admin-modal-request-number" class="text-blue-600"></span></div>
                                <div><span class="font-semibold text-gray-700">의뢰일시:</span> <span id="admin-modal-request-date" class="text-blue-600"></span></div>
                                <div><span class="font-semibold text-gray-700">제품명:</span> <span id="admin-modal-product-name" class="text-blue-600"></span></div>
                                <div><span class="font-semibold text-gray-700">요청가:</span> <span id="admin-modal-original-price" class="text-blue-600"></span></div>
                                <div><span class="font-semibold text-gray-700">상태:</span> <span id="admin-modal-status" class="px-2 py-1 rounded-full text-xs font-bold text-white"></span></div>
                                <div><span class="font-semibold text-gray-700">진행률:</span> <span id="admin-modal-progress" class="text-blue-600"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- 제품 상세 정보 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            🛍️ 제품 상세 정보
                        </h3>
                        <div class="bg-green-50 rounded-lg p-4 border-l-4 border-green-500">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div><span class="font-semibold text-gray-700">브랜드:</span> <span id="admin-modal-brand" class="text-green-600"></span></div>
                                <div><span class="font-semibold text-gray-700">모델명:</span> <span id="admin-modal-model" class="text-green-600"></span></div>
                                <div><span class="font-semibold text-gray-700">카테고리:</span> <span id="admin-modal-category" class="text-green-600"></span></div>
                                <div><span class="font-semibold text-gray-700">수량:</span> <span id="admin-modal-quantity" class="text-green-600"></span></div>
                                <div class="md:col-span-2"><span class="font-semibold text-gray-700">제품 설명:</span> <span id="admin-modal-description" class="text-green-600"></span></div>
                                <div class="md:col-span-2"><span class="font-semibold text-gray-700">참고 URL:</span> <span id="admin-modal-urls" class="text-green-600"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- 첨부 이미지 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            📸 첨부 이미지
                        </h3>
                        <div id="admin-modal-images" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- 이미지들이 여기에 동적으로 추가됩니다 -->
                        </div>
                    </div>

                    <!-- 회원 정보 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            👤 회원 정보
                        </h3>
                        <div class="bg-yellow-50 rounded-lg p-4 border-l-4 border-yellow-500">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div><span class="font-semibold text-gray-700">이름:</span> <span id="admin-modal-user-name" class="text-yellow-600"></span></div>
                                <div><span class="font-semibold text-gray-700">이메일:</span> <span id="admin-modal-user-email" class="text-yellow-600"></span></div>
                                <div><span class="font-semibold text-gray-700">휴대폰:</span> <span id="admin-modal-user-phone" class="text-yellow-600"></span></div>
                                <div><span class="font-semibold text-gray-700">카카오ID:</span> <span id="admin-modal-user-kakao" class="text-yellow-600"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- 추가 요청사항 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            💬 추가 요청사항
                        </h3>
                        <div class="bg-purple-50 rounded-lg p-4 border-l-4 border-purple-500">
                            <div class="text-sm">
                                <span class="font-semibold text-gray-700">특별 요청:</span> <span id="admin-modal-special-request" class="text-purple-600"></span>
                            </div>
                        </div>
                    </div>

                    <!-- 관리자 액션 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            ⚙️ 관리자 액션
                        </h3>
                        <div class="bg-red-50 rounded-lg p-4 border-l-4 border-red-500">
                            <div class="flex flex-wrap gap-3">
                                <button onclick="updateRequestStatusFromModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                                    상태 업데이트
                                </button>
                                <button onclick="deleteRequestFromModal()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                                    의뢰 삭제
                                </button>
                                <button onclick="exportRequestData()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                                    데이터 내보내기
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 관리자 답변 작성 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            💬 관리자 답변 작성
                        </h3>
                        <div class="bg-indigo-50 rounded-lg p-6 border-l-4 border-indigo-500">
                            <form id="admin-response-form" class="space-y-4">
                                <!-- 가격 정보 -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">💰 찾은 최저가</label>
                                        <input type="text" id="response-lowest-price" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="예: 15,000원">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">🏪 판매업체</label>
                                        <input type="text" id="response-seller" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="예: 쿠팡, 네이버쇼핑">
                                    </div>
                                </div>

                                <!-- 링크 정보 -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">🔗 판매 링크</label>
                                    <input type="url" id="response-seller-link" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="https://...">
                                </div>

                                <!-- 배송 정보 -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">🚚 배송비</label>
                                        <input type="text" id="response-shipping-cost" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="예: 2,500원 (무료배송)">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">⏰ 배송기간</label>
                                        <input type="text" id="response-shipping-time" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="예: 1-2일">
                                    </div>
                                </div>

                                <!-- 총 비용 -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">💳 총 구매비용</label>
                                    <input type="text" id="response-total-cost" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="예: 17,500원">
                                </div>

                                <!-- 추가 정보 -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">📝 추가 정보 및 추천사유</label>
                                    <textarea id="response-additional-info" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="추가로 알려드릴 정보나 추천 사유를 입력해주세요..."></textarea>
                                </div>

                                <!-- 버튼들 -->
                                <div class="flex gap-3 pt-4">
                                    <button type="submit" class="px-6 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition font-medium">
                                        답변 저장
                                    </button>
                                    <button type="button" onclick="clearResponseForm()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-medium">
                                        내용 지우기
                                    </button>
                                    <button type="button" onclick="previewResponse()" class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-medium">
                                        미리보기
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- 관리자 답변 (있는 경우) -->
                    <div id="admin-modal-admin-response" class="mb-6 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            💼 관리자 답변
                        </h3>
                        <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-gray-500">
                            <div class="text-sm">
                                <div class="mb-2"><span class="font-semibold text-gray-700">답변일시:</span> <span id="admin-modal-response-date" class="text-gray-600"></span></div>
                                <div><span class="font-semibold text-gray-700">답변내용:</span> <span id="admin-modal-response-content" class="text-gray-600"></span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 관리자용 의뢰 상세보기 모달 관련 함수들 -->
    <script>
        // 관리자용 의뢰 상세보기 모달 표시
        function showAdminRequestDetailModal(request) {
            console.log('관리자용 의뢰 상세보기 모달 표시:', request);
            
            // 모달 데이터 채우기
            fillAdminRequestDetailModal(request);
            
            // 모달 표시
            document.getElementById('admin-request-detail-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // 관리자용 모달 데이터 채우기
        function fillAdminRequestDetailModal(request) {
            // 의뢰 기본 정보
            document.getElementById('admin-modal-request-number').textContent = request.reqNum || request.requestNumber || 'N/A';
            document.getElementById('admin-modal-request-date').textContent = request.reqDate ? new Date(request.reqDate).toLocaleString('ko-KR') : 'N/A';
            document.getElementById('admin-modal-product-name').textContent = request.productName || request.name || 'N/A';
            document.getElementById('admin-modal-original-price').textContent = request.originalPrice || request.price || 'N/A';
            
            // 상태 및 진행률
            const status = request.status || '처리중';
            const statusElement = document.getElementById('admin-modal-status');
            statusElement.textContent = status;
            statusElement.className = 'px-2 py-1 rounded-full text-xs font-bold text-white ' + getAdminStatusClass(status);
            
            document.getElementById('admin-modal-progress').textContent = request.progress || '0%';

            // 제품 상세 정보
            document.getElementById('admin-modal-brand').textContent = request.brand || 'N/A';
            document.getElementById('admin-modal-model').textContent = request.model || 'N/A';
            document.getElementById('admin-modal-category').textContent = request.category || 'N/A';
            document.getElementById('admin-modal-quantity').textContent = request.quantity || '1';
            document.getElementById('admin-modal-description').textContent = request.description || request.productDescription || 'N/A';
            
            // 참고 URL
            const urls = request.urls || [];
            document.getElementById('admin-modal-urls').innerHTML = urls.map(url => 
                `<a href="${url}" target="_blank" class="text-blue-600 hover:underline break-all">${url}</a>`
            ).join('<br>') || 'N/A';

            // 첨부 이미지
            displayAdminModalImages(request.images || request.attachedImages || []);

            // 회원 정보
            document.getElementById('admin-modal-user-name').textContent = request.userName || request.name || 'N/A';
            document.getElementById('admin-modal-user-email').textContent = request.email || 'N/A';
            document.getElementById('admin-modal-user-phone').textContent = request.userPhone || request.phone || 'N/A';
            document.getElementById('admin-modal-user-kakao').textContent = request.userKakao || request.kakao || 'N/A';

            // 추가 요청사항
            document.getElementById('admin-modal-special-request').textContent = request.specialRequest || request.additionalRequest || 'N/A';

            // 기존 답변을 폼에 채우기
            loadExistingResponseToForm(request);

            // 관리자 답변 (있는 경우)
            if (request.adminResponse || request.response) {
                document.getElementById('admin-modal-admin-response').classList.remove('hidden');
                document.getElementById('admin-modal-response-date').textContent = request.responseDate ? new Date(request.responseDate).toLocaleString('ko-KR') : 'N/A';
                
                // 답변이 구조화된 데이터인지 확인
                if (typeof request.adminResponse === 'object' && request.adminResponse !== null) {
                    document.getElementById('admin-modal-response-content').innerHTML = formatResponseForDisplay(request.adminResponse);
                } else {
                    document.getElementById('admin-modal-response-content').textContent = request.adminResponse || request.response || 'N/A';
                }
            } else {
                document.getElementById('admin-modal-admin-response').classList.add('hidden');
            }
        }

        // 관리자용 상태에 따른 CSS 클래스 반환
        function getAdminStatusClass(status) {
            switch(status) {
                case '답변완료': return 'bg-green-500';
                case '완료': return 'bg-green-500';
                case '처리중': return 'bg-yellow-500';
                case '대기': return 'bg-gray-500';
                case '취소': return 'bg-red-500';
                default: return 'bg-blue-500';
            }
        }

        // 관리자용 모달에 이미지 표시
        function displayAdminModalImages(images) {
            const imagesContainer = document.getElementById('admin-modal-images');
            imagesContainer.innerHTML = '';

            if (!images || images.length === 0) {
                imagesContainer.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">첨부된 이미지가 없습니다.</div>';
                return;
            }

            images.forEach((image, index) => {
                const imageElement = document.createElement('div');
                imageElement.className = 'relative group';
                
                if (typeof image === 'string') {
                    // Base64 이미지 또는 URL
                    imageElement.innerHTML = `
                        <img src="${image}" alt="첨부 이미지 ${index + 1}" class="w-full h-48 object-cover rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer" onclick="openAdminImageModal('${image}')">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 rounded-lg flex items-center justify-center">
                            <span class="text-white opacity-0 group-hover:opacity-100 transition-opacity text-sm font-semibold">클릭하여 확대</span>
                        </div>
                    `;
                } else if (image.url) {
                    // 이미지 객체
                    imageElement.innerHTML = `
                        <img src="${image.url}" alt="${image.name || '첨부 이미지 ' + (index + 1)}" class="w-full h-48 object-cover rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer" onclick="openAdminImageModal('${image.url}')">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200 rounded-lg flex items-center justify-center">
                            <span class="text-white opacity-0 group-hover:opacity-100 transition-opacity text-sm font-semibold">클릭하여 확대</span>
                        </div>
                    `;
                }
                
                imagesContainer.appendChild(imageElement);
            });
        }

        // 관리자용 이미지 확대 모달
        function openAdminImageModal(imageSrc) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 z-60 flex items-center justify-center';
            modal.innerHTML = `
                <div class="relative max-w-4xl max-h-full p-4">
                    <img src="${imageSrc}" alt="확대된 이미지" class="max-w-full max-h-full object-contain rounded-lg">
                    <button onclick="this.parentElement.parentElement.remove()" class="absolute top-2 right-2 text-white text-3xl font-bold hover:text-gray-300">&times;</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 관리자용 모달 닫기
        function closeAdminRequestDetailModal() {
            document.getElementById('admin-request-detail-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // 전역 변수
        let currentRequestId = null;
        let currentInquiryId = null;

        // 기존 답변을 폼에 채우기
        function loadExistingResponseToForm(request) {
            // 기존 답변이 있는지 확인
            if (request.adminResponse && typeof request.adminResponse === 'object') {
                const response = request.adminResponse;
                
                // 각 필드에 기존 값 채우기
                document.getElementById('response-lowest-price').value = response.lowestPrice || '';
                document.getElementById('response-seller').value = response.seller || '';
                document.getElementById('response-seller-link').value = response.sellerLink || '';
                document.getElementById('response-shipping-cost').value = response.shippingCost || '';
                document.getElementById('response-shipping-time').value = response.shippingTime || '';
                document.getElementById('response-total-cost').value = response.totalCost || '';
                document.getElementById('response-additional-info').value = response.additionalInfo || '';
                
                console.log('✅ 기존 답변 데이터를 폼에 로드했습니다:', response);
            } else {
                // 기존 답변이 없으면 폼 초기화
                clearResponseForm();
                console.log('📝 새로운 답변을 위한 폼을 초기화했습니다.');
            }
        }

        // 답변 폼 초기화
        function clearResponseForm() {
            document.getElementById('response-lowest-price').value = '';
            document.getElementById('response-seller').value = '';
            document.getElementById('response-seller-link').value = '';
            document.getElementById('response-shipping-cost').value = '';
            document.getElementById('response-shipping-time').value = '';
            document.getElementById('response-total-cost').value = '';
            document.getElementById('response-additional-info').value = '';
        }

        // 답변 미리보기
        function previewResponse() {
            const formData = getResponseFormData();
            if (!formData.lowestPrice && !formData.seller && !formData.additionalInfo) {
                alert('미리보기할 내용이 없습니다.');
                return;
            }
            
            const previewModal = document.createElement('div');
            previewModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center';
            previewModal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">답변 미리보기</h3>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border-l-4 border-blue-500">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center mr-3">
                                <span class="text-white font-bold text-lg">P</span>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-800">PriceHunter 팀</div>
                                <div class="text-sm text-gray-500">${new Date().toLocaleString('ko-KR')}</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            ${formatResponseForDisplay(formData)}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(previewModal);
        }

        // 폼 데이터 가져오기
        function getResponseFormData() {
            return {
                lowestPrice: document.getElementById('response-lowest-price').value.trim(),
                seller: document.getElementById('response-seller').value.trim(),
                sellerLink: document.getElementById('response-seller-link').value.trim(),
                shippingCost: document.getElementById('response-shipping-cost').value.trim(),
                shippingTime: document.getElementById('response-shipping-time').value.trim(),
                totalCost: document.getElementById('response-total-cost').value.trim(),
                additionalInfo: document.getElementById('response-additional-info').value.trim()
            };
        }

        // 답변 저장
        async function saveResponse() {
            const formData = getResponseFormData();
            
            if (!formData.lowestPrice && !formData.seller && !formData.additionalInfo) {
                alert('최소한 하나의 정보는 입력해주세요.');
                return;
            }

            try {
                await waitForFirebase();
                const { collection, doc, updateDoc, serverTimestamp } = window.firebaseFirestoreFunctions;
                
                // Firebase에서 의뢰 문서 업데이트
                const requestRef = doc(collection(window.firebaseDb, 'requests'), currentRequestId);
                await updateDoc(requestRef, {
                    adminResponse: formData,
                    responseDate: serverTimestamp(),
                    status: '답변완료',
                    lastUpdated: serverTimestamp()
                });

                alert('답변이 성공적으로 저장되었습니다.');
                
                // 답변 섹션 업데이트
                document.getElementById('admin-modal-admin-response').classList.remove('hidden');
                document.getElementById('admin-modal-response-content').innerHTML = formatResponseForDisplay(formData);
                document.getElementById('admin-modal-response-date').textContent = new Date().toLocaleString('ko-KR');
                
                // 모달의 상태 표시도 업데이트
                const statusElement = document.getElementById('admin-modal-status');
                statusElement.textContent = '답변완료';
                statusElement.className = 'px-2 py-1 rounded-full text-xs font-bold text-white ' + getAdminStatusClass('답변완료');
                
                // 폼 초기화
                clearResponseForm();
                
                // 의뢰 목록 새로고침
                renderRequestList();
                
            } catch (error) {
                console.error('❌ 답변 저장 실패:', error);
                alert('답변 저장에 실패했습니다. 다시 시도해주세요.');
            }
        }

        // 답변을 표시용으로 포맷팅
        function formatResponseForDisplay(formData) {
            let html = '<div class="space-y-4">';
            
            if (formData.lowestPrice) {
                html += `
                    <div class="flex items-center p-3 bg-green-50 rounded-lg border-l-4 border-green-500">
                        <span class="text-2xl mr-3">💰</span>
                        <div>
                            <div class="font-semibold text-green-800">찾은 최저가</div>
                            <div class="text-green-600 text-lg font-bold">${formData.lowestPrice}</div>
                        </div>
                    </div>
                `;
            }
            
            if (formData.seller) {
                html += `
                    <div class="flex items-center p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                        <span class="text-2xl mr-3">🏪</span>
                        <div>
                            <div class="font-semibold text-blue-800">판매업체</div>
                            <div class="text-blue-600">${formData.seller}</div>
                        </div>
                    </div>
                `;
            }
            
            if (formData.sellerLink) {
                html += `
                    <div class="flex items-center p-3 bg-purple-50 rounded-lg border-l-4 border-purple-500">
                        <span class="text-2xl mr-3">🔗</span>
                        <div>
                            <div class="font-semibold text-purple-800">판매 링크</div>
                            <a href="${formData.sellerLink}" target="_blank" class="text-purple-600 hover:underline break-all">${formData.sellerLink}</a>
                        </div>
                    </div>
                `;
            }
            
            if (formData.shippingCost || formData.shippingTime) {
                html += `
                    <div class="flex items-center p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                        <span class="text-2xl mr-3">🚚</span>
                        <div>
                            <div class="font-semibold text-yellow-800">배송 정보</div>
                            <div class="text-yellow-600">
                                ${formData.shippingCost ? `배송비: ${formData.shippingCost}` : ''}
                                ${formData.shippingCost && formData.shippingTime ? '<br>' : ''}
                                ${formData.shippingTime ? `배송기간: ${formData.shippingTime}` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (formData.totalCost) {
                html += `
                    <div class="flex items-center p-3 bg-red-50 rounded-lg border-l-4 border-red-500">
                        <span class="text-2xl mr-3">💳</span>
                        <div>
                            <div class="font-semibold text-red-800">총 구매비용</div>
                            <div class="text-red-600 text-lg font-bold">${formData.totalCost}</div>
                        </div>
                    </div>
                `;
            }
            
            if (formData.additionalInfo) {
                html += `
                    <div class="p-3 bg-gray-50 rounded-lg border-l-4 border-gray-500">
                        <div class="font-semibold text-gray-800 mb-2">📝 추가 정보 및 추천사유</div>
                        <div class="text-gray-600 whitespace-pre-wrap">${formData.additionalInfo}</div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        // 관리자 액션 함수들
        function updateRequestStatusFromModal() {
            const requestNumber = document.getElementById('admin-modal-request-number').textContent;
            const newStatus = prompt('새로운 상태를 입력하세요 (대기/처리중/완료/취소):');
            if (newStatus) {
                // 상태 업데이트 로직 구현
                console.log('상태 업데이트:', requestNumber, newStatus);
                alert('상태가 업데이트되었습니다.');
            }
        }

        function deleteRequestFromModal() {
            const requestNumber = document.getElementById('admin-modal-request-number').textContent;
            if (confirm(`의뢰 ${requestNumber}를 삭제하시겠습니까?`)) {
                // 삭제 로직 구현
                console.log('의뢰 삭제:', requestNumber);
                alert('의뢰가 삭제되었습니다.');
                closeAdminRequestDetailModal();
            }
        }

        function exportRequestData() {
            const requestNumber = document.getElementById('admin-modal-request-number').textContent;
            // 데이터 내보내기 로직 구현
            console.log('데이터 내보내기:', requestNumber);
            alert('데이터가 내보내기되었습니다.');
        }

        // 관리자용 모달 이벤트 리스너 등록
        document.addEventListener('DOMContentLoaded', function() {
            // 모달 닫기 버튼
            document.getElementById('close-admin-request-modal').addEventListener('click', closeAdminRequestDetailModal);
            
            // 모달 배경 클릭 시 닫기
            document.getElementById('admin-request-detail-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAdminRequestDetailModal();
                }
            });
            
            // ESC 키로 모달 닫기
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !document.getElementById('admin-request-detail-modal').classList.contains('hidden')) {
                    closeAdminRequestDetailModal();
                }
            });

            // 답변 폼 제출 이벤트 리스너
            document.getElementById('admin-response-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveResponse();
            });
        });

        // 문의 상세보기 모달 표시
        function showInquiryDetailModal(inquiry) {
            console.log('문의 상세보기 모달 표시:', inquiry);
            
            // 모달 데이터 채우기
            fillInquiryDetailModal(inquiry);
            
            // 모달 표시
            document.getElementById('inquiry-detail-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // 문의 모달 데이터 채우기
        function fillInquiryDetailModal(inquiry) {
            // 문의 기본 정보
            document.getElementById('inquiry-modal-id').textContent = inquiry.id || 'N/A';
            document.getElementById('inquiry-modal-date').textContent = inquiry.date ? new Date(inquiry.date).toLocaleString('ko-KR') : 'N/A';
            document.getElementById('inquiry-modal-subject').textContent = inquiry.subject || 'N/A';
            document.getElementById('inquiry-modal-message').textContent = inquiry.message || 'N/A';
            
            // 상태
            const status = inquiry.status || '대기';
            const statusElement = document.getElementById('inquiry-modal-status');
            statusElement.textContent = status;
            statusElement.className = 'px-2 py-1 rounded-full text-xs font-bold text-white ' + getInquiryStatusClass(status);

            // 첨부 파일 표시
            displayInquiryAttachments(inquiry.file);

            // 회원 정보
            document.getElementById('inquiry-modal-user-name').textContent = inquiry.name || inquiry.userName || 'N/A';
            document.getElementById('inquiry-modal-user-email').textContent = inquiry.email || 'N/A';
            document.getElementById('inquiry-modal-user-phone').textContent = inquiry.phone || inquiry.userPhone || 'N/A';
            document.getElementById('inquiry-modal-user-kakao').textContent = inquiry.kakao || inquiry.userKakao || 'N/A';

            // 기존 답변을 폼에 채우기
            loadExistingInquiryResponseToForm(inquiry);

            // 관리자 답변 (있는 경우)
            if (inquiry.adminResponse || inquiry.response) {
                document.getElementById('inquiry-modal-admin-response').classList.remove('hidden');
                document.getElementById('inquiry-modal-response-date').textContent = inquiry.responseDate ? new Date(inquiry.responseDate).toLocaleString('ko-KR') : 'N/A';
                
                // 답변이 구조화된 데이터인지 확인
                if (typeof inquiry.adminResponse === 'object' && inquiry.adminResponse !== null) {
                    document.getElementById('inquiry-modal-response-content').innerHTML = formatInquiryResponseForDisplay(inquiry.adminResponse);
                } else {
                    document.getElementById('inquiry-modal-response-content').textContent = inquiry.adminResponse || inquiry.response || 'N/A';
                }
            } else {
                document.getElementById('inquiry-modal-admin-response').classList.add('hidden');
            }
        }

        // 문의 첨부 파일 표시
        function displayInquiryAttachments(file) {
            const attachmentsSection = document.getElementById('inquiry-modal-attachments');
            const attachmentList = document.getElementById('inquiry-modal-attachment-list');
            
            if (!file || file === '') {
                attachmentsSection.classList.add('hidden');
                return;
            }
            
            attachmentsSection.classList.remove('hidden');
            attachmentList.innerHTML = '';
            
            // 단일 파일인 경우
            if (typeof file === 'string' && file.startsWith('data:image/')) {
                const attachmentItem = createAttachmentItem(file, '첨부 이미지');
                attachmentList.appendChild(attachmentItem);
            }
            // 배열인 경우
            else if (Array.isArray(file)) {
                file.forEach((fileData, index) => {
                    if (fileData && fileData.startsWith('data:image/')) {
                        const attachmentItem = createAttachmentItem(fileData, `첨부 이미지 ${index + 1}`);
                        attachmentList.appendChild(attachmentItem);
                    }
                });
            }
        }

        // 첨부 파일 아이템 생성
        function createAttachmentItem(fileData, title) {
            const item = document.createElement('div');
            item.className = 'relative group cursor-pointer';
            
            item.innerHTML = `
                <div class="bg-white rounded-lg border-2 border-orange-200 p-3 hover:border-orange-400 transition-all duration-200 shadow-sm hover:shadow-md">
                    <div class="aspect-square rounded-lg overflow-hidden bg-gray-100 mb-2">
                        <img src="${fileData}" 
                             alt="${title}" 
                             class="w-full h-full object-cover hover:scale-105 transition-transform duration-200"
                             onclick="openInquiryImageModal('${fileData}')">
                    </div>
                    <div class="text-center">
                        <p class="text-xs font-medium text-gray-700 truncate">${title}</p>
                        <p class="text-xs text-gray-500 mt-1">클릭하여 확대</p>
                    </div>
                </div>
            `;
            
            return item;
        }

        // 문의 이미지 모달 열기
        function openInquiryImageModal(imageSrc) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="relative max-w-4xl max-h-full">
                    <img src="${imageSrc}" 
                         alt="확대 이미지" 
                         class="max-w-full max-h-full object-contain rounded-lg">
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="absolute top-4 right-4 text-white text-3xl font-bold hover:text-gray-300 transition-colors">
                        &times;
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            
            // 배경 클릭 시 닫기
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                    document.body.style.overflow = 'auto';
                }
            });
        }

        // 문의 상태에 따른 CSS 클래스 반환
        function getInquiryStatusClass(status) {
            switch(status) {
                case '답변완료': return 'bg-green-500';
                case '완료': return 'bg-green-500';
                case '처리중': return 'bg-yellow-500';
                case '대기': return 'bg-gray-500';
                case '취소': return 'bg-red-500';
                default: return 'bg-blue-500';
            }
        }

        // 기존 문의 답변을 폼에 채우기
        function loadExistingInquiryResponseToForm(inquiry) {
            // 기존 답변이 있는지 확인
            if (inquiry.adminResponse && typeof inquiry.adminResponse === 'object') {
                const response = inquiry.adminResponse;
                
                // 각 필드에 기존 값 채우기
                document.getElementById('inquiry-response-answer').value = response.answer || '';
                document.getElementById('inquiry-response-additional-info').value = response.additionalInfo || '';
                
                console.log('✅ 기존 문의 답변 데이터를 폼에 로드했습니다:', response);
            } else {
                // 기존 답변이 없으면 폼 초기화
                clearInquiryResponseForm();
                console.log('📝 새로운 문의 답변을 위한 폼을 초기화했습니다.');
            }
        }

        // 문의 답변 폼 초기화
        function clearInquiryResponseForm() {
            document.getElementById('inquiry-response-answer').value = '';
            document.getElementById('inquiry-response-additional-info').value = '';
            
            // 포커스를 답변 내용 필드로 이동
            document.getElementById('inquiry-response-answer').focus();
        }

        // 문의 답변 저장
        async function saveInquiryResponse() {
            const formData = getInquiryResponseFormData();
            
            if (!formData.answer && !formData.additionalInfo) {
                alert('최소한 하나의 정보는 입력해주세요.');
                return;
            }

            try {
                await waitForFirebase();
                const { collection, doc, updateDoc, serverTimestamp } = window.firebaseFirestoreFunctions;
                
                // Firebase에서 문의 문서 업데이트
                const inquiryRef = doc(collection(window.firebaseDb, 'inquiries'), currentInquiryId);
                await updateDoc(inquiryRef, {
                    adminResponse: formData,
                    responseDate: serverTimestamp(),
                    status: '답변완료',
                    lastUpdated: serverTimestamp()
                });

                alert('답변이 성공적으로 저장되었습니다.');
                
                // 답변 섹션 업데이트
                document.getElementById('inquiry-modal-admin-response').classList.remove('hidden');
                document.getElementById('inquiry-modal-response-content').innerHTML = formatInquiryResponseForDisplay(formData);
                document.getElementById('inquiry-modal-response-date').textContent = new Date().toLocaleString('ko-KR');
                
                // 모달의 상태 표시도 업데이트
                const statusElement = document.getElementById('inquiry-modal-status');
                statusElement.textContent = '답변완료';
                statusElement.className = 'px-2 py-1 rounded-full text-xs font-bold text-white ' + getInquiryStatusClass('답변완료');
                
                // 폼 초기화
                clearInquiryResponseForm();
                
                // 문의 목록 새로고침
                renderInquiryList();
                
            } catch (error) {
                console.error('❌ 문의 답변 저장 실패:', error);
                alert('답변 저장에 실패했습니다. 다시 시도해주세요.');
            }
        }

        // 문의 답변 폼 데이터 가져오기
        function getInquiryResponseFormData() {
            return {
                answer: document.getElementById('inquiry-response-answer').value.trim(),
                additionalInfo: document.getElementById('inquiry-response-additional-info').value.trim()
            };
        }

        // 문의 답변을 표시용으로 포맷팅
        function formatInquiryResponseForDisplay(formData) {
            let html = '<div class="space-y-4">';
            
            if (formData.answer) {
                html += `
                    <div class="p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                        <div class="font-semibold text-blue-800 mb-2">💬 답변</div>
                        <div class="text-blue-600 whitespace-pre-wrap">${formData.answer}</div>
                    </div>
                `;
            }
            
            if (formData.additionalInfo) {
                html += `
                    <div class="p-3 bg-gray-50 rounded-lg border-l-4 border-gray-500">
                        <div class="font-semibold text-gray-800 mb-2">📝 추가 정보</div>
                        <div class="text-gray-600 whitespace-pre-wrap">${formData.additionalInfo}</div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        // 문의 모달 닫기
        function closeInquiryDetailModal() {
            document.getElementById('inquiry-detail-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // 후기 모달 관련 함수들
        let selectedReviewRating = 0;
        let uploadedReviewPhotos = [];

        // 후기 추가 모달 표시
        function showAddReviewModal() {
            document.getElementById('review-modal-title').textContent = '➕ 새 후기 추가';
            document.getElementById('review-form').reset();
            selectedReviewRating = 0;
            uploadedReviewPhotos = [];
            resetReviewRatingStars();
            hideReviewPhotoPreview();
            
            // 오늘 날짜를 기본값으로 설정
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('review-purchase-date').value = today;
            
            document.getElementById('review-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // 후기 모달 닫기
        function closeReviewModal() {
            document.getElementById('review-modal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // 후기 평점 리셋
        function resetReviewRatingStars() {
            document.querySelectorAll('#review-rating-stars button').forEach((star, i) => {
                star.classList.remove('text-yellow-400');
                star.classList.add('text-gray-300');
            });
        }

        // 후기 사진 미리보기 숨기기
        function hideReviewPhotoPreview() {
            document.getElementById('review-photo-preview').classList.add('hidden');
        }

        // 후기 절약 금액 자동 계산
        function calculateReviewSavings() {
            const originalPrice = document.getElementById('review-original-price').value.replace(/[^0-9]/g, '');
            const finalPrice = document.getElementById('review-final-price').value.replace(/[^0-9]/g, '');
            
            if (originalPrice && finalPrice) {
                const savings = parseInt(originalPrice) - parseInt(finalPrice);
                const savingsPercent = Math.round((savings / parseInt(originalPrice)) * 100);
                document.getElementById('review-savings').value = `${savings.toLocaleString()}원 (${savingsPercent}%)`;
            }
        }

        // 후기 폼 이벤트 리스너 등록
        document.addEventListener('DOMContentLoaded', function() {
            // 후기 평점 선택
            document.querySelectorAll('#review-rating-stars button').forEach((star, index) => {
                star.addEventListener('click', () => {
                    selectedReviewRating = index + 1;
                    document.getElementById('review-rating').value = selectedReviewRating;
                    
                    // 별점 시각적 업데이트
                    document.querySelectorAll('#review-rating-stars button').forEach((s, i) => {
                        if (i < selectedReviewRating) {
                            s.classList.remove('text-gray-300');
                            s.classList.add('text-yellow-400');
                        } else {
                            s.classList.remove('text-yellow-400');
                            s.classList.add('text-gray-300');
                        }
                    });
                });
            });

            // 절약 금액 자동 계산
            document.getElementById('review-original-price').addEventListener('input', calculateReviewSavings);
            document.getElementById('review-final-price').addEventListener('input', calculateReviewSavings);

            // 사진 업로드 처리
            document.getElementById('review-photo-upload').addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                const preview = document.getElementById('review-photo-preview');
                
                if (files.length > 0) {
                    preview.classList.remove('hidden');
                    preview.innerHTML = '';
                    
                    files.slice(0, 5).forEach((file, index) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const photoDiv = document.createElement('div');
                            photoDiv.className = 'relative';
                            photoDiv.innerHTML = `
                                <img src="${e.target.result}" alt="업로드된 사진" class="w-full h-24 object-cover rounded-lg">
                                <button type="button" onclick="removeReviewPhoto(${index})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-sm">×</button>
                            `;
                            preview.appendChild(photoDiv);
                        };
                        reader.readAsDataURL(file);
                    });
                    
                    uploadedReviewPhotos = files.slice(0, 5);
                }
            });

            // 후기 폼 제출
            document.getElementById('review-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (selectedReviewRating === 0) {
                    alert('만족도를 선택해주세요.');
                    return;
                }
                
                try {
                    // Firebase 초기화 대기
                    await waitForFirebase();
                    
                    // 사진 URL 배열 생성 (실제로는 Firebase Storage에 업로드해야 함)
                    const photoUrls = uploadedReviewPhotos.map((file, index) => 
                        `https://images.unsplash.com/photo-${1500000000000 + index}?w=400&h=300&fit=crop`
                    );
                    
                    // 후기 데이터 준비
                    const reviewData = {
                        name: document.getElementById('review-name').value,
                        ageGroup: document.getElementById('review-age-group').value,
                        occupation: document.getElementById('review-occupation').value,
                        productName: document.getElementById('review-product-name').value,
                        originalPrice: document.getElementById('review-original-price').value,
                        finalPrice: document.getElementById('review-final-price').value,
                        savings: document.getElementById('review-savings').value.split(' ')[0],
                        savingsPercent: parseInt(document.getElementById('review-savings').value.match(/\d+%/)?.[0] || '0'),
                        rating: selectedReviewRating,
                        review: document.getElementById('review-content').value,
                        photos: photoUrls,
                        country: '대한민국',
                        shipping: '3일',
                        method: 'PriceHunter 검증',
                        badge: '실제 구매자',
                        purchaseDate: document.getElementById('review-purchase-date').value,
                        approved: document.getElementById('review-approved').value === 'true',
                        featured: document.getElementById('review-featured').value === 'true',
                        views: 0,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp(),
                        userId: 'admin',
                        requestId: null, // 관리자가 직접 작성한 후기
                        category: '일반' // 카테고리 추가
                    };
                    
                    // Firebase에 후기 저장
                    const { collection, addDoc, serverTimestamp } = window.firebaseFirestoreFunctions;
                    const reviewsRef = collection(window.firebaseDb, 'reviews');
                    await addDoc(reviewsRef, reviewData);
                    
                    alert('후기가 성공적으로 저장되었습니다!');
                    closeReviewModal();
                    
                    // 후기 목록 새로고침
                    if (typeof loadReviewsData === 'function') {
                        loadReviewsData();
                    }
                    
                } catch (error) {
                    console.error('후기 저장 실패:', error);
                    alert('후기 저장에 실패했습니다. 다시 시도해주세요.');
                }
            });
        });

        // 후기 사진 제거
        function removeReviewPhoto(index) {
            uploadedReviewPhotos.splice(index, 1);
            const preview = document.getElementById('review-photo-preview');
            preview.innerHTML = '';
            
            if (uploadedReviewPhotos.length > 0) {
                uploadedReviewPhotos.forEach((file, i) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const photoDiv = document.createElement('div');
                        photoDiv.className = 'relative';
                        photoDiv.innerHTML = `
                            <img src="${e.target.result}" alt="업로드된 사진" class="w-full h-24 object-cover rounded-lg">
                            <button type="button" onclick="removeReviewPhoto(${i})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-sm">×</button>
                        `;
                        preview.appendChild(photoDiv);
                    };
                    reader.readAsDataURL(file);
                });
            } else {
                preview.classList.add('hidden');
            }
        }

        // 후기 승인/거부 토글
        async function toggleReviewApproval(reviewId, approved) {
            try {
                await waitForFirebase();
                const { doc, updateDoc, serverTimestamp } = window.firebaseFirestoreFunctions;
                const reviewRef = doc(window.firebaseDb, 'reviews', reviewId);
                
                await updateDoc(reviewRef, {
                    approved: approved,
                    updatedAt: serverTimestamp()
                });
                
                alert(`후기가 ${approved ? '승인' : '거부'}되었습니다.`);
                
                // 후기 목록 새로고침
                if (typeof loadReviewsData === 'function') {
                    loadReviewsData();
                }
                
            } catch (error) {
                console.error('후기 승인 상태 변경 실패:', error);
                alert('후기 승인 상태 변경에 실패했습니다.');
            }
        }

        // 후기 인덱스페이지 노출 토글
        async function toggleReviewFeatured(reviewId, featured) {
            try {
                await waitForFirebase();
                const { doc, updateDoc, serverTimestamp } = window.firebaseFirestoreFunctions;
                const reviewRef = doc(window.firebaseDb, 'reviews', reviewId);
                
                await updateDoc(reviewRef, {
                    featured: featured,
                    updatedAt: serverTimestamp()
                });
                
                alert(`후기가 인덱스페이지에서 ${featured ? '노출' : '숨김'} 처리되었습니다.`);
                
                // 후기 목록 새로고침
                if (typeof loadReviewsData === 'function') {
                    loadReviewsData();
                }
                
            } catch (error) {
                console.error('후기 노출 상태 변경 실패:', error);
                alert('후기 노출 상태 변경에 실패했습니다.');
            }
        }

        // 후기 삭제
        async function deleteReview(reviewId) {
            if (!confirm('정말로 이 후기를 삭제하시겠습니까?')) {
                return;
            }
            
            try {
                await waitForFirebase();
                const { doc, deleteDoc } = window.firebaseFirestoreFunctions;
                const reviewRef = doc(window.firebaseDb, 'reviews', reviewId);
                
                await deleteDoc(reviewRef);
                
                alert('후기가 삭제되었습니다.');
                
                // 후기 목록 새로고침
                if (typeof loadReviewsData === 'function') {
                    loadReviewsData();
                }
                
            } catch (error) {
                console.error('후기 삭제 실패:', error);
                alert('후기 삭제에 실패했습니다.');
            }
        }

        // 후기 상세보기
        function viewReviewDetails(reviewId) {
            const review = allReviews.find(r => r.id === reviewId);
            if (!review) {
                alert('후기 정보를 찾을 수 없습니다.');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">후기 상세보기</h2>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center">
                                <span class="text-gray-600 font-medium text-xl">${review.name.charAt(0)}</span>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold">${review.name}, ${review.ageGroup} ${review.occupation}</h3>
                                <p class="text-gray-600">${review.productName}</p>
                                <div class="flex items-center">
                                    ${'★'.repeat(review.rating || 5)}${'☆'.repeat(5 - (review.rating || 5))}
                                    <span class="ml-2 text-sm text-gray-500">${review.rating || 5}/5</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold mb-2">가격 정보</h4>
                            <div class="grid grid-cols-3 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">원래 가격:</span>
                                    <div class="font-semibold">${review.originalPrice}</div>
                                </div>
                                <div>
                                    <span class="text-gray-600">구매 가격:</span>
                                    <div class="font-semibold text-green-600">${review.finalPrice}</div>
                                </div>
                                <div>
                                    <span class="text-gray-600">절약 금액:</span>
                                    <div class="font-semibold text-red-600">${review.savings} (${review.savingsPercent}%)</div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold mb-2">후기 내용</h4>
                            <p class="text-gray-700 leading-relaxed">${review.review}</p>
                        </div>
                        
                        ${review.photos && review.photos.length > 0 ? `
                            <div>
                                <h4 class="font-semibold mb-2">후기 사진</h4>
                                <div class="grid grid-cols-2 gap-2">
                                    ${review.photos.slice(0, 4).map(photo => `
                                        <img src="${photo}" alt="후기 사진" class="w-full h-24 object-cover rounded-lg">
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h4 class="font-semibold mb-2">상태 정보</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">승인 상태:</span>
                                    <span class="ml-2 px-2 py-1 rounded-full text-xs ${review.approved ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                        ${review.approved ? '승인됨' : '승인 대기'}
                                    </span>
                                </div>
                                <div>
                                    <span class="text-gray-600">인덱스 노출:</span>
                                    <span class="ml-2 px-2 py-1 rounded-full text-xs ${review.featured ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                                        ${review.featured ? '노출' : '숨김'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
    </script>

    <!-- 문의 상세보기 모달 -->
    <div id="inquiry-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <!-- 모달 헤더 -->
                <div class="sticky top-0 bg-white border-b border-gray-200 p-6 rounded-t-2xl">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">💬 문의 상세 정보</h2>
                        <button id="close-inquiry-modal" class="text-gray-500 hover:text-gray-700 text-3xl font-bold">&times;</button>
                    </div>
                </div>
                
                <!-- 모달 내용 -->
                <div class="p-6">
                    <!-- 문의 기본 정보 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            📝 문의 기본 정보
                        </h3>
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border-l-4 border-blue-500 shadow-sm">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div class="flex items-center">
                                    <span class="font-semibold text-gray-700 w-20">문의번호:</span> 
                                    <span id="inquiry-modal-id" class="text-blue-600 font-mono text-xs bg-blue-100 px-2 py-1 rounded"></span>
                                </div>
                                <div class="flex items-center">
                                    <span class="font-semibold text-gray-700 w-20">문의일시:</span> 
                                    <span id="inquiry-modal-date" class="text-blue-600"></span>
                                </div>
                                <div class="flex items-center md:col-span-2">
                                    <span class="font-semibold text-gray-700 w-20">제목:</span> 
                                    <span id="inquiry-modal-subject" class="text-blue-600 font-medium"></span>
                                </div>
                                <div class="flex items-center">
                                    <span class="font-semibold text-gray-700 w-20">상태:</span> 
                                    <span id="inquiry-modal-status" class="px-3 py-1 rounded-full text-xs font-bold text-white"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 문의 내용 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            📄 문의 내용
                        </h3>
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 border-l-4 border-green-500 shadow-sm">
                            <div class="bg-white rounded-lg p-4 border border-green-200">
                                <div class="whitespace-pre-wrap text-gray-700 leading-relaxed" id="inquiry-modal-message"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 첨부 파일 (사진) -->
                    <div id="inquiry-modal-attachments" class="mb-6 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            📎 첨부 파일
                        </h3>
                        <div class="bg-orange-50 rounded-lg p-4 border-l-4 border-orange-500">
                            <div id="inquiry-modal-attachment-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- 동적으로 생성됨 -->
                            </div>
                        </div>
                    </div>

                    <!-- 회원 정보 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            👤 회원 정보
                        </h3>
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 border-l-4 border-purple-500 shadow-sm">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div class="flex items-center">
                                    <span class="font-semibold text-gray-700 w-20">이름:</span> 
                                    <span id="inquiry-modal-user-name" class="text-purple-600 font-medium"></span>
                                </div>
                                <div class="flex items-center">
                                    <span class="font-semibold text-gray-700 w-20">이메일:</span> 
                                    <span id="inquiry-modal-user-email" class="text-purple-600 font-mono text-xs bg-purple-100 px-2 py-1 rounded"></span>
                                </div>
                                <div class="flex items-center">
                                    <span class="font-semibold text-gray-700 w-20">휴대폰:</span> 
                                    <span id="inquiry-modal-user-phone" class="text-purple-600"></span>
                                </div>
                                <div class="flex items-center">
                                    <span class="font-semibold text-gray-700 w-20">카카오ID:</span> 
                                    <span id="inquiry-modal-user-kakao" class="text-purple-600"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 관리자 답변 작성 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            💬 관리자 답변 작성
                        </h3>
                        <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-xl p-6 border-l-4 border-indigo-500 shadow-sm">
                            <form id="inquiry-response-form" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                                        💬 답변 내용
                                    </label>
                                    <textarea id="inquiry-response-answer" 
                                              rows="4" 
                                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:outline-none transition-colors" 
                                              placeholder="문의에 대한 답변을 작성해주세요..."></textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                                        📝 추가 정보
                                    </label>
                                    <textarea id="inquiry-response-additional-info" 
                                              rows="3" 
                                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 focus:outline-none transition-colors" 
                                              placeholder="추가로 알려드릴 정보가 있다면 입력해주세요..."></textarea>
                                </div>

                                <div class="flex gap-3 pt-4">
                                    <button type="submit" class="px-6 py-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition font-medium shadow-sm hover:shadow-md">
                                        💾 답변 저장
                                    </button>
                                    <button type="button" onclick="clearInquiryResponseForm()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-medium shadow-sm hover:shadow-md">
                                        🗑️ 내용 지우기
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- 관리자 답변 (있는 경우) -->
                    <div id="inquiry-modal-admin-response" class="mb-6 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            💼 관리자 답변
                        </h3>
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 border-l-4 border-purple-500 shadow-lg">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center mr-3">
                                    <span class="text-white font-bold text-lg">A</span>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800">관리자</div>
                                    <div class="text-sm text-gray-500" id="inquiry-modal-response-date"></div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-4 shadow-sm">
                                <div id="inquiry-modal-response-content"></div>
                            </div>
                            <div class="mt-4 flex items-center text-sm text-gray-500">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                답변이 완료되었습니다
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 문의 모달 이벤트 리스너 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 문의 모달 닫기 버튼
            document.getElementById('close-inquiry-modal').addEventListener('click', closeInquiryDetailModal);
            
            // 문의 모달 배경 클릭 시 닫기
            document.getElementById('inquiry-detail-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeInquiryDetailModal();
                }
            });
            
            // ESC 키로 문의 모달 닫기
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !document.getElementById('inquiry-detail-modal').classList.contains('hidden')) {
                    closeInquiryDetailModal();
                }
            });

            // 문의 답변 폼 제출 이벤트 리스너
            document.getElementById('inquiry-response-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveInquiryResponse();
            });
        });
    </script>

    <!-- 새로운 후기 관리 시스템 -->
    <script>
        // 새로운 후기 관리 시스템
        const newReviewManager = {
            reviews: [],
            filteredReviews: [],
            
            // 초기화
            init() {
                console.log('🚀 새로운 후기 관리 시스템 초기화');
                this.setupEventListeners();
                this.loadReviews();
            },
            
            // 이벤트 리스너 설정
            setupEventListeners() {
                // 검색 입력
                const searchInput = document.getElementById('review-search-input');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.filterReviews();
                    });
                }
                
                // 필터 선택
                const statusFilter = document.getElementById('status-filter');
                const categoryFilter = document.getElementById('category-filter');
                
                if (statusFilter) {
                    statusFilter.addEventListener('change', () => {
                        this.filterReviews();
                    });
                }
                
                if (categoryFilter) {
                    categoryFilter.addEventListener('change', () => {
                        this.filterReviews();
                    });
                }
            },
            
            // 후기 데이터 로드
            async loadReviews() {
                try {
                    console.log('📋 새로운 후기 관리 시스템 - 데이터 로드 시작...');
                    
                    if (!window.firebaseDb) {
                        console.error('❌ Firebase가 초기화되지 않았습니다.');
                        return;
                    }
                    
                    const { collection, getDocs, query, orderBy } = window.firebaseFirestoreFunctions;
                    const reviewsRef = collection(window.firebaseDb, 'reviews');
                    const q = query(reviewsRef, orderBy('createdAt', 'desc'));
                    
                    const snapshot = await getDocs(q);
                    this.reviews = [];
                    
                    snapshot.docs.forEach(doc => {
                        const reviewData = { id: doc.id, ...doc.data() };
                        // 기본값 설정
                        reviewData.approved = reviewData.approved || false;
                        reviewData.featured = reviewData.featured || false;
                        reviewData.rating = reviewData.rating || 5;
                        this.reviews.push(reviewData);
                    });
                    
                    this.filteredReviews = [...this.reviews];
                    this.updateStatistics();
                    this.renderTable();
                    
                    console.log(`✅ 새로운 후기 관리 시스템 - 데이터 로드 완료: ${this.reviews.length}개`);
                    
                } catch (error) {
                    console.error('❌ 새로운 후기 관리 시스템 - 데이터 로드 실패:', error);
                    alert('후기 데이터를 불러오는데 실패했습니다: ' + error.message);
                }
            },
            
            // 통계 업데이트
            updateStatistics() {
                const total = this.reviews.length;
                const approved = this.reviews.filter(r => r.approved).length;
                const pending = this.reviews.filter(r => !r.approved && !r.rejected).length;
                const avgRating = this.reviews.length > 0 ? 
                    (this.reviews.reduce((sum, r) => sum + (r.rating || 5), 0) / this.reviews.length).toFixed(1) : 0;
                
                document.getElementById('total-reviews-count').textContent = total;
                document.getElementById('approved-reviews-count').textContent = approved;
                document.getElementById('pending-reviews-count').textContent = pending;
                document.getElementById('average-rating').textContent = avgRating;
            },
            
            // 필터링
            filterReviews() {
                const searchTerm = document.getElementById('review-search-input')?.value.toLowerCase() || '';
                const statusFilter = document.getElementById('status-filter')?.value || '';
                const categoryFilter = document.getElementById('category-filter')?.value || '';
                
                this.filteredReviews = this.reviews.filter(review => {
                    const matchesSearch = !searchTerm || 
                        review.productName?.toLowerCase().includes(searchTerm) ||
                        this.maskName(review.name)?.toLowerCase().includes(searchTerm) ||
                        review.review?.toLowerCase().includes(searchTerm);
                    
                    const matchesStatus = !statusFilter || 
                        (statusFilter === 'approved' && review.approved) ||
                        (statusFilter === 'pending' && !review.approved && !review.rejected) ||
                        (statusFilter === 'rejected' && review.rejected);
                    
                    const matchesCategory = !categoryFilter || review.category === categoryFilter;
                    
                    return matchesSearch && matchesStatus && matchesCategory;
                });
                
                this.renderTable();
            },
            
            // 테이블 렌더링
            renderTable() {
                const tbody = document.getElementById('new-reviews-table-body');
                if (!tbody) return;
                
                if (this.filteredReviews.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                                <div class="text-4xl mb-4">📝</div>
                                <p class="text-lg">후기가 없습니다</p>
                                <p class="text-sm text-gray-400 mt-2">새 후기를 추가하거나 필터를 조정해보세요</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = this.filteredReviews.map(review => {
                    const statusBadge = this.getStatusBadge(review);
                    const stars = '★'.repeat(review.rating || 5) + '☆'.repeat(5 - (review.rating || 5));
                    
                    return `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="w-12 h-12 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                    ${this.maskName(review.name)?.charAt(0) || '?'}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${this.maskName(review.name) || '익명'}</div>
                                <div class="text-sm text-gray-500">작성자</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${review.productName || '상품명 없음'}</div>
                                <div class="text-sm text-gray-500">${review.category || '카테고리 없음'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-red-600">${review.savings || '0원'}</div>
                                <div class="text-sm text-gray-500">${review.savingsPercent || 0}%</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-yellow-500">${stars}</div>
                                <div class="text-sm text-gray-500">${review.rating || 5}/5</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                ${statusBadge}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${this.formatDate(review.createdAt || review.purchaseDate)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex space-x-2">
                                    <button onclick="newReviewManager.viewReview('${review.id}')" class="text-blue-600 hover:text-blue-900 font-medium">보기</button>
                                    <button onclick="newReviewManager.editReview('${review.id}')" class="text-green-600 hover:text-green-900 font-medium">수정</button>
                                    <button onclick="newReviewManager.toggleApproval('${review.id}')" class="text-purple-600 hover:text-purple-900 font-medium">
                                        ${review.approved ? '승인취소' : '승인'}
                                    </button>
                                    <button onclick="newReviewManager.deleteReview('${review.id}')" class="text-red-600 hover:text-red-900 font-medium">삭제</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            },
            
            // 상태 배지 생성
            getStatusBadge(review) {
                if (review.approved) {
                    return '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">승인됨</span>';
                } else if (review.rejected) {
                    return '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">거부됨</span>';
                } else {
                    return '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">대기 중</span>';
                }
            },
            
            // 날짜 포맷팅 (단순화)
            formatDate(date) {
                if (!date) return '날짜 없음';
                const d = date.seconds ? new Date(date.seconds * 1000) : new Date(date);
                if (isNaN(d.getTime())) return '날짜 오류';
                const y = d.getFullYear();
                const m = String(d.getMonth()+1).padStart(2,'0');
                const day = String(d.getDate()).padStart(2,'0');
                const h = String(d.getHours()).padStart(2,'0');
                const min = String(d.getMinutes()).padStart(2,'0');
                return `${y}-${m}-${day} ${h}:${min}`;
            },

            // 이름 마스킹 함수
            maskName(name) {
                if (!name) return '익명';
                if (name.length <= 2) return name.charAt(0) + '*';
                if (name.length === 3) return name.charAt(0) + '*' + name.charAt(2);
                // 4글자 이상인 경우
                const firstChar = name.charAt(0);
                const lastChar = name.charAt(name.length - 1);
                const middleChars = '*'.repeat(name.length - 2);
                return firstChar + middleChars + lastChar;
            },
            
            // 새 후기 추가
            addNewReview() {
                this.showEditModal();
            },
            
            // 후기 보기
            viewReview(reviewId) {
                const review = this.reviews.find(r => r.id === reviewId);
                if (!review) return;
                
                alert(`후기 보기: ${review.productName}\n작성자: ${this.maskName(review.name)}\n내용: ${review.review}`);
            },
            
            // 후기 수정
            editReview(reviewId) {
                const review = this.reviews.find(r => r.id === reviewId);
                if (!review) return;
                
                console.log('🔧 새로운 후기 관리 시스템 - 수정 시작:', reviewId);
                this.showEditModal(review);
            },
            
            // 승인 토글
            async toggleApproval(reviewId) {
                const review = this.reviews.find(r => r.id === reviewId);
                if (!review) return;
                
                try {
                    const { doc, updateDoc } = window.firebaseFirestoreFunctions;
                    const reviewRef = doc(window.firebaseDb, 'reviews', reviewId);
                    
                    await updateDoc(reviewRef, {
                        approved: !review.approved,
                        rejected: false,
                        updatedAt: new Date()
                    });
                    
                    review.approved = !review.approved;
                    review.rejected = false;
                    
                    this.updateStatistics();
                    this.renderTable();
                    
                    alert(`후기가 ${review.approved ? '승인' : '승인 취소'}되었습니다.`);
                    
                } catch (error) {
                    console.error('❌ 승인 상태 변경 실패:', error);
                    alert('승인 상태 변경에 실패했습니다: ' + error.message);
                }
            },
            
            // 후기 삭제
            async deleteReview(reviewId) {
                if (!confirm('정말로 이 후기를 삭제하시겠습니까?')) return;
                
                try {
                    const { doc, deleteDoc } = window.firebaseFirestoreFunctions;
                    const reviewRef = doc(window.firebaseDb, 'reviews', reviewId);
                    
                    await deleteDoc(reviewRef);
                    
                    this.reviews = this.reviews.filter(r => r.id !== reviewId);
                    this.filteredReviews = this.filteredReviews.filter(r => r.id !== reviewId);
                    
                    this.updateStatistics();
                    this.renderTable();
                    
                    alert('후기가 삭제되었습니다.');
                    
                } catch (error) {
                    console.error('❌ 후기 삭제 실패:', error);
                    alert('후기 삭제에 실패했습니다: ' + error.message);
                }
            },
            
            // 필터 초기화
            clearFilters() {
                document.getElementById('review-search-input').value = '';
                document.getElementById('status-filter').value = '';
                document.getElementById('category-filter').value = '';
                this.filterReviews();
            },
            
            // 데이터 새로고침
            refreshData() {
                this.loadReviews();
            },
            
            // 수정 모달 표시
            showEditModal(review = null) {
                console.log('🔧 새로운 후기 관리 시스템 - 수정 모달 표시:', review ? '수정 모드' : '새 후기 모드');
                
                // 기존 모달 제거
                const existingModal = document.getElementById('new-edit-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                const isEdit = !!review;
                const modalHTML = `
                    <div id="new-edit-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                                <h2 style="font-size: 24px; font-weight: bold; color: #1f2937;">${isEdit ? '✏️ 후기 수정' : '➕ 새 후기 추가'}</h2>
                                <button onclick="document.getElementById('new-edit-modal').remove()" style="background: none; border: none; font-size: 24px; color: #6b7280; cursor: pointer;">&times;</button>
                            </div>
                            
                            <form id="new-review-form" style="display: flex; flex-direction: column; gap: 16px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 8px;">👤 작성자 이름</label>
                                        <input type="text" id="edit-name" value="${review?.name || ''}" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;" required>
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 8px;">📱 연령대</label>
                                        <select id="edit-age" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                            <option value="20대" ${review?.ageGroup === '20대' ? 'selected' : ''}>20대</option>
                                            <option value="30대" ${review?.ageGroup === '30대' ? 'selected' : ''}>30대</option>
                                            <option value="40대" ${review?.ageGroup === '40대' ? 'selected' : ''}>40대</option>
                                            <option value="50대" ${review?.ageGroup === '50대' ? 'selected' : ''}>50대</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 8px;">🛍️ 상품명</label>
                                    <input type="text" id="edit-product" value="${review?.productName || ''}" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;" required>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 8px;">💰 원가</label>
                                        <input type="number" id="edit-original-price" value="${review?.originalPrice || ''}" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;" required>
                                    </div>
                                    <div>
                                        <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 8px;">💸 최종가격</label>
                                        <input type="number" id="edit-final-price" value="${review?.finalPrice || ''}" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;" required>
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 8px;">⭐ 평점</label>
                                    <select id="edit-rating" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                        <option value="5" ${review?.rating === 5 ? 'selected' : ''}>5점 - 매우 만족</option>
                                        <option value="4" ${review?.rating === 4 ? 'selected' : ''}>4점 - 만족</option>
                                        <option value="3" ${review?.rating === 3 ? 'selected' : ''}>3점 - 보통</option>
                                        <option value="2" ${review?.rating === 2 ? 'selected' : ''}>2점 - 불만족</option>
                                        <option value="1" ${review?.rating === 1 ? 'selected' : ''}>1점 - 매우 불만족</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 8px;">📝 후기 내용</label>
                                    <textarea id="edit-content" rows="4" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; resize: vertical;" required>${review?.review || ''}</textarea>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="edit-approved" ${review?.approved ? 'checked' : ''} style="width: 16px; height: 16px;">
                                        <span style="font-weight: 500; color: #374151;">✅ 승인됨</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="edit-featured" ${review?.featured ? 'checked' : ''} style="width: 16px; height: 16px;">
                                        <span style="font-weight: 500; color: #374151;">🌟 인덱스 노출</span>
                                    </label>
                                </div>
                                
                                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                                    <button type="button" onclick="document.getElementById('new-edit-modal').remove()" style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer;">
                                        취소
                                    </button>
                                    <button type="submit" style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer;">
                                        ${isEdit ? '수정 완료' : '추가 완료'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // 폼 제출 이벤트
                document.getElementById('new-review-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveReview(review?.id);
                });
            },
            
            // 후기 저장
            async saveReview(reviewId = null) {
                try {
                    const formData = {
                        name: document.getElementById('edit-name').value,
                        ageGroup: document.getElementById('edit-age').value,
                        productName: document.getElementById('edit-product').value,
                        originalPrice: parseInt(document.getElementById('edit-original-price').value),
                        finalPrice: parseInt(document.getElementById('edit-final-price').value),
                        rating: parseInt(document.getElementById('edit-rating').value),
                        review: document.getElementById('edit-content').value,
                        approved: document.getElementById('edit-approved').checked,
                        featured: document.getElementById('edit-featured').checked,
                        savings: parseInt(document.getElementById('edit-original-price').value) - parseInt(document.getElementById('edit-final-price').value),
                        savingsPercent: Math.round(((parseInt(document.getElementById('edit-original-price').value) - parseInt(document.getElementById('edit-final-price').value)) / parseInt(document.getElementById('edit-original-price').value)) * 100),
                        updatedAt: new Date()
                    };
                    
                    if (reviewId) {
                        // 수정
                        const { doc, updateDoc } = window.firebaseFirestoreFunctions;
                        const reviewRef = doc(window.firebaseDb, 'reviews', reviewId);
                        await updateDoc(reviewRef, formData);
                        
                        // 로컬 데이터 업데이트
                        const index = this.reviews.findIndex(r => r.id === reviewId);
                        if (index !== -1) {
                            this.reviews[index] = { ...this.reviews[index], ...formData };
                        }
                        
                        alert('후기가 성공적으로 수정되었습니다!');
                    } else {
                        // 새로 추가
                        const { collection, addDoc, serverTimestamp } = window.firebaseFirestoreFunctions;
                        const reviewsRef = collection(window.firebaseDb, 'reviews');
                        const docRef = await addDoc(reviewsRef, {
                            ...formData,
                            createdAt: serverTimestamp()
                        });
                        
                        // 로컬 데이터에 추가
                        this.reviews.unshift({ id: docRef.id, ...formData });
                        
                        alert('새 후기가 성공적으로 추가되었습니다!');
                    }
                    
                    // 모달 닫기 및 데이터 새로고침
                    document.getElementById('new-edit-modal').remove();
                    this.updateStatistics();
                    this.renderTable();
                    
                } catch (error) {
                    console.error('❌ 후기 저장 실패:', error);
                    alert('후기 저장에 실패했습니다: ' + error.message);
                }
            }
        };
        
        // 전역으로 등록
        window.newReviewManager = newReviewManager;
        
        // 후기 섹션 전환 시 새로운 시스템 초기화
        const originalSwitchSection = window.switchSection;
        window.switchSection = function(sectionName) {
            originalSwitchSection(sectionName);
            
            if (sectionName === 'reviews') {
                console.log('🔄 후기 섹션으로 전환 - 새로운 시스템 초기화');
                setTimeout(() => {
                    newReviewManager.init();
                }, 100);
            } else if (sectionName === 'savings-king') {
                console.log('🔄 절약왕 섹션으로 전환 - 데이터 로드');
                setTimeout(() => {
                    loadSavingsKingData();
                }, 100);
            }
        };

        // 절약왕 관리 기능
        async function loadSavingsKingData() {
            console.log('🏆 절약왕 데이터 로드 시작');
            
            // 기본값 설정
            const defaultData = {
                image: 'https://images.unsplash.com/photo-1519125323398-675f0ddb6308?auto=format&fit=crop&w=600&q=80',
                name: '김민수',
                amount: 420000,
                rate: 42
            };
            
            let data = { ...defaultData };
            
            try {
                // Firebase에서 데이터 로드 시도
                if (window.firebaseDb) {
                    const { collection, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                    
                    const savingsKingRef = doc(collection(window.firebaseDb, 'adminSettings'), 'savingsKing');
                    const docSnap = await getDoc(savingsKingRef);
                    
                    if (docSnap.exists()) {
                        const firebaseData = docSnap.data();
                        data = { ...defaultData, ...firebaseData };
                        console.log('✅ Firebase에서 절약왕 데이터 로드 성공:', data);
                    } else {
                        console.log('⚠️ Firebase에 절약왕 데이터가 없음, 기본값 사용');
                    }
                }
            } catch (error) {
                console.error('❌ Firebase에서 절약왕 데이터 로드 실패:', error);
                
                // Firebase 실패 시 localStorage에서 로드
                const savingsKingData = JSON.parse(localStorage.getItem('savingsKingData') || '{}');
                data = { ...defaultData, ...savingsKingData };
                console.log('📱 localStorage에서 절약왕 데이터 로드:', data);
            }
            
            // 폼에 데이터 설정
            document.getElementById('savings-king-image').value = data.image;
            document.getElementById('savings-king-name').value = data.name;
            document.getElementById('savings-king-amount').value = data.amount;
            document.getElementById('savings-king-rate').value = data.rate;
            
            // 미리보기 업데이트
            updateSavingsKingPreview();
            
            console.log('✅ 절약왕 데이터 로드 완료:', data);
        }

        async function saveSavingsKing() {
            console.log('💾 절약왕 데이터 저장 시작');
            
            // 폼 데이터 수집
            const data = {
                image: document.getElementById('savings-king-image').value,
                name: document.getElementById('savings-king-name').value,
                amount: parseInt(document.getElementById('savings-king-amount').value) || 0,
                rate: parseInt(document.getElementById('savings-king-rate').value) || 0
            };
            
            // 유효성 검사
            if (!data.name.trim()) {
                alert('❌ 절약왕 이름을 입력해주세요.');
                return;
            }
            
            if (data.amount <= 0) {
                alert('❌ 절약 금액은 0보다 커야 합니다.');
                return;
            }
            
            if (data.rate < 0 || data.rate > 100) {
                alert('❌ 절약율은 0-100 사이의 값이어야 합니다.');
                return;
            }
            
            try {
                // Firebase에 저장
                if (window.firebaseDb) {
                    const { collection, doc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                    
                    const savingsKingRef = doc(collection(window.firebaseDb, 'adminSettings'), 'savingsKing');
                    await setDoc(savingsKingRef, {
                        ...data,
                        updatedAt: serverTimestamp(),
                        updatedBy: 'admin'
                    }, { merge: true });
                    
                    console.log('✅ Firebase에 절약왕 데이터 저장 완료');
                }
                
                // localStorage에도 저장 (백업용)
                localStorage.setItem('savingsKingData', JSON.stringify(data));
                
                // 미리보기 업데이트
                updateSavingsKingPreview();
                
                // 성공 메시지
                alert('✅ 절약왕 정보가 저장되었습니다!');
                
                console.log('✅ 절약왕 데이터 저장 완료:', data);
                
            } catch (error) {
                console.error('❌ 절약왕 데이터 저장 실패:', error);
                alert('❌ 저장에 실패했습니다. 다시 시도해주세요.');
            }
        }

        function updateSavingsKingPreview() {
            const data = {
                image: document.getElementById('savings-king-image').value,
                name: document.getElementById('savings-king-name').value,
                amount: parseInt(document.getElementById('savings-king-amount').value) || 0,
                rate: parseInt(document.getElementById('savings-king-rate').value) || 0
            };
            
            const preview = document.getElementById('savings-king-preview');
            if (preview) {
                preview.innerHTML = `
                    <div class="flex items-center gap-3 px-6 py-3 font-semibold text-sm">
                        <span class="text-2xl">🏆</span>
                        <div class="text-left">
                            <div class="font-bold">이번 주 절감왕</div>
                            <div class="text-yellow-300 text-xs">-${data.rate}% 절약 성공!</div>
                        </div>
                        <a href="#savings-hero" class="text-yellow-300 text-lg hover:text-yellow-200 transition-colors">→</a>
                    </div>
                `;
            }
        }

        function previewSavingsKing() {
            // 메인 페이지에서 절약왕 배지 미리보기
            const data = {
                image: document.getElementById('savings-king-image').value,
                name: document.getElementById('savings-king-name').value,
                amount: parseInt(document.getElementById('savings-king-amount').value) || 0,
                rate: parseInt(document.getElementById('savings-king-rate').value) || 0
            };
            
            // 메인 페이지로 이동하여 미리보기
            const mainPageUrl = new URL('index.html', window.location.origin);
            mainPageUrl.searchParams.set('preview', 'savings-king');
            mainPageUrl.searchParams.set('name', data.name);
            mainPageUrl.searchParams.set('amount', data.amount);
            mainPageUrl.searchParams.set('rate', data.rate);
            mainPageUrl.searchParams.set('image', data.image);
            
            window.open(mainPageUrl.toString(), '_blank');
        }

        function resetSavingsKing() {
            if (confirm('🔄 절약왕 정보를 초기값으로 리셋하시겠습니까?')) {
                // 기본값으로 리셋
                document.getElementById('savings-king-image').value = 'https://images.unsplash.com/photo-1519125323398-675f0ddb6308?auto=format&fit=crop&w=600&q=80';
                document.getElementById('savings-king-name').value = '김민수';
                document.getElementById('savings-king-amount').value = '420000';
                document.getElementById('savings-king-rate').value = '42';
                
                // 미리보기 업데이트
                updateSavingsKingPreview();
                
                alert('✅ 절약왕 정보가 초기값으로 리셋되었습니다.');
            }
        }

        // 전역 함수로 등록
        window.loadSavingsKingData = loadSavingsKingData;
        window.saveSavingsKing = saveSavingsKing;
        window.updateSavingsKingPreview = updateSavingsKingPreview;
        window.previewSavingsKing = previewSavingsKing;
        window.resetSavingsKing = resetSavingsKing;
    </script>
</body>
</html>
