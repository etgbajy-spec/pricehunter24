<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Content Security Policy - Firebase iframe í—ˆìš© -->
    <meta http-equiv="Content-Security-Policy" content="frame-src 'self' https://www.google.com https://recaptcha.google.com https://kauth.kakao.com https://pricehunter-99a1b.firebaseapp.com https://*.firebaseapp.com https://*.googleapis.com https://apis.google.com; connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firebasestorage.googleapis.com https://content-firebaseappcheck.googleapis.com https://www.googleapis.com https://*.firebaseio.com wss://*.firebaseio.com https://developers.kakao.com https://kapi.kakao.com https://kauth.kakao.com https://*.firebaseapp.com https://*.cloudfunctions.net https://api.emailjs.com https://www.gstatic.com https://*.gstatic.com https://firebasejs.com;" />
    
    <title>í›„ê¸° ì‘ì„± - PriceHunter</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ”%3C/text%3E%3C/svg%3E">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fadeInUp 0.6s ease-out; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- í—¤ë” -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="flex items-center space-x-2 hover:opacity-80 transition">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        <span class="text-xl font-bold">PriceHunter</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm opacity-90">í›„ê¸° ì‘ì„±</span>
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="max-w-4xl mx-auto px-4 py-8">
        <!-- í˜ì´ì§€ ì œëª© -->
        <div class="text-center mb-8 animate-fade-in-up">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">
                âœï¸ <span class="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">í›„ê¸°<br class="sm:hidden">ì‘ì„±í•˜ê¸°</span>
            </h1>
            <p class="text-lg text-gray-600">
                êµ¬ë§¤í•˜ì‹  ì œí’ˆì— ëŒ€í•œ<br class="sm:hidden">ì†”ì§í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”
            </p>
        </div>

        <!-- í›„ê¸° ì‘ì„± í¼ -->
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <form id="review-form" class="space-y-6">
                <!-- ì˜ë¢° ê±´ ì„ íƒ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì˜ë¢° ê±´ ì„ íƒ *</label>
                    <select id="request-select" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">ì˜ë¢°í•˜ì‹  ê±´ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                    <p class="text-sm text-gray-500 mt-1">ì˜ë¢°í•˜ì‹  ê±´ì—ì„œë§Œ í›„ê¸°ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>

                <!-- êµ¬ë§¤ ì •ë³´ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì œí’ˆëª… *</label>
                        <input type="text" id="product-name" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="êµ¬ë§¤í•˜ì‹  ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">êµ¬ë§¤ì¼ *</label>
                        <input type="date" id="purchase-date" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <!-- ê°€ê²© ì •ë³´ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì›ë˜ ê°€ê²© *</label>
                        <input type="text" id="original-price" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="ì˜ˆ: 500,000ì›">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì‹¤ì œ êµ¬ë§¤ ê°€ê²© *</label>
                        <input type="text" id="final-price" required
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="ì˜ˆ: 350,000ì›">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì ˆì•½ ê¸ˆì•¡</label>
                        <input type="text" id="savings" readonly
                               class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50"
                               placeholder="ìë™ ê³„ì‚°ë©ë‹ˆë‹¤">
                    </div>
                </div>

                <!-- í‰ì  -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë§Œì¡±ë„ *</label>
                    <div class="flex space-x-2" id="rating-stars">
                        <button type="button" class="text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="1">â­</button>
                        <button type="button" class="text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="2">â­</button>
                        <button type="button" class="text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="3">â­</button>
                        <button type="button" class="text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="4">â­</button>
                        <button type="button" class="text-3xl text-gray-300 hover:text-yellow-400 transition" data-rating="5">â­</button>
                    </div>
                    <input type="hidden" id="rating" required>
                </div>

                <!-- í›„ê¸° ë‚´ìš© -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">í›„ê¸° ë‚´ìš© *</label>
                    <textarea id="review-content" required rows="5"
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="ì œí’ˆì— ëŒ€í•œ ì†”ì§í•œ í›„ê¸°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”. êµ¬ë§¤ ê³¼ì •, ì œí’ˆ í’ˆì§ˆ, ë°°ì†¡ ë“±ì— ëŒ€í•´ ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš”."></textarea>
                </div>

                <!-- ì‚¬ì§„ ì—…ë¡œë“œ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì œí’ˆ ì‚¬ì§„ (ì„ íƒì‚¬í•­)</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" id="photo-upload" multiple accept="image/*" class="hidden">
                        <button type="button" onclick="document.getElementById('photo-upload').click()" 
                                class="text-blue-600 hover:text-blue-700 font-medium">
                            ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œí•˜ê¸°
                        </button>
                        <p class="text-sm text-gray-500 mt-2">ìµœëŒ€ 5ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                    </div>
                    <div id="photo-preview" class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-4 hidden">
                        <!-- ì—…ë¡œë“œëœ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <!-- ê°œì¸ì •ë³´ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë‚˜ì´ëŒ€</label>
                        <select id="age-group" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="10ëŒ€">10ëŒ€</option>
                            <option value="20ëŒ€">20ëŒ€</option>
                            <option value="30ëŒ€">30ëŒ€</option>
                            <option value="40ëŒ€">40ëŒ€</option>
                            <option value="50ëŒ€">50ëŒ€</option>
                            <option value="60ëŒ€ ì´ìƒ">60ëŒ€ ì´ìƒ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì§ì—…</label>
                        <input type="text" id="occupation"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="ì˜ˆ: ì§ì¥ì¸, í•™ìƒ, í”„ë¦¬ëœì„œ">
                    </div>
                </div>

                <!-- ì œì¶œ ë²„íŠ¼ -->
                <div class="flex justify-center pt-6">
                    <button type="submit" 
                            class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-12 py-3 rounded-full font-bold hover:from-blue-700 hover:to-purple-700 transition-all duration-300 shadow-lg">
                        í›„ê¸° ë“±ë¡í•˜ê¸°
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyBvQZvQZvQZvQZvQZvQZvQZvQZvQZvQZvQ",
            authDomain: "pricehunter-99a1b.firebaseapp.com",
            projectId: "pricehunter-99a1b",
            storageBucket: "pricehunter-99a1b.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdefghijklmnopqrstuv"
        };

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // ì „ì—­ Firebase ì„¤ì •
        window.firebaseDb = db;
        window.firebaseFirestoreFunctions = {
            collection,
            addDoc,
            doc,
            updateDoc,
            getDocs,
            query,
            where,
            orderBy,
            serverTimestamp
        };
        
        // Firebase ì´ˆê¸°í™” ëŒ€ê¸° í•¨ìˆ˜
        async function waitForFirebase() {
            return new Promise((resolve, reject) => {
                const checkFirebase = () => {
                    if (window.firebaseDb && window.firebaseFirestoreFunctions) {
                        console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
                        resolve();
                    } else {
                        console.log('â³ Firebase ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...');
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
                
                // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
                setTimeout(() => {
                    reject(new Error('Firebase ì´ˆê¸°í™” íƒ€ì„ì•„ì›ƒ'));
                }, 10000);
            });
        }

        // ì „ì—­ ë³€ìˆ˜
        let selectedRating = 0;
        let uploadedPhotos = [];

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('loggedIn') === 'true' || localStorage.getItem('currentUser');
            if (!isLoggedIn) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'register.html';
                return false;
            }
            return true;
        }

        // ì‚¬ìš©ìì˜ ì˜ë¢° ê±´ ì¡°íšŒ
        async function loadUserRequests() {
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (!currentUser.uid) {
                    alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return [];
                }

                const { collection, getDocs, query, where } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                const requestsRef = collection(db, 'requests');
                const q = query(requestsRef, where('userId', '==', currentUser.uid));
                const snapshot = await getDocs(q);
                
                const requests = [];
                snapshot.forEach(doc => {
                    requests.push({ id: doc.id, ...doc.data() });
                });
                
                return requests;
            } catch (error) {
                console.error('ì˜ë¢° ê±´ ì¡°íšŒ ì‹¤íŒ¨:', error);
                return [];
            }
        }

        // í‰ì  ì„ íƒ
        document.querySelectorAll('#rating-stars button').forEach((star, index) => {
            star.addEventListener('click', () => {
                selectedRating = index + 1;
                document.getElementById('rating').value = selectedRating;
                
                // ë³„ì  ì‹œê°ì  ì—…ë°ì´íŠ¸
                document.querySelectorAll('#rating-stars button').forEach((s, i) => {
                    if (i < selectedRating) {
                        s.classList.remove('text-gray-300');
                        s.classList.add('text-yellow-400');
                    } else {
                        s.classList.remove('text-yellow-400');
                        s.classList.add('text-gray-300');
                    }
                });
            });
        });

        // ì ˆì•½ ê¸ˆì•¡ ìë™ ê³„ì‚°
        function calculateSavings() {
            const originalPrice = document.getElementById('original-price').value.replace(/[^0-9]/g, '');
            const finalPrice = document.getElementById('final-price').value.replace(/[^0-9]/g, '');
            
            if (originalPrice && finalPrice) {
                const savings = parseInt(originalPrice) - parseInt(finalPrice);
                const savingsPercent = Math.round((savings / parseInt(originalPrice)) * 100);
                document.getElementById('savings').value = `${savings.toLocaleString()}ì› (${savingsPercent}%)`;
            }
        }

        document.getElementById('original-price').addEventListener('input', calculateSavings);
        document.getElementById('final-price').addEventListener('input', calculateSavings);

        // ì‚¬ì§„ ì—…ë¡œë“œ ì²˜ë¦¬
        document.getElementById('photo-upload').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const preview = document.getElementById('photo-preview');
            
            if (files.length > 0) {
                preview.classList.remove('hidden');
                preview.innerHTML = '';
                
                files.slice(0, 5).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const photoDiv = document.createElement('div');
                        photoDiv.className = 'relative';
                        photoDiv.innerHTML = `
                            <img src="${e.target.result}" alt="ì—…ë¡œë“œëœ ì‚¬ì§„" class="w-full h-24 object-cover rounded-lg">
                            <button type="button" onclick="removePhoto(${index})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-sm">Ã—</button>
                        `;
                        preview.appendChild(photoDiv);
                    };
                    reader.readAsDataURL(file);
                });
                
                uploadedPhotos = files.slice(0, 5);
            }
        });

        // ì‚¬ì§„ ì œê±°
        window.removePhoto = function(index) {
            uploadedPhotos.splice(index, 1);
            const preview = document.getElementById('photo-preview');
            preview.innerHTML = '';
            
            if (uploadedPhotos.length > 0) {
                uploadedPhotos.forEach((file, i) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const photoDiv = document.createElement('div');
                        photoDiv.className = 'relative';
                        photoDiv.innerHTML = `
                            <img src="${e.target.result}" alt="ì—…ë¡œë“œëœ ì‚¬ì§„" class="w-full h-24 object-cover rounded-lg">
                            <button type="button" onclick="removePhoto(${i})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-sm">Ã—</button>
                        `;
                        preview.appendChild(photoDiv);
                    };
                    reader.readAsDataURL(file);
                });
            } else {
                preview.classList.add('hidden');
            }
        };

        // í¼ ì œì¶œ
        document.getElementById('review-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!checkLoginStatus()) return;
            
            if (selectedRating === 0) {
                alert('ë§Œì¡±ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
                await waitForFirebase();
                // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                
                // ì‚¬ì§„ URL ë°°ì—´ ìƒì„± (ì‹¤ì œë¡œëŠ” Firebase Storageì— ì—…ë¡œë“œí•´ì•¼ í•¨)
                const photoUrls = uploadedPhotos.map((file, index) => 
                    `https://images.unsplash.com/photo-${1500000000000 + index}?w=400&h=300&fit=crop`
                );
                
                // ì„ íƒëœ ì˜ë¢° ê±´ ID í™•ì¸
                const selectedRequestId = document.getElementById('request-select').value;
                if (!selectedRequestId) {
                    alert('ì˜ë¢° ê±´ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                // í›„ê¸° ë°ì´í„° ì¤€ë¹„
                const reviewData = {
                    name: currentUser.name || 'ìµëª…',
                    ageGroup: document.getElementById('age-group').value || 'ë¯¸ì…ë ¥',
                    occupation: document.getElementById('occupation').value || 'ë¯¸ì…ë ¥',
                    productName: document.getElementById('product-name').value,
                    originalPrice: document.getElementById('original-price').value,
                    finalPrice: document.getElementById('final-price').value,
                    savings: document.getElementById('savings').value.split(' ')[0],
                    savingsPercent: parseInt(document.getElementById('savings').value.match(/\d+%/)?.[0] || '0'),
                    rating: selectedRating,
                    review: document.getElementById('review-content').value,
                    photos: photoUrls,
                    country: 'ëŒ€í•œë¯¼êµ­',
                    shipping: '3ì¼',
                    method: 'PriceHunter ê²€ì¦',
                    badge: 'ì‹¤ì œ êµ¬ë§¤ì',
                    purchaseDate: document.getElementById('purchase-date').value,
                    profileImage: currentUser.profileImage || 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face',
                    approved: false, // ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸°
                    views: 0,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    userId: currentUser.uid || 'anonymous',
                    requestId: selectedRequestId // ì˜ë¢° ê±´ê³¼ ì—°ë™
                };
                
                // Firebaseì— í›„ê¸° ì €ì¥
                const { collection, addDoc, doc, updateDoc, serverTimestamp } = window.firebaseFirestoreFunctions;
                const reviewsRef = collection(window.firebaseDb, 'reviews');
                const reviewDoc = await addDoc(reviewsRef, reviewData);
                
                // ì˜ë¢° ê±´ì— í›„ê¸° ì‘ì„± ìƒíƒœ ì—…ë°ì´íŠ¸
                const requestRef = doc(window.firebaseDb, 'requests', selectedRequestId);
                await updateDoc(requestRef, {
                    reviewId: reviewDoc.id,
                    reviewStatus: 'pending', // pending, approved, rejected
                    reviewCreatedAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                
                alert('í›„ê¸°ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë¦¬ë·° í˜ì´ì§€ì— ê²Œì‹œë©ë‹ˆë‹¤.');
                window.location.href = 'reviews.html';
                
            } catch (error) {
                console.error('í›„ê¸° ë“±ë¡ ì‹¤íŒ¨:', error);
                alert('í›„ê¸° ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        });

        // ì˜ë¢° ê±´ ì„ íƒ ì‹œ ì •ë³´ ìë™ ì…ë ¥
        document.getElementById('request-select').addEventListener('change', function() {
            const selectedRequestId = this.value;
            if (selectedRequestId) {
                // ì„ íƒëœ ì˜ë¢° ê±´ì˜ ì •ë³´ë¥¼ í¼ì— ìë™ ì…ë ¥
                loadRequestDetails(selectedRequestId);
            }
        });

        // ì˜ë¢° ê±´ ìƒì„¸ ì •ë³´ ë¡œë“œ
        async function loadRequestDetails(requestId) {
            try {
                const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                const requestRef = doc(db, 'requests', requestId);
                const requestSnap = await getDoc(requestRef);
                
                if (requestSnap.exists()) {
                    const requestData = requestSnap.data();
                    
                    // í¼ì— ì •ë³´ ìë™ ì…ë ¥
                    document.getElementById('product-name').value = requestData.productName || '';
                    document.getElementById('original-price').value = requestData.originalPrice || '';
                    document.getElementById('final-price').value = requestData.finalPrice || '';
                    
                    // ì ˆì•½ ê¸ˆì•¡ ìë™ ê³„ì‚°
                    calculateSavings();
                }
            } catch (error) {
                console.error('ì˜ë¢° ê±´ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ì˜ë¢° ê±´ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async function() {
            if (!checkLoginStatus()) {
                return;
            }
            
            // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('purchase-date').value = today;
            
            // ì‚¬ìš©ìì˜ ì˜ë¢° ê±´ ë¡œë“œ
            await loadUserRequestsForSelect();
        });

        // ì˜ë¢° ê±´ ì„ íƒ ì˜µì…˜ ë¡œë“œ
        async function loadUserRequestsForSelect() {
            const requests = await loadUserRequests();
            const selectElement = document.getElementById('request-select');
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ì˜µì…˜ ì œì™¸)
            while (selectElement.children.length > 1) {
                selectElement.removeChild(selectElement.lastChild);
            }
            
            if (requests.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'ì˜ë¢°í•˜ì‹  ê±´ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì˜ë¢°ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.';
                option.disabled = true;
                selectElement.appendChild(option);
                return;
            }
            
            // ì˜ë¢° ê±´ ì˜µì…˜ ì¶”ê°€
            requests.forEach(request => {
                const option = document.createElement('option');
                option.value = request.id;
                option.textContent = `${request.productName} - ${request.originalPrice} â†’ ${request.finalPrice}`;
                selectElement.appendChild(option);
            });
        }
    </script>
</body>
</html>
