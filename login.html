<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>로그인 - PriceHunter</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ec4899'><path d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/></svg>">
    
    <!-- 캐시 제어 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <!-- Content Security Policy - Firebase iframe 허용 -->
    <meta http-equiv="Content-Security-Policy" content="frame-src 'self' https://www.google.com https://recaptcha.google.com https://kauth.kakao.com https://pricehunter-99a1b.firebaseapp.com https://*.firebaseapp.com https://*.googleapis.com https://apis.google.com https://*.firebaseapp.com; connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firebasestorage.googleapis.com https://content-firebaseappcheck.googleapis.com https://www.googleapis.com https://*.firebaseio.com wss://*.firebaseio.com https://developers.kakao.com https://kapi.kakao.com https://kauth.kakao.com https://*.firebaseapp.com https://*.cloudfunctions.net https://api.emailjs.com https://www.gstatic.com https://*.gstatic.com https://apis.google.com https://*.googleapis.com;" />
    
    <meta name="cache-buster" content="v1.0-20241220" />
    <script>
      // 강제 캐시 무효화 및 디버깅
      console.log('🚀 login.html v1.0 로드됨');
      console.log('📍 현재 URL:', window.location.href);
      console.log('🕐 로드 시간:', new Date().toISOString());
      
      // 더 강력한 캐시 버스터
      if (window.location.search.indexOf('v=') === -1) {
        console.log('🔄 강력한 캐시 버스터 추가 중...');
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(7);
        window.location.href = window.location.href + (window.location.search ? '&' : '?') + 'v=' + timestamp + '&r=' + random;
      }
      
      // 페이지 로드 완료 확인
      window.addEventListener('load', function() {
        console.log('✅ 페이지 로드 완료 - v1.0');
      });
    </script>
  
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase v9 SDK (모듈식) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, getDocs, where, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyDBZxKyMS7eeBTbPnbZkj0WWOZQHNldoL4",
      authDomain: "pricehunter-99a1b.firebaseapp.com",
      projectId: "pricehunter-99a1b",
      storageBucket: "pricehunter-99a1b.firebasestorage.app",
      messagingSenderId: "242265693919",
      appId: "1:242265693919:web:74234d942b82a51541136a",
      measurementId: "G-4BKLV4EVB9"
    };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 전역 변수로 노출
    window.firebaseApp = app;
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebaseAuthFunctions = { 
      signInWithCustomToken, 
      onAuthStateChanged, 
      signOut 
    };
    window.firebaseFirestoreFunctions = { 
      collection, 
      addDoc, 
      serverTimestamp, 
      getDocs, 
      where, 
      query, 
      deleteDoc,
      getDoc,
      setDoc,
      doc
    };
    window.firebase = {
      firestore: () => db,
      auth: () => auth,
      apps: [app],
      app: () => app,
      firestore: {
        FieldValue: {
          serverTimestamp: serverTimestamp
        }
      }
    };

    console.log('✅ Firebase v9 초기화 완료 (login.html)');
  </script>
  
  <style>
    body {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    body, div, p, h1, h2, h3, h4, h5, h6, span, label {
      caret-color: transparent;
    }
    
    input, textarea {
      caret-color: auto;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
      .fade-in-up {
      animation: fadeInUp 0.6s ease-out;
    }

      .loading {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
  </style>
</head>

  <body class="bg-gradient-to-br from-pink-50 to-blue-50 min-h-screen">
  <!-- 헤더 -->
    <header class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center">
            <a href="index.html" class="text-2xl font-bold text-pink-600">PriceHunter</a>
          </div>
          <nav class="hidden md:flex space-x-8">
            <a href="index.html" class="text-gray-600 hover:text-pink-600">홈</a>
            <a href="about.html" class="text-gray-600 hover:text-pink-600">소개</a>
            <a href="contact.html" class="text-gray-600 hover:text-pink-600">문의</a>
          </nav>
      </div>
    </div>
  </header>

  <!-- 메인 콘텐츠 -->
    <main class="max-w-4xl mx-auto px-4 py-12 mx-4">
      <div class="text-center mb-12 fade-in-up">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">로그인</h1>
        <p class="text-lg text-gray-600">PriceHunter에<br class="sm:hidden">다시 오신 것을 환영합니다!</p>
    </div>

      <!-- 로그인 폼 -->
      <div class="max-w-xs sm:max-w-sm md:max-w-md mx-auto bg-white rounded-2xl shadow-lg p-4 sm:p-6 md:p-8 mx-4 fade-in-up">
        <div class="mb-6">
          <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
            <span class="text-2xl">🔐</span>
        </div>
          <h3 class="text-xl font-semibold text-gray-900 mb-2 text-center">로그인</h3>
          <p class="text-gray-600 text-center">이메일과 비밀번호를<br class="sm:hidden">입력해주세요</p>
      </div>

      <form id="login-form" class="space-y-6">
        <!-- 이메일 -->
        <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">이메일</label>
            <input type="email" id="email" name="email" required placeholder="example@email.com"
                   class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent text-sm sm:text-base">
        </div>

        <!-- 비밀번호 -->
        <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">비밀번호</label>
            <input type="password" id="password" name="password" required
                   class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent text-sm sm:text-base">
        </div>

        <!-- 로그인 버튼 -->
          <button type="submit" id="login-button"
                  class="w-full bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 sm:py-3 px-4 sm:px-6 rounded-lg transition duration-200 text-sm sm:text-base">
            로그인
        </button>
      </form>

      <!-- 오류 메시지 -->
      <div id="login-error" class="text-red-500 text-center mt-4 hidden">
        <span>이메일 또는 비밀번호가 올바르지 않습니다.</span>
      </div>
      
      <!-- 테스트 사용자 생성 버튼 (개발용) -->
      <div class="mt-4 text-center">
        <button id="create-test-user" class="text-xs text-gray-500 hover:text-gray-700 underline">
          테스트 사용자 생성
        </button>
      </div>
    </div>

    <!-- 회원가입 링크 -->
    <div class="max-w-xs sm:max-w-sm md:max-w-md mx-auto text-center mt-8 mx-4">
      <p class="text-gray-600 mb-4">계정이 없으신가요?</p>
      <a href="register.html" class="inline-block bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition">회원가입하기</a>
      
    </div>
  </main>

  <script>
      // Firebase 초기화 대기
      function waitForFirebase() {
        return new Promise((resolve, reject) => {
          console.log('🔍 Firebase 상태 확인:', {
            firebaseDefined: typeof firebase !== 'undefined',
            firebaseApps: firebase ? firebase.apps.length : 0,
            windowFirebaseApp: !!window.firebaseApp,
            windowFirebaseDb: !!window.firebaseDb,
            windowFirebaseAuth: !!window.firebaseAuth,
            firebaseFirestoreFunctions: !!window.firebaseFirestoreFunctions
          });
          
          if (window.firebaseApp && window.firebaseDb && window.firebaseAuth && window.firebaseFirestoreFunctions) {
            console.log('✅ Firebase v9 준비됨');
            resolve();
          } else {
            const checkInterval = setInterval(() => {
              if (window.firebaseApp && window.firebaseDb && window.firebaseAuth && window.firebaseFirestoreFunctions) {
                clearInterval(checkInterval);
                console.log('✅ Firebase v9 준비됨');
                resolve();
              }
            }, 100);
            
            // 10초 후 타임아웃
            setTimeout(() => {
              clearInterval(checkInterval);
              console.error('❌ Firebase 초기화 타임아웃');
              reject(new Error('Firebase 초기화 실패'));
            }, 10000);
          }
        });
      }

      // 사용자 데이터를 Firebase에서 검색
      async function findUserByEmail(email) {
        try {
          console.log('🔍 Firebase에서 사용자 검색 중:', email);
          await waitForFirebase();
          
          const db = window.firebaseDb;
          const { collection, query, where, getDocs } = window.firebaseFirestoreFunctions;
          const usersRef = collection(db, 'users');
          
          // 이메일로 사용자 검색
          const emailQuery = query(usersRef, where('email', '==', email));
          const emailSnapshot = await getDocs(emailQuery);
          
          if (!emailSnapshot.empty) {
            const userDoc = emailSnapshot.docs[0];
            const userData = userDoc.data();
            console.log('✅ Firebase에서 사용자 찾음:', userData.email);
            return userData;
          }
          
          console.log('❌ Firebase에서 사용자를 찾을 수 없음:', email);
          return null;
        } catch (error) {
          console.error('❌ Firebase 사용자 검색 실패:', error);
          return null;
        }
      }

      // 사용자 데이터 upsert 함수
      async function upsertUser(userData, extra = {}) {
        try {
          await waitForFirebase();
          
          const db = window.firebaseDb;
          const { collection, addDoc, setDoc, serverTimestamp } = window.firebaseFirestoreFunctions;
          const usersRef = collection(db, 'users');
          
          const userDocData = {
            uid: userData.uid,
            email: userData.email,
            displayName: userData.displayName || userData.name || userData.nickname || '',
            photoURL: userData.photoURL || userData.profileImage || '',
            loginMethod: userData.loginMethod || 'email',
            createdAt: userData.createdAt || new Date(),
            updatedAt: new Date(),
            isActive: true,
            ...extra
          };
          
          // 사용자 문서 ID 생성 (이메일 기반)
          const docId = `email_${userData.email.replace('@', '_').replace('.', '_')}`;
          const userDocRef = doc(usersRef, docId);
          
          // 문서 설정 (upsert)
          await setDoc(userDocRef, userDocData, { merge: true });
          console.log('✅ 사용자 데이터 upsert 완료:', docId);
          
          return userDocData;
        } catch (error) {
          console.error('❌ 사용자 데이터 upsert 실패:', error);
          throw error;
        }
      }

      // 입력값 검증
      function validateInput(value, type) {
        if (!value || value.trim() === '') return false;
        
        switch (type) {
          case 'email':
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(value.trim());
          case 'password':
            return value.length >= 6;
          default:
            return true;
        }
      }

      // 입력값 정리
      function sanitizeInput(input) {
        return input.trim().replace(/[<>]/g, '');
      }

      // 토스트 메시지 표시
      function showToast(message, type = 'info') {
        // 간단한 토스트 구현
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
          type === 'success' ? 'bg-green-500' : 
          type === 'error' ? 'bg-red-500' : 
          'bg-blue-500'
        }`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 3000);
      }

      // 로그인 시도 제한
      let loginAttempts = 0;
      const maxLoginAttempts = 5;
      let lockoutTime = 0;
      
      function canAttemptLogin() {
        const now = Date.now();
        if (lockoutTime > now) {
          const remainingTime = Math.ceil((lockoutTime - now) / 1000 / 60);
          showToast(`로그인 시도가 제한되었습니다. ${remainingTime}분 후 다시 시도해주세요.`, 'error');
          return false;
        }
        return true;
      }
      
      function recordLoginAttempt(success) {
        if (success) {
          loginAttempts = 0;
          lockoutTime = 0;
        } else {
          loginAttempts++;
          if (loginAttempts >= maxLoginAttempts) {
            lockoutTime = Date.now() + (15 * 60 * 1000); // 15분 제한
            showToast('로그인 시도가 너무 많습니다. 15분 후 다시 시도해주세요.', 'error');
          }
        }
      }

      // 이벤트 리스너 등록
      document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 login.html v1.0 로드됨');
        
        // 로그인 폼 제출
        document.getElementById('login-form').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const loginStartTime = performance.now();
          console.log('🚀 로그인 프로세스 시작');
          
          const email = sanitizeInput(document.getElementById('email').value.trim());
          const password = document.getElementById('password').value;
          
          // 입력값 검증
          if (!validateInput(email, 'email')) {
            showToast('올바른 이메일 주소를 입력해주세요', 'error');
            return;
          }
          
          if (!validateInput(password, 'password')) {
            showToast('비밀번호를 올바르게 입력해주세요', 'error');
            return;
          }
          
          // 로그인 시도 제한 확인
          if (!canAttemptLogin()) {
            return;
          }
          
          // 로그인 버튼 비활성화
          const loginButton = document.getElementById('login-button');
          loginButton.disabled = true;
          loginButton.textContent = '로그인 중...';
          loginButton.classList.add('loading');
          
          try {
            // Firebase에서 사용자 검색
            console.log('🔍 로그인 시도 - 검색할 이메일:', email);
            const user = await findUserByEmail(email);
            
            // 디버깅을 위한 사용자 정보 출력
            if (user) {
              console.log('👤 찾은 사용자 정보:', {
                email: user.email,
                name: user.name,
                hasPassword: !!user.password,
                uid: user.uid
              });
            }
            
            if (!user) {
              console.log('❌ 사용자를 찾을 수 없음');
              document.getElementById('login-error').classList.remove('hidden');
              recordLoginAttempt(false);
              showToast('이메일 또는 비밀번호가 올바르지 않습니다.', 'error');
              return;
            }
            
            // 비밀번호 검증
            console.log('🔍 비밀번호 검증:', {
              hasPassword: !!user.password,
              userPassword: user.password ? '***' : 'null',
              inputPassword: password ? '***' : 'null',
              passwordMatch: user.password === password
            });
            
            // 비밀번호 검증 (회원가입 시 비밀번호는 필수이므로 반드시 있어야 함)
            if (user.password !== password) {
              console.log('❌ 비밀번호 불일치');
              document.getElementById('login-error').classList.remove('hidden');
              recordLoginAttempt(false);
              showToast('이메일 또는 비밀번호가 올바르지 않습니다.', 'error');
              return;
            }
            console.log('✅ 비밀번호 일치');
            
            // 로그인 성공 처리
            const userData = {
              uid: user.uid || `email_${user.email.replace('@', '_').replace('.', '_')}`,
              email: user.email,
              displayName: user.name || user.displayName || '',
              photoURL: user.photoURL || '',
              loginMethod: 'email'
            };

            // Firestore에 사용자 데이터 upsert
            await upsertUser(userData, {
              lastLogin: new Date(),
              loginCount: (user.loginCount || 0) + 1
            });

            // 로컬 스토리지에 로그인 정보 저장
            localStorage.setItem('loggedIn', 'true');
            localStorage.setItem('currentUser', JSON.stringify(userData));
            localStorage.setItem('user', JSON.stringify(userData)); // 마이페이지 호환성
            localStorage.setItem('loggedInEmail', userData.email);
            
            const totalLoginTime = performance.now() - loginStartTime;
            console.log(`🎉 로그인 성공! 총 소요시간: ${totalLoginTime.toFixed(2)}ms`);
            recordLoginAttempt(true);
            showToast(`로그인 성공! (${totalLoginTime.toFixed(0)}ms)`, 'success');
            
            // 메인 페이지로 리다이렉트
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 1000);
            
          } catch (error) {
            console.error('❌ 로그인 실패:', error);
            document.getElementById('login-error').classList.remove('hidden');
            recordLoginAttempt(false);
            showToast('로그인 처리 중 오류가 발생했습니다', 'error');
          } finally {
            // 로그인 버튼 활성화
            loginButton.disabled = false;
            loginButton.textContent = '로그인';
            loginButton.classList.remove('loading');
          }
        });
        
        // 테스트 사용자 생성 버튼
        document.getElementById('create-test-user').addEventListener('click', async function() {
          const testEmail = 'test@example.com';
          const testPassword = '123456';
          
          try {
            await waitForFirebase();
            
            const db = window.firebaseDb;
            const { collection, addDoc, serverTimestamp } = window.firebaseFirestoreFunctions;
            const usersRef = collection(db, 'users');
            
            // 테스트 사용자 데이터
            const testUserData = {
              uid: `email_${testEmail.replace('@', '_').replace('.', '_')}`,
              email: testEmail,
              name: '테스트 사용자',
              displayName: '테스트 사용자',
              phone: '010-1234-5678',
              password: testPassword,
              emailVerification: testEmail,
              agreeTerms: true,
              agreePrivacy: true,
              agreeMarketing: false,
              loginMethod: 'email',
              isActive: true,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            };
            
            // 중복 확인
            const { query, where, getDocs } = window.firebaseFirestoreFunctions;
            const emailQuery = query(usersRef, where('email', '==', testEmail));
            const emailSnapshot = await getDocs(emailQuery);
            
            if (!emailSnapshot.empty) {
              showToast('테스트 사용자가 이미 존재합니다.', 'info');
              return;
            }
            
            // 테스트 사용자 생성
            await addDoc(usersRef, testUserData);
            
            showToast('테스트 사용자가 생성되었습니다!\n이메일: test@example.com\n비밀번호: 123456', 'success');
            
            // 폼에 테스트 데이터 입력
            document.getElementById('email').value = testEmail;
            document.getElementById('password').value = testPassword;
            
          } catch (error) {
            console.error('테스트 사용자 생성 실패:', error);
            showToast('테스트 사용자 생성에 실패했습니다.', 'error');
          }
        });
      });
  </script>
</body>
</html>
