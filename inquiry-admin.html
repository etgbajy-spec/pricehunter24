<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>1:1 ë¬¸ì˜ ê´€ë¦¬ | PriceHunter</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase v9 SDK (ëª¨ë“ˆì‹) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyDBZxKyMS7eeBTbPnbZkj0WWOZQHNldoL4",
      authDomain: "pricehunter-99a1b.firebaseapp.com",
      projectId: "pricehunter-99a1b",
      storageBucket: "pricehunter-99a1b.firebasestorage.app",
      messagingSenderId: "242265693919",
      appId: "1:242265693919:web:74234d942b82a51541136a",
      measurementId: "G-4BKLV4EVB9"
    };

    // Firebase ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ì „ì—­ ë³€ìˆ˜ë¡œ ë…¸ì¶œ
    window.firebaseApp = app;
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebaseFirestoreFunctions = { collection, query, orderBy, onSnapshot, doc, updateDoc, serverTimestamp };

    console.log('âœ… Firebase v9 ì´ˆê¸°í™” ì™„ë£Œ (inquiry-admin.html)');
  </script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-emerald-50 to-pink-50 min-h-screen flex items-center justify-center px-2">
  <main class="w-full max-w-6xl bg-white/90 rounded-3xl shadow-2xl p-8 md:p-12 flex flex-col items-center text-center backdrop-blur-md mt-8 mb-8">
    <h1 class="text-2xl md:text-3xl font-extrabold text-blue-600 mb-6">1:1 ë¬¸ì˜ ê´€ë¦¬</h1>
    
    <!-- íšŒì›ë³„ íƒ­ ì‹œìŠ¤í…œ -->
    <div class="w-full mb-6">
      <div class="flex flex-wrap gap-2 justify-center mb-4">
        <button id="tab-all" class="tab-btn active px-4 py-2 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition" onclick="switchTab('all')">
          ì „ì²´ <span id="count-all" class="ml-1 bg-white text-blue-500 px-2 py-1 rounded text-xs">0</span>
        </button>
        <!-- íšŒì›ë³„ íƒ­ì€ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
      </div>
      
      <!-- ì§„í–‰ìƒí™© í•„í„° -->
      <div class="flex flex-wrap gap-2 justify-center mb-4">
        <button id="filter-all" class="filter-btn active px-3 py-1 bg-gray-500 text-white rounded font-bold hover:bg-gray-600 transition text-sm" onclick="switchFilter('all')">ì „ì²´</button>
        <button id="filter-new" class="filter-btn px-3 py-1 bg-red-500 text-white rounded font-bold hover:bg-red-600 transition text-sm" onclick="switchFilter('new')">ì‹ ê·œë¬¸ì˜</button>
        <button id="filter-progress" class="filter-btn px-3 py-1 bg-orange-500 text-white rounded font-bold hover:bg-orange-600 transition text-sm" onclick="switchFilter('progress')">ì§„í–‰ì¤‘</button>
        <button id="filter-complete" class="filter-btn px-3 py-1 bg-green-500 text-white rounded font-bold hover:bg-green-600 transition text-sm" onclick="switchFilter('complete')">ì™„ë£Œ</button>
      </div>
    </div>
    
    <div class="w-full mb-8">
      <div class="font-bold text-gray-700 mb-2 text-left">ì ‘ìˆ˜ëœ 1:1 ë¬¸ì˜ ëª©ë¡</div>
      <div class="flex justify-between items-center px-4 py-2 bg-blue-100 rounded-t-xl text-sm font-bold text-blue-700 flex-wrap">
        <span class="w-1/4">ë¬¸ì˜ë²ˆí˜¸/ì´ë¦„</span>
        <span class="w-1/4 text-center">ë¬¸ì˜ì¼ì‹œ</span>
        <span class="w-1/4 text-center">ì§„í–‰ìƒí™©</span>
        <span class="w-1/4 text-right">ë‹µë³€ìƒíƒœ</span>
      </div>
      <ul id="inquiry-list" class="bg-blue-50 rounded-b-xl shadow-inner divide-y divide-blue-100 text-left"></ul>
    </div>
    <!-- ë¬¸ì˜ ìƒì„¸ ëª¨ë‹¬ -->
    <div id="inquiry-modal-overlay" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
      <div id="inquiry-modal" class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto relative min-w-0">
        <button id="close-inquiry-modal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
        <h2 class="text-xl font-bold text-blue-700 mb-4">ë¬¸ì˜ ìƒì„¸</h2>
        <div class="mb-2 text-gray-700"><span class="font-semibold">ì´ë¦„:</span> <span id="modal-name"></span></div>
        <div class="mb-2 text-gray-700"><span class="font-semibold">ì´ë©”ì¼:</span> <span id="modal-email"></span></div>
        <div class="mb-2 text-gray-700"><span class="font-semibold">íœ´ëŒ€í°:</span> <span id="modal-phone"></span></div>
        <div class="mb-4 text-gray-700"><span class="font-semibold">ë¬¸ì˜ ë‚´ìš©:</span><br><span id="modal-content" class="block mt-2 whitespace-pre-line"></span></div>
        <div id="modal-file-wrap" class="mb-4"></div>
        <div class="text-xs text-gray-400 mt-2">ë¬¸ì˜ì¼ì‹œ: <span id="modal-date"></span></div>
        <div class="mt-6 text-left w-full">
          <div class="font-bold text-blue-700 mb-2">ê´€ë¦¬ì ë‹µë³€</div>
          <div id="modal-answer-view" class="mb-2 text-gray-800 whitespace-pre-line"></div>
          <form id="answer-form" class="flex flex-col gap-2 mb-2">
            <textarea id="modal-answer" rows="3" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none" placeholder="ì—¬ê¸°ì— ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”" aria-label="ë‹µë³€ ì…ë ¥"></textarea>
            <button type="submit" class="py-2 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition w-full md:w-auto" aria-label="ë‹µë³€ ì €ì¥">ë‹µë³€ ì €ì¥</button>
          </form>
          <button id="delete-inquiry-btn" class="py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition w-full md:w-auto" aria-label="ë¬¸ì˜ ì‚­ì œ">ë¬¸ì˜ ì‚­ì œ</button>
          <div class="mt-6 border-t pt-4">
            <div class="font-bold text-blue-700 mb-3 text-lg">ğŸ’¬ ì¶”ê°€ ëŒ“ê¸€</div>
            <div class="bg-gray-50 rounded-lg p-3 mb-3">
              <ul id="modal-comments-list" class="space-y-2"></ul>
            </div>
            <form id="comment-form" class="flex gap-2">
              <input id="modal-comment-input" type="text" class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..." aria-label="ëŒ“ê¸€ ì…ë ¥" />
              <button type="submit" class="px-4 py-2 bg-emerald-500 text-white rounded-lg font-bold hover:bg-emerald-600 transition" aria-label="ëŒ“ê¸€ ì¶”ê°€">ë‹µë³€</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>
  <script>
    // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
    const style = document.createElement('style');
    style.textContent = `
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .tab-btn.active {
        background-color: #3b82f6;
        color: white;
      }
      .filter-btn.active {
        background-color: #6b7280;
        color: white;
      }
    `;
    document.head.appendChild(style);
    
    // ì „ì—­ ë³€ìˆ˜
    let currentTab = 'all';
    let currentFilter = 'all';
    let allInquiries = [];
    
    // Firebase ì´ˆê¸°í™” ëŒ€ê¸° í•¨ìˆ˜
    async function waitForFirebase() {
      return new Promise((resolve, reject) => {
        console.log('ğŸ”„ Firebase ì´ˆê¸°í™” ìƒíƒœ í™•ì¸:', {
          firebaseApp: !!window.firebaseApp,
          firebaseDb: !!window.firebaseDb,
          firebaseFirestoreFunctions: !!window.firebaseFirestoreFunctions
        });
        
        if (window.firebaseApp && window.firebaseDb && window.firebaseFirestoreFunctions) {
          console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
          resolve();
        } else {
          const checkInterval = setInterval(() => {
            if (window.firebaseApp && window.firebaseDb && window.firebaseFirestoreFunctions) {
              clearInterval(checkInterval);
              console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
              resolve();
            }
          }, 100);
          
          setTimeout(() => {
            clearInterval(checkInterval);
            console.error('âŒ Firebase ì´ˆê¸°í™” íƒ€ì„ì•„ì›ƒ');
            reject(new Error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨'));
          }, 10000);
        }
      });
    }

    // Firebaseì—ì„œ ë¬¸ì˜ ëª©ë¡ ì¡°íšŒ
    async function getFirebaseInquiries() {
      try {
        await waitForFirebase();
        
        const { collection, query, orderBy, onSnapshot } = window.firebaseFirestoreFunctions;
        const inquiriesRef = collection(window.firebaseDb, 'inquiries');
        const q = query(inquiriesRef, orderBy('createdAt', 'desc'));
        
        return new Promise((resolve, reject) => {
          const unsubscribe = onSnapshot(q, (snapshot) => {
            const firebaseInquiries = [];
            snapshot.forEach((doc) => {
              const data = doc.data();
              firebaseInquiries.push({
                key: doc.id,
                id: doc.id,
                ...data,
                source: 'Firebase',
                date: data.createdAt ? 
                  (data.createdAt.seconds ? new Date(data.createdAt.seconds * 1000).toLocaleString() : new Date(data.createdAt).toLocaleString()) :
                  data.date
              });
            });
            resolve(firebaseInquiries);
          }, (error) => {
            console.error('Firebase ë¬¸ì˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
            resolve([]);
          });
        });
      } catch (error) {
        console.error('Firebase ë¬¸ì˜ ì¡°íšŒ ì˜¤ë¥˜:', error);
        return [];
      }
    }

    // localStorageì—ì„œ ë¬¸ì˜ ëª©ë¡ ì¡°íšŒ
    function getLocalStorageInquiries() {
      const list = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('inquiry-')) {
          const inquiry = JSON.parse(localStorage.getItem(key));
          list.push({ key, ...inquiry, source: 'localStorage' });
        }
      }
      return list;
    }

    // í†µí•© ë¬¸ì˜ ëª©ë¡ ì¡°íšŒ (Firebase + localStorage)
    async function getInquiryList() {
      try {
        // Firebaseì™€ localStorageì—ì„œ ë™ì‹œì— ì¡°íšŒ
        const [firebaseInquiries, localStorageInquiries] = await Promise.all([
          getFirebaseInquiries(),
          Promise.resolve(getLocalStorageInquiries())
        ]);
        
        // ì¤‘ë³µ ì œê±° (Firebase ìš°ì„ )
        const allInquiries = [...firebaseInquiries];
        const firebaseKeys = new Set(firebaseInquiries.map(inq => inq.subject + inq.date));
        
        localStorageInquiries.forEach(localInq => {
          const key = localInq.subject + localInq.date;
          if (!firebaseKeys.has(key)) {
            allInquiries.push(localInq);
          }
        });
        
        // ìµœì‹ ìˆœ ì •ë ¬
        return allInquiries.sort((a, b) => {
          const dateA = a.timestamp || (a.createdAt ? (a.createdAt.seconds ? a.createdAt.seconds * 1000 : new Date(a.createdAt).getTime()) : 0);
          const dateB = b.timestamp || (b.createdAt ? (b.createdAt.seconds ? b.createdAt.seconds * 1000 : new Date(b.createdAt).getTime()) : 0);
          return dateB - dateA;
        });
      } catch (error) {
        console.error('ë¬¸ì˜ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
        // ì˜¤ë¥˜ ì‹œ localStorageë§Œ ë°˜í™˜
        return getLocalStorageInquiries();
      }
    }
    
    function formatDateTime(dt) {
      if (!dt) return '';
      const d = new Date(dt);
      if (isNaN(d.getTime())) return dt;
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const h = String(d.getHours()).padStart(2,'0');
      const min = String(d.getMinutes()).padStart(2,'0');
      return `${y}-${m}-${day} ${h}:${min}`;
    }
    
    // ì§„í–‰ìƒí™© íŒë‹¨ í•¨ìˆ˜
    function getInquiryStatus(inq) {
      if (!inq.answer) {
        return { status: 'new', text: 'ì‹ ê·œë¬¸ì˜', color: 'bg-red-500', textColor: 'text-red-500' };
      }
      
      if (inq.comments && inq.comments.length > 0) {
        const lastComment = inq.comments[inq.comments.length - 1];
        if (lastComment.author !== 'ê´€ë¦¬ì') {
          return { status: 'progress', text: 'ì§„í–‰ì¤‘', color: 'bg-orange-500', textColor: 'text-orange-500' };
        }
      }
      
      return { status: 'complete', text: 'ì™„ë£Œ', color: 'bg-green-500', textColor: 'text-green-500' };
    }
    
    // íšŒì›ë³„ íƒ­ ìƒì„±
    function createUserTabs() {
      const users = {};
      allInquiries.forEach(inq => {
        const userName = inq.name || 'ìµëª…';
        if (!users[userName]) {
          users[userName] = { name: userName, count: 0 };
        }
        users[userName].count++;
      });
      
      const tabContainer = document.querySelector('.flex.flex-wrap.gap-2.justify-center');
      const allTab = tabContainer.querySelector('#tab-all');
      tabContainer.innerHTML = '';
      tabContainer.appendChild(allTab);
      
      Object.values(users).forEach(user => {
        const tab = document.createElement('button');
        tab.className = 'tab-btn px-4 py-2 bg-gray-300 text-gray-700 rounded-lg font-bold hover:bg-gray-400 transition';
        tab.onclick = () => switchTab(user.name);
        tab.innerHTML = `${user.name} <span class="ml-1 bg-white text-gray-700 px-2 py-1 rounded text-xs">${user.count}</span>`;
        tabContainer.appendChild(tab);
      });
    }
    
    // íƒ­ ì „í™˜
    function switchTab(userName) {
      currentTab = userName;
      
      // íƒ­ ë²„íŠ¼ í™œì„±í™”
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      renderInquiryList();
    }
    
    // í•„í„° ì „í™˜
    function switchFilter(status) {
      currentFilter = status;
      
      // í•„í„° ë²„íŠ¼ í™œì„±í™”
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      renderInquiryList();
    }
    
    async function renderInquiryList() {
      allInquiries = await getInquiryList();
      
      // íƒ­ë³„ í•„í„°ë§
      let filteredInquiries = allInquiries;
      if (currentTab !== 'all') {
        filteredInquiries = allInquiries.filter(inq => inq.name === currentTab);
      }
      
      // ì§„í–‰ìƒí™©ë³„ í•„í„°ë§
      if (currentFilter !== 'all') {
        filteredInquiries = filteredInquiries.filter(inq => {
          const status = getInquiryStatus(inq);
          return status.status === currentFilter;
        });
      }
      
      // ìš°ì„ ìˆœìœ„ ì •ë ¬ (ì‹ ê·œë¬¸ì˜ â†’ ì§„í–‰ì¤‘ â†’ ì™„ë£Œ)
      filteredInquiries.sort((a, b) => {
        const statusA = getInquiryStatus(a);
        const statusB = getInquiryStatus(b);
        const priority = { new: 3, progress: 2, complete: 1 };
        return priority[statusB.status] - priority[statusA.status];
      });
      
      const ul = document.getElementById('inquiry-list');
      ul.innerHTML = '';
      
      if (filteredInquiries.length === 0) {
        ul.innerHTML = '<li class="py-4 text-center text-gray-400">í•´ë‹¹í•˜ëŠ” ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
        return;
      }
      
      filteredInquiries.forEach(inq => {
        const li = document.createElement('li');
        li.className = 'py-3 px-4 hover:bg-blue-100 cursor-pointer flex justify-between items-center flex-wrap min-h-0';
        
        // ìƒˆë¡œìš´ ëŒ“ê¸€ í™•ì¸ ë¡œì§ (íšŒì› ëŒ“ê¸€ë§Œ ì²´í¬)
        const newCommentsCount = getNewUserCommentsCount(inq);
        const newCommentBadge = newCommentsCount > 0 ? 
          `<span style="display: inline-block; width: 24px; height: 24px; background-color: #ff0000; color: white; border-radius: 50%; text-align: center; line-height: 24px; font-size: 14px; font-weight: bold; margin-left: 8px; animation: pulse 2s infinite; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.3);" title="íšŒì› ìƒˆ ëŒ“ê¸€ ${newCommentsCount}ê°œ">${newCommentsCount}</span>` : '';
        
        // ì§„í–‰ìƒí™©
        const status = getInquiryStatus(inq);
        const statusBadge = `<span class="px-2 py-1 rounded text-xs font-bold text-white ${status.color}">${status.text}</span>`;
        
        // ë‹µë³€ìƒíƒœ
        const answerStatus = inq.answer ? '<span class="text-emerald-600 font-bold">ë‹µë³€ì™„ë£Œ</span>' : '<span class="text-gray-400">ëŒ€ê¸°</span>';
        
        // ë°ì´í„° ì†ŒìŠ¤ í‘œì‹œ
        const dataSource = inq.source || 'localStorage';
        const dataSourceBadge = dataSource === 'Firebase' ? 
          '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Firebase</span>' :
          '<span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">Local</span>';

        const htmlContent = `
          <span class="w-1/4 truncate flex items-center" style="min-width: 0;">
            <span class="font-semibold text-blue-600">${inq.key.replace('inquiry-','')}</span> | 
            <span class="text-gray-700">${inq.name || ''}</span>
          </span>
          <span class="w-1/4 text-center text-xs text-gray-400">${formatDateTime(inq.date)}</span>
          <span class="w-1/4 text-center">${statusBadge}</span>
          <span class="w-1/4 text-right flex items-center justify-end gap-2">
            ${dataSourceBadge}
            ${answerStatus}
            ${newCommentBadge}
          </span>
        `;
        
        li.innerHTML = htmlContent;
        li.onclick = function() { showInquiryModal(inq); };
        ul.appendChild(li);
      });
      
      // ì „ì²´ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
      updateCounts();
    }
    
    // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    function updateCounts() {
      const counts = { all: 0, new: 0, progress: 0, complete: 0 };
      
      allInquiries.forEach(inq => {
        counts.all++;
        const status = getInquiryStatus(inq);
        counts[status.status]++;
      });
      
      document.getElementById('count-all').textContent = counts.all;
    }
    
    // íšŒì›ì´ ë‹¨ ìƒˆë¡œìš´ ëŒ“ê¸€ ê°œìˆ˜ ê³„ì‚° í•¨ìˆ˜
    function getNewUserCommentsCount(inq) {
      if (!inq.comments || inq.comments.length === 0) return 0;
      
      const lastChecked = inq.lastChecked || 0;
      // ê´€ë¦¬ìê°€ ì•„ë‹Œ ëŒ“ê¸€ë§Œ í•„í„°ë§ (íšŒì› ëŒ“ê¸€)
      const userComments = inq.comments.filter(c => c.author !== 'ê´€ë¦¬ì');
      
      // ê´€ë¦¬ì ëŒ“ê¸€ì´ ìˆê³ , lastCheckedê°€ ìµœì‹ ì´ë©´ ìƒˆë¡œìš´ ì•Œë¦¼ ì œê±°
      const hasAdminComment = inq.comments.some(c => c.author === 'ê´€ë¦¬ì');
      const maxUserCommentTime = userComments.length > 0 ? Math.max(...userComments.map(c => c.date || 0)) : 0;
      
      if (hasAdminComment && lastChecked >= maxUserCommentTime) {
        console.log('ê´€ë¦¬ì ëŒ“ê¸€ ì¡´ì¬ + lastChecked ìµœì‹  - ìƒˆë¡œìš´ ì•Œë¦¼ ì œê±°:', inq.key, 'lastChecked:', lastChecked, 'maxUserCommentTime:', maxUserCommentTime);
        return 0;
      }
      
      // lastCheckedê°€ ì˜ëª» ì„¤ì •ëœ ê²½ìš° ê°ì§€ (ëª¨ë“  ëŒ“ê¸€ë³´ë‹¤ í° ê²½ìš°)
      const maxCommentTime = Math.max(...userComments.map(c => c.date || 0));
      if (lastChecked > maxCommentTime && userComments.length > 0) {
        // lastCheckedë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì—¬ ëª¨ë“  ëŒ“ê¸€ì„ ìƒˆë¡œìš´ ëŒ“ê¸€ë¡œ í‘œì‹œ
        const updated = {...inq, lastChecked: 0};
        localStorage.setItem(inq.key, JSON.stringify(updated));
        return userComments.length; // ëª¨ë“  íšŒì› ëŒ“ê¸€ì„ ìƒˆë¡œìš´ ëŒ“ê¸€ë¡œ í‘œì‹œ
      }
      
      const newUserComments = userComments.filter(c => (c.date || 0) > lastChecked);
      
      console.log('ìƒˆë¡œìš´ ëŒ“ê¸€ ì²´í¬:', inq.key, 'lastChecked:', lastChecked, 'íšŒì›ëŒ“ê¸€:', userComments.length, 'ìƒˆëŒ“ê¸€:', newUserComments.length, 'íšŒì›ëŒ“ê¸€ì‹œê°„ë“¤:', userComments.map(c => c.date));
      
      // ë””ë²„ê¹…: ê° ëŒ“ê¸€ì˜ ì‹œê°„ê³¼ lastChecked ë¹„êµ
      userComments.forEach((c, i) => {
        console.log(`ëŒ“ê¸€ ${i}: ${c.date} > ${lastChecked} = ${(c.date || 0) > lastChecked}`);
      });
      
      return newUserComments.length;
    }
    
    // ìƒˆë¡œìš´ ëŒ“ê¸€ í™•ì¸ í•¨ìˆ˜ (ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€)
    function checkNewComments(inq) {
      return getNewUserCommentsCount(inq) > 0;
    }
    
    // ë¬¸ì˜ í™•ì¸ ì‹œ lastChecked ì—…ë°ì´íŠ¸
    function updateLastChecked(inq) {
      if (inq.comments && inq.comments.length > 0) {
        const lastCommentTime = Math.max(...inq.comments.map(c => c.date || 0));
        const updated = {...inq, lastChecked: lastCommentTime};
        localStorage.setItem(inq.key, JSON.stringify(updated));
      }
    }
    
    // íŠ¹ì • ëŒ“ê¸€ì— ë‹µë³€í•˜ëŠ” í•¨ìˆ˜
    function replyToComment(commentIndex, authorName, commentText) {
      const input = document.getElementById('modal-comment-input');
      input.value = '';
      input.focus();
      
      // ë‹µë³€ ëŒ€ìƒ ëŒ“ê¸€ ì •ë³´ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
      window.replyingToComment = {
        index: commentIndex,
        author: authorName,
        text: commentText
      };
    }
    
    function showInquiryModal(inq) {
      // ë¬¸ì˜ë¥¼ ì—´ ë•Œ lastChecked ì—…ë°ì´íŠ¸ (ìƒˆë¡œìš´ ëŒ“ê¸€ í™•ì¸ í‘œì‹œ ì œê±°)
      updateLastChecked(inq);
      
      document.getElementById('modal-name').textContent = inq.name || '';
      document.getElementById('modal-email').textContent = inq.email || '';
      document.getElementById('modal-phone').textContent = inq.phone || '';
      document.getElementById('modal-content').textContent = inq.message || inq.content || '';
      document.getElementById('modal-date').textContent = formatDateTime(inq.date);
      // ì²¨ë¶€íŒŒì¼ í‘œì‹œ
      var fileWrap = document.getElementById('modal-file-wrap');
      fileWrap.innerHTML = '';
      if (inq.file) {
        if (inq.file.startsWith('data:image/')) {
          fileWrap.innerHTML = '<div class="mb-2"><img src="'+inq.file+'" alt="ì²¨ë¶€ ì´ë¯¸ì§€" class="max-h-40 rounded-xl border shadow w-full object-contain" /></div>';
        } else {
          // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë§í¬ ì œê³µ
          const fileName = inq.fileName || 'ì²¨ë¶€íŒŒì¼';
          fileWrap.innerHTML = '<div class="mb-2 text-gray-600">ì²¨ë¶€íŒŒì¼: <a href="'+inq.file+'" download="'+fileName+'" class="text-blue-600 underline">'+fileName+'</a></div>';
        }
      }
      // ë‹µë³€ í‘œì‹œ ë° ì…ë ¥
      document.getElementById('modal-answer').value = inq.answer || '';
      document.getElementById('modal-answer-view').textContent = inq.answer ? inq.answer : '(ì•„ì§ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤)';
      // ë‹µë³€ ì €ì¥
      var answerForm = document.getElementById('answer-form');
      answerForm.onsubmit = function(e) {
        e.preventDefault();
        var answer = document.getElementById('modal-answer').value.trim();
        document.getElementById('modal-answer-view').textContent = answer || '(ì•„ì§ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤)';
        // inquiry-...ì— ë‹µë³€ ì €ì¥
        var updated = {...inq, answer};
        localStorage.setItem(inq.key, JSON.stringify(updated));
        // contact-historyì—ë„ ë™ê¸°í™”
        let history = JSON.parse(localStorage.getItem('contact-history') || '[]');
        let changed = false;
        for (let i = 0; i < history.length; i++) {
          if (history[i].subject === inq.subject && history[i].date === inq.date) {
            history[i].answer = answer;
            changed = true;
            break;
          }
        }
        if (changed) localStorage.setItem('contact-history', JSON.stringify(history));
        alert('ë‹µë³€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        document.getElementById('modal-answer').value = '';
        setTimeout(function() {
          document.getElementById('inquiry-modal-overlay').classList.add('hidden');
          renderInquiryList(); // ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
        }, 1000);
      };
      document.getElementById('delete-inquiry-btn').onclick = function() {
        if (confirm('ì •ë§ ì´ ë¬¸ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          // inquiry-ì—ì„œ ì‚­ì œ
          localStorage.removeItem(inq.key);
          
          // contact-historyì—ì„œë„ ë™ê¸°í™”í•˜ì—¬ ì‚­ì œ
          let history = JSON.parse(localStorage.getItem('contact-history') || '[]');
          history = history.filter(item => !(item.subject === inq.subject && item.date === inq.date));
          localStorage.setItem('contact-history', JSON.stringify(history));
          
          document.getElementById('inquiry-modal-overlay').classList.add('hidden');
          renderInquiryList();
        }
      };
      // ëŒ“ê¸€ ë Œë”ë§
      function renderComments(comments) {
        const ul = document.getElementById('modal-comments-list');
        ul.innerHTML = '';
        if (!comments || comments.length === 0) {
          ul.innerHTML = '<li class="text-gray-400 text-sm italic">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
          return;
        }
        (comments||[]).forEach((c, index) => {
          const li = document.createElement('li');
          const isAdmin = c.author === 'ê´€ë¦¬ì';
          const isUserComment = !isAdmin;
          li.className = `text-sm p-3 rounded ${isAdmin ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-700'}`;
          
          // íšŒì› ëŒ“ê¸€ì—ë§Œ ë‹µë³€ ë²„íŠ¼ í‘œì‹œ
          const replyButton = isUserComment ? 
            `<button onclick="replyToComment(${index}, '${c.author}', '${c.text.replace(/'/g, "\\'")}')" class="mt-2 px-2 py-1 bg-emerald-500 text-white text-xs rounded hover:bg-emerald-600 transition">ë‹µë³€</button>` : '';
          
          // ë‹µë³€ ì •ë³´ í‘œì‹œ
          let replyInfoHtml = '';
          if (c.replyInfo && isAdmin) {
            replyInfoHtml = `
              <div class="mt-2 p-2 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                <div class="text-xs text-yellow-700 font-semibold">â†³ ${c.replyInfo.replyTo}ë‹˜ì˜ ëŒ“ê¸€ì— ë‹µë³€</div>
                <div class="text-xs text-yellow-600 mt-1">"${c.replyInfo.replyToText.substring(0, 50)}${c.replyInfo.replyToText.length > 50 ? '...' : ''}"</div>
              </div>
            `;
          }
          
          li.innerHTML = `
            <div class="font-semibold text-xs ${isAdmin ? 'text-blue-600' : 'text-gray-600'}">${c.author||'ìµëª…'}</div>
            ${replyInfoHtml}
            <div class="mt-1">${c.text}</div>
            <div class="text-xs text-gray-400 mt-1">${formatDateTime(c.date)}</div>
            ${replyButton}
          `;
          ul.appendChild(li);
        });
      }
      renderComments(inq.comments);
      // ëŒ“ê¸€ ì¶”ê°€
      document.getElementById('comment-form').onsubmit = function(e) {
        e.preventDefault();
        const input = document.getElementById('modal-comment-input');
        const text = input.value.trim();
        if (!text) return;
        const author = localStorage.getItem('isAdmin') === 'true' ? 'ê´€ë¦¬ì' : (inq.name || 'íšŒì›');
        
        // ê´€ë¦¬ìê°€ ëŒ“ê¸€ì„ ë‹¬ë©´ ìƒˆë¡œìš´ ëŒ“ê¸€ ì•Œë¦¼ ì´ˆê¸°í™”
        const isAdminComment = author === 'ê´€ë¦¬ì';
        const currentTime = Date.now();
        
        // ë‹µë³€ ëŒ€ìƒ ì •ë³´ê°€ ìˆìœ¼ë©´ ëŒ“ê¸€ì— í¬í•¨
        let replyInfo = null;
        let cleanText = text; // ì‹¤ì œ ì €ì¥í•  í…ìŠ¤íŠ¸
        
        if (window.replyingToComment && isAdminComment) {
          replyInfo = {
            replyTo: window.replyingToComment.author,
            replyToText: window.replyingToComment.text,
            replyToIndex: window.replyingToComment.index
          };
          
          // ë©˜ì…˜ í…ìŠ¤íŠ¸ ì œê±° (@ì´ë¦„ ë‚´ìš©... ë¶€ë¶„ ì œê±°)
          const mentionPattern = /^@[^\s]+\s+[^\s]+.*?\s/;
          cleanText = text.replace(mentionPattern, '').trim();
        }
        
        // ê´€ë¦¬ì ëŒ“ê¸€ì¸ ê²½ìš° ìƒˆë¡œìš´ ì•Œë¦¼ ì œê±°
        let newLastChecked = inq.lastChecked || 0;
        if (isAdminComment) {
          // ê´€ë¦¬ìê°€ ëŒ“ê¸€ì„ ë‹¬ë©´ ì¦‰ì‹œ ëª¨ë“  ìƒˆë¡œìš´ ì•Œë¦¼ ì œê±°
          // í˜„ì¬ ì‹œê°„ë³´ë‹¤ 1ì´ˆ ë’¤ë¡œ ì„¤ì •í•˜ì—¬ ëª¨ë“  ê¸°ì¡´ ëŒ“ê¸€ì„ í™•ì¸í•œ ê²ƒìœ¼ë¡œ í‘œì‹œ
          newLastChecked = currentTime + 1000;
          console.log('ê´€ë¦¬ì ëŒ“ê¸€ - ì¦‰ì‹œ ëª¨ë“  ì•Œë¦¼ ì œê±°:', 'ê¸°ì¡´ lastChecked:', inq.lastChecked, 'ìƒˆë¡œìš´ lastChecked:', newLastChecked, 'í˜„ì¬ì‹œê°„:', currentTime);
          
          // ì¶”ê°€ ë””ë²„ê¹…: íšŒì› ëŒ“ê¸€ë“¤ í™•ì¸
          const userComments = (inq.comments||[]).filter(c => c.author !== 'ê´€ë¦¬ì');
          console.log('íšŒì› ëŒ“ê¸€ë“¤:', userComments.map(c => ({author: c.author, date: c.date, text: c.text.substring(0, 20)})));
        }
        
        const updated = {
          ...inq, 
          comments: (inq.comments||[]).concat({author, text: cleanText, date: currentTime, replyInfo}),
          lastChecked: newLastChecked
        };
        
        console.log('ê´€ë¦¬ì ëŒ“ê¸€ ì¶”ê°€:', inq.key, 'isAdminComment:', isAdminComment, 'ê¸°ì¡´ lastChecked:', inq.lastChecked, 'ìƒˆë¡œìš´ lastChecked:', updated.lastChecked);
        
        localStorage.setItem(inq.key, JSON.stringify(updated));
        renderComments(updated.comments);
        input.value = '';
        
        // ë‹µë³€ ëŒ€ìƒ ì •ë³´ ì´ˆê¸°í™”
        window.replyingToComment = null;
        
        // ì¦‰ì‹œ ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨ (ìƒˆë¡œìš´ ëŒ“ê¸€ í‘œì‹œ ì—…ë°ì´íŠ¸)
        renderInquiryList();
      };
      const overlay = document.getElementById('inquiry-modal-overlay');
      overlay.classList.remove('hidden');
    }
    document.getElementById('close-inquiry-modal').onclick = function() {
      document.getElementById('inquiry-modal-overlay').classList.add('hidden');
    };
    document.getElementById('inquiry-modal-overlay').onclick = function(e) {
      if (e.target === this) this.classList.add('hidden');
    };
    
    // ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', function() {
      renderInquiryList();
      createUserTabs();
    });
  </script>
</body>
</html> 