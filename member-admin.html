<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원 관리 - 프라이스헌터</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .member-card { transition: all 0.3s ease; }
        .member-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .status-active { background: linear-gradient(135deg, #10B981, #059669); }
        .status-suspended { background: linear-gradient(135deg, #F59E0B, #D97706); }
        .status-withdrawn { background: linear-gradient(135deg, #EF4444, #DC2626); }
        .modal-backdrop { backdrop-filter: blur(5px); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 헤더 -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">회원 관리</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-gray-600 hover:text-gray-900">홈으로</a>
                    <button id="admin-logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">관리자 로그아웃</button>
                </div>
            </div>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 통계 카드 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">전체 회원</p>
                        <p id="total-members" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">활성 회원</p>
                        <p id="active-members" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">이번 달 가입</p>
                        <p id="new-members" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-red-100 rounded-lg">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">탈퇴 회원</p>
                        <p id="withdrawn-members" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 검색 및 필터 -->
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">검색</label>
                        <input type="text" id="search-input" placeholder="이름 또는 이메일로 검색" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">회원 상태</label>
                        <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">전체</option>
                            <option value="active">활성</option>
                            <option value="suspended">정지</option>
                            <option value="withdrawn">탈퇴</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">가입 방식</label>
                        <select id="login-type-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">전체</option>
                            <option value="normal">일반</option>
                            <option value="kakao">카카오</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">정렬</label>
                        <select id="sort-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="recent">최근 가입순</option>
                            <option value="old">오래된 가입순</option>
                            <option value="name">이름순</option>
                            <option value="email">이메일순</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 회원 목록 -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-lg font-medium text-gray-900">회원 목록</h2>
                    <div class="flex space-x-2">
                        <button id="bulk-delete-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition hidden">선택 삭제</button>
                        <button id="export-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">내보내기</button>
                    </div>
                </div>
            </div>
            <div id="member-list" class="divide-y divide-gray-200">
                <!-- 회원 카드들이 여기에 동적으로 추가됩니다 -->
            </div>
        </div>
    </main>

    <!-- 회원 상세 정보 모달 -->
    <div id="member-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900">회원 상세 정보</h3>
                        <button id="close-detail-modal" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="member-detail-content" class="p-6">
                    <!-- 회원 상세 정보가 여기에 표시됩니다 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 회원 삭제 확인 모달 -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">회원 삭제 확인</h3>
                </div>
                <div class="p-6">
                    <p class="text-gray-600 mb-4">정말로 이 회원을 삭제하시겠습니까?</p>
                    <p class="text-sm text-red-600 mb-4">⚠️ 이 작업은 되돌릴 수 없으며, 회원의 모든 데이터가 삭제됩니다.</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancel-delete" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition">취소</button>
                        <button id="confirm-delete" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">삭제</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 관리자 세션 확인
        function validateAdminSession() {
            const adminMode = localStorage.getItem('adminMode') === 'true';
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            const result = adminMode || isAdmin;
            
            console.log('관리자 세션 확인:', {
                adminMode: adminMode,
                isAdmin: isAdmin,
                result: result
            });
            
            if (!result) {
                alert('관리자 권한이 필요합니다.');
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        // 페이지 로드 시 관리자 확인
        if (!validateAdminSession()) {
            window.location.href = 'index.html';
        }

        // 전역 변수
        let allMembers = [];
        let filteredMembers = [];
        let selectedMembers = new Set();

        // 회원 데이터 로드
        function loadMembers() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const currentTime = Date.now();
            
            allMembers = users.map(user => ({
                ...user,
                joinDate: user.joinDate || user.loginTime || currentTime,
                lastLogin: user.lastLogin || user.loginTime || currentTime,
                status: user.status || 'active',
                requestCount: getRequestCount(user.email),
                inquiryCount: getInquiryCount(user.email),
                purchaseCount: getPurchaseCount(user.email)
            }));

            // filteredMembers 초기화
            filteredMembers = [...allMembers];

            updateStatistics();
            renderMemberList();
        }

        // 통계 업데이트
        function updateStatistics() {
            const total = allMembers.length;
            const active = allMembers.filter(m => m.status === 'active').length;
            const withdrawn = allMembers.filter(m => m.status === 'withdrawn').length;
            
            // 이번 달 가입자 수
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const newMembers = allMembers.filter(m => {
                const joinDate = new Date(m.joinDate);
                return joinDate.getMonth() === currentMonth && joinDate.getFullYear() === currentYear;
            }).length;

            document.getElementById('total-members').textContent = total;
            document.getElementById('active-members').textContent = active;
            document.getElementById('new-members').textContent = newMembers;
            document.getElementById('withdrawn-members').textContent = withdrawn;
        }

        // 의뢰 건수 조회
        function getRequestCount(email) {
            let count = 0;
            
            // localStorage에서 request- 키로 시작하는 모든 항목 검색
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('request-') && !key.includes('TEST') && !key.startsWith('requestCount-')) {
                    try {
                        const requestData = JSON.parse(localStorage.getItem(key));
                        if (requestData && requestData.email === email) {
                            count++;
                        }
                    } catch (e) {
                        console.log('의뢰 데이터 파싱 실패:', key, e);
                    }
                }
            }
            
            return count;
        }

        // 문의 건수 조회
        function getInquiryCount(email) {
            let count = 0;
            
            // localStorage에서 inquiry- 키로 시작하는 모든 항목 검색
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('inquiry-') && !key.includes('TEST')) {
                    try {
                        const inquiryData = JSON.parse(localStorage.getItem(key));
                        if (inquiryData && inquiryData.email === email) {
                            count++;
                        }
                    } catch (e) {
                        console.log('문의 데이터 파싱 실패:', key, e);
                    }
                }
            }
            
            return count;
        }

        // 구매 건수 조회
        function getPurchaseCount(email) {
            let count = 0;
            
            // localStorage에서 order- 키로 시작하는 모든 항목 검색
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('order-') && !key.includes('TEST')) {
                    try {
                        const orderData = JSON.parse(localStorage.getItem(key));
                        if (orderData && orderData.email === email) {
                            count++;
                        }
                    } catch (e) {
                        console.log('주문 데이터 파싱 실패:', key, e);
                    }
                }
            }
            
            return count;
        }

        // 회원 목록 렌더링
        function renderMemberList() {
            const container = document.getElementById('member-list');
            container.innerHTML = '';

            if (filteredMembers.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                        <p>검색 결과가 없습니다.</p>
                    </div>
                `;
                return;
            }

            filteredMembers.forEach(member => {
                const card = createMemberCard(member);
                container.appendChild(card);
            });
        }

        // 회원 카드 생성
        function createMemberCard(member) {
            const card = document.createElement('div');
            card.className = 'member-card p-6 hover:bg-gray-50 cursor-pointer';
            card.dataset.email = member.email;

            const statusClass = {
                'active': 'status-active',
                'suspended': 'status-suspended',
                'withdrawn': 'status-withdrawn'
            }[member.status] || 'bg-gray-500';

            const statusText = {
                'active': '활성',
                'suspended': '정지',
                'withdrawn': '탈퇴'
            }[member.status] || '알 수 없음';

            const loginTypeText = {
                'normal': '일반',
                'kakao': '카카오'
            }[member.loginType] || '일반';

            const joinDate = new Date(member.joinDate).toLocaleDateString('ko-KR');
            const lastLogin = new Date(member.lastLogin).toLocaleDateString('ko-KR');

            card.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <input type="checkbox" class="member-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500" data-email="${member.email}">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">
                                <span class="text-sm font-medium text-gray-700">${member.name.charAt(0)}</span>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2">
                                <p class="text-sm font-medium text-gray-900 truncate">${member.name}</p>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium text-white ${statusClass}">${statusText}</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${loginTypeText}</span>
                            </div>
                            <p class="text-sm text-gray-500 truncate">${member.email}</p>
                            <div class="flex items-center space-x-4 mt-1">
                                <span class="text-xs text-gray-400">가입: ${joinDate}</span>
                                <span class="text-xs text-gray-400">최근 로그인: ${lastLogin}</span>
                            </div>
                            <div class="flex items-center space-x-4 mt-1">
                                <span class="text-xs text-gray-400">전화번호: ${member.phone || '미입력'}</span>
                                <span class="text-xs text-gray-400">카카오: ${member.kakao || member.kakaoId || '미입력'}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <div class="flex items-center space-x-2 text-xs text-gray-500">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">의뢰: ${member.requestCount}</span>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded">문의: ${member.inquiryCount}</span>
                                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">구매: ${member.purchaseCount}</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="view-detail-btn text-blue-600 hover:text-blue-800 text-sm font-medium" data-email="${member.email}">상세보기</button>
                            <button class="delete-member-btn text-red-600 hover:text-red-800 text-sm font-medium" data-email="${member.email}">삭제</button>
                        </div>
                    </div>
                </div>
            `;

            // 이벤트 리스너 추가
            card.querySelector('.view-detail-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                showMemberDetail(member.email);
            });

            card.querySelector('.delete-member-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                showDeleteConfirm(member.email);
            });

            card.querySelector('.member-checkbox').addEventListener('change', (e) => {
                e.stopPropagation();
                if (e.target.checked) {
                    selectedMembers.add(member.email);
                } else {
                    selectedMembers.delete(member.email);
                }
                updateBulkDeleteButton();
            });

            return card;
        }

        // 회원 상세 정보 표시
        function showMemberDetail(email) {
            const member = allMembers.find(m => m.email === email);
            if (!member) return;

            const modal = document.getElementById('member-detail-modal');
            const content = document.getElementById('member-detail-content');

            const joinDate = new Date(member.joinDate).toLocaleString('ko-KR');
            const lastLogin = new Date(member.lastLogin).toLocaleString('ko-KR');

            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-4">기본 정보</h4>
                        <dl class="space-y-3">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">이름</dt>
                                <dd class="text-sm text-gray-900">${member.name}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">이메일</dt>
                                <dd class="text-sm text-gray-900">${member.email}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">전화번호</dt>
                                <dd class="text-sm text-gray-900">${member.phone || '미입력'}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">가입 방식</dt>
                                <dd class="text-sm text-gray-900">${member.loginType === 'kakao' ? '카카오' : '일반'}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">가입일</dt>
                                <dd class="text-sm text-gray-900">${joinDate}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">최근 로그인</dt>
                                <dd class="text-sm text-gray-900">${lastLogin}</dd>
                            </div>
                        </dl>
                    </div>
                    <div>
                        <h4 class="text-lg font-medium text-gray-900 mb-4">활동 정보</h4>
                        <dl class="space-y-3">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">총 의뢰 건수</dt>
                                <dd class="text-sm text-gray-900">${member.requestCount}건</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">총 문의 건수</dt>
                                <dd class="text-sm text-gray-900">${member.inquiryCount}건</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">총 구매 건수</dt>
                                <dd class="text-sm text-gray-900">${member.purchaseCount}건</dd>
                            </div>
                        </dl>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
        }

        // 삭제 확인 모달 표시
        function showDeleteConfirm(email) {
            const modal = document.getElementById('delete-confirm-modal');
            modal.dataset.email = email;
            modal.classList.remove('hidden');
        }

        // 회원 삭제 실행
        function deleteMember(email) {
            const confirmMessage = `회원 ${email}을(를) 삭제하시겠습니까?\n\n⚠️ 삭제되는 데이터:\n• 회원 정보\n• 해당 회원의 모든 의뢰\n• 해당 회원의 모든 의뢰 결과\n• 해당 회원의 모든 주문 정보\n• 해당 회원의 모든 알림 기록\n\n이 작업은 되돌릴 수 없습니다.`;
            
            if (!confirm(confirmMessage)) return;
            
            // 사용자 목록에서 삭제
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const updatedUsers = users.filter(user => user.email !== email);
            localStorage.setItem('users', JSON.stringify(updatedUsers));

            // 현재 로그인된 사용자라면 로그아웃
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            if (currentUser.email === email) {
                localStorage.removeItem('loggedIn');
                localStorage.removeItem('currentUser');
            }

            // 해당 회원의 모든 의뢰 데이터 삭제
            const allKeys = Object.keys(localStorage);
            let deletedCount = 0;
            
            allKeys.forEach(key => {
                // request- 키 찾기
                if (key.startsWith('request-')) {
                    try {
                        const requestData = JSON.parse(localStorage.getItem(key));
                        if (requestData.email === email) {
                            const reqNum = key.replace('request-', '');
                            
                            // 관련된 모든 데이터 삭제
                            localStorage.removeItem(key); // 의뢰 정보
                            localStorage.removeItem('result-' + reqNum); // 의뢰 결과
                            localStorage.removeItem('order-' + reqNum); // 주문 정보
                            localStorage.removeItem('notify-' + reqNum); // 알림 기록
                            
                            deletedCount++;
                        }
                    } catch (e) {
                        console.log(`${key} 파싱 실패:`, e);
                    }
                }
            });

            // 문의 내역도 익명화
            const inquiries = JSON.parse(localStorage.getItem('inquiries') || '[]');
            const updatedInquiries = inquiries.map(inq => {
                if (inq.email === email) {
                    return { ...inq, email: 'deleted_user', name: '삭제된 사용자' };
                }
                return inq;
            });
            localStorage.setItem('inquiries', JSON.stringify(updatedInquiries));

            // 목록 새로고침
            loadMembers();
            
            alert(`회원 ${email}과 관련된 모든 데이터가 삭제되었습니다.\n\n삭제된 의뢰 수: ${deletedCount}개`);
        }

        // 필터링 및 검색
        function filterMembers() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const loginTypeFilter = document.getElementById('login-type-filter').value;
            const sortFilter = document.getElementById('sort-filter').value;

            filteredMembers = allMembers.filter(member => {
                const matchesSearch = member.name.toLowerCase().includes(searchTerm) || 
                                    member.email.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || member.status === statusFilter;
                const matchesLoginType = !loginTypeFilter || member.loginType === loginTypeFilter;

                return matchesSearch && matchesStatus && matchesLoginType;
            });

            // 정렬
            filteredMembers.sort((a, b) => {
                switch (sortFilter) {
                    case 'recent':
                        return b.joinDate - a.joinDate;
                    case 'old':
                        return a.joinDate - b.joinDate;
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'email':
                        return a.email.localeCompare(b.email);
                    default:
                        return 0;
                }
            });

            renderMemberList();
        }

        // 일괄 삭제 버튼 업데이트
        function updateBulkDeleteButton() {
            const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
            if (selectedMembers.size > 0) {
                bulkDeleteBtn.classList.remove('hidden');
                bulkDeleteBtn.textContent = `선택 삭제 (${selectedMembers.size}명)`;
            } else {
                bulkDeleteBtn.classList.add('hidden');
            }
        }

        // 일괄 삭제 실행
        function bulkDeleteMembers() {
            if (selectedMembers.size === 0) return;

            const confirmMessage = `선택된 ${selectedMembers.size}명의 회원을 삭제하시겠습니까?\n\n⚠️ 삭제되는 데이터:\n• 선택된 회원들의 모든 정보\n• 해당 회원들의 모든 의뢰\n• 해당 회원들의 모든 의뢰 결과\n• 해당 회원들의 모든 주문 정보\n• 해당 회원들의 모든 알림 기록\n\n이 작업은 되돌릴 수 없습니다.`;
            
            if (confirm(confirmMessage)) {
                let totalDeletedRequests = 0;
                selectedMembers.forEach(email => {
                    // 삭제 전에 해당 회원의 의뢰 수 계산
                    const allKeys = Object.keys(localStorage);
                    const userRequests = allKeys.filter(key => {
                        if (key.startsWith('request-')) {
                            try {
                                const requestData = JSON.parse(localStorage.getItem(key));
                                return requestData.email === email;
                            } catch (e) {
                                return false;
                            }
                        }
                        return false;
                    });
                    totalDeletedRequests += userRequests.length;
                    
                    deleteMember(email);
                });
                selectedMembers.clear();
                updateBulkDeleteButton();
                
                alert(`선택된 ${selectedMembers.size}명의 회원과 관련된 모든 데이터가 삭제되었습니다.\n\n총 삭제된 의뢰 수: ${totalDeletedRequests}개`);
            }
        }

        // 데이터 내보내기
        function exportMembers() {
            const data = filteredMembers.map(member => ({
                이름: member.name,
                이메일: member.email,
                전화번호: member.phone || '',
                가입방식: member.loginType === 'kakao' ? '카카오' : '일반',
                가입일: new Date(member.joinDate).toLocaleDateString('ko-KR'),
                최근로그인: new Date(member.lastLogin).toLocaleDateString('ko-KR'),
                상태: member.status === 'active' ? '활성' : member.status === 'suspended' ? '정지' : '탈퇴',
                의뢰건수: member.requestCount,
                문의건수: member.inquiryCount,
                구매건수: member.purchaseCount
            }));

            const csv = convertToCSV(data);
            downloadCSV(csv, '회원목록.csv');
        }

        // CSV 변환
        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            return csvContent;
        }

        // CSV 다운로드
        function downloadCSV(csv, filename) {
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 테스트 데이터 정리 함수
        function cleanupTestData() {
            console.log('=== 회원 관리 페이지 테스트 데이터 정리 시작 ===');
            const allKeys = Object.keys(localStorage);
            let deletedCount = 0;
            
            allKeys.forEach(key => {
                // 테스트 데이터 패턴들
                const isTestData = 
                    key.includes('TEST') || 
                    key.startsWith('requestCount-') ||
                    key.includes('#PH-') ||
                    key.includes('result-#PH-') ||
                    key.includes('order-#PH-') ||
                    key.includes('notify-#PH-') ||
                    key.includes('inquiry-#PH-');
                
                if (isTestData) {
                    localStorage.removeItem(key);
                    deletedCount++;
                    console.log(`테스트 데이터 삭제: ${key}`);
                }
            });
            
            if (deletedCount > 0) {
                console.log(`총 ${deletedCount}개의 테스트 데이터가 삭제되었습니다.`);
                alert(`테스트 데이터 ${deletedCount}개가 삭제되었습니다.`);
            } else {
                console.log('삭제할 테스트 데이터가 없습니다.');
            }
            
            // 페이지 새로고침
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        // 이벤트 리스너
        document.addEventListener('DOMContentLoaded', function() {
            // 테스트 데이터 정리는 수동으로만 실행 (자동 실행 제거)
            // cleanupTestData();
            
            // 관리자 권한 확인
            if (!validateAdminSession()) {
                alert('관리자 권한이 필요합니다.');
                window.location.href = 'index.html';
                return;
            }
            
            // 회원 목록 로드
            loadMembers();
            
            // 이벤트 리스너 등록
            document.getElementById('search-input').addEventListener('input', filterMembers);
            document.getElementById('status-filter').addEventListener('change', filterMembers);
            document.getElementById('login-type-filter').addEventListener('change', filterMembers);
            document.getElementById('sort-filter').addEventListener('change', filterMembers);
            document.getElementById('bulk-delete-btn').addEventListener('click', bulkDeleteMembers);
            document.getElementById('export-btn').addEventListener('click', exportMembers);
            document.getElementById('admin-logout-btn').addEventListener('click', function() {
                localStorage.removeItem('isAdmin');
                window.location.href = 'index.html';
            });
        });

        // 모달 외부 클릭 시 닫기
        window.addEventListener('click', (e) => {
            const detailModal = document.getElementById('member-detail-modal');
            const deleteModal = document.getElementById('delete-confirm-modal');
            
            if (e.target === detailModal) {
                detailModal.classList.add('hidden');
            }
            if (e.target === deleteModal) {
                deleteModal.classList.add('hidden');
            }
        });

        // 모달 닫기 버튼 이벤트 리스너
        document.getElementById('close-detail-modal').addEventListener('click', function() {
            document.getElementById('member-detail-modal').classList.add('hidden');
        });

        // 삭제 모달 취소 버튼 이벤트 리스너
        document.getElementById('cancel-delete').addEventListener('click', function() {
            document.getElementById('delete-confirm-modal').classList.add('hidden');
        });
    </script>
</body>
</html> 