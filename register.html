<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <title>íšŒì›ê°€ì… - PriceHunter</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ec4899'><path d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/></svg>">
    
    <!-- ìºì‹œ ì œì–´ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <!-- Content Security Policy - Firebase iframe í—ˆìš© -->
    <meta http-equiv="Content-Security-Policy" content="frame-src 'self' https://www.google.com https://accounts.google.com https://recaptcha.google.com https://kauth.kakao.com https://pricehunter-99a1b.firebaseapp.com https://*.firebaseapp.com https://*.googleapis.com https://apis.google.com https://*.gstatic.com https://*.google.com; connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://firebasestorage.googleapis.com https://content-firebaseappcheck.googleapis.com https://www.googleapis.com https://*.firebaseio.com wss://*.firebaseio.com https://developers.kakao.com https://kapi.kakao.com https://kauth.kakao.com https://*.firebaseapp.com https://*.cloudfunctions.net https://api.emailjs.com https://www.gstatic.com https://*.gstatic.com https://accounts.google.com https://oauth2.googleapis.com https://apis.google.com https://*.google.com https://*.googleapis.com; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://www.gstatic.com https://*.gstatic.com https://apis.google.com https://*.google.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;" />
    
    <!-- Cross-Origin-Opener-Policy ì œê±° - Firebaseì™€ ì¶©ëŒ ë°©ì§€ -->
    
    <meta name="cache-buster" content="v3.5-20250126-csp-fix" />
    <script>
      // ê°•ì œ ìºì‹œ ë¬´íš¨í™” ë° ë””ë²„ê¹…
      console.log('ğŸš€ register.html v3.2 ë¡œë“œë¨ (ì‹¤ì œ ì´ë©”ì¼ ì¸ì¦ ì‹œìŠ¤í…œ)');
      console.log('ğŸ“ í˜„ì¬ URL:', window.location.href);
      console.log('ğŸ• ë¡œë“œ ì‹œê°„:', new Date().toISOString());
      
      // ë” ê°•ë ¥í•œ ìºì‹œ ë²„ìŠ¤í„°
      if (window.location.search.indexOf('v=') === -1) {
        console.log('ğŸ”„ ê°•ë ¥í•œ ìºì‹œ ë²„ìŠ¤í„° ì¶”ê°€ ì¤‘...');
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(7);
        window.location.href = window.location.href + (window.location.search ? '&' : '?') + 'v=' + timestamp + '&r=' + random;
      }
      
      // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í™•ì¸
      window.addEventListener('load', function() {
        console.log('âœ… í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - v3.2 (ì‹¤ì œ ì´ë©”ì¼ ì¸ì¦ ì‹œìŠ¤í…œ)');
      });
    </script>
  
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  
  <!-- Firebase v9 SDK (ëª¨ë“ˆì‹) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, getAdditionalUserInfo } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, getDocs, where, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyDBZxKyMS7eeBTbPnbZkj0WWOZQHNldoL4",
      authDomain: "pricehunter-99a1b.firebaseapp.com",
      projectId: "pricehunter-99a1b",
      storageBucket: "pricehunter-99a1b.firebasestorage.app",
      messagingSenderId: "242265693919",
      appId: "1:242265693919:web:74234d942b82a51541136a",
      measurementId: "G-4BKLV4EVB9"
    };

    // Firebase ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ì „ì—­ ë³€ìˆ˜ë¡œ ë…¸ì¶œ
    window.firebaseApp = app;
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebaseAuthFunctions = { signInWithPopup, signInWithRedirect, getRedirectResult, getAdditionalUserInfo };
    window.firebaseFirestoreFunctions = { 
      collection, 
      addDoc, 
      serverTimestamp, 
      getDocs, 
      where, 
      query, 
      deleteDoc,
      getDoc,
      doc,
      setDoc
    };
    const googleProvider = new GoogleAuthProvider();
    googleProvider.setCustomParameters({ prompt: 'select_account' });
    window.firebaseGoogleProvider = googleProvider;
    window.firebase = {
      firestore: () => db,
      auth: () => auth,
      apps: [app],
      app: () => app,
      firestore: {
        FieldValue: {
          serverTimestamp: serverTimestamp
        }
      }
    };

    console.log('âœ… Firebase v9 ì´ˆê¸°í™” ì™„ë£Œ (register.html)');
    
    // Firebase Auth ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    // ë¦¬ë””ë ‰ì…˜ í›„ ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë˜ì—ˆì„ ë•Œ ìë™ìœ¼ë¡œ ì²˜ë¦¬
    let authStateProcessed = false;
    
    // ë¦¬ë””ë ‰ì…˜ ì—¬ë¶€ í™•ì¸ (URLì— íŠ¹ì • íŒŒë¼ë¯¸í„°ê°€ ìˆê±°ë‚˜, sessionStorageì— í”Œë˜ê·¸ê°€ ìˆëŠ”ì§€)
    const isRedirectReturn = sessionStorage.getItem('googleRedirectStarted') === 'true';
    if (isRedirectReturn) {
      const redirectStartTime = sessionStorage.getItem('googleRedirectStartTime');
      const currentTime = Date.now();
      const elapsedTime = redirectStartTime ? currentTime - parseInt(redirectStartTime) : 0;
      
      console.log('ğŸ”„ êµ¬ê¸€ ë¦¬ë””ë ‰ì…˜ í›„ ë³µê·€ ê°ì§€ - ì¸ì¦ ìƒíƒœ ì²˜ë¦¬ ì¤€ë¹„');
      console.log('â° ë¦¬ë””ë ‰ì…˜ ê²½ê³¼ ì‹œê°„:', elapsedTime, 'ms');
      console.log('ğŸ“ í˜„ì¬ URL:', window.location.href);
      
      authStateProcessed = false; // ë¦¬ë””ë ‰ì…˜ í›„ì—ëŠ” í”Œë˜ê·¸ ë¦¬ì…‹
      
      // getRedirectResultë¥¼ ë¨¼ì € í˜¸ì¶œ (ë¦¬ë””ë ‰ì…˜ í›„ í•œ ë²ˆë§Œ í˜¸ì¶œ ê°€ëŠ¥)
      setTimeout(async () => {
        try {
          const { getRedirectResult } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js');
          console.log('ğŸ“ ë¦¬ë””ë ‰ì…˜ í›„ getRedirectResult í˜¸ì¶œ ì¤‘...');
          const result = await getRedirectResult(auth);
          
          if (result && result.user) {
            console.log('âœ… getRedirectResultì—ì„œ ì‚¬ìš©ì ë°œê²¬:', result.user.email);
            const isGoogleUser = result.user.providerData?.some(provider => provider.providerId === 'google.com');
            if (isGoogleUser) {
              authStateProcessed = false; // ì²˜ë¦¬ ê°€ëŠ¥í•˜ë„ë¡ ë¦¬ì…‹
              const processFn = window.processGoogleUser || processGoogleUser;
              if (processFn) {
                await processFn(result.user);
                sessionStorage.removeItem('googleRedirectStarted');
                sessionStorage.removeItem('googleRedirectStartTime');
                return;
              }
            }
          } else {
            console.log('âš ï¸ getRedirectResultê°€ nullì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤.');
          }
        } catch (error) {
          console.error('âŒ getRedirectResult í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜:', error);
        }
        
        // getRedirectResultê°€ ì‹¤íŒ¨í–ˆê±°ë‚˜ nullì„ ë°˜í™˜í•œ ê²½ìš° ìˆ˜ë™ í™•ì¸ ì‹œì‘
        sessionStorage.removeItem('googleRedirectStarted');
        sessionStorage.removeItem('googleRedirectStartTime');
        
        // ë¦¬ë””ë ‰ì…˜ í›„ ì¦‰ì‹œ í˜„ì¬ ì‚¬ìš©ì í™•ì¸ (onAuthStateChangedê°€ íŠ¸ë¦¬ê±°ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ)
        // ì—¬ëŸ¬ ë²ˆ ì‹œë„ (ì¸ì¦ ìƒíƒœê°€ ì„¤ì •ë˜ëŠ” ë° ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŒ)
        let checkCount = 0;
        const maxChecks = 20; // ìµœëŒ€ 10ì´ˆê°„ í™•ì¸
        
        const checkUser = async () => {
          try {
            checkCount++;
            const currentUser = auth.currentUser;
            console.log(`ğŸ” ë¦¬ë””ë ‰ì…˜ í›„ ìˆ˜ë™ í™•ì¸ (${checkCount}/${maxChecks}):`, currentUser ? currentUser.email : 'ì‚¬ìš©ì ì—†ìŒ');
            
            if (currentUser) {
              const isGoogleUser = currentUser.providerData?.some(provider => provider.providerId === 'google.com');
              if (isGoogleUser) {
                console.log('âœ… ë¦¬ë””ë ‰ì…˜ í›„ ìˆ˜ë™ í™•ì¸ - êµ¬ê¸€ ì‚¬ìš©ì ë°œê²¬:', currentUser.email);
                
                // authStateProcessedë¥¼ ì„ì‹œë¡œ ë¦¬ì…‹í•˜ì—¬ ì²˜ë¦¬ ê°€ëŠ¥í•˜ë„ë¡ í•¨
                authStateProcessed = false;
                
                // processGoogleUser í•¨ìˆ˜ í˜¸ì¶œ (ì „ì—­ ë˜ëŠ” ë¡œì»¬)
                const processFn = window.processGoogleUser || processGoogleUser;
                if (processFn) {
                  await processFn(currentUser);
                } else {
                  console.error('âŒ processGoogleUser í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                return; // ì„±ê³µí•˜ë©´ ì¤‘ë‹¨
              } else {
                console.log('â­ï¸ êµ¬ê¸€ ì‚¬ìš©ìê°€ ì•„ë‹˜');
              }
            }
            
            // ì•„ì§ ì‚¬ìš©ìê°€ ì—†ê³  ìµœëŒ€ ì‹œë„ íšŸìˆ˜ì— ë„ë‹¬í•˜ì§€ ì•Šì•˜ìœ¼ë©´ ë‹¤ì‹œ ì‹œë„
            if (!currentUser && checkCount < maxChecks) {
              setTimeout(checkUser, 500);
            } else if (checkCount >= maxChecks) {
              console.log('âš ï¸ ë¦¬ë””ë ‰ì…˜ í›„ ìˆ˜ë™ í™•ì¸ ì‹¤íŒ¨ - ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ë„ë‹¬');
              console.log('ğŸ’¡ ë¦¬ë””ë ‰ì…˜ì´ ë°œìƒí–ˆì§€ë§Œ ì¸ì¦ ìƒíƒœê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              console.log('ğŸ’¡ ê°€ëŠ¥í•œ ì›ì¸:');
              console.log('   1. êµ¬ê¸€ ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              console.log('   2. ë¦¬ë””ë ‰ì…˜ í›„ ëŒì•„ì™”ì§€ë§Œ Firebase Authê°€ ì¸ì¦ ìƒíƒœë¥¼ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
              console.log('   3. CSP ì˜¤ë¥˜ë¡œ ì¸í•´ ì¸ì¦ í”„ë¡œì„¸ìŠ¤ê°€ ì°¨ë‹¨ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
          } catch (error) {
            console.error('ë¦¬ë””ë ‰ì…˜ í›„ ìˆ˜ë™ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
            if (checkCount < maxChecks) {
              setTimeout(checkUser, 500);
            }
          }
        };
        
        // ì¦‰ì‹œ í™•ì¸ ë° ì§€ì—° í›„ í™•ì¸
        checkUser();
        setTimeout(checkUser, 500);
        setTimeout(checkUser, 1000);
        setTimeout(checkUser, 2000);
        setTimeout(checkUser, 3000);
      }, 100); // Firebase ì´ˆê¸°í™” í›„ ì•½ê°„ì˜ ì§€ì—°
    }
    
    // êµ¬ê¸€ ì‚¬ìš©ì ì²˜ë¦¬ í•¨ìˆ˜
    async function processGoogleUser(user) {
      if (authStateProcessed) {
        console.log('â­ï¸ ì´ë¯¸ ì²˜ë¦¬ë¨');
        return;
      }
      
      if (localStorage.getItem('googleAuthProcessing') === 'true') {
        console.log('â­ï¸ ì´ë¯¸ ì²˜ë¦¬ ì¤‘');
        return;
      }
      
      localStorage.setItem('googleAuthProcessing', 'true');
      authStateProcessed = true;
      
      try {
        console.log('ğŸ“ êµ¬ê¸€ ì‚¬ìš©ì ë°ì´í„° ì €ì¥ ì‹œì‘...');
        
        // finalizeSocialLogin ì‚¬ìš©
        await finalizeSocialLogin(user, {
          loginMethod: 'google',
          additionalInfo: null,
          toastMessage: 'Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.'
        });
      } catch (error) {
        console.error('âŒ êµ¬ê¸€ ì‚¬ìš©ì ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        alert('íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        localStorage.removeItem('googleAuthProcessing');
      }
    }
    
    // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (ë¦¬ë””ë ‰ì…˜ í›„ ìˆ˜ë™ í™•ì¸ì—ì„œë„ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
    window.processGoogleUser = processGoogleUser;
    
    // onAuthStateChanged ë¦¬ìŠ¤ë„ˆ ì„¤ì • í™•ì¸
    console.log('ğŸ”§ onAuthStateChanged ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì¤‘...');
    console.log('ğŸ” Firebase Auth ì¸ìŠ¤í„´ìŠ¤:', auth ? 'ìˆìŒ' : 'ì—†ìŒ');
    console.log('ğŸ” í˜„ì¬ ì‚¬ìš©ì:', auth.currentUser ? auth.currentUser.email : 'ì—†ìŒ');
    
    onAuthStateChanged(auth, async (user) => {
      console.log('ğŸ”” Firebase Auth ìƒíƒœ ë³€ê²½:', user ? `ë¡œê·¸ì¸ë¨ (${user.email})` : 'ë¡œê·¸ì•„ì›ƒë¨');
      console.log('ğŸ” ìƒíƒœ ë³€ê²½ ìƒì„¸:', {
        user: user ? {
          uid: user.uid,
          email: user.email,
          providerId: user.providerData?.[0]?.providerId
        } : null,
        authStateProcessed: authStateProcessed,
        googleAuthProcessing: localStorage.getItem('googleAuthProcessing')
      });
      
      if (user && !authStateProcessed) {
        console.log('ğŸ”„ Firebase Auth ìƒíƒœ ë³€ê²½ ê°ì§€ - ì‚¬ìš©ì ë¡œê·¸ì¸ë¨:', user.email);
        console.log('ğŸ” ì‚¬ìš©ì ìƒì„¸ ì •ë³´:', {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName,
          providerId: user.providerData?.[0]?.providerId
        });
        
        // ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ê±°ë‚˜ ì™„ë£Œëœ ê²½ìš° ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
        if (localStorage.getItem('googleAuthProcessing') === 'true') {
          console.log('â­ï¸ ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ë¯€ë¡œ ê±´ë„ˆëœ€');
          return;
        }
        
        localStorage.setItem('googleAuthProcessing', 'true');
        
        try {
          // êµ¬ê¸€ ë¡œê·¸ì¸ì¸ì§€ í™•ì¸
          const isGoogleUser = user.providerData?.some(provider => provider.providerId === 'google.com');
          if (!isGoogleUser) {
            console.log('â­ï¸ êµ¬ê¸€ ë¡œê·¸ì¸ì´ ì•„ë‹ˆë¯€ë¡œ ê±´ë„ˆëœ€');
            authStateProcessed = true;
            return;
          }
          
          console.log('âœ… êµ¬ê¸€ ë¡œê·¸ì¸ ì‚¬ìš©ì í™•ì¸ë¨ - processGoogleUser í˜¸ì¶œ');
          
          // processGoogleUser í•¨ìˆ˜ ì‚¬ìš©
          await processGoogleUser(user);
        } catch (error) {
          console.error('âŒ Auth ìƒíƒœ ë³€ê²½ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
          localStorage.removeItem('googleAuthProcessing');
          authStateProcessed = true;
        }
      }
    });
    
    // ë¦¬ë””ë ‰ì…˜ í›„ ì¸ì¦ ìƒíƒœ ì¬í™•ì¸ (ì§€ì—° í›„)
    // ë¦¬ë””ë ‰ì…˜ ì§í›„ì—ëŠ” ì¸ì¦ ìƒíƒœê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì—¬ëŸ¬ ì‹œì ì—ì„œ í™•ì¸
    const checkAuthState = async (delay, attempt) => {
      setTimeout(async () => {
        try {
          console.log(`â° ì¸ì¦ ìƒíƒœ í™•ì¸ (${attempt}ì°¨, ${delay}ms í›„):`);
          const currentUser = auth.currentUser;
          console.log('ğŸ” í˜„ì¬ ì‚¬ìš©ì:', currentUser ? currentUser.email : 'ì—†ìŒ');
          console.log('ğŸ” authStateProcessed:', authStateProcessed);
          console.log('ğŸ” googleAuthProcessing:', localStorage.getItem('googleAuthProcessing'));
          
          if (currentUser && !authStateProcessed) {
            const isGoogleUser = currentUser.providerData?.some(provider => provider.providerId === 'google.com');
            if (isGoogleUser) {
              console.log('âœ… ì§€ì—° í›„ ì¸ì¦ ìƒíƒœ í™•ì¸ - êµ¬ê¸€ ì‚¬ìš©ì ë°œê²¬:', currentUser.email);
              console.log('ğŸ”„ processGoogleUser ì§ì ‘ í˜¸ì¶œ...');
              
              // onAuthStateChangedê°€ íŠ¸ë¦¬ê±°ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ì§ì ‘ ì²˜ë¦¬
              const processFn = window.processGoogleUser || processGoogleUser;
              if (processFn) {
                // authStateProcessedë¥¼ ì„ì‹œë¡œ ë¦¬ì…‹
                const wasProcessed = authStateProcessed;
                authStateProcessed = false;
                await processFn(currentUser);
              }
            } else {
              console.log('â­ï¸ êµ¬ê¸€ ì‚¬ìš©ìê°€ ì•„ë‹˜');
            }
          } else if (!currentUser) {
            console.log('â° ì¸ì¦ ìƒíƒœ í™•ì¸ - ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì—†ìŒ');
          }
        } catch (error) {
          console.warn('ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
        }
      }, delay);
    };
    
    // ì—¬ëŸ¬ ì‹œì ì—ì„œ í™•ì¸
    checkAuthState(500, 1);
    checkAuthState(1500, 2);
    checkAuthState(3000, 3);
    checkAuthState(5000, 4);
    checkAuthState(10000, 5);
    
    // êµ¬ê¸€ ë¦¬ë””ë ‰ì…˜ ê²°ê³¼ ì²˜ë¦¬ (ì´ˆê¸°í™” í›„)
    // DOMContentLoadedê°€ ì´ë¯¸ ì‹¤í–‰ë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë°”ë¡œ ì²˜ë¦¬
    if (typeof handleGoogleRedirectResult === 'function') {
      handleGoogleRedirectResult().catch(err => {
        console.warn('ë¦¬ë””ë ‰ì…˜ ê²°ê³¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œ ê°€ëŠ¥):', err);
      });
    } else {
      // í•¨ìˆ˜ê°€ ì•„ì§ ì •ì˜ë˜ì§€ ì•Šì•˜ë‹¤ë©´ DOMContentLoadedë¥¼ ê¸°ë‹¤ë¦¼
      document.addEventListener('DOMContentLoaded', () => {
        if (typeof handleGoogleRedirectResult === 'function') {
          handleGoogleRedirectResult().catch(err => {
            console.warn('ë¦¬ë””ë ‰ì…˜ ê²°ê³¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œ ê°€ëŠ¥):', err);
          });
        }
      });
    }
  </script>
  
  <style>
    body {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    body, div, p, h1, h2, h3, h4, h5, h6, span, label {
      caret-color: transparent;
    }
    
    input, textarea {
      caret-color: auto;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
      .fade-in-up {
      animation: fadeInUp 0.6s ease-out;
    }

      .loading {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
  </style>
</head>

  <body class="bg-gradient-to-br from-pink-50 to-blue-50 min-h-screen">
  <!-- í—¤ë” -->
    <header class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center">
            <a href="index.html" class="text-2xl font-bold text-pink-600">PriceHunter</a>
          </div>
          <nav class="hidden md:flex space-x-8">
            <a href="index.html" class="text-gray-600 hover:text-pink-600">í™ˆ</a>
            <a href="about.html" class="text-gray-600 hover:text-pink-600">ì†Œê°œ</a>
            <a href="contact.html" class="text-gray-600 hover:text-pink-600">ë¬¸ì˜</a>
          </nav>
      </div>
    </div>
  </header>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="max-w-4xl mx-auto px-4 py-12 mx-4">
      <div class="text-center mb-12 fade-in-up">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">íšŒì›ê°€ì…</h1>
        <p class="text-lg text-gray-600">PriceHunterì—<br class="sm:hidden">ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</p>
    </div>

      <!-- íšŒì›ê°€ì… ì˜µì…˜ -->
      <div class="max-w-xs sm:max-w-sm md:max-w-md mx-auto mb-12 mx-4 space-y-6">
        <!-- êµ¬ê¸€ íšŒì›ê°€ì… -->
        <div class="bg-white rounded-2xl shadow-lg p-8 text-center fade-in-up">
          <div class="mb-6">
            <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
              <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-8 h-8">
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ<br class="sm:hidden">ê°„í¸ ê°€ì…</h3>
            <p class="text-gray-600">ë¹ ë¥´ê³  ì•ˆì „í•˜ê²Œ<br class="sm:hidden">ê°€ì…í•˜ì„¸ìš”</p>
          </div>
          <button id="google-register" class="w-full flex items-center justify-center gap-3 py-2 sm:py-3 px-4 sm:px-6 border-2 border-gray-200 rounded-lg hover:border-gray-300 transition duration-200 bg-white text-gray-700 font-semibold text-sm sm:text-base">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" class="w-5 h-5" loading="lazy">
            <span>Google ê³„ì •ìœ¼ë¡œ ê°€ì…í•˜ê¸°</span>
          </button>
          <p class="text-sm text-blue-600 mt-3">âš¡ ë³„ë„ ì •ë³´ ì…ë ¥ ì—†ì´<br class="sm:hidden">ì¦‰ì‹œ ê°€ì… ì™„ë£Œ!</p>
        </div>

        <div class="flex items-center gap-3 text-gray-400 text-xs uppercase tracking-wide">
          <span class="flex-1 h-px bg-gray-200"></span>
          <span>ë˜ëŠ”</span>
          <span class="flex-1 h-px bg-gray-200"></span>
        </div>

        <!-- ì¼ë°˜ íšŒì›ê°€ì… -->
        <div class="bg-white rounded-2xl shadow-lg p-8 text-center fade-in-up">
      <div class="mb-6">
            <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
              <span class="text-2xl">ğŸ“§</span>
          </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">ì¼ë°˜<br class="sm:hidden">íšŒì›ê°€ì…</h3>
            <p class="text-gray-600">ì´ë©”ì¼ë¡œ<br class="sm:hidden">ì§ì ‘ ê°€ì…í•˜ì„¸ìš”</p>
      </div>
          <button id="normal-register" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 sm:py-3 px-4 sm:px-6 rounded-lg transition duration-200 flex items-center justify-center text-sm sm:text-base">
            <span class="mr-2">ğŸ“§</span>
            ì´ë©”ì¼ë¡œ<br class="sm:hidden">ê°€ì…í•˜ê¸°
        </button>
          <p class="text-sm text-green-600 mt-3">ğŸ‰ ê°€ì… í›„<br class="sm:hidden">ì‹¤ì œ ê³ ê° í›„ê¸°ë¥¼<br class="sm:hidden">í™•ì¸í•˜ì„¸ìš”!</p>
      </div>
    </div>

    <!-- ì¼ë°˜ íšŒì›ê°€ì… í¼ (ìˆ¨ê¹€) -->
    <div id="register-form" class="max-w-xs sm:max-w-sm md:max-w-md mx-auto bg-white rounded-2xl shadow-lg p-4 sm:p-6 md:p-8 hidden mx-4">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-900">íšŒì›ê°€ì…</h2>
          <button id="close-form" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <form id="signup-form" class="space-y-6">
        <!-- ì´ë¦„ -->
        <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">ì´ë¦„</label>
            <input type="text" id="name" name="name" required
                   class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent text-sm sm:text-base">
        </div>

        <!-- íœ´ëŒ€í° ë²ˆí˜¸ -->
        <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">íœ´ëŒ€í° ë²ˆí˜¸</label>
            <input type="tel" id="phone" name="phone" required placeholder="010-1234-5678"
                   class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent text-sm sm:text-base">
        </div>

        <!-- ì´ë©”ì¼ ì¸ì¦ -->
        <div>
            <label for="email-verification" class="block text-sm font-medium text-gray-700 mb-2">ì´ë©”ì¼ ì¸ì¦</label>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
              <input type="email" id="email-verification" name="email-verification" required placeholder="example@email.com"
                     class="flex-1 px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent text-sm sm:text-base">
              <button type="button" id="send-email" class="px-4 py-2 sm:px-6 sm:py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm sm:text-base whitespace-nowrap">
                ì¸ì¦ë²ˆí˜¸ ë°œì†¡
              </button>
          </div>
            <div id="email-verification-code" class="mt-2 hidden">
              <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                <input type="text" id="email-code" placeholder="ì¸ì¦ë²ˆí˜¸ ì…ë ¥"
                       class="flex-1 px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent text-sm sm:text-base">
                <button type="button" id="verify-email" class="px-4 py-2 sm:px-6 sm:py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm sm:text-base whitespace-nowrap">
                  ì¸ì¦
                </button>
        </div>
              <p id="email-timer" class="text-sm text-gray-500 mt-1"></p>
          </div>
        </div>

        <!-- ë¹„ë°€ë²ˆí˜¸ -->
        <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="password" name="password" required
                   class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent text-sm sm:text-base">
            <div id="password-strength" class="mt-2 text-sm"></div>
        </div>

        <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ -->
        <div>
            <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" id="confirm-password" name="confirm-password" required
                   class="w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent text-sm sm:text-base">
            <div id="password-match" class="mt-2 text-sm"></div>
        </div>

        <!-- ì•½ê´€ ë™ì˜ -->
        <div class="space-y-4">
            <div class="flex items-center">
              <input type="checkbox" id="agree-all" class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
              <label for="agree-all" class="ml-2 text-sm font-medium text-gray-700">ì „ì²´ ë™ì˜</label>
          </div>

            <div class="ml-6 space-y-2">
              <div class="flex items-center">
                <input type="checkbox" id="agree-terms" class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                <label for="agree-terms" class="ml-2 text-sm text-gray-600">
                  <a href="#" class="text-pink-600 hover:underline">ì´ìš©ì•½ê´€</a> ë™ì˜ (í•„ìˆ˜)
                </label>
            </div>
            
              <div class="flex items-center">
                <input type="checkbox" id="agree-privacy" class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                <label for="agree-privacy" class="ml-2 text-sm text-gray-600">
                  <a href="#" class="text-pink-600 hover:underline">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a> ë™ì˜ (í•„ìˆ˜)
                </label>
            </div>
            
              <div class="flex items-center">
                <input type="checkbox" id="agree-marketing" class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                <label for="agree-marketing" class="ml-2 text-sm text-gray-600">
                  ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜ (ì„ íƒ)
                </label>
            </div>
          </div>
        </div>

        <!-- ê°€ì… ë²„íŠ¼ -->
          <button type="submit" id="signup-button" disabled
                  class="w-full bg-gray-400 text-white font-semibold py-2 sm:py-3 px-4 sm:px-6 rounded-lg transition duration-200 text-sm sm:text-base">
            íšŒì›ê°€ì…
        </button>
      </form>
    </div>

    <!-- ë¡œê·¸ì¸ ë§í¬ -->
    <div class="max-w-xs sm:max-w-sm md:max-w-md mx-auto text-center mt-8 mx-4">
      <p class="text-gray-600 mb-4">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?</p>
      <a href="index.html#login" class="inline-block bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition">ë¡œê·¸ì¸í•˜ê¸°</a>
      
    </div>
  </main>

  <script>
      // ì´ë©”ì¼ ì¸ì¦ + íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ëŠ” íšŒì›ê°€ì…

      // ì „ì—­ ë³€ìˆ˜
      let isEmailVerified = false;

      // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
      function waitForFirebase() {
        return new Promise((resolve, reject) => {
          console.log('ğŸ” Firebase ìƒíƒœ í™•ì¸:', {
            firebaseDefined: typeof firebase !== 'undefined',
            firebaseApps: firebase ? firebase.apps.length : 0,
            windowFirebaseApp: !!window.firebaseApp,
            windowFirebaseDb: !!window.firebaseDb,
            windowFirebaseAuth: !!window.firebaseAuth,
            firebaseFirestoreFunctions: !!window.firebaseFirestoreFunctions
          });
          
          if (window.firebaseApp && window.firebaseDb && window.firebaseAuth && window.firebaseFirestoreFunctions) {
            console.log('âœ… Firebase v9 ì¤€ë¹„ë¨');
            resolve();
          } else {
            const checkInterval = setInterval(() => {
              if (window.firebaseApp && window.firebaseDb && window.firebaseAuth && window.firebaseFirestoreFunctions) {
                clearInterval(checkInterval);
                console.log('âœ… Firebase v9 ì¤€ë¹„ë¨');
                resolve();
              }
            }, 100);
            
            // 10ì´ˆ í›„ íƒ€ì„ì•„ì›ƒ
            setTimeout(() => {
              clearInterval(checkInterval);
              console.error('âŒ Firebase ì´ˆê¸°í™” íƒ€ì„ì•„ì›ƒ');
              reject(new Error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨'));
            }, 10000);
          }
        });
      }

      // ì‚¬ìš©ì ë°ì´í„°ë¥¼ Firebaseì— ì €ì¥
    async function saveUserToFirebase(userData) {
      try {
          console.log('â³ Firebase ëŒ€ê¸° ì¤‘...');
          await waitForFirebase();
          console.log('âœ… Firebase ì¤€ë¹„ ì™„ë£Œ');
          
          const db = window.firebaseDb;
          const { collection, query, where, getDocs, addDoc, setDoc, doc, serverTimestamp } = window.firebaseFirestoreFunctions;
          const usersRef = collection(db, 'users');
          console.log('ğŸ“Š Firebase Firestore ì—°ê²° ì™„ë£Œ');
          
          // ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ (Firebase)
          console.log('ğŸ” Firebaseì—ì„œ ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ ì¤‘...', userData.email);
          const emailQuery = query(usersRef, where('email', '==', userData.email));
          const emailSnapshot = await getDocs(emailQuery);
          console.log('ğŸ“‹ Firebase ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ ê²°ê³¼:', emailSnapshot.empty ? 'ì¤‘ë³µ ì—†ìŒ' : 'ì¤‘ë³µ ë°œê²¬');
          if (!emailSnapshot.empty) {
            throw new Error('ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
          }
          
          // íœ´ëŒ€í° ë²ˆí˜¸ ì¤‘ë³µ í™•ì¸ (Firebase)
          console.log('ğŸ” Firebaseì—ì„œ íœ´ëŒ€í° ë²ˆí˜¸ ì¤‘ë³µ í™•ì¸ ì¤‘...', userData.phone);
          const phoneQuery = query(usersRef, where('phone', '==', userData.phone));
          const phoneSnapshot = await getDocs(phoneQuery);
          console.log('ğŸ“‹ Firebase íœ´ëŒ€í° ì¤‘ë³µ í™•ì¸ ê²°ê³¼:', phoneSnapshot.empty ? 'ì¤‘ë³µ ì—†ìŒ' : 'ì¤‘ë³µ ë°œê²¬');
          if (!phoneSnapshot.empty) {
            throw new Error('ì´ë¯¸ ê°€ì…ëœ íœ´ëŒ€í° ë²ˆí˜¸ì…ë‹ˆë‹¤.');
          }
          
          // localStorageì—ì„œë„ ì¤‘ë³µ í™•ì¸
          console.log('ğŸ” localStorageì—ì„œ ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ ì¤‘...', userData.email);
          const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
          const duplicateEmail = existingUsers.find(user => user.email === userData.email);
          if (duplicateEmail) {
            throw new Error('ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
          }
          
          console.log('ğŸ” localStorageì—ì„œ íœ´ëŒ€í° ë²ˆí˜¸ ì¤‘ë³µ í™•ì¸ ì¤‘...', userData.phone);
          const duplicatePhone = existingUsers.find(user => user.phone === userData.phone);
          if (duplicatePhone) {
            throw new Error('ì´ë¯¸ ê°€ì…ëœ íœ´ëŒ€í° ë²ˆí˜¸ì…ë‹ˆë‹¤.');
          }
          console.log('ğŸ“‹ localStorage ì¤‘ë³µ í™•ì¸ ê²°ê³¼: ì¤‘ë³µ ì—†ìŒ');
          
          // ì‚¬ìš©ì ë°ì´í„° ì €ì¥ (ì¼ê´€ëœ í˜•ì‹ìœ¼ë¡œ)
          console.log('ğŸ’¾ Firebaseì— ì‚¬ìš©ì ë°ì´í„° ì €ì¥ ì¤‘...');
          // Firebase Authë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²½ìš°ë¥¼ ìœ„í•œ ì„ì‹œ uid ìƒì„±
          // í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” Firebase Authë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë¨
          const uid = `email_${userData.email.replace('@', '_').replace('.', '_')}`;
          
          // ë¬¸ì„œ IDë¥¼ uidë¡œ ì„¤ì •í•˜ì—¬ ì¼ê´€ì„± ìœ ì§€ (setDoc ì‚¬ìš©)
          const { doc, setDoc } = window.firebaseFirestoreFunctions;
          const userDocRef = doc(db, 'users', uid);
          
          await setDoc(userDocRef, {
            uid: uid,
            email: userData.email,
            name: userData.name.trim(), // ì´ë¦„ ê³µë°± ì œê±°
            displayName: userData.name.trim(), // ì´ë¦„ ê³µë°± ì œê±°
            phone: userData.phone,
            password: userData.password,
            emailVerification: userData.emailVerification,
            agreeTerms: userData.agreeTerms,
            agreePrivacy: userData.agreePrivacy,
            agreeMarketing: userData.agreeMarketing,
            loginMethod: 'email',
            isActive: true,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          }, { merge: true });
          
          console.log('âœ… Firebaseì— ì‚¬ìš©ì ì €ì¥ ì™„ë£Œ:', uid);
          return uid;
      } catch (error) {
          console.error('âŒ Firebase ì €ì¥ ì‹¤íŒ¨:', error);
          
          // Firebase ì €ì¥ ì‹¤íŒ¨ ì‹œ ì˜¤ë¥˜ ë©”ì‹œì§€ì™€ í•¨ê»˜ throw
          if (error.message.includes('Missing or insufficient permissions') || 
              error.message.includes('permission-denied')) {
            throw new Error('Firebase ê¶Œí•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
          }
          
          // ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” ê·¸ëŒ€ë¡œ throw
          throw error;
        }
      }

      // localStorageì— ì‚¬ìš©ì ë°ì´í„° ì €ì¥
      function saveUserToLocalStorage(userData) {
        // localStorage ì €ì¥ ì œê±° - Firebase ì „ìš©
        console.log('âœ… Firebaseì—ë§Œ ì‚¬ìš©ì ë°ì´í„° ì €ì¥');
        }
        
        // í¬ì¸íŠ¸ ì¶”ê°€
      // í¬ì¸íŠ¸ ì‹œìŠ¤í…œ ì œê±°ë¨

      // ì‚¬ìš©ì ë°ì´í„° upsert í•¨ìˆ˜ (ëª¨ë“  ë¡œê·¸ì¸ ê²½ë¡œì—ì„œ ê³µí†µ ì‚¬ìš©)
      async function upsertUser(userData, extra = {}) {
        try {
          await waitForFirebase();
          
          const { doc, setDoc, getDoc } = window.firebaseFirestoreFunctions;
          const userRef = doc(window.firebaseDb, 'users', userData.uid);
          
          // ê¸°ì¡´ ì‚¬ìš©ì ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          const userDocSnapshot = await getDoc(userRef);
          const isNewUser = !userDocSnapshot.exists();
          
          const userDoc = {
            uid: userData.uid,
            email: userData.email,
            displayName: userData.displayName || userData.name || userData.nickname || '',
            photoURL: userData.photoURL || userData.profileImage || '',
            loginMethod: userData.loginMethod || 'email',
            createdAt: userData.createdAt || new Date(),
            updatedAt: new Date(),
            isActive: true,
            ...extra
          };

          await setDoc(userRef, userDoc, { merge: true });
          console.log('âœ… ì‚¬ìš©ì ë°ì´í„° upsert ì™„ë£Œ:', userData.email);
          return { success: true, isNewUser };
        } catch (error) {
          console.error('âŒ ì‚¬ìš©ì ë°ì´í„° upsert ì‹¤íŒ¨:', error);
          return { success: false, isNewUser: false };
        }
      }

      async function finalizeSocialLogin(firebaseUser, options = {}) {
        if (!firebaseUser) return;
        
        const additionalInfo = options.additionalInfo || {};
        const providerData = firebaseUser.providerData?.[0] || {};
        const userData = {
          uid: firebaseUser.uid,
          email: firebaseUser.email || '',
          displayName: firebaseUser.displayName || providerData.displayName || firebaseUser.email?.split('@')[0] || '',
          photoURL: firebaseUser.photoURL || providerData.photoURL || '',
          phoneNumber: firebaseUser.phoneNumber || providerData.phoneNumber || '',
          loginMethod: options.loginMethod || providerData.providerId || 'google',
          emailVerified: firebaseUser.emailVerified,
          createdAt: firebaseUser.metadata?.creationTime ? new Date(firebaseUser.metadata.creationTime) : new Date(),
          updatedAt: new Date()
        };
        
        // ìƒˆ ì‚¬ìš©ìì¸ì§€ í™•ì¸ (upsertUser í˜¸ì¶œ ì „ì— í™•ì¸)
        await waitForFirebase();
        const { doc, getDoc } = window.firebaseFirestoreFunctions;
        const userRefBeforeUpsert = doc(window.firebaseDb, 'users', firebaseUser.uid);
        const userDocBeforeUpsert = await getDoc(userRefBeforeUpsert);
        const isNewUserBeforeUpsert = !userDocBeforeUpsert.exists();
        
        // êµ¬ê¸€ ë¡œê·¸ì¸ ì‚¬ìš©ìì˜ ê²½ìš° ì´ë¦„ê³¼ í•¸ë“œí°ë²ˆí˜¸ í™•ì¸ (upsertUser ì „ì—)
        let needsProfile = false;
        if (options.loginMethod === 'google' || providerData.providerId === 'google.com') {
          if (userDocBeforeUpsert.exists()) {
            const existingData = userDocBeforeUpsert.data();
            // ì´ë¦„ì´ë‚˜ í•¸ë“œí°ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ í”„ë¡œí•„ ì™„ì„± í˜ì´ì§€ë¡œ ì´ë™
            if (!existingData.name || !existingData.phone) {
              needsProfile = true;
            }
          } else {
            // ìƒˆ ì‚¬ìš©ìëŠ” ë¬´ì¡°ê±´ í”„ë¡œí•„ ì™„ì„± í•„ìš”
            needsProfile = true;
          }
        }
        
        // í”„ë¡œí•„ ì™„ì„±ì´ í•„ìš”í•œ ê²½ìš° upsertUser í˜¸ì¶œí•˜ì§€ ì•Šê³  ë°”ë¡œ ì´ë™
        if (needsProfile) {
          // ìµœì†Œí•œì˜ ì‚¬ìš©ì ì •ë³´ë§Œ localStorageì— ì €ì¥ (í”„ë¡œí•„ ì™„ì„± í˜ì´ì§€ì—ì„œ ì‚¬ìš©)
          localStorage.setItem('loggedIn', 'true');
          localStorage.setItem('currentUser', JSON.stringify(userData));
          localStorage.setItem('user', JSON.stringify(userData));
          if (userData.email) {
            localStorage.setItem('loggedInEmail', userData.email);
          }
          
          alert('êµ¬ê¸€ ë¡œê·¸ì¸ íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì¶”ê°€ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          window.location.href = 'complete-profile.html';
          return;
        }
        
        // í”„ë¡œí•„ì´ ì´ë¯¸ ì™„ì„±ëœ ê²½ìš°ì—ë§Œ upsertUser í˜¸ì¶œ
        const upsertResult = await upsertUser(userData, {
          lastLogin: new Date(),
          providerId: additionalInfo.providerId || providerData.providerId || 'google',
          isNewUser: additionalInfo.isNewUser ?? options.isNewUser ?? isNewUserBeforeUpsert
        });
        
        // ìƒˆ ì‚¬ìš©ìì¸ì§€ í™•ì¸ (additionalInfo.isNewUser ë˜ëŠ” upsertResult.isNewUser ì‚¬ìš©)
        const isNewUser = additionalInfo.isNewUser ?? upsertResult?.isNewUser ?? isNewUserBeforeUpsert;
        
        localStorage.setItem('loggedIn', 'true');
        localStorage.setItem('currentUser', JSON.stringify(userData));
        localStorage.setItem('user', JSON.stringify(userData));
        if (userData.email) {
          localStorage.setItem('loggedInEmail', userData.email);
        }
        
        // ì„±ê³µ ë©”ì‹œì§€ ë° ë¦¬ë””ë ‰ì…˜
        if (isNewUser) {
          alert('êµ¬ê¸€ ë¡œê·¸ì¸ íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì‹¤ì œ ê³ ê° í›„ê¸°ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!');
        } else {
          alert('ì´ë¯¸ ê°€ì…ëœ ê³„ì •ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        window.location.href = 'reviews.html';
      }

      // êµ¬ê¸€ íšŒì›ê°€ì…/ë¡œê·¸ì¸ í•¨ìˆ˜
      async function registerWithGoogle() {
        console.log('ğŸš€ registerWithGoogle í•¨ìˆ˜ ì‹œì‘');
        try {
          console.log('â³ Firebase ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...');
          await waitForFirebase();
          console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
          
          console.log('ğŸ” Firebase Auth í•¨ìˆ˜ í™•ì¸:', {
            firebaseAuthFunctions: !!window.firebaseAuthFunctions,
            firebaseGoogleProvider: !!window.firebaseGoogleProvider,
            firebaseAuth: !!window.firebaseAuth
          });
          
          if (!window.firebaseAuthFunctions || !window.firebaseGoogleProvider) {
            const errorMsg = 'êµ¬ê¸€ ë¡œê·¸ì¸ êµ¬ì„±ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            console.error('âŒ', errorMsg);
            alert(errorMsg);
            return;
          }
          
          if (!window.firebaseAuth) {
            const errorMsg = 'Firebase Authê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            console.error('âŒ', errorMsg);
            alert(errorMsg);
            return;
          }
          
          const { signInWithPopup, signInWithRedirect, getAdditionalUserInfo } = window.firebaseAuthFunctions;
          let result = null;
          
          console.log('ğŸ”µ êµ¬ê¸€ ë¡œê·¸ì¸ íŒì—… ì‹œë„ ì¤‘...');
          try {
            result = await signInWithPopup(window.firebaseAuth, window.firebaseGoogleProvider);
            console.log('âœ… êµ¬ê¸€ ë¡œê·¸ì¸ íŒì—… ì„±ê³µ:', result?.user?.email);
          } catch (popupError) {
            console.warn('âš ï¸ íŒì—… ë¡œê·¸ì¸ ì‹¤íŒ¨, ë¦¬ë””ë ‰ì…˜ ì‹œë„:', popupError.code, popupError.message);
            const shouldFallback = popupError.code === 'auth/popup-blocked' ||
              popupError.code === 'auth/cancelled-popup-request' ||
              popupError.code === 'auth/popup-closed-by-user' ||
              popupError.code === 'auth/operation-not-supported-in-this-environment';
            
            if (shouldFallback && signInWithRedirect) {
              console.log('ğŸ”„ ë¦¬ë””ë ‰ì…˜ ë°©ì‹ìœ¼ë¡œ ì „í™˜');
              // ë¦¬ë””ë ‰ì…˜ ì‹œì‘ í”Œë˜ê·¸ ì„¤ì •
              sessionStorage.setItem('googleRedirectStarted', 'true');
              sessionStorage.setItem('googleRedirectStartTime', Date.now().toString());
              await signInWithRedirect(window.firebaseAuth, window.firebaseGoogleProvider);
              console.log('âœ… ë¦¬ë””ë ‰ì…˜ ì‹œì‘ë¨');
              return;
            }
            throw popupError;
          }
          
          if (result?.user) {
            console.log('âœ… êµ¬ê¸€ ë¡œê·¸ì¸ ì‚¬ìš©ì í™•ì¸ë¨, finalizeSocialLogin í˜¸ì¶œ');
            const additionalInfo = getAdditionalUserInfo ? getAdditionalUserInfo(result) : null;
            await finalizeSocialLogin(result.user, {
              loginMethod: 'google',
              additionalInfo,
              toastMessage: 'Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.'
            });
          } else {
            console.warn('âš ï¸ êµ¬ê¸€ ë¡œê·¸ì¸ ê²°ê³¼ì— ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
          }
        } catch (error) {
          console.error('âŒ Google ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
          console.error('ì—ëŸ¬ ìƒì„¸:', {
            code: error.code,
            message: error.message,
            stack: error.stack
          });
          
          let errorMessage = 'êµ¬ê¸€ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
          
          if (error.code === 'auth/popup-closed-by-user') {
            errorMessage = 'ë¡œê·¸ì¸ ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
          } else if (error.code === 'auth/account-exists-with-different-credential') {
            errorMessage = 'ì´ë¯¸ ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
          } else if (error.code === 'auth/popup-blocked') {
            errorMessage = 'íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
          } else if (error.message) {
            errorMessage = error.message;
          }
          
          alert(errorMessage);
        }
      }

      // EmailJS ì´ˆê¸°í™”
      function initEmailJS() {
        // EmailJS ê³µê°œ í‚¤ (ì‹¤ì œ ì‚¬ìš© ì‹œ https://dashboard.emailjs.com/admin/integration ì—ì„œ ë°œê¸‰ë°›ì•„ì•¼ í•¨)
        emailjs.init("zrRVWnL0cA9eyxpDp"); // ì‹¤ì œ Public Key (ë³µì‚¬ ì™„ë£Œ)
        
        console.log('ğŸ“§ EmailJS ì´ˆê¸°í™” ì™„ë£Œ');
      }

      // ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„° ì •ë¦¬ í•¨ìˆ˜
      function cleanupUserData() {
        try {
          console.log('ğŸ§¹ ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„° ì •ë¦¬ ì‹œì‘...');
          
          // ê¸°ì¡´ users ë°°ì—´ í™•ì¸
          const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
          console.log('ğŸ“‹ ê¸°ì¡´ ì‚¬ìš©ì ìˆ˜:', existingUsers.length);
          
          // ì˜ëª»ëœ í˜•ì‹ì˜ ë°ì´í„° ì •ë¦¬
          const cleanedUsers = existingUsers.filter(user => {
            // email í•„ë“œê°€ ì—†ê³  emailVerificationë§Œ ìˆëŠ” ê²½ìš° ìˆ˜ì •
            if (!user.email && user.emailVerification) {
              user.email = user.emailVerification;
              console.log('âœ… ì´ë©”ì¼ í•„ë“œ ìˆ˜ì •:', user.email);
            }
            
            // í•„ìˆ˜ í•„ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
            return user.email && user.password && user.name && user.phone;
          });
          
          // localStorage ì‚¬ìš©ì ë°ì´í„° ì •ë¦¬ ì œê±° - Firebase ì „ìš©
          console.log('âœ… Firebase ì „ìš© ì‹œìŠ¤í…œ - localStorage ì‚¬ìš©ì ë°ì´í„° ì •ë¦¬ ë¶ˆí•„ìš”');
          
          return cleanedUsers;
        } catch (error) {
          console.error('âŒ ì‚¬ìš©ì ë°ì´í„° ì •ë¦¬ ì‹¤íŒ¨:', error);
          return [];
        }
      }


      // ì‹¤ì œ ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ ë°œì†¡
      async function sendEmailVerification() {
        const email = document.getElementById('email-verification').value;
        
        if (!email) {
          alert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          alert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // ì¸ì¦ë²ˆí˜¸ ìƒì„±
        const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
        localStorage.setItem('emailVerificationCode', verificationCode);
        localStorage.setItem('emailVerificationTime', Date.now().toString());
        
        // UI ì—…ë°ì´íŠ¸
        document.getElementById('email-verification-code').classList.remove('hidden');
        document.getElementById('send-email').textContent = 'ë°œì†¡ ì¤‘...';
        document.getElementById('send-email').disabled = true;
        
        try {
          // EmailJSë¥¼ ì‚¬ìš©í•œ ì‹¤ì œ ì´ë©”ì¼ ë°œì†¡
          const templateParams = {
            to_email: email,
            verification_code: verificationCode,
            user_name: document.getElementById('name').value || 'ì‚¬ìš©ì',
            from_name: 'PriceHunter'
          };
          
          // EmailJS ì„œë¹„ìŠ¤ IDì™€ í…œí”Œë¦¿ ID (ì‹¤ì œ ì‚¬ìš© ì‹œ êµì²´ í•„ìš”)
          const result = await emailjs.send(
            'service_qq3o0or', // ì‹¤ì œ ì„œë¹„ìŠ¤ ID (ì´ë¯¸ í™•ì¸ë¨)
            'template_9oj52gx', // ì‹¤ì œ í…œí”Œë¦¿ ID (ë³µì‚¬ ì™„ë£Œ)
            templateParams
          );
          
          console.log('âœ… ì´ë©”ì¼ ë°œì†¡ ì„±ê³µ:', result);
          
          // UI ì—…ë°ì´íŠ¸
          document.getElementById('send-email').textContent = 'ì¬ë°œì†¡';
          document.getElementById('send-email').disabled = false;
          
          // íƒ€ì´ë¨¸ ì‹œì‘ (5ë¶„)
          startEmailTimer();
          
          alert('ì¸ì¦ë²ˆí˜¸ê°€ ì´ë©”ì¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
          
        } catch (error) {
          console.error('âŒ ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨:', error);
          
          // ì‹¤íŒ¨ ì‹œ Mock ì‹œìŠ¤í…œìœ¼ë¡œ í´ë°±
          console.log('ğŸ”„ Mock ì‹œìŠ¤í…œìœ¼ë¡œ í´ë°±');
          document.getElementById('send-email').textContent = 'ì¬ë°œì†¡';
          document.getElementById('send-email').disabled = false;
          startEmailTimer();
          
          alert(`ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¸ì¦ë²ˆí˜¸: ${verificationCode}\n(ê°œë°œ ëª¨ë“œ: ì‹¤ì œ ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨)`);
        }
      }

      // ì´ë©”ì¼ íƒ€ì´ë¨¸ ì‹œì‘
      function startEmailTimer() {
        let timeLeft = 300; // 5ë¶„
        const timer = setInterval(() => {
          const minutes = Math.floor(timeLeft / 60);
          const seconds = timeLeft % 60;
          document.getElementById('email-timer').textContent = `ë‚¨ì€ ì‹œê°„: ${minutes}:${seconds.toString().padStart(2, '0')}`;
          
          if (timeLeft <= 0) {
            clearInterval(timer);
            document.getElementById('email-timer').textContent = 'ì¸ì¦ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            document.getElementById('send-email').disabled = false;
          }
          timeLeft--;
        }, 1000);
        
        // 5ë¶„ í›„ ë²„íŠ¼ í™œì„±í™”
        setTimeout(() => {
          document.getElementById('send-email').disabled = false;
        }, 300000);
      }
      // ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ í™•ì¸
      function verifyEmailCode() {
        const inputCode = document.getElementById('email-code').value;
        const storedCode = localStorage.getItem('emailVerificationCode');
        const storedTime = localStorage.getItem('emailVerificationTime');
        
        if (!inputCode) {
          alert('ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (!storedCode) {
          alert('ì¸ì¦ë²ˆí˜¸ë¥¼ ë¨¼ì € ë°œì†¡í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // ì‹œê°„ ë§Œë£Œ í™•ì¸ (5ë¶„)
        const currentTime = Date.now();
        const timeDiff = currentTime - parseInt(storedTime);
        if (timeDiff > 300000) { // 5ë¶„ = 300000ms
          alert('ì¸ì¦ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë°œì†¡í•´ì£¼ì„¸ìš”.');
          localStorage.removeItem('emailVerificationCode');
          localStorage.removeItem('emailVerificationTime');
           return;
         }

        if (inputCode === storedCode) {
          isEmailVerified = true;
          document.getElementById('email-verification-code').classList.add('hidden');
          document.getElementById('email-timer').textContent = 'âœ… ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
          document.getElementById('email-timer').classList.add('text-green-600');
          document.getElementById('send-email').disabled = true;
          document.getElementById('email-verification').disabled = true;
          
          // ê°€ì… ë²„íŠ¼ í™œì„±í™” ì²´í¬
          checkSignupButton();
          
          alert('ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          console.log('âœ… ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ');
        } else {
          alert('ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
      }
      
      // ê°€ì… ë²„íŠ¼ í™œì„±í™” ì²´í¬
      function checkSignupButton() {
        const name = document.getElementById('name').value;
        const phone = document.getElementById('phone').value;
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const agreeTerms = document.getElementById('agree-terms').checked;
        const agreePrivacy = document.getElementById('agree-privacy').checked;
        
        console.log('ğŸ” íšŒì›ê°€ì… ë²„íŠ¼ ì²´í¬:', {
          name: name ? 'âœ…' : 'âŒ',
          phone: phone ? 'âœ…' : 'âŒ',
          password: password ? 'âœ…' : 'âŒ',
          confirmPassword: confirmPassword ? 'âœ…' : 'âŒ',
          passwordMatch: password === confirmPassword ? 'âœ…' : 'âŒ',
          agreeTerms: agreeTerms ? 'âœ…' : 'âŒ',
          agreePrivacy: agreePrivacy ? 'âœ…' : 'âŒ',
          isEmailVerified: isEmailVerified ? 'âœ…' : 'âŒ'
        });
        
        const isFormValid = name && phone && password && confirmPassword && 
                           password === confirmPassword && agreeTerms && agreePrivacy && isEmailVerified;
        
        const signupButton = document.getElementById('signup-button');
        if (isFormValid) {
          signupButton.disabled = false;
          signupButton.classList.remove('bg-gray-400');
          signupButton.classList.add('bg-pink-600', 'hover:bg-pink-700');
          console.log('âœ… íšŒì›ê°€ì… ë²„íŠ¼ í™œì„±í™”ë¨');
            } else {
          signupButton.disabled = true;
          signupButton.classList.add('bg-gray-400');
          signupButton.classList.remove('bg-pink-600', 'hover:bg-pink-700');
          console.log('âŒ íšŒì›ê°€ì… ë²„íŠ¼ ë¹„í™œì„±í™”ë¨');
        }
      }
      // êµ¬ê¸€ ë¦¬ë””ë ‰ì…˜ ê²°ê³¼ ì²˜ë¦¬
      async function handleGoogleRedirectResult() {
        try {
          console.log('ğŸ”„ êµ¬ê¸€ ë¦¬ë””ë ‰ì…˜ ê²°ê³¼ í™•ì¸ ì‹œì‘...');
          console.log('ğŸ“ í˜„ì¬ URL:', window.location.href);
          console.log('ğŸ” URL íŒŒë¼ë¯¸í„°:', window.location.search);
          console.log('ğŸ” URL í•´ì‹œ:', window.location.hash);
          
          // URLì— ì¸ì¦ ê´€ë ¨ íŒŒë¼ë¯¸í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
          const urlParams = new URLSearchParams(window.location.search);
          const hashParams = new URLSearchParams(window.location.hash.substring(1));
          const hasAuthParams = urlParams.has('apiKey') || urlParams.has('mode') || hashParams.has('access_token') || hashParams.has('id_token');
          console.log('ğŸ” ì¸ì¦ ê´€ë ¨ URL íŒŒë¼ë¯¸í„°:', hasAuthParams ? 'ìˆìŒ' : 'ì—†ìŒ');
          
          await waitForFirebase();
          
          if (!window.firebaseAuthFunctions) {
            console.log('âš ï¸ Firebase Auth í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          
          const { getRedirectResult, getAdditionalUserInfo } = window.firebaseAuthFunctions;
          console.log('ğŸ“ getRedirectResult í˜¸ì¶œ ì¤‘...');
          console.log('ğŸ” Firebase Auth ìƒíƒœ:', {
            currentUser: window.firebaseAuth.currentUser ? window.firebaseAuth.currentUser.email : 'ì—†ìŒ',
            app: window.firebaseAuth.app ? 'ìˆìŒ' : 'ì—†ìŒ',
            authDomain: window.firebaseAuth.app?.options?.authDomain || 'ì—†ìŒ',
            apiKey: window.firebaseAuth.app?.options?.apiKey ? 'ì„¤ì •ë¨' : 'ì—†ìŒ'
          });
          
          // ë¦¬ë””ë ‰ì…˜ í›„ ë³µê·€ ì—¬ë¶€ í™•ì¸
          const isRedirectReturn = sessionStorage.getItem('googleRedirectStarted') === 'true';
          console.log('ğŸ” ë¦¬ë””ë ‰ì…˜ í›„ ë³µê·€ ì—¬ë¶€:', isRedirectReturn ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤');
          
          // URLì— ì¸ì¦ ê´€ë ¨ íŒŒë¼ë¯¸í„° í™•ì¸ (ì´ë¯¸ ìœ„ì—ì„œ ì„ ì–¸ëœ ë³€ìˆ˜ ì‚¬ìš©)
          const hasAuthParamsExtended = urlParams.has('apiKey') || urlParams.has('mode') || hashParams.has('access_token') || hashParams.has('id_token');
          console.log('ğŸ” URL ì¸ì¦ íŒŒë¼ë¯¸í„° (í™•ì¥):', hasAuthParamsExtended ? 'ìˆìŒ' : 'ì—†ìŒ');
          if (hasAuthParamsExtended) {
            console.log('ğŸ” URL íŒŒë¼ë¯¸í„° ìƒì„¸:', {
              search: window.location.search,
              hash: window.location.hash.substring(0, 100) // í•´ì‹œëŠ” ê¸¸ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¼ë¶€ë§Œ
            });
          }
          
          // ë¦¬ë””ë ‰ì…˜ í›„ ë³µê·€ì¸ ê²½ìš° ì•½ê°„ì˜ ì§€ì—° í›„ getRedirectResult í˜¸ì¶œ (Firebase Authê°€ ì¸ì¦ ìƒíƒœë¥¼ ì„¤ì •í•  ì‹œê°„ì„ ì¤Œ)
          if (isRedirectReturn || hasAuthParams) {
            console.log('â³ ë¦¬ë””ë ‰ì…˜ í›„ ë³µê·€ ê°ì§€ - ì ì‹œ ëŒ€ê¸° í›„ getRedirectResult í˜¸ì¶œ...');
            await new Promise(resolve => setTimeout(resolve, 500));
          }
          
          let result = null;
          try {
            console.log('ğŸ“ getRedirectResult í˜¸ì¶œ ì§ì „...');
            console.log('ğŸ” í˜„ì¬ ì¸ì¦ ìƒíƒœ:', {
              currentUser: window.firebaseAuth.currentUser ? window.firebaseAuth.currentUser.email : 'ì—†ìŒ',
              authDomain: window.firebaseAuth.app?.options?.authDomain
            });
            
            result = await getRedirectResult(window.firebaseAuth);
            
            console.log('ğŸ“‹ getRedirectResult ì™„ë£Œ');
            console.log('ğŸ“‹ ë¦¬ë””ë ‰ì…˜ ê²°ê³¼:', result ? 'ê²°ê³¼ ìˆìŒ' : 'ê²°ê³¼ ì—†ìŒ (null)');
            
            if (result) {
              console.log('âœ… getRedirectResult ì„±ê³µ!');
              console.log('ğŸ“‹ ê²°ê³¼ ìƒì„¸:', {
                user: result.user ? {
                  email: result.user.email,
                  uid: result.user.uid,
                  providerId: result.user.providerData?.[0]?.providerId
                } : 'ì—†ìŒ',
                credential: result.credential ? 'ìˆìŒ' : 'ì—†ìŒ',
                operationType: result.operationType || 'ì—†ìŒ'
              });
            } else {
              console.log('âš ï¸ getRedirectResultê°€ nullì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤.');
              console.log('ğŸ’¡ ì´ëŠ” ë‹¤ìŒ ì¤‘ í•˜ë‚˜ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:');
              console.log('   1. ë¦¬ë””ë ‰ì…˜ì´ ë°œìƒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              console.log('   2. ë¦¬ë””ë ‰ì…˜ì´ ë°œìƒí–ˆì§€ë§Œ ì¸ì¦ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              console.log('   3. ì´ë¯¸ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
              console.log('   4. ë¦¬ë””ë ‰ì…˜ í›„ ëŒì•„ì™”ì§€ë§Œ Firebase Authê°€ ì¸ì¦ ìƒíƒœë¥¼ ì¸ì‹í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
              console.log('   5. CSP ì˜¤ë¥˜ë¡œ ì¸í•´ ì¸ì¦ í”„ë¡œì„¸ìŠ¤ê°€ ì°¨ë‹¨ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              
              // ë¦¬ë””ë ‰ì…˜ í›„ ë³µê·€ì¸ ê²½ìš° ì¶”ê°€ í™•ì¸
              if (isRedirectReturn || hasAuthParams) {
                console.log('ğŸ”„ ë¦¬ë””ë ‰ì…˜ í›„ ë³µê·€ë¡œ í™•ì¸ë¨ - ì¸ì¦ ìƒíƒœë¥¼ ìˆ˜ë™ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.');
                console.log('ğŸ’¡ onAuthStateChangedê°€ íŠ¸ë¦¬ê±°ë  ë•Œê¹Œì§€ ëŒ€ê¸° ì¤‘...');
                // onAuthStateChangedê°€ íŠ¸ë¦¬ê±°ë  ë•Œê¹Œì§€ ëŒ€ê¸°
                await new Promise(resolve => setTimeout(resolve, 2000));
              }
            }
          } catch (redirectError) {
            console.error('âŒ getRedirectResult ì—ëŸ¬ ë°œìƒ!');
            console.error('ì—ëŸ¬ ì „ì²´:', redirectError);
            console.error('ì—ëŸ¬ ì½”ë“œ:', redirectError.code);
            console.error('ì—ëŸ¬ ë©”ì‹œì§€:', redirectError.message);
            if (redirectError.stack) {
              console.error('ì—ëŸ¬ ìŠ¤íƒ:', redirectError.stack);
            }
            
            // ì—ëŸ¬ë¥¼ ë‹¤ì‹œ throwí•˜ì§€ ì•Šê³  ê³„ì† ì§„í–‰ (ì •ìƒì ì¸ ê²½ìš°ì¼ ìˆ˜ ìˆìŒ)
            if (redirectError.code) {
              if (redirectError.code.includes('no-auth-event') || redirectError.code === 'auth/no-auth-event') {
                console.log('â„¹ï¸ auth/no-auth-event - ì •ìƒì ì¸ ê²½ìš°ì…ë‹ˆë‹¤ (ë¦¬ë””ë ‰ì…˜ì´ ë°œìƒí•˜ì§€ ì•ŠìŒ)');
              } else {
                console.warn('âš ï¸ ì¸ì¦ ì´ë²¤íŠ¸ê°€ ì•„ë‹Œ ì—ëŸ¬ì´ì§€ë§Œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤:', redirectError.code);
              }
            } else {
              console.warn('âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ì—ëŸ¬ì´ì§€ë§Œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.');
            }
          }
          
          // getRedirectResultê°€ nullì„ ë°˜í™˜í–ˆì§€ë§Œ, ì‹¤ì œë¡œëŠ” ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŒ
          // Firebase Authì˜ í˜„ì¬ ì‚¬ìš©ì ìƒíƒœ í™•ì¸ (ì—¬ëŸ¬ ë²ˆ ì‹œë„)
          let firebaseUser = result?.user;
          if (!firebaseUser && window.firebaseAuth) {
            console.log('ğŸ” getRedirectResult ê²°ê³¼ê°€ ì—†ìŒ - í˜„ì¬ ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...');
            
            // ì—¬ëŸ¬ ë²ˆ ì‹œë„ (ì¸ì¦ ìƒíƒœê°€ ì„¤ì •ë˜ëŠ” ë° ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŒ)
            for (let i = 0; i < 5; i++) {
              firebaseUser = window.firebaseAuth.currentUser;
              if (firebaseUser) {
                console.log(`âœ… í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ë°œê²¬ (${i + 1}ë²ˆì§¸ ì‹œë„):`, firebaseUser.email);
                // result ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ ì¼ê´€ëœ ì²˜ë¦¬
                result = { user: firebaseUser };
                break;
              } else {
                console.log(`â³ ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘... (${i + 1}/5)`);
                await new Promise(resolve => setTimeout(resolve, 500));
              }
            }
            
            if (!firebaseUser) {
              console.log('â„¹ï¸ í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì—†ìŒ');
            }
          }
          
          if (result?.user || firebaseUser) {
            const user = result?.user || firebaseUser;
            console.log('âœ… êµ¬ê¸€ ë¡œê·¸ì¸ ì„±ê³µ:', user.email);
            
            const additionalInfo = getAdditionalUserInfo && result ? getAdditionalUserInfo(result) : null;
            
            // finalizeSocialLogin ì‚¬ìš©
            await finalizeSocialLogin(user, {
              loginMethod: 'google',
              additionalInfo,
              toastMessage: 'Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.'
            });
          } else {
            console.log('â„¹ï¸ êµ¬ê¸€ ë¦¬ë””ë ‰ì…˜ ê²°ê³¼ ì—†ìŒ (ì •ìƒì ì¸ ì ‘ê·¼ ë˜ëŠ” ì•„ì§ ë¦¬ë””ë ‰ì…˜ë˜ì§€ ì•ŠìŒ)');
            console.log('ğŸ’¡ êµ¬ê¸€ íšŒì›ê°€ì… ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ êµ¬ê¸€ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
          }
        } catch (error) {
          console.error('âŒ êµ¬ê¸€ ë¦¬ë””ë ‰ì…˜ ê²°ê³¼ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
          
          // ì¸ì¦ ê´€ë ¨ ì—ëŸ¬ì¸ ê²½ìš° ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
          if (error.code && error.code.startsWith('auth/')) {
            console.error('ì¸ì¦ ì—ëŸ¬ ìƒì„¸:', error.code, error.message);
            
            // íŠ¹ì • ì—ëŸ¬ëŠ” ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
            if (error.code === 'auth/account-exists-with-different-credential') {
              alert('ì´ë¯¸ ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.\nê¸°ì¡´ ë¡œê·¸ì¸ ë°©ë²•ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
            } else if (error.code !== 'auth/no-auth-event') {
              // no-auth-eventëŠ” ì •ìƒì ì¸ ê²½ìš°ì´ë¯€ë¡œ ë¬´ì‹œ
              console.warn('ì¸ì¦ ì—ëŸ¬ (ë¬´ì‹œ ê°€ëŠ¥):', error.code);
            }
          }
        }
      }
      
      // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (Firebase ì´ˆê¸°í™” ì „ì—ë„ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
      window.handleGoogleRedirectResult = handleGoogleRedirectResult;

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ register.html v3.2 ë¡œë“œë¨ (ì‹¤ì œ ì´ë©”ì¼ ì¸ì¦ ì‹œìŠ¤í…œ)');
        console.log('âœ… DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
        
        // êµ¬ê¸€ íšŒì›ê°€ì… ë²„íŠ¼ ì¡´ì¬ í™•ì¸
        const googleBtn = document.getElementById('google-register');
        console.log('ğŸ” êµ¬ê¸€ íšŒì›ê°€ì… ë²„íŠ¼ í™•ì¸:', googleBtn ? 'ì°¾ìŒ' : 'ì—†ìŒ');
        if (googleBtn) {
          console.log('ğŸ” ë²„íŠ¼ ìƒì„¸:', {
            id: googleBtn.id,
            className: googleBtn.className,
            disabled: googleBtn.disabled,
            style: googleBtn.style.cssText
          });
        }
        
        // êµ¬ê¸€ ë¦¬ë””ë ‰ì…˜ ê²°ê³¼ ì²˜ë¦¬
        handleGoogleRedirectResult();
        
        // ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„° ì •ë¦¬
        cleanupUserData();
        
        // EmailJS ì´ˆê¸°í™”
        initEmailJS();
        
        // ì´ë©”ì¼ ì¸ì¦ ë°œì†¡ ë²„íŠ¼
        document.getElementById('send-email').addEventListener('click', sendEmailVerification);
        
        // ì´ë©”ì¼ ì¸ì¦ í™•ì¸ ë²„íŠ¼
        document.getElementById('verify-email').addEventListener('click', verifyEmailCode);
        
        // í¼ ì…ë ¥ ì´ë²¤íŠ¸
        document.getElementById('name').addEventListener('input', checkSignupButton);
        document.getElementById('phone').addEventListener('input', checkSignupButton);
        document.getElementById('password').addEventListener('input', checkSignupButton);
        document.getElementById('confirm-password').addEventListener('input', checkSignupButton);
        document.getElementById('agree-terms').addEventListener('change', checkSignupButton);
        document.getElementById('agree-privacy').addEventListener('change', checkSignupButton);
        
        // ì „ì²´ ë™ì˜ ì²´í¬ë°•ìŠ¤
        document.getElementById('agree-all').addEventListener('change', function() {
          const isChecked = this.checked;
          document.getElementById('agree-terms').checked = isChecked;
          document.getElementById('agree-privacy').checked = isChecked;
          document.getElementById('agree-marketing').checked = isChecked;
          checkSignupButton();
        });
        
        // ê°œë³„ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ì „ì²´ ë™ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸
        ['agree-terms', 'agree-privacy', 'agree-marketing'].forEach(id => {
          document.getElementById(id).addEventListener('change', function() {
            const allChecked = document.getElementById('agree-terms').checked &&
                              document.getElementById('agree-privacy').checked &&
                              document.getElementById('agree-marketing').checked;
            document.getElementById('agree-all').checked = allChecked;
            checkSignupButton();
          });
        });
        
        // íšŒì›ê°€ì… í¼ ì œì¶œ
        document.getElementById('signup-form').addEventListener('submit', async function(e) {
          console.log('ğŸš€ íšŒì›ê°€ì… í¼ ì œì¶œ ì‹œì‘');
          e.preventDefault();
          
          if (!isEmailVerified) {
            console.log('âŒ ì´ë©”ì¼ ì¸ì¦ ë¯¸ì™„ë£Œ');
            alert('ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
           return;
         }
         
         console.log('âœ… ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ í™•ì¸ë¨');

          const formData = {
            name: document.getElementById('name').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email-verification').value, // ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©í•  í•„ë“œëª…ìœ¼ë¡œ ë³€ê²½
            emailVerification: document.getElementById('email-verification').value, // ê¸°ì¡´ í•„ë“œë„ ìœ ì§€
            password: document.getElementById('password').value,
            agreeTerms: document.getElementById('agree-terms').checked,
            agreePrivacy: document.getElementById('agree-privacy').checked,
            agreeMarketing: document.getElementById('agree-marketing').checked,
            createdAt: new Date().toISOString()
          };
          
          console.log('ğŸ“‹ í¼ ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ:', formData);
          
          try {
            console.log('ğŸ”¥ Firebase ì €ì¥ ì‹œì‘');
            // Firebaseì— ì €ì¥ (ê¶Œí•œ ì˜¤ë¥˜ ì‹œ localStorageë¡œ í´ë°±)
            const firebaseResult = await saveUserToFirebase(formData);
            
            // localStorage ë°±ì—… ì €ì¥ ì œê±° - Firebase ì „ìš©
            
            // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ë¥¼ user í‚¤ë¡œë„ ì €ì¥ (ë§ˆì´í˜ì´ì§€ í˜¸í™˜ì„±)
            const userDataForStorage = {
              ...formData,
              name: formData.name.trim() // ì´ë¦„ ê³µë°± ì œê±°
            };
            localStorage.setItem('user', JSON.stringify(userDataForStorage));
            localStorage.setItem('currentUser', JSON.stringify(userDataForStorage));
            localStorage.setItem('loggedIn', 'true');
            localStorage.setItem('loggedInEmail', formData.email); // ì´ë©”ì¼ ì €ì¥
            
            // í¬ì¸íŠ¸ ì‹œìŠ¤í…œ ì œê±°ë¨
            
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\në°ì´í„°ê°€ Firebase ì„œë²„ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì‹¤ì œ ê³ ê° í›„ê¸°ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!');
            
            // í›„ê¸° í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = 'reviews.html';

      } catch (error) {
            console.error('íšŒì›ê°€ì… ì‹¤íŒ¨:', error);
            alert('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      });

      // êµ¬ê¸€ íšŒì›ê°€ì… ë²„íŠ¼
      const googleRegisterButton = document.getElementById('google-register');
      if (googleRegisterButton) {
        console.log('âœ… êµ¬ê¸€ íšŒì›ê°€ì… ë²„íŠ¼ ì°¾ìŒ, ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì¤‘...');
        googleRegisterButton.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('ğŸ”µ êµ¬ê¸€ íšŒì›ê°€ì… ë²„íŠ¼ í´ë¦­ë¨');
          try {
            registerWithGoogle();
          } catch (error) {
            console.error('âŒ êµ¬ê¸€ íšŒì›ê°€ì… ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
            alert('êµ¬ê¸€ íšŒì›ê°€ì…ì„ ì‹œì‘í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
          }
        });
        console.log('âœ… êµ¬ê¸€ íšŒì›ê°€ì… ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
      } else {
        console.error('âŒ êµ¬ê¸€ íšŒì›ê°€ì… ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
      }

      // ì¼ë°˜ íšŒì›ê°€ì… í¼ í‘œì‹œ
      document.getElementById('normal-register').addEventListener('click', function() {
        document.getElementById('register-form').classList.remove('hidden');
        this.scrollIntoView({ behavior: 'smooth' });
      });

      // í¼ ë‹«ê¸°
      document.getElementById('close-form').addEventListener('click', function() {
        document.getElementById('register-form').classList.add('hidden');
      });
      });


      // ë¹„ë°€ë²ˆí˜¸ ê°•ë„ í™•ì¸
      function checkPasswordStrength(password) {
        const strengthElement = document.getElementById('password-strength');
        let strength = 0;
        let message = '';
        
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        
        switch (strength) {
          case 0:
          case 1:
            message = 'âŒ ë§¤ìš° ì•½í•¨';
            strengthElement.className = 'mt-2 text-sm text-red-600';
            break;
          case 2:
            message = 'âš ï¸ ì•½í•¨';
            strengthElement.className = 'mt-2 text-sm text-orange-600';
            break;
          case 3:
            message = 'âœ… ë³´í†µ';
            strengthElement.className = 'mt-2 text-sm text-yellow-600';
            break;
          case 4:
            message = 'âœ… ê°•í•¨';
            strengthElement.className = 'mt-2 text-sm text-green-600';
            break;
          case 5:
            message = 'âœ… ë§¤ìš° ê°•í•¨';
            strengthElement.className = 'mt-2 text-sm text-green-600';
            break;
        }
        
        strengthElement.textContent = message;
      }

      // ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ í™•ì¸
      function checkPasswordMatch() {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const matchElement = document.getElementById('password-match');
        
        if (confirmPassword === '') {
          matchElement.textContent = '';
          return;
        }
        
        if (password === confirmPassword) {
          matchElement.textContent = 'âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.';
          matchElement.className = 'mt-2 text-sm text-green-600';
          } else {
          matchElement.textContent = 'âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          matchElement.className = 'mt-2 text-sm text-red-600';
        }
      }

  </script>
</body>
</html>