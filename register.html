<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>íšŒì›ê°€ì… - PriceHunter</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ec4899'><path d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/></svg>">
    
    <!-- ìºì‹œ ì œì–´ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="cache-buster" content="v3.2-20241220" />
    <script>
      // ê°•ì œ ìºì‹œ ë¬´íš¨í™” ë° ë””ë²„ê¹…
      console.log('ğŸš€ register.html v3.2 ë¡œë“œë¨ (ì‹¤ì œ ì´ë©”ì¼ ì¸ì¦ ì‹œìŠ¤í…œ)');
      console.log('ğŸ“ í˜„ì¬ URL:', window.location.href);
      console.log('ğŸ• ë¡œë“œ ì‹œê°„:', new Date().toISOString());
      
      // ë” ê°•ë ¥í•œ ìºì‹œ ë²„ìŠ¤í„°
      if (window.location.search.indexOf('v=') === -1) {
        console.log('ğŸ”„ ê°•ë ¥í•œ ìºì‹œ ë²„ìŠ¤í„° ì¶”ê°€ ì¤‘...');
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(7);
        window.location.href = window.location.href + (window.location.search ? '&' : '?') + 'v=' + timestamp + '&r=' + random;
      }
      
      // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í™•ì¸
      window.addEventListener('load', function() {
        console.log('âœ… í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - v3.2 (ì‹¤ì œ ì´ë©”ì¼ ì¸ì¦ ì‹œìŠ¤í…œ)');
      });
    </script>
  
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  
  <!-- Firebase v9 SDK (ëª¨ë“ˆì‹) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, getDocs, where, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyDBZxKyMS7eeBTbPnbZkj0WWOZQHNldoL4",
      authDomain: "pricehunter-99a1b.firebaseapp.com",
      projectId: "pricehunter-99a1b",
      storageBucket: "pricehunter-99a1b.firebasestorage.app",
      messagingSenderId: "242265693919",
      appId: "1:242265693919:web:74234d942b82a51541136a",
      measurementId: "G-4BKLV4EVB9"
    };

    // Firebase ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ì „ì—­ ë³€ìˆ˜ë¡œ ë…¸ì¶œ
    window.firebaseApp = app;
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebase = {
      firestore: () => db,
      auth: () => auth,
      apps: [app],
      app: () => app,
      firestore: {
        FieldValue: {
          serverTimestamp: serverTimestamp
        }
      }
    };

    console.log('âœ… Firebase v9 ì´ˆê¸°í™” ì™„ë£Œ (register.html)');
  </script>
  
  <style>
    body {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    body, div, p, h1, h2, h3, h4, h5, h6, span, label {
      caret-color: transparent;
    }
    
    input, textarea {
      caret-color: auto;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
      .fade-in-up {
      animation: fadeInUp 0.6s ease-out;
    }

      .loading {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
  </style>
</head>

  <body class="bg-gradient-to-br from-pink-50 to-blue-50 min-h-screen">
  <!-- í—¤ë” -->
    <header class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center">
            <a href="index.html" class="text-2xl font-bold text-pink-600">PriceHunter</a>
          </div>
          <nav class="hidden md:flex space-x-8">
            <a href="index.html" class="text-gray-600 hover:text-pink-600">í™ˆ</a>
            <a href="about.html" class="text-gray-600 hover:text-pink-600">ì†Œê°œ</a>
            <a href="contact.html" class="text-gray-600 hover:text-pink-600">ë¬¸ì˜</a>
          </nav>
      </div>
    </div>
  </header>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="max-w-4xl mx-auto px-4 py-12">
      <div class="text-center mb-12 fade-in-up">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">íšŒì›ê°€ì…</h1>
        <p class="text-lg text-gray-600">PriceHunterì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</p>
    </div>

      <!-- íšŒì›ê°€ì… ì˜µì…˜ -->
      <div class="max-w-md mx-auto mb-12">
        <!-- ì¼ë°˜ íšŒì›ê°€ì… -->
        <div class="bg-white rounded-2xl shadow-lg p-8 text-center fade-in-up">
      <div class="mb-6">
            <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
              <span class="text-2xl">ğŸ“§</span>
          </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">ì¼ë°˜ íšŒì›ê°€ì…</h3>
            <p class="text-gray-600">ì´ë©”ì¼ë¡œ ì§ì ‘ ê°€ì…í•˜ì„¸ìš”</p>
      </div>
          <button id="normal-register" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
            <span class="mr-2">ğŸ“§</span>
            ì´ë©”ì¼ë¡œ ê°€ì…í•˜ê¸°
        </button>
          <p class="text-sm text-green-600 mt-3">ğŸ‰ ê°€ì… ì‹œ 50í¬ì¸íŠ¸ ì§€ê¸‰!</p>
      </div>
    </div>

    <!-- ì¼ë°˜ íšŒì›ê°€ì… í¼ (ìˆ¨ê¹€) -->
    <div id="register-form" class="max-w-md mx-auto bg-white rounded-2xl shadow-lg p-8 hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-900">íšŒì›ê°€ì…</h2>
          <button id="close-form" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <form id="signup-form" class="space-y-6">
        <!-- ì´ë¦„ -->
        <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">ì´ë¦„</label>
            <input type="text" id="name" name="name" required
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
        </div>

        <!-- íœ´ëŒ€í° ë²ˆí˜¸ -->
        <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">íœ´ëŒ€í° ë²ˆí˜¸</label>
            <input type="tel" id="phone" name="phone" required placeholder="010-1234-5678"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
        </div>

        <!-- ì´ë©”ì¼ ì¸ì¦ -->
        <div>
            <label for="email-verification" class="block text-sm font-medium text-gray-700 mb-2">ì´ë©”ì¼ ì¸ì¦</label>
            <div class="flex space-x-2">
              <input type="email" id="email-verification" name="email-verification" required placeholder="example@email.com"
                     class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
              <button type="button" id="send-email" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                ì¸ì¦ë²ˆí˜¸ ë°œì†¡
              </button>
          </div>
            <div id="email-verification-code" class="mt-2 hidden">
              <div class="flex space-x-2">
                <input type="text" id="email-code" placeholder="ì¸ì¦ë²ˆí˜¸ ì…ë ¥"
                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                <button type="button" id="verify-email" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                  ì¸ì¦
                </button>
        </div>
              <p id="email-timer" class="text-sm text-gray-500 mt-1"></p>
          </div>
        </div>

        <!-- ë¹„ë°€ë²ˆí˜¸ -->
        <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="password" name="password" required
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
            <div id="password-strength" class="mt-2 text-sm"></div>
        </div>

        <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ -->
        <div>
            <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" id="confirm-password" name="confirm-password" required
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
            <div id="password-match" class="mt-2 text-sm"></div>
        </div>

        <!-- ì•½ê´€ ë™ì˜ -->
        <div class="space-y-4">
            <div class="flex items-center">
              <input type="checkbox" id="agree-all" class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
              <label for="agree-all" class="ml-2 text-sm font-medium text-gray-700">ì „ì²´ ë™ì˜</label>
          </div>

            <div class="ml-6 space-y-2">
              <div class="flex items-center">
                <input type="checkbox" id="agree-terms" class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                <label for="agree-terms" class="ml-2 text-sm text-gray-600">
                  <a href="#" class="text-pink-600 hover:underline">ì´ìš©ì•½ê´€</a> ë™ì˜ (í•„ìˆ˜)
                </label>
            </div>
            
              <div class="flex items-center">
                <input type="checkbox" id="agree-privacy" class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                <label for="agree-privacy" class="ml-2 text-sm text-gray-600">
                  <a href="#" class="text-pink-600 hover:underline">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a> ë™ì˜ (í•„ìˆ˜)
                </label>
            </div>
            
              <div class="flex items-center">
                <input type="checkbox" id="agree-marketing" class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                <label for="agree-marketing" class="ml-2 text-sm text-gray-600">
                  ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜ (ì„ íƒ)
                </label>
            </div>
          </div>
        </div>

        <!-- ê°€ì… ë²„íŠ¼ -->
          <button type="submit" id="signup-button" disabled
                  class="w-full bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
            íšŒì›ê°€ì…
        </button>
      </form>
    </div>

    <!-- ë¡œê·¸ì¸ ë§í¬ ë° Firebase í…ŒìŠ¤íŠ¸ -->
    <div class="max-w-md mx-auto text-center mt-8">
      <p class="text-gray-600 mb-4">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?</p>
      <a href="index.html#login" class="inline-block bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition">ë¡œê·¸ì¸í•˜ê¸°</a>
      
      <!-- Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ë²„íŠ¼ (ê°œë°œìš©) -->
      <div class="mt-6 p-4 bg-gray-100 rounded-lg">
        <p class="text-sm text-gray-600 mb-2">Firebase ì—°ê²° í…ŒìŠ¤íŠ¸</p>
        <button onclick="testFirebaseConnection()" class="text-sm bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700 transition">
          Firebase ì—°ê²° í…ŒìŠ¤íŠ¸
        </button>
      </div>
    </div>
  </main>

  <script>
      // ì´ë©”ì¼ ì¸ì¦ + íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ëŠ” íšŒì›ê°€ì…

      // ì „ì—­ ë³€ìˆ˜
      let isEmailVerified = false;

      // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
      function waitForFirebase() {
        return new Promise((resolve, reject) => {
          console.log('ğŸ” Firebase ìƒíƒœ í™•ì¸:', {
            firebaseDefined: typeof firebase !== 'undefined',
            firebaseApps: firebase ? firebase.apps.length : 0,
            windowFirebaseApp: !!window.firebaseApp,
            windowFirebaseDb: !!window.firebaseDb,
            windowFirebaseAuth: !!window.firebaseAuth
          });
          
          if (window.firebaseApp && window.firebaseDb && window.firebaseAuth) {
            console.log('âœ… Firebase v9 ì¤€ë¹„ë¨');
            resolve();
          } else {
            console.log('â³ Firebase v9 ëŒ€ê¸° ì¤‘... 100ms í›„ ì¬ì‹œë„');
            setTimeout(() => waitForFirebase().then(resolve).catch(reject), 100);
          }
        });
      }

      // ì‚¬ìš©ì ë°ì´í„°ë¥¼ Firebaseì— ì €ì¥
    async function saveUserToFirebase(userData) {
      try {
          console.log('â³ Firebase ëŒ€ê¸° ì¤‘...');
          await waitForFirebase();
          console.log('âœ… Firebase ì¤€ë¹„ ì™„ë£Œ');
          
          const db = window.firebaseDb;
          const usersRef = collection(db, 'users');
          console.log('ğŸ“Š Firebase Firestore ì—°ê²° ì™„ë£Œ');
          
          // ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ (Firebase)
          console.log('ğŸ” Firebaseì—ì„œ ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ ì¤‘...', userData.email);
          const emailQuery = query(usersRef, where('email', '==', userData.email));
          const emailSnapshot = await getDocs(emailQuery);
          console.log('ğŸ“‹ Firebase ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ ê²°ê³¼:', emailSnapshot.empty ? 'ì¤‘ë³µ ì—†ìŒ' : 'ì¤‘ë³µ ë°œê²¬');
          if (!emailSnapshot.empty) {
            throw new Error('ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
          }
          
          // íœ´ëŒ€í° ë²ˆí˜¸ ì¤‘ë³µ í™•ì¸ (Firebase)
          console.log('ğŸ” Firebaseì—ì„œ íœ´ëŒ€í° ë²ˆí˜¸ ì¤‘ë³µ í™•ì¸ ì¤‘...', userData.phone);
          const phoneQuery = query(usersRef, where('phone', '==', userData.phone));
          const phoneSnapshot = await getDocs(phoneQuery);
          console.log('ğŸ“‹ Firebase íœ´ëŒ€í° ì¤‘ë³µ í™•ì¸ ê²°ê³¼:', phoneSnapshot.empty ? 'ì¤‘ë³µ ì—†ìŒ' : 'ì¤‘ë³µ ë°œê²¬');
          if (!phoneSnapshot.empty) {
            throw new Error('ì´ë¯¸ ê°€ì…ëœ íœ´ëŒ€í° ë²ˆí˜¸ì…ë‹ˆë‹¤.');
          }
          
          // localStorageì—ì„œë„ ì¤‘ë³µ í™•ì¸
          console.log('ğŸ” localStorageì—ì„œ ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ ì¤‘...', userData.email);
          const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
          const duplicateEmail = existingUsers.find(user => user.email === userData.email);
          if (duplicateEmail) {
            throw new Error('ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
          }
          
          console.log('ğŸ” localStorageì—ì„œ íœ´ëŒ€í° ë²ˆí˜¸ ì¤‘ë³µ í™•ì¸ ì¤‘...', userData.phone);
          const duplicatePhone = existingUsers.find(user => user.phone === userData.phone);
          if (duplicatePhone) {
            throw new Error('ì´ë¯¸ ê°€ì…ëœ íœ´ëŒ€í° ë²ˆí˜¸ì…ë‹ˆë‹¤.');
          }
          console.log('ğŸ“‹ localStorage ì¤‘ë³µ í™•ì¸ ê²°ê³¼: ì¤‘ë³µ ì—†ìŒ');
          
          // ì‚¬ìš©ì ë°ì´í„° ì €ì¥
          console.log('ğŸ’¾ Firebaseì— ì‚¬ìš©ì ë°ì´í„° ì €ì¥ ì¤‘...');
          const docRef = await addDoc(usersRef, {
          ...userData,
          createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          
          console.log('âœ… Firebaseì— ì‚¬ìš©ì ì €ì¥ ì™„ë£Œ:', docRef.id);
          return docRef.id;
      } catch (error) {
          console.error('âŒ Firebase ì €ì¥ ì‹¤íŒ¨:', error);
          
          // ê¶Œí•œ ì˜¤ë¥˜ì¸ ê²½ìš° localStorageë¡œ í´ë°±
          if (error.message.includes('Missing or insufficient permissions') || 
              error.message.includes('permission-denied')) {
            console.log('ğŸ”„ Firebase ê¶Œí•œ ì˜¤ë¥˜ ê°ì§€ - localStorageë¡œ í´ë°±');
            
            // localStorageì—ì„œ ì¤‘ë³µ í™•ì¸
            console.log('ğŸ” localStorageì—ì„œ ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ ì¤‘...', userData.email);
            const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
            const duplicateEmail = existingUsers.find(user => user.email === userData.email);
            if (duplicateEmail) {
              throw new Error('ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
            }
            
            console.log('ğŸ” localStorageì—ì„œ íœ´ëŒ€í° ë²ˆí˜¸ ì¤‘ë³µ í™•ì¸ ì¤‘...', userData.phone);
            const duplicatePhone = existingUsers.find(user => user.phone === userData.phone);
            if (duplicatePhone) {
              throw new Error('ì´ë¯¸ ê°€ì…ëœ íœ´ëŒ€í° ë²ˆí˜¸ì…ë‹ˆë‹¤.');
            }
            console.log('ğŸ“‹ localStorage ì¤‘ë³µ í™•ì¸ ê²°ê³¼: ì¤‘ë³µ ì—†ìŒ');
            
            console.log('âœ… ì‚¬ìš©ì ë°ì´í„°ê°€ localStorageì— ì €ì¥ë©ë‹ˆë‹¤');
            return 'localStorage_fallback';
          }
          
          // ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” ê·¸ëŒ€ë¡œ throw
          throw error;
        }
      }

      // localStorageì— ì‚¬ìš©ì ë°ì´í„° ì €ì¥
      function saveUserToLocalStorage(userData) {
        try {
          const users = JSON.parse(localStorage.getItem('users') || '[]');
          users.push(userData);
          localStorage.setItem('users', JSON.stringify(users));
          console.log('âœ… localStorageì— ì‚¬ìš©ì ì €ì¥ ì™„ë£Œ');
        } catch (error) {
          console.error('âŒ localStorage ì €ì¥ ì‹¤íŒ¨:', error);
        }
        }
        
        // í¬ì¸íŠ¸ ì¶”ê°€
      function addPoints(userEmail, points = 50) {
        try {
          const pointsData = JSON.parse(localStorage.getItem('userPoints') || '{}');
          if (!pointsData[userEmail]) {
            pointsData[userEmail] = { total: 0, history: [] };
          }
        pointsData[userEmail].total += points;
        pointsData[userEmail].history.push({
          points: points,
            reason: 'íšŒì›ê°€ì… ë³´ë„ˆìŠ¤',
            date: new Date().toISOString()
        });
        localStorage.setItem('userPoints', JSON.stringify(pointsData));
          console.log(`âœ… ${points}í¬ì¸íŠ¸ ì¶”ê°€ ì™„ë£Œ`);
      } catch (error) {
          console.error('âŒ í¬ì¸íŠ¸ ì¶”ê°€ ì‹¤íŒ¨:', error);
        }
      }

      // EmailJS ì´ˆê¸°í™”
      function initEmailJS() {
        // EmailJS ê³µê°œ í‚¤ (ì‹¤ì œ ì‚¬ìš© ì‹œ https://dashboard.emailjs.com/admin/integration ì—ì„œ ë°œê¸‰ë°›ì•„ì•¼ í•¨)
        emailjs.init("zrRVWnL0cA9eyxpDp"); // ì‹¤ì œ Public Key (ë³µì‚¬ ì™„ë£Œ)
        
        console.log('ğŸ“§ EmailJS ì´ˆê¸°í™” ì™„ë£Œ');
      }

      // ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„° ì •ë¦¬ í•¨ìˆ˜
      function cleanupUserData() {
        try {
          console.log('ğŸ§¹ ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„° ì •ë¦¬ ì‹œì‘...');
          
          // ê¸°ì¡´ users ë°°ì—´ í™•ì¸
          const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
          console.log('ğŸ“‹ ê¸°ì¡´ ì‚¬ìš©ì ìˆ˜:', existingUsers.length);
          
          // ì˜ëª»ëœ í˜•ì‹ì˜ ë°ì´í„° ì •ë¦¬
          const cleanedUsers = existingUsers.filter(user => {
            // email í•„ë“œê°€ ì—†ê³  emailVerificationë§Œ ìˆëŠ” ê²½ìš° ìˆ˜ì •
            if (!user.email && user.emailVerification) {
              user.email = user.emailVerification;
              console.log('âœ… ì´ë©”ì¼ í•„ë“œ ìˆ˜ì •:', user.email);
            }
            
            // í•„ìˆ˜ í•„ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
            return user.email && user.password && user.name && user.phone;
          });
          
          if (cleanedUsers.length !== existingUsers.length) {
            localStorage.setItem('users', JSON.stringify(cleanedUsers));
            console.log('âœ… ì‚¬ìš©ì ë°ì´í„° ì •ë¦¬ ì™„ë£Œ:', cleanedUsers.length, 'ëª…');
          } else {
            console.log('âœ… ì‚¬ìš©ì ë°ì´í„°ê°€ ì´ë¯¸ ì •ë¦¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
          }
          
          return cleanedUsers;
        } catch (error) {
          console.error('âŒ ì‚¬ìš©ì ë°ì´í„° ì •ë¦¬ ì‹¤íŒ¨:', error);
          return [];
        }
      }

      // Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
      async function testFirebaseConnection() {
        try {
          console.log('ğŸ§ª Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...');
          await waitForFirebase();
          
          const db = window.firebaseDb;
          const testRef = collection(db, 'test');
          
          // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì“°ê¸°
          console.log('ğŸ“ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì“°ê¸° ì¤‘...');
          const testDoc = await addDoc(testRef, {
            test: true,
            timestamp: serverTimestamp(),
            message: 'Firebase ì—°ê²° í…ŒìŠ¤íŠ¸'
          });
          
          console.log('âœ… Firebase ì“°ê¸° í…ŒìŠ¤íŠ¸ ì„±ê³µ:', testDoc.id);
          
          // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì½ê¸°
          console.log('ğŸ“– í…ŒìŠ¤íŠ¸ ë°ì´í„° ì½ê¸° ì¤‘...');
          const testData = await getDoc(testDoc);
          console.log('âœ… Firebase ì½ê¸° í…ŒìŠ¤íŠ¸ ì„±ê³µ:', testData.data());
          
          // í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ
          console.log('ğŸ—‘ï¸ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì¤‘...');
          await deleteDoc(testDoc);
          console.log('âœ… Firebase ì‚­ì œ í…ŒìŠ¤íŠ¸ ì„±ê³µ');
          
          alert('âœ… Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!\n\nëª¨ë“  ì‘ì—…(ì½ê¸°/ì“°ê¸°/ì‚­ì œ)ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.');
          return true;
          
        } catch (error) {
          console.error('âŒ Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
          
          if (error.message.includes('Missing or insufficient permissions')) {
            alert('âŒ Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!\n\n' +
                  'Firebase ë³´ì•ˆ ê·œì¹™ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' +
                  'FIREBASE_SECURITY_RULES.md íŒŒì¼ì„ ì°¸ê³ í•˜ì—¬ ë³´ì•ˆ ê·œì¹™ì„ ìˆ˜ì •í•˜ì„¸ìš”.');
          } else {
            alert('âŒ Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!\n\nì˜¤ë¥˜: ' + error.message);
          }
          
          return false;
        }
      }

      // ì‹¤ì œ ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ ë°œì†¡
      async function sendEmailVerification() {
        const email = document.getElementById('email-verification').value;
        
        if (!email) {
          alert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          alert('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // ì¸ì¦ë²ˆí˜¸ ìƒì„±
        const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
        localStorage.setItem('emailVerificationCode', verificationCode);
        localStorage.setItem('emailVerificationTime', Date.now().toString());
        
        // UI ì—…ë°ì´íŠ¸
        document.getElementById('email-verification-code').classList.remove('hidden');
        document.getElementById('send-email').textContent = 'ë°œì†¡ ì¤‘...';
        document.getElementById('send-email').disabled = true;
        
        try {
          // EmailJSë¥¼ ì‚¬ìš©í•œ ì‹¤ì œ ì´ë©”ì¼ ë°œì†¡
          const templateParams = {
            to_email: email,
            verification_code: verificationCode,
            user_name: document.getElementById('name').value || 'ì‚¬ìš©ì',
            from_name: 'PriceHunter'
          };
          
          // EmailJS ì„œë¹„ìŠ¤ IDì™€ í…œí”Œë¦¿ ID (ì‹¤ì œ ì‚¬ìš© ì‹œ êµì²´ í•„ìš”)
          const result = await emailjs.send(
            'service_qq3o0or', // ì‹¤ì œ ì„œë¹„ìŠ¤ ID (ì´ë¯¸ í™•ì¸ë¨)
            'template_9oj52gx', // ì‹¤ì œ í…œí”Œë¦¿ ID (ë³µì‚¬ ì™„ë£Œ)
            templateParams
          );
          
          console.log('âœ… ì´ë©”ì¼ ë°œì†¡ ì„±ê³µ:', result);
          
          // UI ì—…ë°ì´íŠ¸
          document.getElementById('send-email').textContent = 'ì¬ë°œì†¡';
          document.getElementById('send-email').disabled = false;
          
          // íƒ€ì´ë¨¸ ì‹œì‘ (5ë¶„)
          startEmailTimer();
          
          alert('ì¸ì¦ë²ˆí˜¸ê°€ ì´ë©”ì¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
          
        } catch (error) {
          console.error('âŒ ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨:', error);
          
          // ì‹¤íŒ¨ ì‹œ Mock ì‹œìŠ¤í…œìœ¼ë¡œ í´ë°±
          console.log('ğŸ”„ Mock ì‹œìŠ¤í…œìœ¼ë¡œ í´ë°±');
          document.getElementById('send-email').textContent = 'ì¬ë°œì†¡';
          document.getElementById('send-email').disabled = false;
          startEmailTimer();
          
          alert(`ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¸ì¦ë²ˆí˜¸: ${verificationCode}\n(ê°œë°œ ëª¨ë“œ: ì‹¤ì œ ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨)`);
        }
      }

      // ì´ë©”ì¼ íƒ€ì´ë¨¸ ì‹œì‘
      function startEmailTimer() {
        let timeLeft = 300; // 5ë¶„
        const timer = setInterval(() => {
          const minutes = Math.floor(timeLeft / 60);
          const seconds = timeLeft % 60;
          document.getElementById('email-timer').textContent = `ë‚¨ì€ ì‹œê°„: ${minutes}:${seconds.toString().padStart(2, '0')}`;
          
          if (timeLeft <= 0) {
            clearInterval(timer);
            document.getElementById('email-timer').textContent = 'ì¸ì¦ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            document.getElementById('send-email').disabled = false;
          }
          timeLeft--;
        }, 1000);
        
        // 5ë¶„ í›„ ë²„íŠ¼ í™œì„±í™”
        setTimeout(() => {
          document.getElementById('send-email').disabled = false;
        }, 300000);
      }
      // ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ í™•ì¸
      function verifyEmailCode() {
        const inputCode = document.getElementById('email-code').value;
        const storedCode = localStorage.getItem('emailVerificationCode');
        const storedTime = localStorage.getItem('emailVerificationTime');
        
        if (!inputCode) {
          alert('ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (!storedCode) {
          alert('ì¸ì¦ë²ˆí˜¸ë¥¼ ë¨¼ì € ë°œì†¡í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // ì‹œê°„ ë§Œë£Œ í™•ì¸ (5ë¶„)
        const currentTime = Date.now();
        const timeDiff = currentTime - parseInt(storedTime);
        if (timeDiff > 300000) { // 5ë¶„ = 300000ms
          alert('ì¸ì¦ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë°œì†¡í•´ì£¼ì„¸ìš”.');
          localStorage.removeItem('emailVerificationCode');
          localStorage.removeItem('emailVerificationTime');
           return;
         }

        if (inputCode === storedCode) {
          isEmailVerified = true;
          document.getElementById('email-verification-code').classList.add('hidden');
          document.getElementById('email-timer').textContent = 'âœ… ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
          document.getElementById('email-timer').classList.add('text-green-600');
          document.getElementById('send-email').disabled = true;
          document.getElementById('email-verification').disabled = true;
          
          // ê°€ì… ë²„íŠ¼ í™œì„±í™” ì²´í¬
          checkSignupButton();
          
          alert('ì´ë©”ì¼ ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          console.log('âœ… ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ');
        } else {
          alert('ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
      }
      
      // ê°€ì… ë²„íŠ¼ í™œì„±í™” ì²´í¬
      function checkSignupButton() {
        const name = document.getElementById('name').value;
        const phone = document.getElementById('phone').value;
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const agreeTerms = document.getElementById('agree-terms').checked;
        const agreePrivacy = document.getElementById('agree-privacy').checked;
        
        console.log('ğŸ” íšŒì›ê°€ì… ë²„íŠ¼ ì²´í¬:', {
          name: name ? 'âœ…' : 'âŒ',
          phone: phone ? 'âœ…' : 'âŒ',
          password: password ? 'âœ…' : 'âŒ',
          confirmPassword: confirmPassword ? 'âœ…' : 'âŒ',
          passwordMatch: password === confirmPassword ? 'âœ…' : 'âŒ',
          agreeTerms: agreeTerms ? 'âœ…' : 'âŒ',
          agreePrivacy: agreePrivacy ? 'âœ…' : 'âŒ',
          isEmailVerified: isEmailVerified ? 'âœ…' : 'âŒ'
        });
        
        const isFormValid = name && phone && password && confirmPassword && 
                           password === confirmPassword && agreeTerms && agreePrivacy && isEmailVerified;
        
        const signupButton = document.getElementById('signup-button');
        if (isFormValid) {
          signupButton.disabled = false;
          signupButton.classList.remove('bg-gray-400');
          signupButton.classList.add('bg-pink-600', 'hover:bg-pink-700');
          console.log('âœ… íšŒì›ê°€ì… ë²„íŠ¼ í™œì„±í™”ë¨');
            } else {
          signupButton.disabled = true;
          signupButton.classList.add('bg-gray-400');
          signupButton.classList.remove('bg-pink-600', 'hover:bg-pink-700');
          console.log('âŒ íšŒì›ê°€ì… ë²„íŠ¼ ë¹„í™œì„±í™”ë¨');
        }
      }
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸš€ register.html v3.2 ë¡œë“œë¨ (ì‹¤ì œ ì´ë©”ì¼ ì¸ì¦ ì‹œìŠ¤í…œ)');
        
        // ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„° ì •ë¦¬
        cleanupUserData();
        
        // EmailJS ì´ˆê¸°í™”
        initEmailJS();
        
        // ì´ë©”ì¼ ì¸ì¦ ë°œì†¡ ë²„íŠ¼
        document.getElementById('send-email').addEventListener('click', sendEmailVerification);
        
        // ì´ë©”ì¼ ì¸ì¦ í™•ì¸ ë²„íŠ¼
        document.getElementById('verify-email').addEventListener('click', verifyEmailCode);
        
        // í¼ ì…ë ¥ ì´ë²¤íŠ¸
        document.getElementById('name').addEventListener('input', checkSignupButton);
        document.getElementById('phone').addEventListener('input', checkSignupButton);
        document.getElementById('password').addEventListener('input', checkSignupButton);
        document.getElementById('confirm-password').addEventListener('input', checkSignupButton);
        document.getElementById('agree-terms').addEventListener('change', checkSignupButton);
        document.getElementById('agree-privacy').addEventListener('change', checkSignupButton);
        
        // ì „ì²´ ë™ì˜ ì²´í¬ë°•ìŠ¤
        document.getElementById('agree-all').addEventListener('change', function() {
          const isChecked = this.checked;
          document.getElementById('agree-terms').checked = isChecked;
          document.getElementById('agree-privacy').checked = isChecked;
          document.getElementById('agree-marketing').checked = isChecked;
          checkSignupButton();
        });
        
        // ê°œë³„ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ì „ì²´ ë™ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸
        ['agree-terms', 'agree-privacy', 'agree-marketing'].forEach(id => {
          document.getElementById(id).addEventListener('change', function() {
            const allChecked = document.getElementById('agree-terms').checked &&
                              document.getElementById('agree-privacy').checked &&
                              document.getElementById('agree-marketing').checked;
            document.getElementById('agree-all').checked = allChecked;
            checkSignupButton();
          });
        });
        
        // íšŒì›ê°€ì… í¼ ì œì¶œ
        document.getElementById('signup-form').addEventListener('submit', async function(e) {
          console.log('ğŸš€ íšŒì›ê°€ì… í¼ ì œì¶œ ì‹œì‘');
          e.preventDefault();
          
          if (!isEmailVerified) {
            console.log('âŒ ì´ë©”ì¼ ì¸ì¦ ë¯¸ì™„ë£Œ');
            alert('ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
           return;
         }
         
         console.log('âœ… ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ í™•ì¸ë¨');

          const formData = {
            name: document.getElementById('name').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email-verification').value, // ë¡œê·¸ì¸ ì‹œ ì‚¬ìš©í•  í•„ë“œëª…ìœ¼ë¡œ ë³€ê²½
            emailVerification: document.getElementById('email-verification').value, // ê¸°ì¡´ í•„ë“œë„ ìœ ì§€
            password: document.getElementById('password').value,
            agreeTerms: document.getElementById('agree-terms').checked,
            agreePrivacy: document.getElementById('agree-privacy').checked,
            agreeMarketing: document.getElementById('agree-marketing').checked,
            createdAt: new Date().toISOString()
          };
          
          console.log('ğŸ“‹ í¼ ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ:', formData);
          
          try {
            console.log('ğŸ”¥ Firebase ì €ì¥ ì‹œì‘');
            // Firebaseì— ì €ì¥ (ê¶Œí•œ ì˜¤ë¥˜ ì‹œ localStorageë¡œ í´ë°±)
            const firebaseResult = await saveUserToFirebase(formData);
            
            // localStorageì—ë„ ë°±ì—… ì €ì¥
            saveUserToLocalStorage(formData);
            
            // í¬ì¸íŠ¸ ì¶”ê°€
            addPoints(formData.email, 50);
            
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            if (firebaseResult === 'localStorage_fallback') {
              alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! 50í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ë°ì´í„°ëŠ” ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤)');
            } else {
              alert('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! 50í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.\në°ì´í„°ê°€ Firebase ì„œë²„ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
            
            window.location.href = 'index.html';

      } catch (error) {
            console.error('íšŒì›ê°€ì… ì‹¤íŒ¨:', error);
            alert('íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      });

      // ì¼ë°˜ íšŒì›ê°€ì… í¼ í‘œì‹œ
      document.getElementById('normal-register').addEventListener('click', function() {
        document.getElementById('register-form').classList.remove('hidden');
        this.scrollIntoView({ behavior: 'smooth' });
      });

      // í¼ ë‹«ê¸°
      document.getElementById('close-form').addEventListener('click', function() {
        document.getElementById('register-form').classList.add('hidden');
      });
      });


      // ë¹„ë°€ë²ˆí˜¸ ê°•ë„ í™•ì¸
      function checkPasswordStrength(password) {
        const strengthElement = document.getElementById('password-strength');
        let strength = 0;
        let message = '';
        
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        
        switch (strength) {
          case 0:
          case 1:
            message = 'âŒ ë§¤ìš° ì•½í•¨';
            strengthElement.className = 'mt-2 text-sm text-red-600';
            break;
          case 2:
            message = 'âš ï¸ ì•½í•¨';
            strengthElement.className = 'mt-2 text-sm text-orange-600';
            break;
          case 3:
            message = 'âœ… ë³´í†µ';
            strengthElement.className = 'mt-2 text-sm text-yellow-600';
            break;
          case 4:
            message = 'âœ… ê°•í•¨';
            strengthElement.className = 'mt-2 text-sm text-green-600';
            break;
          case 5:
            message = 'âœ… ë§¤ìš° ê°•í•¨';
            strengthElement.className = 'mt-2 text-sm text-green-600';
            break;
        }
        
        strengthElement.textContent = message;
      }

      // ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ í™•ì¸
      function checkPasswordMatch() {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const matchElement = document.getElementById('password-match');
        
        if (confirmPassword === '') {
          matchElement.textContent = '';
          return;
        }
        
        if (password === confirmPassword) {
          matchElement.textContent = 'âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.';
          matchElement.className = 'mt-2 text-sm text-green-600';
          } else {
          matchElement.textContent = 'âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          matchElement.className = 'mt-2 text-sm text-red-600';
        }
      }

  </script>
</body>
</html>