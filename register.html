<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>회원가입 - PriceHunter</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ec4899'><path d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/></svg>">
    
    <!-- 캐시 제어 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="cache-buster" content="v3.2-20241220" />
    <script>
      // 강제 캐시 무효화 및 디버깅
      console.log('🚀 register.html v3.2 로드됨 (실제 이메일 인증 시스템)');
      console.log('📍 현재 URL:', window.location.href);
      console.log('🕐 로드 시간:', new Date().toISOString());
      
      // 더 강력한 캐시 버스터
      if (window.location.search.indexOf('v=') === -1) {
        console.log('🔄 강력한 캐시 버스터 추가 중...');
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(7);
        window.location.href = window.location.href + (window.location.search ? '&' : '?') + 'v=' + timestamp + '&r=' + random;
      }
      
      // 페이지 로드 완료 확인
      window.addEventListener('load', function() {
        console.log('✅ 페이지 로드 완료 - v3.2 (실제 이메일 인증 시스템)');
      });
    </script>
  
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  
  <!-- Firebase v9 SDK (모듈식) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, getDocs, where, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyDBZxKyMS7eeBTbPnbZkj0WWOZQHNldoL4",
      authDomain: "pricehunter-99a1b.firebaseapp.com",
      projectId: "pricehunter-99a1b",
      storageBucket: "pricehunter-99a1b.firebasestorage.app",
      messagingSenderId: "242265693919",
      appId: "1:242265693919:web:74234d942b82a51541136a",
      measurementId: "G-4BKLV4EVB9"
    };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 전역 변수로 노출
    window.firebaseApp = app;
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebase = {
      firestore: () => db,
      auth: () => auth,
      apps: [app],
      app: () => app,
      firestore: {
        FieldValue: {
          serverTimestamp: serverTimestamp
        }
      }
    };

    console.log('✅ Firebase v9 초기화 완료 (register.html)');
  </script>
  
  <style>
    body {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    body, div, p, h1, h2, h3, h4, h5, h6, span, label {
      caret-color: transparent;
    }
    
    input, textarea {
      caret-color: auto;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
      .fade-in-up {
      animation: fadeInUp 0.6s ease-out;
    }

      .loading {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
  </style>
</head>

  <body class="bg-gradient-to-br from-pink-50 to-blue-50 min-h-screen">
  <!-- 헤더 -->
    <header class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center">
            <a href="index.html" class="text-2xl font-bold text-pink-600">PriceHunter</a>
          </div>
          <nav class="hidden md:flex space-x-8">
            <a href="index.html" class="text-gray-600 hover:text-pink-600">홈</a>
            <a href="about.html" class="text-gray-600 hover:text-pink-600">소개</a>
            <a href="contact.html" class="text-gray-600 hover:text-pink-600">문의</a>
          </nav>
      </div>
    </div>
  </header>

  <!-- 메인 콘텐츠 -->
    <main class="max-w-4xl mx-auto px-4 py-12">
      <div class="text-center mb-12 fade-in-up">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">회원가입</h1>
        <p class="text-lg text-gray-600">PriceHunter에 오신 것을 환영합니다!</p>
    </div>

      <!-- 회원가입 옵션 -->
      <div class="max-w-md mx-auto mb-12">
        <!-- 일반 회원가입 -->
        <div class="bg-white rounded-2xl shadow-lg p-8 text-center fade-in-up">
      <div class="mb-6">
            <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
              <span class="text-2xl">📧</span>
          </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">일반 회원가입</h3>
            <p class="text-gray-600">이메일로 직접 가입하세요</p>
      </div>
          <button id="normal-register" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
            <span class="mr-2">📧</span>
            이메일로 가입하기
        </button>
          <p class="text-sm text-green-600 mt-3">🎉 가입 시 50포인트 지급!</p>
      </div>
    </div>

    <!-- 일반 회원가입 폼 (숨김) -->
    <div id="register-form" class="max-w-md mx-auto bg-white rounded-2xl shadow-lg p-8 hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-900">회원가입</h2>
          <button id="close-form" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <form id="signup-form" class="space-y-6">
        <!-- 이름 -->
        <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">이름</label>
            <input type="text" id="name" name="name" required
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
        </div>

        <!-- 휴대폰 번호 -->
        <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">휴대폰 번호</label>
            <input type="tel" id="phone" name="phone" required placeholder="010-1234-5678"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
        </div>

        <!-- 이메일 인증 -->
        <div>
            <label for="email-verification" class="block text-sm font-medium text-gray-700 mb-2">이메일 인증</label>
            <div class="flex space-x-2">
              <input type="email" id="email-verification" name="email-verification" required placeholder="example@email.com"
                     class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
              <button type="button" id="send-email" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                인증번호 발송
              </button>
          </div>
            <div id="email-verification-code" class="mt-2 hidden">
              <div class="flex space-x-2">
                <input type="text" id="email-code" placeholder="인증번호 입력"
                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
                <button type="button" id="verify-email" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                  인증
                </button>
        </div>
              <p id="email-timer" class="text-sm text-gray-500 mt-1"></p>
          </div>
        </div>

        <!-- 비밀번호 -->
        <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">비밀번호</label>
            <input type="password" id="password" name="password" required
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
            <div id="password-strength" class="mt-2 text-sm"></div>
        </div>

        <!-- 비밀번호 확인 -->
        <div>
            <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-2">비밀번호 확인</label>
            <input type="password" id="confirm-password" name="confirm-password" required
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
            <div id="password-match" class="mt-2 text-sm"></div>
        </div>

        <!-- 약관 동의 -->
        <div class="space-y-4">
            <div class="flex items-center">
              <input type="checkbox" id="agree-all" class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
              <label for="agree-all" class="ml-2 text-sm font-medium text-gray-700">전체 동의</label>
          </div>

            <div class="ml-6 space-y-2">
              <div class="flex items-center">
                <input type="checkbox" id="agree-terms" class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                <label for="agree-terms" class="ml-2 text-sm text-gray-600">
                  <a href="#" class="text-pink-600 hover:underline">이용약관</a> 동의 (필수)
                </label>
            </div>
            
              <div class="flex items-center">
                <input type="checkbox" id="agree-privacy" class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                <label for="agree-privacy" class="ml-2 text-sm text-gray-600">
                  <a href="#" class="text-pink-600 hover:underline">개인정보처리방침</a> 동의 (필수)
                </label>
            </div>
            
              <div class="flex items-center">
                <input type="checkbox" id="agree-marketing" class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                <label for="agree-marketing" class="ml-2 text-sm text-gray-600">
                  마케팅 정보 수신 동의 (선택)
                </label>
            </div>
          </div>
        </div>

        <!-- 가입 버튼 -->
          <button type="submit" id="signup-button" disabled
                  class="w-full bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
            회원가입
        </button>
      </form>
    </div>

    <!-- 로그인 링크 및 Firebase 테스트 -->
    <div class="max-w-md mx-auto text-center mt-8">
      <p class="text-gray-600 mb-4">이미 계정이 있으신가요?</p>
      <a href="index.html#login" class="inline-block bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition">로그인하기</a>
      
      <!-- Firebase 연결 테스트 버튼 (개발용) -->
      <div class="mt-6 p-4 bg-gray-100 rounded-lg">
        <p class="text-sm text-gray-600 mb-2">Firebase 연결 테스트</p>
        <button onclick="testFirebaseConnection()" class="text-sm bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700 transition">
          Firebase 연결 테스트
        </button>
      </div>
    </div>
  </main>

  <script>
      // 이메일 인증 + 휴대폰 번호를 사용하는 회원가입

      // 전역 변수
      let isEmailVerified = false;

      // Firebase 초기화 대기
      function waitForFirebase() {
        return new Promise((resolve, reject) => {
          console.log('🔍 Firebase 상태 확인:', {
            firebaseDefined: typeof firebase !== 'undefined',
            firebaseApps: firebase ? firebase.apps.length : 0,
            windowFirebaseApp: !!window.firebaseApp,
            windowFirebaseDb: !!window.firebaseDb,
            windowFirebaseAuth: !!window.firebaseAuth
          });
          
          if (window.firebaseApp && window.firebaseDb && window.firebaseAuth) {
            console.log('✅ Firebase v9 준비됨');
            resolve();
          } else {
            console.log('⏳ Firebase v9 대기 중... 100ms 후 재시도');
            setTimeout(() => waitForFirebase().then(resolve).catch(reject), 100);
          }
        });
      }

      // 사용자 데이터를 Firebase에 저장
    async function saveUserToFirebase(userData) {
      try {
          console.log('⏳ Firebase 대기 중...');
          await waitForFirebase();
          console.log('✅ Firebase 준비 완료');
          
          const db = window.firebaseDb;
          const usersRef = collection(db, 'users');
          console.log('📊 Firebase Firestore 연결 완료');
          
          // 이메일 중복 확인 (Firebase)
          console.log('🔍 Firebase에서 이메일 중복 확인 중...', userData.email);
          const emailQuery = query(usersRef, where('email', '==', userData.email));
          const emailSnapshot = await getDocs(emailQuery);
          console.log('📋 Firebase 이메일 중복 확인 결과:', emailSnapshot.empty ? '중복 없음' : '중복 발견');
          if (!emailSnapshot.empty) {
            throw new Error('이미 가입된 이메일입니다.');
          }
          
          // 휴대폰 번호 중복 확인 (Firebase)
          console.log('🔍 Firebase에서 휴대폰 번호 중복 확인 중...', userData.phone);
          const phoneQuery = query(usersRef, where('phone', '==', userData.phone));
          const phoneSnapshot = await getDocs(phoneQuery);
          console.log('📋 Firebase 휴대폰 중복 확인 결과:', phoneSnapshot.empty ? '중복 없음' : '중복 발견');
          if (!phoneSnapshot.empty) {
            throw new Error('이미 가입된 휴대폰 번호입니다.');
          }
          
          // localStorage에서도 중복 확인
          console.log('🔍 localStorage에서 이메일 중복 확인 중...', userData.email);
          const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
          const duplicateEmail = existingUsers.find(user => user.email === userData.email);
          if (duplicateEmail) {
            throw new Error('이미 가입된 이메일입니다.');
          }
          
          console.log('🔍 localStorage에서 휴대폰 번호 중복 확인 중...', userData.phone);
          const duplicatePhone = existingUsers.find(user => user.phone === userData.phone);
          if (duplicatePhone) {
            throw new Error('이미 가입된 휴대폰 번호입니다.');
          }
          console.log('📋 localStorage 중복 확인 결과: 중복 없음');
          
          // 사용자 데이터 저장
          console.log('💾 Firebase에 사용자 데이터 저장 중...');
          const docRef = await addDoc(usersRef, {
          ...userData,
          createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          
          console.log('✅ Firebase에 사용자 저장 완료:', docRef.id);
          return docRef.id;
      } catch (error) {
          console.error('❌ Firebase 저장 실패:', error);
          
          // 권한 오류인 경우 localStorage로 폴백
          if (error.message.includes('Missing or insufficient permissions') || 
              error.message.includes('permission-denied')) {
            console.log('🔄 Firebase 권한 오류 감지 - localStorage로 폴백');
            
            // localStorage에서 중복 확인
            console.log('🔍 localStorage에서 이메일 중복 확인 중...', userData.email);
            const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
            const duplicateEmail = existingUsers.find(user => user.email === userData.email);
            if (duplicateEmail) {
              throw new Error('이미 가입된 이메일입니다.');
            }
            
            console.log('🔍 localStorage에서 휴대폰 번호 중복 확인 중...', userData.phone);
            const duplicatePhone = existingUsers.find(user => user.phone === userData.phone);
            if (duplicatePhone) {
              throw new Error('이미 가입된 휴대폰 번호입니다.');
            }
            console.log('📋 localStorage 중복 확인 결과: 중복 없음');
            
            console.log('✅ 사용자 데이터가 localStorage에 저장됩니다');
            return 'localStorage_fallback';
          }
          
          // 다른 오류는 그대로 throw
          throw error;
        }
      }

      // localStorage에 사용자 데이터 저장
      function saveUserToLocalStorage(userData) {
        try {
          const users = JSON.parse(localStorage.getItem('users') || '[]');
          users.push(userData);
          localStorage.setItem('users', JSON.stringify(users));
          console.log('✅ localStorage에 사용자 저장 완료');
        } catch (error) {
          console.error('❌ localStorage 저장 실패:', error);
        }
        }
        
        // 포인트 추가
      function addPoints(userEmail, points = 50) {
        try {
          const pointsData = JSON.parse(localStorage.getItem('userPoints') || '{}');
          if (!pointsData[userEmail]) {
            pointsData[userEmail] = { total: 0, history: [] };
          }
        pointsData[userEmail].total += points;
        pointsData[userEmail].history.push({
          points: points,
            reason: '회원가입 보너스',
            date: new Date().toISOString()
        });
        localStorage.setItem('userPoints', JSON.stringify(pointsData));
          console.log(`✅ ${points}포인트 추가 완료`);
      } catch (error) {
          console.error('❌ 포인트 추가 실패:', error);
        }
      }

      // EmailJS 초기화
      function initEmailJS() {
        // EmailJS 공개 키 (실제 사용 시 https://dashboard.emailjs.com/admin/integration 에서 발급받아야 함)
        emailjs.init("zrRVWnL0cA9eyxpDp"); // 실제 Public Key (복사 완료)
        
        console.log('📧 EmailJS 초기화 완료');
      }

      // 기존 사용자 데이터 정리 함수
      function cleanupUserData() {
        try {
          console.log('🧹 기존 사용자 데이터 정리 시작...');
          
          // 기존 users 배열 확인
          const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
          console.log('📋 기존 사용자 수:', existingUsers.length);
          
          // 잘못된 형식의 데이터 정리
          const cleanedUsers = existingUsers.filter(user => {
            // email 필드가 없고 emailVerification만 있는 경우 수정
            if (!user.email && user.emailVerification) {
              user.email = user.emailVerification;
              console.log('✅ 이메일 필드 수정:', user.email);
            }
            
            // 필수 필드가 있는지 확인
            return user.email && user.password && user.name && user.phone;
          });
          
          if (cleanedUsers.length !== existingUsers.length) {
            localStorage.setItem('users', JSON.stringify(cleanedUsers));
            console.log('✅ 사용자 데이터 정리 완료:', cleanedUsers.length, '명');
          } else {
            console.log('✅ 사용자 데이터가 이미 정리되어 있습니다.');
          }
          
          return cleanedUsers;
        } catch (error) {
          console.error('❌ 사용자 데이터 정리 실패:', error);
          return [];
        }
      }

      // Firebase 연결 테스트 함수
      async function testFirebaseConnection() {
        try {
          console.log('🧪 Firebase 연결 테스트 시작...');
          await waitForFirebase();
          
          const db = window.firebaseDb;
          const testRef = collection(db, 'test');
          
          // 테스트 데이터 쓰기
          console.log('📝 테스트 데이터 쓰기 중...');
          const testDoc = await addDoc(testRef, {
            test: true,
            timestamp: serverTimestamp(),
            message: 'Firebase 연결 테스트'
          });
          
          console.log('✅ Firebase 쓰기 테스트 성공:', testDoc.id);
          
          // 테스트 데이터 읽기
          console.log('📖 테스트 데이터 읽기 중...');
          const testData = await getDoc(testDoc);
          console.log('✅ Firebase 읽기 테스트 성공:', testData.data());
          
          // 테스트 데이터 삭제
          console.log('🗑️ 테스트 데이터 삭제 중...');
          await deleteDoc(testDoc);
          console.log('✅ Firebase 삭제 테스트 성공');
          
          alert('✅ Firebase 연결 테스트 성공!\n\n모든 작업(읽기/쓰기/삭제)이 정상적으로 작동합니다.');
          return true;
          
        } catch (error) {
          console.error('❌ Firebase 연결 테스트 실패:', error);
          
          if (error.message.includes('Missing or insufficient permissions')) {
            alert('❌ Firebase 연결 테스트 실패!\n\n' +
                  'Firebase 보안 규칙 오류가 발생했습니다.\n' +
                  'FIREBASE_SECURITY_RULES.md 파일을 참고하여 보안 규칙을 수정하세요.');
          } else {
            alert('❌ Firebase 연결 테스트 실패!\n\n오류: ' + error.message);
          }
          
          return false;
        }
      }

      // 실제 이메일 인증번호 발송
      async function sendEmailVerification() {
        const email = document.getElementById('email-verification').value;
        
        if (!email) {
          alert('이메일을 입력해주세요.');
          return;
        }
        
        // 이메일 형식 검증
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          alert('올바른 이메일 형식을 입력해주세요.');
          return;
        }
        
        // 인증번호 생성
        const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
        localStorage.setItem('emailVerificationCode', verificationCode);
        localStorage.setItem('emailVerificationTime', Date.now().toString());
        
        // UI 업데이트
        document.getElementById('email-verification-code').classList.remove('hidden');
        document.getElementById('send-email').textContent = '발송 중...';
        document.getElementById('send-email').disabled = true;
        
        try {
          // EmailJS를 사용한 실제 이메일 발송
          const templateParams = {
            to_email: email,
            verification_code: verificationCode,
            user_name: document.getElementById('name').value || '사용자',
            from_name: 'PriceHunter'
          };
          
          // EmailJS 서비스 ID와 템플릿 ID (실제 사용 시 교체 필요)
          const result = await emailjs.send(
            'service_qq3o0or', // 실제 서비스 ID (이미 확인됨)
            'template_9oj52gx', // 실제 템플릿 ID (복사 완료)
            templateParams
          );
          
          console.log('✅ 이메일 발송 성공:', result);
          
          // UI 업데이트
          document.getElementById('send-email').textContent = '재발송';
          document.getElementById('send-email').disabled = false;
          
          // 타이머 시작 (5분)
          startEmailTimer();
          
          alert('인증번호가 이메일로 발송되었습니다. 이메일을 확인해주세요.');
          
        } catch (error) {
          console.error('❌ 이메일 발송 실패:', error);
          
          // 실패 시 Mock 시스템으로 폴백
          console.log('🔄 Mock 시스템으로 폴백');
          document.getElementById('send-email').textContent = '재발송';
          document.getElementById('send-email').disabled = false;
          startEmailTimer();
          
          alert(`인증번호가 발송되었습니다.\n인증번호: ${verificationCode}\n(개발 모드: 실제 이메일 발송 실패)`);
        }
      }

      // 이메일 타이머 시작
      function startEmailTimer() {
        let timeLeft = 300; // 5분
        const timer = setInterval(() => {
          const minutes = Math.floor(timeLeft / 60);
          const seconds = timeLeft % 60;
          document.getElementById('email-timer').textContent = `남은 시간: ${minutes}:${seconds.toString().padStart(2, '0')}`;
          
          if (timeLeft <= 0) {
            clearInterval(timer);
            document.getElementById('email-timer').textContent = '인증 시간이 만료되었습니다.';
            document.getElementById('send-email').disabled = false;
          }
          timeLeft--;
        }, 1000);
        
        // 5분 후 버튼 활성화
        setTimeout(() => {
          document.getElementById('send-email').disabled = false;
        }, 300000);
      }
      // 이메일 인증번호 확인
      function verifyEmailCode() {
        const inputCode = document.getElementById('email-code').value;
        const storedCode = localStorage.getItem('emailVerificationCode');
        const storedTime = localStorage.getItem('emailVerificationTime');
        
        if (!inputCode) {
          alert('인증번호를 입력해주세요.');
          return;
        }
        
        if (!storedCode) {
          alert('인증번호를 먼저 발송해주세요.');
          return;
        }
        
        // 시간 만료 확인 (5분)
        const currentTime = Date.now();
        const timeDiff = currentTime - parseInt(storedTime);
        if (timeDiff > 300000) { // 5분 = 300000ms
          alert('인증 시간이 만료되었습니다. 다시 발송해주세요.');
          localStorage.removeItem('emailVerificationCode');
          localStorage.removeItem('emailVerificationTime');
           return;
         }

        if (inputCode === storedCode) {
          isEmailVerified = true;
          document.getElementById('email-verification-code').classList.add('hidden');
          document.getElementById('email-timer').textContent = '✅ 이메일 인증이 완료되었습니다.';
          document.getElementById('email-timer').classList.add('text-green-600');
          document.getElementById('send-email').disabled = true;
          document.getElementById('email-verification').disabled = true;
          
          // 가입 버튼 활성화 체크
          checkSignupButton();
          
          alert('이메일 인증이 완료되었습니다.');
          console.log('✅ 이메일 인증 완료');
        } else {
          alert('인증번호가 일치하지 않습니다.');
        }
      }
      
      // 가입 버튼 활성화 체크
      function checkSignupButton() {
        const name = document.getElementById('name').value;
        const phone = document.getElementById('phone').value;
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const agreeTerms = document.getElementById('agree-terms').checked;
        const agreePrivacy = document.getElementById('agree-privacy').checked;
        
        console.log('🔍 회원가입 버튼 체크:', {
          name: name ? '✅' : '❌',
          phone: phone ? '✅' : '❌',
          password: password ? '✅' : '❌',
          confirmPassword: confirmPassword ? '✅' : '❌',
          passwordMatch: password === confirmPassword ? '✅' : '❌',
          agreeTerms: agreeTerms ? '✅' : '❌',
          agreePrivacy: agreePrivacy ? '✅' : '❌',
          isEmailVerified: isEmailVerified ? '✅' : '❌'
        });
        
        const isFormValid = name && phone && password && confirmPassword && 
                           password === confirmPassword && agreeTerms && agreePrivacy && isEmailVerified;
        
        const signupButton = document.getElementById('signup-button');
        if (isFormValid) {
          signupButton.disabled = false;
          signupButton.classList.remove('bg-gray-400');
          signupButton.classList.add('bg-pink-600', 'hover:bg-pink-700');
          console.log('✅ 회원가입 버튼 활성화됨');
            } else {
          signupButton.disabled = true;
          signupButton.classList.add('bg-gray-400');
          signupButton.classList.remove('bg-pink-600', 'hover:bg-pink-700');
          console.log('❌ 회원가입 버튼 비활성화됨');
        }
      }
      // 이벤트 리스너 등록
      document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 register.html v3.2 로드됨 (실제 이메일 인증 시스템)');
        
        // 기존 사용자 데이터 정리
        cleanupUserData();
        
        // EmailJS 초기화
        initEmailJS();
        
        // 이메일 인증 발송 버튼
        document.getElementById('send-email').addEventListener('click', sendEmailVerification);
        
        // 이메일 인증 확인 버튼
        document.getElementById('verify-email').addEventListener('click', verifyEmailCode);
        
        // 폼 입력 이벤트
        document.getElementById('name').addEventListener('input', checkSignupButton);
        document.getElementById('phone').addEventListener('input', checkSignupButton);
        document.getElementById('password').addEventListener('input', checkSignupButton);
        document.getElementById('confirm-password').addEventListener('input', checkSignupButton);
        document.getElementById('agree-terms').addEventListener('change', checkSignupButton);
        document.getElementById('agree-privacy').addEventListener('change', checkSignupButton);
        
        // 전체 동의 체크박스
        document.getElementById('agree-all').addEventListener('change', function() {
          const isChecked = this.checked;
          document.getElementById('agree-terms').checked = isChecked;
          document.getElementById('agree-privacy').checked = isChecked;
          document.getElementById('agree-marketing').checked = isChecked;
          checkSignupButton();
        });
        
        // 개별 체크박스 변경 시 전체 동의 상태 업데이트
        ['agree-terms', 'agree-privacy', 'agree-marketing'].forEach(id => {
          document.getElementById(id).addEventListener('change', function() {
            const allChecked = document.getElementById('agree-terms').checked &&
                              document.getElementById('agree-privacy').checked &&
                              document.getElementById('agree-marketing').checked;
            document.getElementById('agree-all').checked = allChecked;
            checkSignupButton();
          });
        });
        
        // 회원가입 폼 제출
        document.getElementById('signup-form').addEventListener('submit', async function(e) {
          console.log('🚀 회원가입 폼 제출 시작');
          e.preventDefault();
          
          if (!isEmailVerified) {
            console.log('❌ 이메일 인증 미완료');
            alert('이메일 인증을 완료해주세요.');
           return;
         }
         
         console.log('✅ 이메일 인증 완료 확인됨');

          const formData = {
            name: document.getElementById('name').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email-verification').value, // 로그인 시 사용할 필드명으로 변경
            emailVerification: document.getElementById('email-verification').value, // 기존 필드도 유지
            password: document.getElementById('password').value,
            agreeTerms: document.getElementById('agree-terms').checked,
            agreePrivacy: document.getElementById('agree-privacy').checked,
            agreeMarketing: document.getElementById('agree-marketing').checked,
            createdAt: new Date().toISOString()
          };
          
          console.log('📋 폼 데이터 수집 완료:', formData);
          
          try {
            console.log('🔥 Firebase 저장 시작');
            // Firebase에 저장 (권한 오류 시 localStorage로 폴백)
            const firebaseResult = await saveUserToFirebase(formData);
            
            // localStorage에도 백업 저장
            saveUserToLocalStorage(formData);
            
            // 포인트 추가
            addPoints(formData.email, 50);
            
            // 성공 메시지 표시
            if (firebaseResult === 'localStorage_fallback') {
              alert('회원가입이 완료되었습니다! 50포인트가 지급되었습니다.\n(데이터는 로컬에 저장되었습니다)');
            } else {
              alert('회원가입이 완료되었습니다! 50포인트가 지급되었습니다.\n데이터가 Firebase 서버에 안전하게 저장되었습니다.');
            }
            
            window.location.href = 'index.html';

      } catch (error) {
            console.error('회원가입 실패:', error);
            alert('회원가입 중 오류가 발생했습니다: ' + error.message);
        }
      });

      // 일반 회원가입 폼 표시
      document.getElementById('normal-register').addEventListener('click', function() {
        document.getElementById('register-form').classList.remove('hidden');
        this.scrollIntoView({ behavior: 'smooth' });
      });

      // 폼 닫기
      document.getElementById('close-form').addEventListener('click', function() {
        document.getElementById('register-form').classList.add('hidden');
      });
      });


      // 비밀번호 강도 확인
      function checkPasswordStrength(password) {
        const strengthElement = document.getElementById('password-strength');
        let strength = 0;
        let message = '';
        
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        
        switch (strength) {
          case 0:
          case 1:
            message = '❌ 매우 약함';
            strengthElement.className = 'mt-2 text-sm text-red-600';
            break;
          case 2:
            message = '⚠️ 약함';
            strengthElement.className = 'mt-2 text-sm text-orange-600';
            break;
          case 3:
            message = '✅ 보통';
            strengthElement.className = 'mt-2 text-sm text-yellow-600';
            break;
          case 4:
            message = '✅ 강함';
            strengthElement.className = 'mt-2 text-sm text-green-600';
            break;
          case 5:
            message = '✅ 매우 강함';
            strengthElement.className = 'mt-2 text-sm text-green-600';
            break;
        }
        
        strengthElement.textContent = message;
      }

      // 비밀번호 일치 확인
      function checkPasswordMatch() {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const matchElement = document.getElementById('password-match');
        
        if (confirmPassword === '') {
          matchElement.textContent = '';
          return;
        }
        
        if (password === confirmPassword) {
          matchElement.textContent = '✅ 비밀번호가 일치합니다.';
          matchElement.className = 'mt-2 text-sm text-green-600';
          } else {
          matchElement.textContent = '❌ 비밀번호가 일치하지 않습니다.';
          matchElement.className = 'mt-2 text-sm text-red-600';
        }
      }

  </script>
</body>
</html>