<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <title>í”„ë¡œí•„ ì •ë³´ ì…ë ¥ - PriceHunter</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ec4899'><path d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z'/></svg>">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase v9 SDK (ëª¨ë“ˆì‹) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyDBZxKyMS7eeBTbPnbZkj0WWOZQHNldoL4",
      authDomain: "pricehunter-99a1b.firebaseapp.com",
      projectId: "pricehunter-99a1b",
      storageBucket: "pricehunter-99a1b.firebasestorage.app",
      messagingSenderId: "242265693919",
      appId: "1:242265693919:web:74234d942b82a51541136a",
      measurementId: "G-4BKLV4EVB9"
    };

    // Firebase ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ì „ì—­ ë³€ìˆ˜ë¡œ ë…¸ì¶œ
    window.firebaseApp = app;
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebaseFirestoreFunctions = { 
      doc, 
      getDoc, 
      setDoc 
    };

    console.log('âœ… Firebase v9 ì´ˆê¸°í™” ì™„ë£Œ (complete-profile.html)');
  </script>
  
  <style>
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .fade-in-up {
      animation: fadeInUp 0.6s ease-out;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-pink-50 to-blue-50 min-h-screen">
  <!-- í—¤ë” -->
  <header class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center">
          <a href="index.html" class="text-2xl font-bold text-pink-600">PriceHunter</a>
        </div>
      </div>
    </div>
  </header>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <main class="max-w-4xl mx-auto px-4 py-12 mx-4">
    <div class="text-center mb-12 fade-in-up">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">í”„ë¡œí•„ ì •ë³´ ì…ë ¥</h1>
      <p class="text-lg text-gray-600">ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´<br class="sm:hidden">ì¶”ê°€ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
    </div>

    <!-- í”„ë¡œí•„ ì…ë ¥ í¼ -->
    <div class="max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8 fade-in-up">
      <form id="profile-form" class="space-y-6">
        <!-- ì´ë¦„ -->
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700 mb-2">ì´ë¦„ *</label>
          <input type="text" id="name" name="name" required placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
        </div>

        <!-- íœ´ëŒ€í° ë²ˆí˜¸ -->
        <div>
          <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">íœ´ëŒ€í° ë²ˆí˜¸ *</label>
          <input type="tel" id="phone" name="phone" required placeholder="010-1234-5678"
                 pattern="[0-9]{3}-[0-9]{4}-[0-9]{4}"
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent">
          <p class="mt-1 text-sm text-gray-500">ì˜ˆ: 010-1234-5678</p>
        </div>

        <!-- ì´ë©”ì¼ (ì½ê¸° ì „ìš©) -->
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700 mb-2">ì´ë©”ì¼</label>
          <input type="email" id="email" name="email" readonly
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed">
        </div>

        <!-- ì œì¶œ ë²„íŠ¼ -->
        <button type="submit" id="submit-button"
                class="w-full bg-pink-600 hover:bg-pink-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
          ì •ë³´ ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°
        </button>
      </form>
    </div>
  </main>

  <script>
    // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
    function waitForFirebase() {
      return new Promise((resolve, reject) => {
        if (window.firebaseApp && window.firebaseDb && window.firebaseAuth && window.firebaseFirestoreFunctions) {
          resolve();
        } else {
          const checkInterval = setInterval(() => {
            if (window.firebaseApp && window.firebaseDb && window.firebaseAuth && window.firebaseFirestoreFunctions) {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
          
          setTimeout(() => {
            clearInterval(checkInterval);
            reject(new Error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨'));
          }, 10000);
        }
      });
    }

    // íœ´ëŒ€í° ë²ˆí˜¸ í¬ë§·íŒ…
    function formatPhoneNumber(value) {
      const numbers = value.replace(/[^0-9]/g, '');
      if (numbers.length <= 3) return numbers;
      if (numbers.length <= 7) return `${numbers.slice(0, 3)}-${numbers.slice(3)}`;
      return `${numbers.slice(0, 3)}-${numbers.slice(3, 7)}-${numbers.slice(7, 11)}`;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('ğŸš€ complete-profile.html ë¡œë“œë¨');
      
      try {
        await waitForFirebase();
        const { onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js');
        
        // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì í™•ì¸
        onAuthStateChanged(window.firebaseAuth, async (user) => {
          if (!user) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
            return;
          }
          
          // ì´ë©”ì¼ ì…ë ¥ í•„ë“œì— í˜„ì¬ ì´ë©”ì¼ ì„¤ì •
          document.getElementById('email').value = user.email || '';
          
          // ì´ë¯¸ í”„ë¡œí•„ ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸
          try {
            const { doc, getDoc } = window.firebaseFirestoreFunctions;
            const userRef = doc(window.firebaseDb, 'users', user.uid);
            const userDoc = await getDoc(userRef);
            
            if (userDoc.exists()) {
              const userData = userDoc.data();
              // ì´ë¦„ê³¼ í•¸ë“œí°ë²ˆí˜¸ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
              if (userData.name && userData.phone) {
                console.log('âœ… ì´ë¯¸ í”„ë¡œí•„ ì •ë³´ê°€ ìˆìŠµë‹ˆë‹¤. ëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                window.location.href = 'member-dashboard.html';
                return;
              }
              
              // ë¶€ë¶„ì ìœ¼ë¡œ ì •ë³´ê°€ ìˆìœ¼ë©´ ì…ë ¥ í•„ë“œì— ì±„ìš°ê¸°
              if (userData.name) {
                document.getElementById('name').value = userData.name;
              }
              if (userData.phone) {
                document.getElementById('phone').value = userData.phone;
              }
            }
          } catch (error) {
            console.error('ì‚¬ìš©ì ì •ë³´ í™•ì¸ ì‹¤íŒ¨:', error);
          }
        });
      } catch (error) {
        console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        alert('í˜ì´ì§€ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
      }

      // íœ´ëŒ€í° ë²ˆí˜¸ ì…ë ¥ ì‹œ ìë™ í¬ë§·íŒ…
      const phoneInput = document.getElementById('phone');
      phoneInput.addEventListener('input', function(e) {
        const formatted = formatPhoneNumber(e.target.value);
        e.target.value = formatted;
      });

      // í¼ ì œì¶œ
      document.getElementById('profile-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const email = document.getElementById('email').value.trim();
        
        // ìœ íš¨ì„± ê²€ì‚¬
        if (!name) {
          alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (!phone) {
          alert('íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // íœ´ëŒ€í° ë²ˆí˜¸ í˜•ì‹ ê²€ì‚¬
        const phonePattern = /^[0-9]{3}-[0-9]{4}-[0-9]{4}$/;
        if (!phonePattern.test(phone)) {
          alert('íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.\nì˜ˆ: 010-1234-5678');
          return;
        }
        
        const submitButton = document.getElementById('submit-button');
        submitButton.disabled = true;
        submitButton.textContent = 'ì €ì¥ ì¤‘...';
        
        try {
          await waitForFirebase();
          
          const currentUser = window.firebaseAuth.currentUser;
          if (!currentUser) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html';
            return;
          }
          
          const { doc, setDoc } = window.firebaseFirestoreFunctions;
          const userRef = doc(window.firebaseDb, 'users', currentUser.uid);
          
          // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
          await setDoc(userRef, {
            name: name,
            displayName: name,
            phone: phone,
            phoneNumber: phone,
            email: email,
            updatedAt: new Date()
          }, { merge: true });
          
          console.log('âœ… í”„ë¡œí•„ ì •ë³´ ì €ì¥ ì™„ë£Œ');
          
          // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
          const userData = {
            uid: currentUser.uid,
            email: email,
            name: name,
            displayName: name,
            phone: phone,
            phoneNumber: phone
          };
          localStorage.setItem('currentUser', JSON.stringify(userData));
          localStorage.setItem('user', JSON.stringify(userData));
          
          alert('í”„ë¡œí•„ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
          window.location.href = 'member-dashboard.html';
          
        } catch (error) {
          console.error('í”„ë¡œí•„ ì •ë³´ ì €ì¥ ì‹¤íŒ¨:', error);
          alert('í”„ë¡œí•„ ì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = 'ì •ë³´ ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°';
        }
      });
    });
  </script>
</body>
</html>

