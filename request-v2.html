<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PriceHunter - 최저가 검증 의뢰</title>
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-N7R437NT77"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-N7R437NT77');
  </script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Firebase v9 SDK (모듈식) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query, where, orderBy, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyDBZxKyMS7eeBTbPnbZkj0WWOZQHNldoL4",
      authDomain: "pricehunter-99a1b.firebaseapp.com",
      projectId: "pricehunter-99a1b",
      storageBucket: "pricehunter-99a1b.firebasestorage.app",
      messagingSenderId: "242265693919",
      appId: "1:242265693919:web:74234d942b82a51541136a",
      measurementId: "G-4BKLV4EVB9"
    };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 전역 변수로 노출
    window.firebaseApp = app;
    window.firebaseAuth = auth;
    window.firebaseDb = db;
    window.firebaseFirestoreFunctions = { 
      collection, 
      addDoc, 
      serverTimestamp, 
      query, 
      orderBy, 
      getDocs, 
      where, 
      doc, 
      updateDoc, 
      deleteDoc 
    };

    console.log('✅ Firebase v9 초기화 완료 (request-v2.html)');
  </script>
  
  <style>
    /* 텍스트 선택 허용 (드래그 가능) */
    body {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    /* 버튼과 링크, 입력 필드는 텍스트 선택 허용 */
    button, a, input, textarea, select {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    /* 커서 깜빡임 방지 */
    body, div, p, h1, h2, h3, h4, h5, h6, span, label {
      caret-color: transparent;
    }
    
    /* 입력 요소는 커서 표시 */
    input, textarea {
      caret-color: auto;
    }
    .fadein-step {
      animation: fadein-step 0.7s cubic-bezier(.4,0,.2,1) both;
    }
    @keyframes fadein-step {
      0% { opacity: 0; transform: translateY(40px) scale(0.98); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    .slidein-step {
      animation: slidein-step 0.7s cubic-bezier(.4,0,.2,1) both;
    }
    @keyframes slidein-step {
      0% { opacity: 0; transform: translateX(60px) scale(0.98); }
      100% { opacity: 1; transform: translateX(0) scale(1); }
    }
    .stepper-dot-animate {
      transition: background 0.4s, box-shadow 0.4s, transform 0.4s;
    }
    .stepper-dot-active {
      background: linear-gradient(90deg, #f472b6 0%, #fbbf24 100%);
      box-shadow: 0 4px 16px 0 rgba(255, 99, 132, 0.15);
      transform: scale(1.15);
    }
    .stepper-dot {
      background: #d1d5db;
    }
    .input-animate:focus {
      box-shadow: 0 0 0 3px #fbbf24aa;
      transition: box-shadow 0.3s;
    }
    .btn-animate {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-animate:hover {
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 8px 32px 0 rgba(236, 72, 153, 0.12);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-100 via-blue-50 to-emerald-50 min-h-screen flex flex-col items-center justify-center py-4 md:py-12">
  <div class="w-full max-w-lg bg-white/90 rounded-2xl shadow-2xl p-4 md:p-8 lg:p-10 backdrop-blur-md">
    <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-blue-800 mb-4 md:mb-6 text-center">최저가<br class="sm:hidden">요청하기</h2>
    <div id="stepper" class="flex justify-between items-center mb-6 md:mb-8">
      <div class="flex-1 flex flex-col items-center">
        <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-white stepper-dot stepper-dot-animate text-sm md:text-base" id="step-1-dot">1</div>
        <div class="text-xs mt-1 hidden sm:block">의뢰<br class="sm:hidden">등록</div>
      </div>
      <div class="flex-1 h-1 bg-gradient-to-r from-blue-300 to-pink-300 mx-1"></div>
      <div class="flex-1 flex flex-col items-center">
        <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-white stepper-dot stepper-dot-animate text-sm md:text-base" id="step-2-dot">2</div>
        <div class="text-xs mt-1 hidden sm:block">참고/<br class="sm:hidden">이미지</div>
      </div>
      <div class="flex-1 h-1 bg-gradient-to-r from-blue-300 to-pink-300 mx-1"></div>
      <div class="flex-1 flex flex-col items-center">
        <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-white stepper-dot stepper-dot-animate text-sm md:text-base" id="step-3-dot">3</div>
        <div class="text-xs mt-1 hidden sm:block">연락처</div>
      </div>
      <div class="flex-1 h-1 bg-gradient-to-r from-blue-300 to-pink-300 mx-1"></div>
      <div class="flex-1 flex flex-col items-center">
        <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center font-bold text-white stepper-dot stepper-dot-animate text-sm md:text-base" id="step-4-dot">4</div>
        <div class="text-xs mt-1 hidden sm:block">접수완료</div>
      </div>
    </div>
    <form id="step-form">
      <!-- Step 1: 제품정보 -->
      <div class="step" id="step-1">
        <div class="mb-4 p-3 rounded-xl bg-blue-50 border border-blue-200 text-blue-800 text-base font-semibold text-center shadow-sm animate-fadein-up">
          📝 <span class="font-bold">최저가 요청 등록</span><br>
          <span class="text-pink-600 font-bold">⚠️ 브랜드 제품은 검증 제외됩니다</span><br>
          <span class="text-xs text-gray-600">애플, 삼성, LG, 명품, 스니커즈, 대형TV 등 브랜드 제품은<br>가격 변동이 심하고 정확한 비교가 어려워 검증에서 제외됩니다</span><br>
          <span class="block mt-2 text-blue-700">예시: "캠핑용 접이식 의자, 4인용, 방수천, 등받이 조절 가능"</span>
          <div class="mt-3">
            <a href="support.html#faq" class="inline-block px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
              📋 자세한 내용은 구매전필독사항
            </a>
          </div>
        </div>
        <label class="block text-gray-700 font-semibold mb-2" for="productName">제품명</label>
        <input type="text" id="productName" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-400 focus:outline-none transition mb-4 input-animate" placeholder="예: 캠핑용 접이식 의자, 책상, 옷장, 주방용품 등" />
        <div class="text-xs text-blue-500 mt-1">💡 브랜드가 없는 제품, 또는 브랜드가 중요하지 않은 제품 위주로 의뢰해 주세요!</div>
        <label class="block text-gray-700 font-semibold mb-2" for="productDesc">제품 설명 <span class="text-sm text-blue-600 font-normal">(제품의 핵심포인트)</span></label>
        <textarea id="productDesc" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-400 focus:outline-none transition mb-4 input-animate" rows="3" placeholder="예: 4인용, 방수천, 등받이 조절, 접이식, 휴대용, 최대 하중 120kg, 색상: 네이비 / 3단, 철제 프레임, 옷걸이 포함, 조립식, 색상: 화이트 등"></textarea>
        <label class="block text-gray-700 font-semibold mb-2" for="productPrice">예상 가격(원)</label>
        <input type="number" id="productPrice" min="1000" step="1" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-400 focus:outline-none transition mb-2 input-animate" placeholder="예: 1000 (원)" />
        <div class="text-xs text-pink-600 mb-4">※ 최소 의뢰 금액은 <span class="font-bold">1,000원</span> 이상입니다.</div>
        
        <!-- 비교 옵션 -->
        <div class="bg-gray-50 p-4 rounded-lg mb-4">
          <h4 class="font-semibold text-gray-800 mb-3">비교 옵션</h4>
          <div class="space-y-2">
            <label class="flex items-center">
              <input type="radio" name="comparisonType" value="exact" checked class="mr-2 text-blue-600">
              <span class="text-sm">▢ 완전 동일만 비교 (기본)</span>
            </label>
            <label class="flex items-center">
              <input type="radio" name="comparisonType" value="flexible" class="mr-2 text-blue-600">
              <span class="text-sm">▢ 색상·패키징 무관 허용</span>
            </label>
          </div>
        </div>
        
        <!-- 마이크로카피 -->
        <div class="bg-blue-50 p-3 rounded-lg mb-4">
          <p class="text-sm text-blue-800 font-medium">💡 고객님이 의뢰하신 제품보다 더 저렴한 최저가를 찾아드리는 전문가입니다!</p>
        </div>
        
        <!-- 동의 체크박스 -->
        <div class="space-y-3 mb-4">
          <div class="flex items-start">
            <input type="checkbox" id="evidenceAgree" required class="mt-1 mr-2 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-400">
            <label for="evidenceAgree" class="text-sm text-gray-700">[필수] 증거 수집(링크/스크린샷)·시점고정 안내에 동의합니다.</label>
          </div>
          <div class="flex items-start">
            <input type="checkbox" id="brandExcludeAgree" required class="mt-1 mr-2 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-400">
            <label for="brandExcludeAgree" class="text-sm text-gray-700">[필수] 브랜드배제 정책(애플·명품·스니커즈·대형TV 등)을 확인했습니다.</label>
          </div>
        </div>
        <button type="button" class="w-full mt-8 py-3 bg-blue-500 text-white font-bold rounded-lg shadow btn-animate" id="to-step-2">다음</button>
      </div>
      <!-- Step 2: 참고/이미지 -->
      <div class="step hidden" id="step-2">
        <div class="mb-4 p-3 rounded-xl bg-emerald-50 border border-emerald-200 text-emerald-800 text-base font-semibold text-center shadow-sm animate-fadein-up">
          🔗 <span class="font-bold">참고할 만한 사이트(쇼핑몰, 블로그 등) 링크를 남겨주시면<br>더 정확하게 원하는 제품을 파악할 수 있어요!</span><br>
          공식 쇼핑몰, 가격비교 사이트, 블로그 후기 등 어떤 링크든 괜찮아요.<br>
          <span class="text-pink-600 font-bold">링크는 1개만 입력해 주세요.</span><br>
          <span class="text-xs text-gray-500">💡 이미지는 최대 5장까지 첨부할 수 있습니다.<br>제품의 실제 사진, 캡처, 설명서 등 어떤 이미지든 도움이 됩니다!</span>
        </div>
        <label class="block text-gray-700 font-semibold mb-2" for="productUrl">참고사이트(링크 1개) <span class="text-red-500">*</span></label>
        <input type="text" id="productUrl" name="productUrl" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-amber-400 focus:outline-none transition" placeholder="예: https://example.com 또는 www.example.com" />
        <div class="text-xs text-emerald-500 mt-1">💡 http://, https://, www.로 시작하는 링크만 입력해 주세요.</div>
        <label class="block text-gray-700 font-semibold mb-2 mt-6" for="productImage">제품 이미지 업로드 (최대 5장)</label>
        <input type="file" id="productImage" name="productImage" accept="image/*" class="w-full" multiple />
        <div id="imagePreview" class="mt-2 flex flex-wrap gap-2"></div>
        <div class="text-xs text-emerald-500 mt-1">💡 여러 장 첨부 시, 첫 번째 이미지를 대표 이미지로 사용합니다.</div>
        <button type="button" class="w-full mt-8 py-3 bg-blue-500 text-white font-bold rounded-lg shadow btn-animate" id="to-step-3">다음</button>
        <button type="button" class="w-full mt-2 py-2 bg-gray-200 text-gray-700 rounded-lg shadow btn-animate" id="back-step-1">이전</button>
      </div>
      <!-- Step 3: 연락처/이름/통관번호 -->
      <div class="step hidden" id="step-3">
        <div class="mb-4 p-3 rounded-xl bg-yellow-50 border border-yellow-200 text-yellow-800 text-base font-semibold text-center shadow-sm animate-fadein-up">
          📞 <span class="font-bold">연락 가능한 정보를 정확히 입력해 주세요!</span><br>
          입력하신 정보로 최저가 안내 및 추가 문의를 드릴 수 있습니다.
          <span class="text-pink-600 font-bold">이름은 “회원가입 시 입력한 이름”과 반드시 일치해야 합니다.</span><br>
          전화번호, 이메일, 통관고유부호(필요시) 등은 실제로 연락 가능한 정보로 입력해 주세요.<br>
          <span class="text-xs text-gray-500">입력하신 정보는 오직 의뢰 처리와 안내를 위해서만 사용됩니다.</span>
        </div>
        <label class="block text-gray-700 font-semibold mb-2" for="userName">이름</label>
        <input type="text" id="userName" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-400 focus:outline-none transition mb-2 input-animate" placeholder="회원가입 시 입력한 이름" />
        <div class="text-xs text-yellow-600 mt-1">💡 회원가입 시 입력한 이름과 다르면 의뢰가 접수되지 않습니다.</div>
        <label class="block text-gray-700 font-semibold mb-2 mt-4" for="userPhone">전화번호</label>
        <input type="tel" id="userPhone" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-400 focus:outline-none transition mb-2 input-animate" placeholder="예: 01012345678" />
        <div class="text-xs text-yellow-600 mt-1">📱 정확한 연락처를 입력해 주세요. 안내 및 문의에 꼭 필요합니다.</div>

        <label class="block text-gray-700 font-semibold mb-2 mt-4" for="userEmail">이메일</label>
        <input type="email" id="userEmail" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-yellow-400 focus:outline-none transition mb-2 input-animate" placeholder="예: user@email.com" />
        <div class="text-xs text-yellow-600 mt-1">📧 정확한 이메일을 입력해 주세요. 안내 및 문의에 꼭 필요합니다.</div>
        <button type="button" class="w-full mt-8 py-3 bg-blue-500 text-white font-bold rounded-lg shadow btn-animate" id="to-step-4">다음</button>
        <button type="button" class="w-full mt-2 py-2 bg-gray-200 text-gray-700 rounded-lg shadow btn-animate" id="back-step-2">이전</button>
      </div>
      <!-- Step 4: 확인 및 제출 -->
      <div class="step hidden" id="step-4">
        <div class="mb-4 p-3 rounded-xl bg-gray-50 border border-gray-200 text-gray-800 text-base font-semibold text-center shadow-sm animate-fadein-up">
          ✅ <span class="font-bold">입력하신 내용을 다시 한 번 확인해 주세요!</span><br>
          제출 후에는 수정이 어려우니, 모든 정보가 정확한지 꼭 확인해 주세요.<br>
          <span class="text-pink-600 font-bold">개인정보 수집 및 이용에 동의하셔야 의뢰가 완료됩니다.</span><br>
          <span class="text-xs text-gray-500">입력하신 정보는 오직 의뢰 처리와 안내를 위해서만 안전하게 사용됩니다.<br>
          의뢰가 접수되면, 입력하신 연락처로 안내를 드립니다.</span>
        </div>
        <div class="bg-blue-50 rounded-xl p-4 mb-4 text-sm text-gray-700" id="confirm-summary"></div>
        <div class="flex items-start mt-2 mb-4">
          <input type="checkbox" id="privacyAgree" required class="mt-1 mr-2 w-5 h-5 text-pink-500 border-gray-300 rounded focus:ring-pink-400" />
          <label for="privacyAgree" class="text-gray-700 text-sm select-none">[필수] 개인정보 수집 및 이용에 동의합니다.</label>
        </div>
        <div class="text-xs text-pink-600 mb-4">💡 동의하지 않으시면 의뢰가 접수되지 않습니다.</div>
        <button type="submit" class="w-full py-3 bg-gradient-to-r from-amber-400 to-pink-500 text-white font-bold rounded-lg shadow-lg btn-animate text-lg" id="submit-btn">최저가 요청 제출하기</button>
        <button type="button" class="w-full mt-2 py-2 bg-gray-200 text-gray-700 rounded-lg shadow btn-animate" id="back-step-3">이전</button>
      </div>
    </form>
    <div id="submit-success" class="hidden mt-6 space-y-6">
      <!-- 접수 완료 메시지 -->
      <div class="p-6 bg-emerald-50 border border-emerald-200 rounded-xl text-emerald-700 text-center">
        <div class="text-2xl mb-2">✅</div>
        <h3 class="text-xl font-bold mb-2">의뢰가 정상적으로 접수되었습니다!</h3>
        <p class="text-sm">검증 리포트는 24-48시간 내 전달됩니다.</p>
      </div>
      
      <!-- 현재 공개 마켓 스냅샷 -->
      <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <h4 class="font-semibold text-blue-800 mb-2">📊 현재 공개 마켓 표면최저가</h4>
        <div class="text-sm text-blue-700">
          <p>• 쿠폰 미적용 기준 대략치</p>
          <p>• 정확한 검증 결과는 별도 안내</p>
        </div>
      </div>
      
      <!-- 절감왕 사례 썸네일 -->
      <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
        <h4 class="font-semibold text-yellow-800 mb-2">🏆 이번 주 절감왕 사례</h4>
        <div class="flex items-center gap-3">
          <img src="https://images.unsplash.com/photo-1519125323398-675f0ddb6308?auto=format&fit=crop&w=80&q=80" 
               alt="절감왕" class="w-16 h-16 object-cover rounded-lg">
          <div class="flex-1">
            <p class="font-semibold text-sm">전기포트 3만8천원 절감</p>
            <p class="text-xs text-gray-600">-42% 절감 | 김OO, 30대 직장인</p>
          </div>
          <a href="savings-king.html" class="text-xs bg-yellow-600 text-white px-2 py-1 rounded hover:bg-yellow-700 transition">
            더보기
          </a>
        </div>
      </div>
    </div>
  </div>
  <script>
    // 스텝 관리
    let currentStep = 1;
    const steps = [1,2,3,4];
    function showStep(n) {
      console.log(`showStep(${n}) 호출됨`);
      steps.forEach(s => {
        const el = document.getElementById(`step-${s}`);
        if (el) {
          el.classList.toggle('hidden', s !== n);
          console.log(`Step ${s} 요소:`, el.classList.contains('hidden') ? '숨김' : '표시');
        }
        const dot = document.getElementById(`step-${s}-dot`);
        if (dot) {
          dot.className = `w-10 h-10 rounded-full flex items-center justify-center font-bold text-white stepper-dot stepper-dot-animate${s === n ? ' stepper-dot-active' : ''}`;
        }
        if (s === n) {
          el.classList.remove('slidein-step','fadein-step');
          el.classList.add('fadein-step');
        } else {
          el.classList.remove('fadein-step');
        }
      });
      currentStep = n;
      console.log(`현재 단계: ${currentStep}`);
    }
    showStep(1);
    // 스텝 이동 버튼
    document.getElementById('to-step-2').onclick = function() {
      console.log('다음 버튼 클릭됨');
      // Step 1 유효성
      if (!document.getElementById('productName').value.trim() || !document.getElementById('productDesc').value.trim()) {
        alert('제품명과 설명을 모두 입력해 주세요.');
        return;
      }
      const price = Number(document.getElementById('productPrice').value);
      if (isNaN(price) || price < 1000) {
        alert('최소 의뢰 금액은 1,000원 이상입니다. 더 저렴한 제품은 의뢰가 어렵습니다.');
        return;
      }
      if (!document.getElementById('brandExcludeAgree').checked) {
        alert('브랜드 배제 정책에 동의해 주세요.');
        return;
      }
      console.log('유효성 검사 통과, showStep(2) 호출');
      showStep(2);
    };
    document.getElementById('to-step-3').onclick = function() {
      // Step 2 유효성: 참고사이트 필수 입력
      const url = document.getElementById('productUrl').value.trim();
      if (!url) {
        alert('참고사이트 링크를 입력해 주세요.');
        return;
      }
      const urlPattern = /^(https?:\/\/)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)$/;
      if (!urlPattern.test(url)) {
        alert('참고사이트는 http://, https://, 또는 www.로 시작하는 올바른 링크를 입력해 주세요.');
        return;
      }
      showStep(3);
    };
    document.getElementById('to-step-4').onclick = async function() {
      // Step 3 유효성
      if (!document.getElementById('userName').value.trim() || !document.getElementById('userPhone').value.trim() || !document.getElementById('userEmail').value.trim()) {
        alert('연락처 정보를 모두 입력해 주세요.');
        return;
      }
      // 이름 일치 검증 (Firebase에서 사용자 정보 가져오기)
      let user = null;
      try {
        await waitForFirebase();
        const { collection, query, where, getDocs } = window.firebaseFirestoreFunctions;
        const db = window.firebaseDb;
        
        const loggedInEmail = localStorage.getItem('loggedInEmail');
        if (loggedInEmail) {
          const usersRef = collection(db, 'users');
          const q = query(usersRef, where('email', '==', loggedInEmail));
          const querySnapshot = await getDocs(q);
          
          if (!querySnapshot.empty) {
            user = querySnapshot.docs[0].data();
          }
        }
      } catch (error) {
        console.error('사용자 정보 로드 실패:', error);
      }
      
      const userName = document.getElementById('userName').value.trim();
      if (!user || !user.name || user.name.trim() !== userName) {
        alert('회원가입 시 입력한 이름과 동일하게 입력해야 합니다.');
        return;
      }
      renderConfirmSummary();
      showStep(4);
    };
    document.getElementById('back-step-1').onclick = function() { showStep(1); };
    document.getElementById('back-step-2').onclick = function() { showStep(2); };
    document.getElementById('back-step-3').onclick = function() { showStep(3); };
    // 이미지 미리보기 및 최대 5장 제한
    const imageInput = document.getElementById('productImage');
    const imagePreview = document.getElementById('imagePreview');
    let imageFiles = [];
    if (imageInput) {
      imageInput.addEventListener('change', function(event) {
        const files = Array.from(event.target.files);
        if (files.length + imageFiles.length > 5) {
          alert('이미지는 최대 5장까지 첨부할 수 있습니다.');
          imageInput.value = '';
          return;
        }
        files.forEach(file => {
          if (imageFiles.length < 5) {
            imageFiles.push(file);
          }
        });
        renderImagePreview();
        imageInput.value = '';
      });
    }
    function renderImagePreview() {
      imagePreview.innerHTML = '';
      imageFiles.forEach((file, idx) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const wrapper = document.createElement('div');
          wrapper.className = 'relative';
          wrapper.innerHTML = `<img src="${e.target.result}" alt="미리보기" class="max-h-32 rounded-xl shadow-md border border-gray-200" />` +
            `<button type="button" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs" data-idx="${idx}">&times;</button>`;
          imagePreview.appendChild(wrapper);
          wrapper.querySelector('button').onclick = function() {
            imageFiles.splice(idx, 1);
            renderImagePreview();
          };
        };
        reader.readAsDataURL(file);
      });
    }
    // Step 4: 확인 요약 렌더링
    function renderConfirmSummary() {
      const productName = document.getElementById('productName').value;
      const productDesc = document.getElementById('productDesc').value;
      const productUrl = document.getElementById('productUrl').value.trim();
      const price = document.getElementById('productPrice').value;
      const summary = `
        <div><span class="font-bold">제품명:</span> ${productName}</div>
        <div><span class="font-bold">제품 설명:</span> ${productDesc}</div>
        <div><span class="font-bold">예상 가격:</span> ${price ? price + '원' : '(미입력)'}</div>
        <div><span class="font-bold">참고사이트:</span> ${productUrl ? (/^https?:\/\//.test(productUrl) || /^www\./.test(productUrl) ? `<a href='${productUrl}' target='_blank' class='text-blue-600 underline'>${productUrl}</a>` : `<span class='bg-gray-100 rounded px-2 py-1'>${productUrl}</span>`) : '<span class=\'text-gray-400\'>(없음)</span>'}</div>
        <div><span class="font-bold">이름:</span> ${document.getElementById('userName').value}</div>
        <div><span class="font-bold">전화번호:</span> ${document.getElementById('userPhone').value}</div>

        <div><span class="font-bold">이메일:</span> ${document.getElementById('userEmail').value}</div>
        <div><span class="font-bold">이미지:</span> <span id='confirm-images'></span></div>
      `;
      document.getElementById('confirm-summary').innerHTML = summary;
      // 이미지 썸네일 렌더링
      const imgWrap = document.getElementById('confirm-images');
      if (imageFiles.length > 0) {
        imageFiles.forEach(file => {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'inline-block h-12 w-auto rounded-xl border border-gray-200 shadow-sm align-middle mr-2 mb-1';
            imgWrap.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      } else {
        imgWrap.innerHTML = '<span class="text-gray-400">(없음)</span>';
      }
    }
    
    // Firebase에서 의뢰 상태 업데이트
    async function updateRequestStatus(reqNum, newStatus, newDetail, newProgress) {
      try {
        await waitForFirebase();
        const { collection, query, where, getDocs, updateDoc } = window.firebaseFirestoreFunctions;
        const db = window.firebaseDb;
        
        const requestsRef = collection(db, 'requests');
        const q = query(requestsRef, where('requestNumber', '==', reqNum));
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
          const doc = querySnapshot.docs[0];
          await updateDoc(doc.ref, {
            status: newStatus,
            statusDetail: newDetail,
            progress: newProgress,
            lastUpdated: new Date()
          });
          
          // 상태 변경 알림 (브라우저 알림)
          if (Notification.permission === 'granted') {
            new Notification('PriceHunter 의뢰 상태 업데이트', {
              body: `${newStatus}: ${newDetail}`,
              icon: '/favicon.ico'
            });
          }
          
          console.log(`의뢰 #${reqNum} 상태 업데이트:`, newStatus);
          return true;
        }
      } catch (error) {
        console.error('의뢰 상태 업데이트 실패:', error);
      }
      return false;
    }
    
    // 제출
    document.getElementById('step-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (!document.getElementById('privacyAgree').checked) {
        alert('개인정보 수집 및 이용에 동의하셔야 제출이 가능합니다.');
        return;
      }
      // 이름 일치 검증 (Firebase에서 사용자 정보 가져오기)
      let user = null;
      try {
        await waitForFirebase();
        const { collection, query, where, getDocs } = window.firebaseFirestoreFunctions;
        const db = window.firebaseDb;
        
        const loggedInEmail = localStorage.getItem('loggedInEmail');
        if (loggedInEmail) {
          const usersRef = collection(db, 'users');
          const q = query(usersRef, where('email', '==', loggedInEmail));
          const querySnapshot = await getDocs(q);
          
          if (!querySnapshot.empty) {
            user = querySnapshot.docs[0].data();
          }
        }
      } catch (error) {
        console.error('사용자 정보 로드 실패:', error);
      }
      
      const userName = document.getElementById('userName').value.trim();
      if (!user || !user.name || user.name.trim() !== userName) {
        alert('회원가입 시 입력한 이름과 동일하게 입력해야 합니다.');
        return;
      }
      // 참고사이트 단일 링크 유효성 검사 (최종 제출 시에도)
      const url = document.getElementById('productUrl').value.trim();
      const urlPattern = /^(https?:\/\/)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)$/;
      if (!urlPattern.test(url)) {
        alert('참고사이트는 http://, https://, 또는 www.로 시작하는 올바른 링크를 입력해 주세요.');
        return;
      }
      // 이미지 총 용량 체크 (5MB 제한)
      function getTotalImageSize(files) {
        return files.reduce((sum, file) => sum + file.size, 0);
      }
      if (getTotalImageSize(imageFiles) > 5 * 1024 * 1024) {
        alert('첨부한 이미지의 총 용량이 5MB를 초과합니다. 더 작은 이미지로 첨부해 주세요.');
        return;
      }
      // 하루 10건 제한 (테스트용으로 완화)
      const today = new Date().toISOString().slice(0,10);
      const userId = user && user.email ? user.email : userName;
      // Firebase에서 하루 의뢰 카운트 확인 (향후 구현)
      const reqCount = 0; // 임시로 0으로 설정
      if (reqCount >= 10) {
        alert('하루 최대 10건까지만 의뢰할 수 있습니다. 내일 다시 이용해 주세요!');
        return;
      }
      // 입력값 수집
      const name = document.getElementById('productName').value;
      const desc = document.getElementById('productDesc').value;
      const urls = [url]; // 단일 링크로 저장
      const email = document.getElementById('userEmail').value;
      const phone = document.getElementById('userPhone').value;
      

      const price = Number(document.getElementById('productPrice').value);
      // 고유 의뢰번호 생성
      function generateReqNum() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth()+1).padStart(2,'0');
        const d = String(now.getDate()).padStart(2,'0');
        const rand = String(Math.floor(Math.random()*900)+100);
        return `#PH-${y}${m}${d}${rand}`;
      }
      const reqNum = generateReqNum();
      // 이미지 base64 배열 저장
      if (imageFiles.length > 0) {
        const imgArr = [];
        let loaded = 0;
        imageFiles.forEach((file, idx) => {
          const reader = new FileReader();
          reader.onload = async function(e2) {
            imgArr[idx] = e2.target.result;
            loaded++;
            if (loaded === imageFiles.length) {
              await saveRequest(imgArr);
            }
          };
          reader.readAsDataURL(file);
        });
      } else {
        await saveRequest([]);
      }
      async function saveRequest(imgArr) {
        // 로컬스토리지 정리 함수 제거됨 - Firebase 전용 사용
        
        const reqData = {
          name, 
          desc, 
          urls, 
          images: imgArr, 
          email, 
          phone, 
          price, 
          userName, 
          date: Date.now(),
          reqNum: reqNum,
          status: '접수됨',
          statusDetail: '의뢰가 접수되었습니다. 검색을 시작합니다.',
          estimatedTime: '2-3일 내 완료 예정',
          lastUpdated: Date.now(),
          progress: 10
        };
        
        try {
          // Firebase에만 저장 (로컬스토리지 제거)
          
          // Firebase에 저장
          await saveRequestToFirebase(reqData, reqNum);
          
          document.getElementById('submit-success').classList.remove('hidden');
          
          // 포인트 지급 (의뢰 접수 시) - Firebase 전용
          if (user && user.email) {
            // Firebase 포인트 시스템 (향후 구현)
            console.log('Firebase 포인트 시스템 사용 예정');
          }
          
          setTimeout(() => { window.location.href = 'request-complete.html'; }, 1200);
          // 하루 의뢰 카운트 증가 (Firebase에 저장 예정)
          console.log('의뢰 카운트 증가:', reqCount + 1);
        } catch (error) {
          console.error('의뢰 저장 실패:', error);
          alert('의뢰 저장에 실패했습니다. 브라우저 캐시를 정리하고 다시 시도해주세요.');
        }
      }
    });
    
    // Firebase에 의뢰 데이터 저장
    async function saveRequestToFirebase(reqData, reqNum) {
      try {
        // Firebase 초기화 대기
        await waitForFirebase();
        
        const { collection, addDoc, serverTimestamp } = window.firebaseFirestoreFunctions;
        const db = window.firebaseDb;
        
        // Firebase에 저장할 데이터 준비
        const firebaseData = {
          ...reqData,
          requestNumber: reqNum,
          createdAt: serverTimestamp(),
          status: 'pending',
          source: 'web_form'
        };
        
        // Firebase에 저장
        const docRef = await addDoc(collection(db, 'requests'), firebaseData);
        console.log('✅ Firebase에 의뢰 데이터 저장 완료:', docRef.id);
        
        return docRef.id;
      } catch (error) {
        console.error('❌ Firebase에 의뢰 데이터 저장 실패:', error);
        throw error;
      }
    }
    
    // Firebase 초기화 대기 함수
    async function waitForFirebase() {
      return new Promise((resolve, reject) => {
        if (window.firebaseApp && window.firebaseDb) {
          resolve();
        } else {
          // Firebase 초기화 대기
          const checkInterval = setInterval(() => {
            if (window.firebaseApp && window.firebaseDb) {
              clearInterval(checkInterval);
              resolve();
            }
          }, 100);
          
          // 5초 후 타임아웃
          setTimeout(() => {
            clearInterval(checkInterval);
            reject(new Error('Firebase 초기화 타임아웃'));
          }, 5000);
        }
      });
    }
    
    // 이메일 입력란 자동 채우기 및 읽기전용 처리
    window.addEventListener('DOMContentLoaded', function() {
      // Firebase에서 사용자 데이터 가져오기
      let user = null;
      let loggedIn = false;
      
      try {
        const loggedInEmail = localStorage.getItem('loggedInEmail');
        if (loggedInEmail) {
          loggedIn = true;
          // Firebase에서 사용자 정보 가져오기 (비동기)
          waitForFirebase().then(async () => {
            const { collection, query, where, getDocs } = window.firebaseFirestoreFunctions;
            const db = window.firebaseDb;
            
            const usersRef = collection(db, 'users');
            const q = query(usersRef, where('email', '==', loggedInEmail));
            const querySnapshot = await getDocs(q);
            
            if (!querySnapshot.empty) {
              user = querySnapshot.docs[0].data();
              // 사용자 정보로 폼 자동 채우기
              if (user.email) {
                emailInput.value = user.email;
              }
              if (user.name) {
                nameInput.value = user.name;
              }
            }
          });
        }
      } catch (error) {
        console.error('사용자 정보 로드 실패:', error);
      }
      var emailInput = document.getElementById('userEmail');
      var nameInput = document.getElementById('userName');
      
      if (emailInput && user && user.email && loggedIn) {
        emailInput.value = user.email;
        emailInput.readOnly = true;
      }
      
      if (nameInput && user && user.name) {
        nameInput.value = user.name;
        emailInput.classList.add('bg-gray-100','cursor-not-allowed');
      }
    });
  </script>
</body>
</html> 