<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ¬ë§¤ ëŒ€í–‰ ì§€ì› ì„œë¹„ìŠ¤ - PriceHunter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-2xl font-bold">ğŸ¹ PriceHunter</a>
                    <span class="text-sm opacity-90">êµ¬ë§¤ ëŒ€í–‰ ì§€ì› ì„œë¹„ìŠ¤</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm">ê³ ê°ì„¼í„°: 1588-1234</span>
                    <a href="index.html" class="bg-white bg-opacity-20 px-4 py-2 rounded-lg hover:bg-opacity-30 transition">í™ˆìœ¼ë¡œ</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-4 md:py-8">
        <!-- Loading State -->
        <div id="loading" class="text-center py-8 md:py-12">
            <div class="animate-spin rounded-full h-10 w-10 md:h-12 md:w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
            <p class="text-gray-600">êµ¬ë§¤ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- Purchase Support Form -->
        <div id="purchase-form" class="hidden max-w-4xl mx-auto">
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden fade-in">
                <!-- Header -->
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 md:p-6">
                    <h1 class="text-xl sm:text-2xl font-bold mb-2">ğŸ¤ êµ¬ë§¤ ëŒ€í–‰ ì§€ì› ì„œë¹„ìŠ¤</h1>
                    <p class="opacity-90 text-sm md:text-base">ì „ë‹´ ê´€ë¦¬ë¡œ ì•ˆì „í•˜ê³  í¸ë¦¬í•œ êµ¬ë§¤ë¥¼ ë„ì™€ë“œë¦½ë‹ˆë‹¤</p>
                </div>

                <!-- Product Information -->
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“¦ ìƒí’ˆ ì •ë³´</h2>
                    
                    <!-- ì˜ë¢° ì •ë³´ í‘œì‹œ ì˜ì—­ -->
                    <div id="request-info" class="mb-4"></div>
                    
                    <!-- ê²°ê³¼ ì •ë³´ í‘œì‹œ ì˜ì—­ -->
                    <div id="result-info" class="mb-4"></div>
                    
                    <!-- ê°€ê²© ì •ë³´ í‘œì‹œ ì˜ì—­ -->
                    <div id="pricing-info" class="mb-4"></div>
                </div>

                <!-- Service Details -->
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">âœ¨ ì„œë¹„ìŠ¤ ë‚´ìš©</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                            <span class="text-green-600 text-xl">âœ…</span>
                            <span class="text-sm">ì „ë‹´ êµ¬ë§¤ ëŒ€í–‰ ì„œë¹„ìŠ¤</span>
                        </div>
                        <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                            <span class="text-green-600 text-xl">âœ…</span>
                            <span class="text-sm">ì‹¤ì‹œê°„ ë°°ì†¡ ì¶”ì </span>
                        </div>
                        <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                            <span class="text-green-600 text-xl">âœ…</span>
                            <span class="text-sm">í’ˆì§ˆ ë³´ì¦ & í™˜ë¶ˆ ì§€ì›</span>
                        </div>
                        <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                            <span class="text-green-600 text-xl">âœ…</span>
                            <span class="text-sm">24ì‹œê°„ ê³ ê° ì§€ì›</span>
                        </div>
                    </div>
                </div>

                <!-- Customer Information -->
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ‘¤ ë°°ì†¡ ì •ë³´</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ˜ë ¹ì¸ *</label>
                            <input type="text" id="recipient-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì—°ë½ì²˜ *</label>
                            <input type="tel" id="recipient-phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë©”ì¼ *</label>
                            <input type="email" id="recipient-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í†µê´€ë¶€í˜¸ *</label>
                            <input type="text" id="customs-code" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ì˜ˆ: P123456789" required>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë°°ì†¡ ì£¼ì†Œ *</label>
                            <textarea id="shipping-address" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ìƒì„¸í•œ ë°°ì†¡ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" required></textarea>
                        </div>
                    </div>
                </div>

                <!-- Terms and Conditions -->
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“‹ ì´ìš©ì•½ê´€</h2>
                    <div class="bg-gray-50 p-4 rounded-lg max-h-40 overflow-y-auto">
                        <div class="space-y-2 text-sm text-gray-600">
                            <p><strong>1. ì„œë¹„ìŠ¤ ë‚´ìš©:</strong> PriceHunterê°€ ê³ ê°ì„ ëŒ€ì‹ í•˜ì—¬ ìƒí’ˆì„ êµ¬ë§¤í•˜ê³  ë°°ì†¡ê¹Œì§€ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                            <p><strong>2. ìˆ˜ìˆ˜ë£Œ:</strong> êµ¬ë§¤ ê¸ˆì•¡ì˜ 3% (ìµœì†Œ 5,000ì›)ë¥¼ ì„œë¹„ìŠ¤ ìˆ˜ìˆ˜ë£Œë¡œ ë°›ìŠµë‹ˆë‹¤.</p>
                            <p><strong>3. ë°°ì†¡:</strong> ìƒí’ˆ ìˆ˜ë ¹ í›„ 1-2ì¼ ë‚´ì— ë°°ì†¡ì„ ì‹œì‘í•©ë‹ˆë‹¤.</p>
                            <p><strong>4. í™˜ë¶ˆ:</strong> ìƒí’ˆ ìˆ˜ë ¹ í›„ 7ì¼ ë‚´ì— ë¬¸ì œê°€ ìˆì„ ê²½ìš° í™˜ë¶ˆì„ ì§€ì›í•©ë‹ˆë‹¤.</p>
                            <p><strong>5. ì±…ì„:</strong> ë°°ì†¡ ì¤‘ ë°œìƒí•˜ëŠ” ë¬¸ì œëŠ” PriceHunterê°€ ì±…ì„ì§‘ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center">
                        <input type="checkbox" id="agree-terms" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                        <label for="agree-terms" class="ml-2 text-sm text-gray-700">ì´ìš©ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤ *</label>
                    </div>
                </div>

                <!-- Payment Button -->
                <div class="p-6 bg-gray-50">
                    <div class="flex space-x-4">
                        <button onclick="goBack()" class="flex-1 py-3 px-6 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition">
                            â† ëŒì•„ê°€ê¸°
                        </button>
                        <button onclick="processPayment()" id="payment-btn" class="flex-1 py-3 px-6 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold rounded-lg hover:from-blue-600 hover:to-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
                            ğŸ’³ ê²°ì œí•˜ê¸°
                        </button>
                    </div>
                    
                    <!-- ìˆ¨ê²¨ì§„ í•„ë“œë“¤ -->
                    <input type="hidden" id="base-price" value="">
                    <input type="hidden" id="service-fee" value="">
                    <input type="hidden" id="total-amount" value="">
                    <input type="hidden" id="request-number" value="">
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden text-center py-12">
            <div class="text-red-500 text-6xl mb-4">âŒ</div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">êµ¬ë§¤ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
            <p class="text-gray-600 mb-4">ì˜ë¢° ê²°ê³¼ í˜ì´ì§€ì—ì„œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
            <a href="result-search.html" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition">ê²°ê³¼ ì¡°íšŒë¡œ ëŒì•„ê°€ê¸°</a>
        </div>
    </main>

    <script>
        let currentRequestData = null;
        let currentResultData = null;
        let currentReqNumber = '';

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', function() {
            console.log('=== purchase-support.html ë¡œë“œë¨ ===');
            console.log('í˜„ì¬ ì‹œê°„:', new Date().toISOString());
            console.log('User Agent:', navigator.userAgent);
            initializePage();
        });

        function initializePage() {
            // êµ¬ë§¤ ì •ë³´ ë¡œë“œ
            loadPurchaseData();
        }

        // URLì—ì„œ ì˜ë¢°ë²ˆí˜¸ íŒŒë¼ë¯¸í„° ì¶”ì¶œ - ìƒˆë¡œìš´ ì ‘ê·¼ ë°©ì‹
        function getUrlParameter(name) {
            console.log('=== getUrlParameter í˜¸ì¶œë¨ ===');
            console.log('ì°¾ì„ íŒŒë¼ë¯¸í„°:', name);
            console.log('í˜„ì¬ URL:', window.location.href);
            console.log('í˜„ì¬ location.search:', location.search);
            console.log('í˜„ì¬ location.hash:', location.hash);
            
            // ğŸ¯ ìƒˆë¡œìš´ ì ‘ê·¼ ë°©ì‹: ì§ì ‘ í•´ì‹œê°’ ì¶”ì¶œ
            if (location.hash) {
                const hashValue = location.hash.substring(1); // # ì œê±°
                console.log('í•´ì‹œê°’ ì¶”ì¶œ:', hashValue);
                
                // PH- í˜•íƒœì˜ ê°’ì´ ìˆëŠ”ì§€ í™•ì¸
                if (hashValue.startsWith('PH-')) {
                    console.log('âœ… í•´ì‹œì—ì„œ PH- ê°’ ë°œê²¬:', hashValue);
                    return hashValue;
                }
            }
            
            // ğŸ” ë°±ì—… ë°©ë²•: ì „ì²´ URLì—ì„œ PH- íŒ¨í„´ ê²€ìƒ‰
            const fullUrl = window.location.href;
            const phPattern = /PH-[A-Za-z0-9]+/;
            const phMatch = fullUrl.match(phPattern);
            if (phMatch) {
                console.log('âœ… ì „ì²´ URLì—ì„œ PH- íŒ¨í„´ ë°œê²¬:', phMatch[0]);
                return phMatch[0];
            }
            
            // ğŸ” ë°±ì—… ë°©ë²• 2: req= ë’¤ì— ìˆëŠ” ê°’ ì¶”ì¶œ
            if (location.search.includes('req=')) {
                const searchPart = location.search;
                console.log('ê²€ìƒ‰ ë¶€ë¶„ì—ì„œ req= ì°¾ìŒ:', searchPart);
                
                // req= ë’¤ì˜ ëª¨ë“  ë¬¸ì ì¶”ì¶œ (í•´ì‹œ í¬í•¨)
                const afterReq = searchPart.substring(searchPart.indexOf('req=') + 4);
                console.log('req= ë’¤ì˜ ê°’:', afterReq);
                
                if (afterReq && afterReq.trim() !== '') {
                    console.log('âœ… req= ë’¤ì—ì„œ ê°’ ë°œê²¬:', afterReq);
                    return afterReq;
                }
            }
            
            console.log('âŒ íŒŒë¼ë¯¸í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return '';
        }

        // êµ¬ë§¤ ì •ë³´ ë¡œë“œ
        function loadPurchaseData() {
            console.log('=== loadPurchaseData ì‹œì‘ ===');
            
            // URLì—ì„œ ì˜ë¢°ë²ˆí˜¸ ì¶”ì¶œ
            let reqParam = getUrlParameter('req');
            console.log('URLì—ì„œ ì¶”ì¶œí•œ req íŒŒë¼ë¯¸í„°:', reqParam);
            console.log('reqParam íƒ€ì…:', typeof reqParam);
            console.log('reqParam ê¸¸ì´:', reqParam ? reqParam.length : 0);
            
            if (!reqParam) {
                console.log('req íŒŒë¼ë¯¸í„°ê°€ ì—†ìŒ');
                console.log('í˜„ì¬ URL êµ¬ì¡° ë¶„ì„:');
                console.log('- ì „ì²´ URL:', window.location.href);
                console.log('- ê²€ìƒ‰ ë¶€ë¶„:', window.location.search);
                console.log('- í•´ì‹œ ë¶€ë¶„:', window.location.hash);
                console.log('- ê²½ë¡œ ë¶€ë¶„:', window.location.pathname);
                showError();
                return;
            }
            
            // í‚¤ ì •ê·œí™”
            let normalizedReq = reqParam.toString().trim();
            console.log('ì •ê·œí™” ì „ req:', normalizedReq);
            
            // PH- ì ‘ë‘ì‚¬ ì œê±°
            if (normalizedReq.startsWith('PH-')) {
                normalizedReq = normalizedReq.substring(3);
                console.log('PH- ì œê±° í›„:', normalizedReq);
            }
            
            // # ì ‘ë‘ì‚¬ ì œê±°
            if (normalizedReq.startsWith('#')) {
                normalizedReq = normalizedReq.substring(1);
                console.log('# ì œê±° í›„:', normalizedReq);
            }
            
            console.log('ìµœì¢… ì •ê·œí™”ëœ req:', normalizedReq);
            
            // ğŸ¯ ë‹¨ìˆœí™”ëœ í‚¤ ê²€ìƒ‰ - ì§ì ‘ ë§¤ì¹­ ìš°ì„ 
            const requestKey = `request-#PH-${normalizedReq}`;
            const resultKey = `result-#PH-${normalizedReq}`;
            
            console.log('ì°¾ì„ í‚¤ë“¤:');
            console.log('- requestKey:', requestKey);
            console.log('- resultKey:', resultKey);
            
            // ë°ì´í„° ê²€ìƒ‰
            let requestData = null;
            let resultData = null;
            
            // ì§ì ‘ í‚¤ ë§¤ì¹­
            const requestDataStr = localStorage.getItem(requestKey);
            const resultDataStr = localStorage.getItem(resultKey);
            
            if (requestDataStr) {
                console.log(`âœ… request ë°ì´í„° ë°œê²¬: ${requestKey}`);
                requestData = JSON.parse(requestDataStr);
            } else {
                console.log(`âŒ request ë°ì´í„° ì—†ìŒ: ${requestKey}`);
            }
            
            if (resultDataStr) {
                console.log(`âœ… result ë°ì´í„° ë°œê²¬: ${resultKey}`);
                resultData = JSON.parse(resultDataStr);
            } else {
                console.log(`âŒ result ë°ì´í„° ì—†ìŒ: ${resultKey}`);
            }
            
            // ğŸ” ë°±ì—…: ì „ì²´ localStorage í‚¤ì—ì„œ ê²€ìƒ‰
            if (!requestData || !resultData) {
                console.log('ë°±ì—… ê²€ìƒ‰ ì‹œì‘...');
                const allKeys = Object.keys(localStorage);
                console.log('ì „ì²´ localStorage í‚¤ë“¤:', allKeys);
                
                // request ë°ì´í„° ë°±ì—… ê²€ìƒ‰
                if (!requestData) {
                    for (const key of allKeys) {
                        if (key.includes('request') && key.includes(normalizedReq)) {
                            console.log(`ğŸ” ë°±ì—…ìœ¼ë¡œ request ë°œê²¬: ${key}`);
                            const data = localStorage.getItem(key);
                            if (data) {
                                requestData = JSON.parse(data);
                                break;
                            }
                        }
                    }
                }
                
                // result ë°ì´í„° ë°±ì—… ê²€ìƒ‰
                if (!resultData) {
                    for (const key of allKeys) {
                        if (key.includes('result') && key.includes(normalizedReq)) {
                            console.log(`ğŸ” ë°±ì—…ìœ¼ë¡œ result ë°œê²¬: ${key}`);
                            const data = localStorage.getItem(key);
                            if (data) {
                                resultData = JSON.parse(data);
                                break;
                            }
                        }
                    }
                }
            }
            
            console.log('=== ë°ì´í„° ê²€ìƒ‰ ê²°ê³¼ ===');
            console.log('requestData ì¡´ì¬:', !!requestData);
            console.log('resultData ì¡´ì¬:', !!resultData);
            
            if (!requestData || !resultData) {
                console.log('ì˜ë¢° ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                console.log('ì „ì²´ localStorage í‚¤ë“¤:', Object.keys(localStorage));
                
                // ìœ ì‚¬í•œ í‚¤ë“¤ ì°¾ê¸°
                const allKeys = Object.keys(localStorage);
                const similarKeys = allKeys.filter(key => 
                    key.includes('request') || key.includes('result')
                );
                console.log('ìœ ì‚¬í•œ í‚¤ë“¤:', similarKeys);
                
                showError();
                return;
            }
            
            // ê¸€ë¡œë²Œ ë³€ìˆ˜ì— ì €ì¥
            currentRequestData = requestData;
            currentResultData = resultData;
            currentReqNumber = normalizedReq;
            
            console.log('ì €ì¥ëœ ì „ì—­ ë³€ìˆ˜ë“¤:');
            console.log('currentRequestData:', currentRequestData);
            console.log('currentResultData:', currentResultData);
            console.log('currentReqNumber:', currentReqNumber);
            
            // UI ì—…ë°ì´íŠ¸
            updateUI();
        }

        function updateUI() {
            console.log('=== updateUI ì‹œì‘ ===');
            
            // ì˜ë¢° ì •ë³´ í‘œì‹œ
            const requestInfoElement = document.getElementById('request-info');
            if (requestInfoElement && currentRequestData) {
                requestInfoElement.innerHTML = `
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <h3 class="text-lg font-semibold text-blue-800 mb-2">ğŸ“‹ ì˜ë¢° ì •ë³´</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                            <div><span class="font-medium">ì˜ë¢°ë²ˆí˜¸:</span> ${currentReqNumber}</div>
                            <div><span class="font-medium">ì œí’ˆëª…:</span> ${currentRequestData.name || 'ì •ë³´ ì—†ìŒ'}</div>
                            <div><span class="font-medium">ì œí’ˆì„¤ëª…:</span> ${currentRequestData.desc || 'ì •ë³´ ì—†ìŒ'}</div>
                            <div><span class="font-medium">í¬ë§ê°€ê²©:</span> ${currentRequestData.price ? currentRequestData.price + 'ì›' : 'ì •ë³´ ì—†ìŒ'}</div>
                        </div>
                    </div>
                `;
            }
            
            // ê²°ê³¼ ì •ë³´ í‘œì‹œ
            const resultInfoElement = document.getElementById('result-info');
            if (resultInfoElement && currentResultData) {
                resultInfoElement.innerHTML = `
                    <div class="bg-green-50 p-4 rounded-lg mb-4">
                        <h3 class="text-lg font-semibold text-green-800 mb-2">âœ… ì°¾ì€ ìµœì €ê°€ ì •ë³´</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                            <div><span class="font-medium">ìµœì €ê°€:</span> ${currentResultData.price || 'ì •ë³´ ì—†ìŒ'}</div>
                            <div><span class="font-medium">ì›ì‚°ì§€/ê³µê¸‰ì²˜:</span> ${currentResultData.origin || 'ì •ë³´ ì—†ìŒ'}</div>
                        </div>
                    </div>
                `;
            }
            
            // íšŒì› ì •ë³´ ìë™ ì…ë ¥
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            console.log('í˜„ì¬ ì‚¬ìš©ì ì •ë³´:', currentUser);
            
            // ì´ë¦„ ìë™ ì…ë ¥
            const nameInput = document.getElementById('recipient-name');
            if (nameInput && currentUser.name) {
                nameInput.value = currentUser.name;
                nameInput.readOnly = true;
                nameInput.classList.add('bg-gray-100');
                console.log('ì´ë¦„ ìë™ ì…ë ¥:', currentUser.name);
            }
            
            // ì „í™”ë²ˆí˜¸ ìë™ ì…ë ¥
            const phoneInput = document.getElementById('recipient-phone');
            if (phoneInput && currentUser.phone) {
                phoneInput.value = currentUser.phone;
                phoneInput.readOnly = true;
                phoneInput.classList.add('bg-gray-100');
                console.log('ì „í™”ë²ˆí˜¸ ìë™ ì…ë ¥:', currentUser.phone);
            }
            
            // ì´ë©”ì¼ ìë™ ì…ë ¥
            const emailInput = document.getElementById('recipient-email');
            if (emailInput && currentUser.email) {
                emailInput.value = currentUser.email;
                emailInput.readOnly = true;
                emailInput.classList.add('bg-gray-100');
                console.log('ì´ë©”ì¼ ìë™ ì…ë ¥:', currentUser.email);
            }
            
            // ê°€ê²© ì •ë³´ ê³„ì‚° ë° í‘œì‹œ
            calculateAndDisplayPricing();
            
            // ë¡œë”© ìˆ¨ê¸°ê³  í¼ í‘œì‹œ
            const loadingElement = document.getElementById('loading');
            const purchaseFormElement = document.getElementById('purchase-form');
            
            if (loadingElement) {
                loadingElement.classList.add('hidden');
                console.log('âœ… ë¡œë”© ìˆ¨ê¹€ ì™„ë£Œ');
            }
            
            if (purchaseFormElement) {
                purchaseFormElement.classList.remove('hidden');
                console.log('âœ… êµ¬ë§¤ í¼ í‘œì‹œ ì™„ë£Œ');
            }
            
            console.log('=== updateUI ì™„ë£Œ ===');
        }
        
        // ê°€ê²© ë° ìˆ˜ìˆ˜ë£Œ ê³„ì‚° í•¨ìˆ˜
        function calculateAndDisplayPricing() {
            console.log('=== ê°€ê²© ê³„ì‚° ì‹œì‘ ===');
            
            // ê¸°ë³¸ ê°€ê²© ì¶”ì¶œ (ìˆ«ìë§Œ)
            const basePriceText = currentResultData.price;
            const basePrice = parseInt(basePriceText.replace(/[^\d]/g, ''));
            console.log('ê¸°ë³¸ ê°€ê²©:', basePrice);
            
            // ìˆ˜ìˆ˜ë£Œ ê³„ì‚° (3%)
            const serviceFee = Math.round(basePrice * 0.03);
            console.log('ì„œë¹„ìŠ¤ ìˆ˜ìˆ˜ë£Œ (3%):', serviceFee);
            
            // ì´ ê¸ˆì•¡ ê³„ì‚°
            const totalAmount = basePrice + serviceFee;
            console.log('ì´ ê¸ˆì•¡:', totalAmount);
            
            // ê°€ê²© ì •ë³´ í‘œì‹œ
            const pricingInfo = document.getElementById('pricing-info');
            if (pricingInfo) {
                pricingInfo.innerHTML = `
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ’° ê²°ì œ ê¸ˆì•¡</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">ìƒí’ˆ ê°€ê²©:</span>
                                <span class="font-medium">${basePrice.toLocaleString()}ì›</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">êµ¬ë§¤ ì§€ì› ì„œë¹„ìŠ¤ ìˆ˜ìˆ˜ë£Œ (3%):</span>
                                <span class="font-medium">${serviceFee.toLocaleString()}ì›</span>
                            </div>
                            <hr class="border-gray-200">
                            <div class="flex justify-between text-lg font-semibold text-blue-600">
                                <span>ì´ ê²°ì œ ê¸ˆì•¡:</span>
                                <span>${totalAmount.toLocaleString()}ì›</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // ìˆ¨ê²¨ì§„ ì…ë ¥ í•„ë“œì— ê°’ ì„¤ì •
            const basePriceInput = document.getElementById('base-price');
            const serviceFeeInput = document.getElementById('service-fee');
            const totalAmountInput = document.getElementById('total-amount');
            
            if (basePriceInput) basePriceInput.value = basePrice;
            if (serviceFeeInput) serviceFeeInput.value = serviceFee;
            if (totalAmountInput) totalAmountInput.value = totalAmount;
            
            console.log('=== ê°€ê²© ê³„ì‚° ì™„ë£Œ ===');
        }

        function showError(message = 'êµ¬ë§¤ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.') {
            console.log('=== showError í˜¸ì¶œë¨ ===');
            console.log('í˜„ì¬ localStorage ë‚´ìš©:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                console.log(key, ':', localStorage.getItem(key));
            }
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error-state').classList.remove('hidden');
            
            // ì—ëŸ¬ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            const errorMessage = document.querySelector('#error-state h2');
            const errorDesc = document.querySelector('#error-state p');
            
            if (errorMessage) {
                if (!currentReqNumber) {
                    errorMessage.textContent = 'ì˜ë¢° ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤';
                    if (errorDesc) {
                        errorDesc.innerHTML = `
                            ì˜¬ë°”ë¥¸ ì˜ë¢° ê²°ê³¼ í˜ì´ì§€ì—ì„œ ì ‘ê·¼í•´ì£¼ì„¸ìš”.<br>
                            <br>
                            <strong>í•´ê²° ë°©ë²•:</strong><br>
                            1. ì˜ë¢° ê²°ê³¼ ì¡°íšŒ í˜ì´ì§€ì—ì„œ "êµ¬ë§¤ ëŒ€í–‰ ì§€ì› ì„œë¹„ìŠ¤" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.<br>
                            2. ì§ì ‘ URLì— ì˜ë¢°ë²ˆí˜¸ë¥¼ í¬í•¨í•˜ì—¬ ì ‘ê·¼: <code>purchase-support.html?req=ì˜ë¢°ë²ˆí˜¸</code>
                        `;
                    }
                } else {
                    errorMessage.textContent = message;
                    if (errorDesc) {
                        errorDesc.innerHTML = `
                            ê´€ë¦¬ìê°€ ì•„ì§ ë‹µë³€í•˜ì§€ ì•Šì•˜ê±°ë‚˜, ì˜ë¢° ê²°ê³¼ í˜ì´ì§€ì—ì„œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.<br>
                            <br>
                            <strong>í™•ì¸ì‚¬í•­:</strong><br>
                            1. ì˜ë¢°ë²ˆí˜¸ <code>${currentReqNumber}</code>ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸<br>
                            2. ê´€ë¦¬ìê°€ í•´ë‹¹ ì˜ë¢°ì— ë‹µë³€í–ˆëŠ”ì§€ í™•ì¸<br>
                            3. ì˜ë¢° ê²°ê³¼ ì¡°íšŒ í˜ì´ì§€ì—ì„œ ë‹¤ì‹œ ì‹œë„
                        `;
                    }
                }
            }
        }

        function goBack() {
            window.history.back();
        }

        function processPayment() {
            console.log('=== ê²°ì œ ì²˜ë¦¬ ì‹œì‘ ===');
            
            // í•„ìˆ˜ í•„ë“œ ê²€ì¦
            const recipientName = document.getElementById('recipient-name').value.trim();
            const recipientPhone = document.getElementById('recipient-phone').value.trim();
            const recipientEmail = document.getElementById('recipient-email').value.trim();
            const customsCode = document.getElementById('customs-code').value.trim();
            const shippingAddress = document.getElementById('shipping-address').value.trim();
            const agreeTerms = document.getElementById('agree-terms').checked;

            if (!recipientName || !recipientPhone || !recipientEmail || !customsCode || !shippingAddress) {
                alert('í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!agreeTerms) {
                alert('ì´ìš©ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ìˆ¨ê²¨ì§„ í•„ë“œì—ì„œ ê°€ê²© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const basePrice = parseInt(document.getElementById('base-price').value) || 0;
            const serviceFee = parseInt(document.getElementById('service-fee').value) || 0;
            const totalAmount = parseInt(document.getElementById('total-amount').value) || 0;
            
            console.log('ê°€ê²© ì •ë³´:', { basePrice, serviceFee, totalAmount });

            const orderInfo = {
                reqKey: currentReqNumber,
                productName: currentRequestData.name,
                originalPrice: currentResultData.price,
                basePrice: basePrice,
                serviceFee: serviceFee,
                totalAmount: totalAmount,
                recipientName: recipientName,
                recipientPhone: recipientPhone,
                recipientEmail: recipientEmail,
                customsCode: customsCode,
                shippingAddress: shippingAddress,
                method: 'support',
                status: 'pending',
                orderDate: new Date().toISOString(),
                origin: currentResultData.origin
            };

            console.log('ì£¼ë¬¸ ì •ë³´:', orderInfo);

            // ì£¼ë¬¸ ì •ë³´ ì €ì¥
            localStorage.setItem('order-' + currentReqNumber, JSON.stringify(orderInfo));

            // ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™
            const paymentUrl = `payment.html?req=${currentReqNumber}&price=${totalAmount}&name=${encodeURIComponent(currentRequestData.name)}&origin=${encodeURIComponent(currentResultData.origin)}&method=support`;
            console.log('ê²°ì œ í˜ì´ì§€ URL:', paymentUrl);
            window.location.href = paymentUrl;
        }

        // ì´ìš©ì•½ê´€ ë™ì˜ ì‹œ ê²°ì œ ë²„íŠ¼ í™œì„±í™”
        document.getElementById('agree-terms').addEventListener('change', function() {
            const paymentBtn = document.getElementById('payment-btn');
            paymentBtn.disabled = !this.checked;
        });
    </script>
</body>
</html> 