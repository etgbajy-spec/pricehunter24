<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í›„ê¸° - PriceHunter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- í—¤ë” -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">â­ ê³ ê° í›„ê¸°</h1>
                <div class="flex gap-4 items-center">
                    <a href="index.html" class="text-blue-600 hover:text-blue-800 font-medium">â† ë©”ì¸ìœ¼ë¡œ</a>
                    <a href="admin-dashboard.html" id="admin-link" class="hidden px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-semibold text-sm">
                        ğŸ‘‘ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- í†µê³„ ì„¹ì…˜ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <div class="text-3xl font-bold text-blue-600" id="total-reviews">0</div>
                <div class="text-gray-600 mt-2">ì „ì²´ í›„ê¸°</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <div class="text-3xl font-bold text-green-600" id="avg-savings">0ì›</div>
                <div class="text-gray-600 mt-2">í‰ê·  ì ˆì•½ì•¡</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <div class="text-3xl font-bold text-purple-600" id="avg-rating">0</div>
                <div class="text-gray-600 mt-2">í‰ê·  í‰ì </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <div class="text-3xl font-bold text-orange-600" id="total-savings">0ì›</div>
                <div class="text-gray-600 mt-2">ì´ ì ˆì•½ì•¡</div>
            </div>
        </div>

        <!-- í•„í„° ì„¹ì…˜ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-[200px]">
                    <input type="text" id="search-input" placeholder="ì œí’ˆëª… ë˜ëŠ” í›„ê¸° ë‚´ìš© ê²€ìƒ‰..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <select id="sort-select" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="newest">ìµœì‹ ìˆœ</option>
                        <option value="oldest">ì˜¤ë˜ëœìˆœ</option>
                    <option value="savings">ì ˆì•½ì•¡ ë†’ì€ìˆœ</option>
                    <option value="rating">í‰ì  ë†’ì€ìˆœ</option>
                    </select>
            </div>
        </div>

        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
            <p class="mt-4 text-gray-600">í›„ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- í›„ê¸° ëª©ë¡ -->
        <div id="reviews-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>

        <!-- ë¹ˆ ìƒíƒœ -->
        <div id="empty-state" class="text-center py-12 hidden">
            <div class="text-6xl mb-4">ğŸ“</div>
            <p class="text-xl text-gray-600 mb-2">ì•„ì§ ë“±ë¡ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
            <p class="text-gray-500">ì²« ë²ˆì§¸ í›„ê¸°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
        </div>
    </main>

    <!-- Firebase ì´ˆê¸°í™” -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, where, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDBZxKyMS7eeBTbPnbZkj0WWOZQHNldoL4",
            authDomain: "pricehunter-99a1b.firebaseapp.com",
            projectId: "pricehunter-99a1b",
            storageBucket: "pricehunter-99a1b.firebasestorage.app",
            messagingSenderId: "242265693919",
            appId: "1:242265693919:web:74234d942b82a51541136a",
            measurementId: "G-4BKLV4EVB9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let allReviews = [];
        let filteredReviews = [];
        let isAdmin = false;
        let currentUser = null;

        // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
        async function checkAdminPermission(user) {
            try {
                if (!user || !user.uid) return false;
                
                const { getDoc } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                const adminDoc = await getDoc(doc(db, 'admins', user.uid));
                
                if (adminDoc.exists()) {
                    const adminData = adminDoc.data();
                    return adminData.role === 'admin' || adminData.permissions?.includes('admin');
                }
                
                // ê¸°ë³¸ ê´€ë¦¬ì ì´ë©”ì¼ í™•ì¸
                const adminEmails = ['admin@pricehunter.com', 'admin@example.com'];
                return adminEmails.includes(user.email);
                
            } catch (error) {
                console.error('âŒ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨:', error);
                return false;
            }
        }

        // ì¸ì¦ ìƒíƒœ í™•ì¸
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                isAdmin = await checkAdminPermission(user);
                console.log('ğŸ” ê´€ë¦¬ì ëª¨ë“œ:', isAdmin ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”');
                if (isAdmin) {
                    // ê´€ë¦¬ì ëª¨ë“œì¼ ë•Œ í—¤ë”ì— ê´€ë¦¬ì í‘œì‹œ ì¶”ê°€
                    const header = document.querySelector('header .flex');
                    if (header && !document.getElementById('admin-badge')) {
                        const adminBadge = document.createElement('div');
                        adminBadge.id = 'admin-badge';
                        adminBadge.className = 'px-3 py-1 bg-red-500 text-white text-sm rounded-full font-semibold';
                        adminBadge.textContent = 'ğŸ‘‘ ê´€ë¦¬ì ëª¨ë“œ';
                        header.appendChild(adminBadge);
                    }
                    // ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë§í¬ í‘œì‹œ
                    const adminLink = document.getElementById('admin-link');
                    if (adminLink) {
                        adminLink.classList.remove('hidden');
                    }
                }
                renderReviews(); // ê´€ë¦¬ì ëª¨ë“œ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ í‘œì‹œ ì—…ë°ì´íŠ¸
            } else {
                currentUser = null;
                isAdmin = false;
                const adminBadge = document.getElementById('admin-badge');
                if (adminBadge) adminBadge.remove();
                const adminLink = document.getElementById('admin-link');
                if (adminLink) {
                    adminLink.classList.add('hidden');
                }
                renderReviews();
            }
        });

        // í›„ê¸° ë°ì´í„° ë¡œë“œ
        async function loadReviews() {
            try {
                const reviewsRef = collection(db, 'reviews');
                
                // ì¸ë±ìŠ¤ ì—†ì´ë„ ì‘ë™í•˜ë„ë¡ whereë§Œ ì‚¬ìš©í•˜ê³  í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬
                const q = query(reviewsRef, where('approved', '==', true));
                
                const querySnapshot = await getDocs(q);
                allReviews = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allReviews.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt || Date.now())
                    });
                });

                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìµœì‹ ìˆœ ì •ë ¬
                allReviews.sort((a, b) => b.createdAt - a.createdAt);
                
                filteredReviews = [...allReviews];
                renderReviews();
                updateStatistics();
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('reviews-container').classList.remove('hidden');
                
            } catch (error) {
                console.error('í›„ê¸° ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('loading').innerHTML = '<p class="text-red-600">í›„ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ êµ¬ë…
        function subscribeToReviews() {
            const reviewsRef = collection(db, 'reviews');
            // ì¸ë±ìŠ¤ ì—†ì´ë„ ì‘ë™í•˜ë„ë¡ whereë§Œ ì‚¬ìš©í•˜ê³  í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬
            const q = query(reviewsRef, where('approved', '==', true));
            
            onSnapshot(q, (snapshot) => {
                    allReviews = [];
                snapshot.forEach((doc) => {
                        const data = doc.data();
                    allReviews.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt || Date.now())
                    });
                });
                
                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìµœì‹ ìˆœ ì •ë ¬
                allReviews.sort((a, b) => b.createdAt - a.createdAt);
                    
                    filteredReviews = [...allReviews];
                renderReviews();
                    updateStatistics();
                }, (error) => {
                console.error('ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€
            });
        }

        // í›„ê¸° ë Œë”ë§
        function renderReviews() {
            const container = document.getElementById('reviews-container');
            
            if (filteredReviews.length === 0) {
                container.classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }

            document.getElementById('empty-state').classList.add('hidden');
            container.classList.remove('hidden');
            
            container.innerHTML = filteredReviews.map(review => {
                const savings = parseInt(String(review.savings || '0').replace(/[^0-9]/g, ''));
                const savingsPercent = review.savingsPercent || 0;
                const rating = review.rating || 5;
                const stars = 'â˜…'.repeat(rating) + 'â˜†'.repeat(5 - rating);
                const date = review.createdAt ? new Date(review.createdAt).toLocaleDateString('ko-KR') : 'ë‚ ì§œ ì—†ìŒ';
                const images = review.images || review.photos || [];
                const mainImage = images.length > 0 ? images[0] : 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=400&h=300&fit=crop';

                return `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                        <div class="relative h-48 bg-gradient-to-br from-purple-100 to-blue-100">
                            ${images.length > 0 ? `
                                <img src="${mainImage}" alt="${review.productName || 'ì œí’ˆ'}" 
                                     class="w-full h-full object-cover">
                            ` : `
                                <div class="w-full h-full flex items-center justify-center text-6xl">
                                    ğŸ›ï¸
                                </div>
                            `}
                            <div class="absolute top-4 right-4 bg-white rounded-full px-3 py-1 text-sm font-bold text-purple-600 shadow-lg">
                                ${savingsPercent}% ì ˆì•½
                            </div>
                        </div>
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-2 line-clamp-2">${review.productName || 'ì œí’ˆëª… ì—†ìŒ'}</h3>
                            <div class="flex items-center mb-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-white font-bold mr-3">
                                    ${(review.userName || review.name || 'ìµ').charAt(0)}
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800">${review.userName || review.name || 'ìµëª…'}</div>
                                    <div class="text-sm text-gray-500">${date}</div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="text-yellow-500 text-lg mb-1">${stars}</div>
                                <p class="text-gray-700 text-sm line-clamp-3">${review.review || 'í›„ê¸° ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</p>
                        </div>
                            <div class="grid grid-cols-2 gap-4 pt-4 border-t border-gray-200">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">ì›ë˜ ê°€ê²©</div>
                                    <div class="text-sm line-through text-gray-400">${review.originalPrice || '0ì›'}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">êµ¬ë§¤ ê°€ê²©</div>
                                    <div class="text-lg font-bold text-green-600">${review.finalPrice || '0ì›'}</div>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">ì ˆì•½ì•¡</span>
                                    <span class="text-xl font-bold text-red-600">${review.savings || '0ì›'}</span>
                                </div>
                            </div>
                            ${review.badge ? `
                                <div class="mt-4">
                                    <span class="inline-block px-3 py-1 bg-purple-100 text-purple-800 text-xs rounded-full font-semibold">
                                ${review.badge}
                            </span>
                                </div>
                            ` : ''}
                            ${isAdmin ? `
                                <div class="mt-4 pt-4 border-t border-gray-200 flex gap-2">
                                    <button onclick="editReview('${review.id}')" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-semibold text-sm">
                                        âœï¸ ìˆ˜ì •
                                    </button>
                                    <button onclick="deleteReview('${review.id}')" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-semibold text-sm">
                                        ğŸ—‘ï¸ ì‚­ì œ
                                    </button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            const total = allReviews.length;
            const totalSavings = allReviews.reduce((sum, r) => {
                const savings = parseInt(String(r.savings || '0').replace(/[^0-9]/g, ''));
                return sum + savings;
            }, 0);
            const avgSavings = total > 0 ? Math.round(totalSavings / total) : 0;
            const avgRating = total > 0 ? (allReviews.reduce((sum, r) => sum + (r.rating || 5), 0) / total).toFixed(1) : 0;

            document.getElementById('total-reviews').textContent = total;
            document.getElementById('avg-savings').textContent = avgSavings.toLocaleString() + 'ì›';
            document.getElementById('avg-rating').textContent = avgRating;
            document.getElementById('total-savings').textContent = totalSavings.toLocaleString() + 'ì›';
        }

        // ê²€ìƒ‰ ë° í•„í„°
        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            filteredReviews = allReviews.filter(review => {
                const productName = (review.productName || '').toLowerCase();
                const reviewText = (review.review || '').toLowerCase();
                const userName = (review.userName || review.name || '').toLowerCase();
                return productName.includes(searchTerm) || reviewText.includes(searchTerm) || userName.includes(searchTerm);
            });
            renderReviews();
        });

        document.getElementById('sort-select').addEventListener('change', (e) => {
            const sortBy = e.target.value;
            filteredReviews = [...filteredReviews].sort((a, b) => {
                switch(sortBy) {
                case 'newest':
                        return b.createdAt - a.createdAt;
                case 'oldest':
                        return a.createdAt - b.createdAt;
                    case 'savings':
                        const savingsA = parseInt(String(a.savings || '0').replace(/[^0-9]/g, ''));
                        const savingsB = parseInt(String(b.savings || '0').replace(/[^0-9]/g, ''));
                        return savingsB - savingsA;
                case 'rating':
                        return (b.rating || 5) - (a.rating || 5);
                    default:
                        return 0;
                }
            });
            renderReviews();
        });

        // í›„ê¸° ìˆ˜ì •
        window.editReview = async function(reviewId) {
            const review = allReviews.find(r => r.id === reviewId);
            if (!review) {
                alert('í›„ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ìˆ˜ì • ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.id = 'edit-review-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">âœï¸ í›„ê¸° ìˆ˜ì •</h2>
                        <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <form id="edit-review-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì œí’ˆëª… *</label>
                            <input type="text" id="edit-productName" value="${review.productName || ''}" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì‘ì„±ìëª… *</label>
                            <input type="text" id="edit-userName" value="${review.userName || review.name || ''}" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì›ë˜ ê°€ê²© *</label>
                                <input type="text" id="edit-originalPrice" value="${review.originalPrice || ''}" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">êµ¬ë§¤ ê°€ê²© *</label>
                                <input type="text" id="edit-finalPrice" value="${review.finalPrice || ''}" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í‰ì  *</label>
                            <select id="edit-rating" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="5" ${review.rating === 5 ? 'selected' : ''}>5ì </option>
                                <option value="4" ${review.rating === 4 ? 'selected' : ''}>4ì </option>
                                <option value="3" ${review.rating === 3 ? 'selected' : ''}>3ì </option>
                                <option value="2" ${review.rating === 2 ? 'selected' : ''}>2ì </option>
                                <option value="1" ${review.rating === 1 ? 'selected' : ''}>1ì </option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í›„ê¸° ë‚´ìš© *</label>
                            <textarea id="edit-review" rows="4" 
                                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>${review.review || ''}</textarea>
                        </div>
                        <div class="flex items-center gap-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="edit-approved" ${review.approved ? 'checked' : ''} class="mr-2">
                                <span class="text-sm font-medium text-gray-700">ìŠ¹ì¸ë¨</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="edit-featured" ${review.featured ? 'checked' : ''} class="mr-2">
                                <span class="text-sm font-medium text-gray-700">ì¶”ì²œ í›„ê¸°</span>
                            </label>
                        </div>
                        <div class="flex justify-end gap-3 pt-4 border-t">
                            <button type="button" onclick="closeEditModal()" 
                                    class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                ì·¨ì†Œ
                            </button>
                            <button type="submit" 
                                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                                ì €ì¥
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            // í¼ ì œì¶œ ì´ë²¤íŠ¸
            document.getElementById('edit-review-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveReview(reviewId);
            });
        };

        // í›„ê¸° ì €ì¥
        async function saveReview(reviewId) {
            try {
                const originalPrice = document.getElementById('edit-originalPrice').value;
                const finalPrice = document.getElementById('edit-finalPrice').value;
                const original = parseInt(String(originalPrice).replace(/[^0-9]/g, ''));
                const final = parseInt(String(finalPrice).replace(/[^0-9]/g, ''));
                
                let savings = '0ì›';
                let savingsPercent = 0;
                if (!isNaN(original) && !isNaN(final) && original > 0) {
                    const savingsAmount = original - final;
                    savings = savingsAmount > 0 ? savingsAmount.toLocaleString() + 'ì›' : '0ì›';
                    savingsPercent = original > 0 ? Math.round(((original - final) / original) * 100) : 0;
                }

                const reviewData = {
                    productName: document.getElementById('edit-productName').value,
                    userName: document.getElementById('edit-userName').value,
                    name: document.getElementById('edit-userName').value, // í˜¸í™˜ì„±
                    originalPrice: originalPrice,
                    finalPrice: finalPrice,
                    savings: savings,
                    savingsPercent: savingsPercent,
                    rating: parseInt(document.getElementById('edit-rating').value),
                    review: document.getElementById('edit-review').value,
                    approved: document.getElementById('edit-approved').checked,
                    featured: document.getElementById('edit-featured').checked,
                    updatedAt: serverTimestamp()
                };

                const reviewRef = doc(db, 'reviews', reviewId);
                await updateDoc(reviewRef, reviewData);

                alert('í›„ê¸°ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeEditModal();
                
            } catch (error) {
                console.error('í›„ê¸° ìˆ˜ì • ì‹¤íŒ¨:', error);
                alert('í›„ê¸° ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
        window.closeEditModal = function() {
            const modal = document.getElementById('edit-review-modal');
            if (modal) {
                modal.remove();
            }
        };

        // í›„ê¸° ì‚­ì œ
        window.deleteReview = async function(reviewId) {
            if (!confirm('ì •ë§ë¡œ ì´ í›„ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ í›„ê¸°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }

            try {
                const reviewRef = doc(db, 'reviews', reviewId);
                await deleteDoc(reviewRef);
                
                alert('í›„ê¸°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                
            } catch (error) {
                console.error('í›„ê¸° ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('í›„ê¸° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        };

        // ì´ˆê¸° ë¡œë“œ
        loadReviews();
        subscribeToReviews();
    </script>
</body>
</html>
