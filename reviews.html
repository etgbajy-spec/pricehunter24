<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í›„ê¸° - PriceHunter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- í—¤ë” -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">â­ ê³ ê° í›„ê¸°</h1>
                <a href="index.html" class="text-blue-600 hover:text-blue-800 font-medium">â† ë©”ì¸ìœ¼ë¡œ</a>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- í†µê³„ ì„¹ì…˜ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <div class="text-3xl font-bold text-blue-600" id="total-reviews">0</div>
                <div class="text-gray-600 mt-2">ì „ì²´ í›„ê¸°</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <div class="text-3xl font-bold text-green-600" id="avg-savings">0ì›</div>
                <div class="text-gray-600 mt-2">í‰ê·  ì ˆì•½ì•¡</div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <div class="text-3xl font-bold text-purple-600" id="avg-rating">0</div>
                <div class="text-gray-600 mt-2">í‰ê·  í‰ì </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                <div class="text-3xl font-bold text-orange-600" id="total-savings">0ì›</div>
                <div class="text-gray-600 mt-2">ì´ ì ˆì•½ì•¡</div>
            </div>
        </div>

        <!-- í•„í„° ì„¹ì…˜ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-[200px]">
                    <input type="text" id="search-input" placeholder="ì œí’ˆëª… ë˜ëŠ” í›„ê¸° ë‚´ìš© ê²€ìƒ‰..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <select id="sort-select" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="newest">ìµœì‹ ìˆœ</option>
                        <option value="oldest">ì˜¤ë˜ëœìˆœ</option>
                    <option value="savings">ì ˆì•½ì•¡ ë†’ì€ìˆœ</option>
                    <option value="rating">í‰ì  ë†’ì€ìˆœ</option>
                    </select>
            </div>
        </div>

        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
            <p class="mt-4 text-gray-600">í›„ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- í›„ê¸° ëª©ë¡ -->
        <div id="reviews-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>

        <!-- ë¹ˆ ìƒíƒœ -->
        <div id="empty-state" class="text-center py-12 hidden">
            <div class="text-6xl mb-4">ğŸ“</div>
            <p class="text-xl text-gray-600 mb-2">ì•„ì§ ë“±ë¡ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
            <p class="text-gray-500">ì²« ë²ˆì§¸ í›„ê¸°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
        </div>
    </main>

    <!-- Firebase ì´ˆê¸°í™” -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDBZxKyMS7eeBTbPnbZkj0WWOZQHNldoL4",
            authDomain: "pricehunter-99a1b.firebaseapp.com",
            projectId: "pricehunter-99a1b",
            storageBucket: "pricehunter-99a1b.firebasestorage.app",
            messagingSenderId: "242265693919",
            appId: "1:242265693919:web:74234d942b82a51541136a",
            measurementId: "G-4BKLV4EVB9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let allReviews = [];
        let filteredReviews = [];

        // í›„ê¸° ë°ì´í„° ë¡œë“œ
        async function loadReviews() {
            try {
                const reviewsRef = collection(db, 'reviews');
                
                // ì¸ë±ìŠ¤ ì—†ì´ë„ ì‘ë™í•˜ë„ë¡ whereë§Œ ì‚¬ìš©í•˜ê³  í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬
                const q = query(reviewsRef, where('approved', '==', true));
                
                const querySnapshot = await getDocs(q);
                allReviews = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allReviews.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt || Date.now())
                    });
                });

                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìµœì‹ ìˆœ ì •ë ¬
                allReviews.sort((a, b) => b.createdAt - a.createdAt);
                
                filteredReviews = [...allReviews];
                renderReviews();
                updateStatistics();
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('reviews-container').classList.remove('hidden');
                
            } catch (error) {
                console.error('í›„ê¸° ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('loading').innerHTML = '<p class="text-red-600">í›„ê¸°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ êµ¬ë…
        function subscribeToReviews() {
            const reviewsRef = collection(db, 'reviews');
            // ì¸ë±ìŠ¤ ì—†ì´ë„ ì‘ë™í•˜ë„ë¡ whereë§Œ ì‚¬ìš©í•˜ê³  í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬
            const q = query(reviewsRef, where('approved', '==', true));
            
            onSnapshot(q, (snapshot) => {
                    allReviews = [];
                snapshot.forEach((doc) => {
                        const data = doc.data();
                    allReviews.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt || Date.now())
                    });
                });
                
                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ìµœì‹ ìˆœ ì •ë ¬
                allReviews.sort((a, b) => b.createdAt - a.createdAt);
                    
                    filteredReviews = [...allReviews];
                renderReviews();
                    updateStatistics();
                }, (error) => {
                console.error('ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€
            });
        }

        function formatCurrency(value, { suffix = 'ì›', prefix = '', fallback = `0${suffix}` } = {}) {
            const numeric = parseInt(String(value ?? '').replace(/[^0-9]/g, ''), 10);
            if (isNaN(numeric) || numeric === 0) {
                return fallback;
            }
            return `${prefix}${numeric.toLocaleString('ko-KR')}${suffix}`;
        }

        // í›„ê¸° ë Œë”ë§
        function renderReviews() {
            const container = document.getElementById('reviews-container');
            
            if (filteredReviews.length === 0) {
                container.classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }

            document.getElementById('empty-state').classList.add('hidden');
            container.classList.remove('hidden');
            
            container.innerHTML = filteredReviews.map(review => {
                const savings = parseInt(String(review.savings || '0').replace(/[^0-9]/g, ''));
                const savingsPercent = review.savingsPercent || 0;
                const rating = review.rating || 5;
                const stars = 'â˜…'.repeat(rating) + 'â˜†'.repeat(5 - rating);
                const date = review.createdAt ? new Date(review.createdAt).toLocaleDateString('ko-KR') : 'ë‚ ì§œ ì—†ìŒ';
                const images = review.images || review.photos || [];
                const mainImage = images.length > 0 ? images[0] : 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=400&h=300&fit=crop';

                const originalPriceText = formatCurrency(review.originalPrice);
                const finalPriceText = formatCurrency(review.finalPrice);
                const savingsText = formatCurrency(review.savings);

                return `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                        <div class="relative h-48 bg-gradient-to-br from-purple-100 to-blue-100">
                            ${images.length > 0 ? `
                                <img src="${mainImage}" alt="${review.productName || 'ì œí’ˆ'}" 
                                     class="w-full h-full object-cover">
                            ` : `
                                <div class="w-full h-full flex items-center justify-center text-6xl">
                                    ğŸ›ï¸
                                </div>
                            `}
                            <div class="absolute top-4 right-4 bg-white rounded-full px-3 py-1 text-sm font-bold text-purple-600 shadow-lg">
                                ${savingsPercent}% ì ˆì•½
                            </div>
                        </div>
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-2 line-clamp-2">${review.productName || 'ì œí’ˆëª… ì—†ìŒ'}</h3>
                            <div class="flex items-center mb-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center text-white font-bold mr-3">
                                    ${(review.userName || review.name || 'ìµ').charAt(0)}
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800">${review.userName || review.name || 'ìµëª…'}</div>
                                    <div class="text-sm text-gray-500">${date}</div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <div class="text-yellow-500 text-lg mb-1">${stars}</div>
                                <p class="text-gray-700 text-sm line-clamp-3">${review.review || 'í›„ê¸° ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'}</p>
                        </div>
                            <div class="grid grid-cols-2 gap-4 pt-4 border-t border-gray-200">
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">ì˜ë¢° ê°€ê²©</div>
                                    <div class="text-sm line-through text-gray-400">${originalPriceText}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 mb-1">êµ¬ë§¤ ê°€ê²©</div>
                                    <div class="text-lg font-bold text-green-600">${finalPriceText}</div>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">ì ˆì•½ì•¡</span>
                                    <span class="text-xl font-bold text-red-600">${savingsText}</span>
                                </div>
                            </div>
                            <div class="mt-4">
                                <span class="inline-block px-3 py-1 bg-green-100 text-green-800 text-xs rounded-full font-semibold">
                                    âœ“ ìµœì €ê°€ ì œê³µì™„ë£Œ
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            const total = allReviews.length;
            const totalSavings = allReviews.reduce((sum, r) => {
                const savings = parseInt(String(r.savings || '0').replace(/[^0-9]/g, ''));
                return sum + savings;
            }, 0);
            const avgSavings = total > 0 ? Math.round(totalSavings / total) : 0;
            const avgRating = total > 0 ? (allReviews.reduce((sum, r) => sum + (r.rating || 5), 0) / total).toFixed(1) : 0;

            document.getElementById('total-reviews').textContent = total;
            document.getElementById('avg-savings').textContent = avgSavings.toLocaleString() + 'ì›';
            document.getElementById('avg-rating').textContent = avgRating;
            document.getElementById('total-savings').textContent = totalSavings.toLocaleString() + 'ì›';
        }

        // ê²€ìƒ‰ ë° í•„í„°
        document.getElementById('search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            filteredReviews = allReviews.filter(review => {
                const productName = (review.productName || '').toLowerCase();
                const reviewText = (review.review || '').toLowerCase();
                const userName = (review.userName || review.name || '').toLowerCase();
                return productName.includes(searchTerm) || reviewText.includes(searchTerm) || userName.includes(searchTerm);
            });
            renderReviews();
        });

        document.getElementById('sort-select').addEventListener('change', (e) => {
            const sortBy = e.target.value;
            filteredReviews = [...filteredReviews].sort((a, b) => {
                switch(sortBy) {
                case 'newest':
                        return b.createdAt - a.createdAt;
                case 'oldest':
                        return a.createdAt - b.createdAt;
                    case 'savings':
                        const savingsA = parseInt(String(a.savings || '0').replace(/[^0-9]/g, ''));
                        const savingsB = parseInt(String(b.savings || '0').replace(/[^0-9]/g, ''));
                        return savingsB - savingsA;
                case 'rating':
                        return (b.rating || 5) - (a.rating || 5);
                    default:
                        return 0;
                }
            });
            renderReviews();
        });

        // ì´ˆê¸° ë¡œë“œ
        loadReviews();
        subscribeToReviews();
    </script>
</body>
</html>
