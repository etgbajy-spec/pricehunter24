<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>내 주문 목록 | PriceHunter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Noto Sans KR', 'Inter', sans-serif; }
      .status-ordered { color: #3b82f6; }
      .status-paid { color: #8b5cf6; }
      .status-preparing { color: #f97316; }
      .status-shipping { color: #6366f1; }
      .status-delivered { color: #10b981; }
      .status-none { color: #6b7280; }
    </style>
  </head>
  <body class="bg-gradient-to-br from-gray-50 via-blue-50 to-emerald-50 min-h-screen">
    <main class="container mx-auto px-4 py-8 max-w-4xl">
      <div class="bg-white/90 rounded-3xl shadow-2xl p-8 backdrop-blur-md">
        <div class="text-center mb-8">
          <h1 class="text-3xl font-extrabold text-pink-600 mb-2">📦 내 주문 목록</h1>
          <p class="text-gray-600">구매한 상품들의 진행상태를 확인하세요</p>
        </div>

        <!-- 사용자 정보 -->
        <div class="bg-pink-50 rounded-xl p-4 mb-6">
          <div class="flex items-center justify-between">
            <div>
              <span class="font-bold text-pink-700" id="user-name">사용자</span>
              <span class="text-gray-600 ml-2" id="user-email">이메일</span>
            </div>
            <a href="index.html" class="px-4 py-2 bg-pink-500 text-white rounded-lg font-bold hover:bg-pink-600 transition">
              홈으로 돌아가기
            </a>
          </div>
        </div>

        <!-- 주문 목록 -->
        <div class="mb-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-800">주문 내역</h2>
            <div class="text-sm text-gray-600">
              총 <span id="order-count">0</span>개의 주문
            </div>
          </div>
          
          <div class="bg-gray-50 rounded-xl overflow-hidden">
            <div class="grid grid-cols-12 gap-4 p-4 bg-gray-100 font-bold text-sm text-gray-700">
              <div class="col-span-2">주문번호</div>
              <div class="col-span-3">상품명</div>
              <div class="col-span-2">구매방식</div>
              <div class="col-span-2">구매상태</div>
              <div class="col-span-2">주문일</div>
              <div class="col-span-1">상세</div>
            </div>
            
            <div id="orders-list" class="divide-y divide-gray-200">
              <!-- 주문 목록이 여기에 동적으로 생성됩니다 -->
            </div>
          </div>
        </div>

        <!-- 주문 상세 정보 -->
        <div id="order-detail" class="hidden bg-blue-50 rounded-xl p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-blue-700">📋 주문 상세 정보</h3>
            <button onclick="closeOrderDetail()" class="text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <div id="order-detail-content" class="space-y-4">
            <!-- 주문 상세 내용이 여기에 표시됩니다 -->
          </div>
        </div>

        <!-- 진행상태 안내 -->
        <div class="bg-yellow-50 rounded-xl p-4">
          <h3 class="font-bold text-yellow-800 mb-2">📊 구매 진행상태 안내</h3>
          <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
            <div class="flex items-center">
              <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
              <span class="status-ordered">주문접수</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 bg-purple-500 rounded-full mr-2"></div>
              <span class="status-paid">결제완료</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 bg-orange-500 rounded-full mr-2"></div>
              <span class="status-preparing">배송준비</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 bg-indigo-500 rounded-full mr-2"></div>
              <span class="status-shipping">배송중</span>
            </div>
            <div class="flex items-center">
              <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
              <span class="status-delivered">배송완료</span>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      let currentUser = null;
      let allOrders = [];

      // 사용자 정보 로드
      function loadUserInfo() {
        const userData = localStorage.getItem('user');
        if (userData) {
          currentUser = JSON.parse(userData);
          document.getElementById('user-name').textContent = currentUser.name;
          document.getElementById('user-email').textContent = currentUser.email;
        } else {
          // 로그인되지 않은 경우 홈으로 리다이렉트
          window.location.href = 'index.html';
        }
      }

      // 주문 목록 가져오기
      function getOrders() {
        const orders = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('order-') && !key.includes('PH-')) {
            const orderData = localStorage.getItem(key);
            if (orderData) {
              const order = JSON.parse(orderData);
              // 현재 사용자의 의뢰와 연결된 주문만 필터링
              const requestKey = 'request-' + key.replace('order-', '');
              const requestData = localStorage.getItem(requestKey);
              if (requestData) {
                const request = JSON.parse(requestData);
                if (request.email === currentUser.email) {
                  orders.push({
                    key: key,
                    reqKey: key.replace('order-', ''),
                    ...order
                  });
                }
              }
            }
          }
        }
        return orders.sort((a, b) => new Date(b.orderDate || 0) - new Date(a.orderDate || 0));
      }

      // 구매 상태 텍스트 변환
      function getPurchaseStatusText(status) {
        const statusMap = {
          'none': '구매하지 않음',
          'ordered': '주문접수',
          'paid': '결제완료',
          'preparing': '배송준비',
          'shipping': '배송중',
          'delivered': '배송완료'
        };
        return statusMap[status] || '구매하지 않음';
      }

      // 구매 방식 텍스트 변환
      function getPurchaseMethodText(method) {
        const methodMap = {
          'direct': 'PriceHunter 직접구매 (서비스 중단)',
          'external': '최저가 쇼핑몰',
          'none': '구매하지 않음'
        };
        return methodMap[method] || '구매하지 않음';
      }

      // 주문 목록 렌더링
      function renderOrders() {
        allOrders = getOrders();
        const ordersList = document.getElementById('orders-list');
        const orderCount = document.getElementById('order-count');
        
        orderCount.textContent = allOrders.length;
        
        if (allOrders.length === 0) {
          ordersList.innerHTML = `
            <div class="p-8 text-center text-gray-500">
              <div class="text-4xl mb-4">📦</div>
              <div class="text-lg font-semibold mb-2">아직 주문한 상품이 없습니다</div>
              <div class="text-sm">의뢰 결과에서 구매를 진행해보세요!</div>
            </div>
          `;
          return;
        }

        ordersList.innerHTML = '';
        
        allOrders.forEach(order => {
          const orderItem = document.createElement('div');
          orderItem.className = 'grid grid-cols-12 gap-4 p-4 hover:bg-gray-50 transition';
          
          const orderDate = order.orderDate ? new Date(order.orderDate).toLocaleDateString() : '-';
          const statusText = getPurchaseStatusText(order.status);
          const methodText = getPurchaseMethodText(order.method);
          
          orderItem.innerHTML = `
            <div class="col-span-2 text-sm font-semibold text-gray-700">${order.reqKey}</div>
            <div class="col-span-3 text-sm text-gray-800">${order.productName || '-'}</div>
            <div class="col-span-2 text-sm text-gray-600">${methodText}</div>
            <div class="col-span-2">
              <span class="px-2 py-1 rounded text-xs font-bold status-${order.status}">${statusText}</span>
            </div>
            <div class="col-span-2 text-sm text-gray-500">${orderDate}</div>
            <div class="col-span-1">
              <button onclick="showOrderDetail('${order.key}')" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
                상세보기
              </button>
            </div>
          `;
          
          ordersList.appendChild(orderItem);
        });
      }

      // 주문 상세 정보 표시
      function showOrderDetail(orderKey) {
        const order = allOrders.find(o => o.key === orderKey);
        if (!order) return;

        const detailContent = document.getElementById('order-detail-content');
        const detailSection = document.getElementById('order-detail');
        
        let detailHtml = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="font-bold text-gray-800 mb-3">📦 주문 정보</h4>
              <div class="space-y-2 text-sm">
                <div><span class="font-semibold">주문번호:</span> ${order.reqKey}</div>
                <div><span class="font-semibold">상품명:</span> ${order.productName || '-'}</div>
                <div><span class="font-semibold">구매방식:</span> ${getPurchaseMethodText(order.method)}</div>
                <div><span class="font-semibold">구매상태:</span> 
                  <span class="px-2 py-1 rounded text-xs font-bold status-${order.status}">${getPurchaseStatusText(order.status)}</span>
                </div>
                <div><span class="font-semibold">주문일:</span> ${order.orderDate ? new Date(order.orderDate).toLocaleString() : '-'}</div>
              </div>
            </div>
        `;

        if (order.method === 'direct') {
          detailHtml += `
            <div>
              <h4 class="font-bold text-gray-800 mb-3">💳 결제 정보</h4>
              <div class="space-y-2 text-sm">
                <div><span class="font-semibold">결제방법:</span> ${order.paymentMethod || '-'}</div>
                <div><span class="font-semibold">결제금액:</span> ${order.price || '-'}</div>
              </div>
            </div>
          `;
        } else if (order.method === 'external') {
          detailHtml += `
            <div>
              <h4 class="font-bold text-gray-800 mb-3">🔗 외부 링크</h4>
              <div class="space-y-2 text-sm">
                <div><span class="font-semibold">구매 링크:</span></div>
                <a href="${order.externalLink}" target="_blank" class="text-blue-600 underline break-all">${order.externalLink}</a>
              </div>
            </div>
          `;
        }

        if (order.recipient) {
          detailHtml += `
            <div>
              <h4 class="font-bold text-gray-800 mb-3">📮 배송 정보</h4>
              <div class="space-y-2 text-sm">
                <div><span class="font-semibold">수령인:</span> ${order.recipient.name || '-'}</div>
                <div><span class="font-semibold">연락처:</span> ${order.recipient.phone || '-'}</div>
                <div><span class="font-semibold">배송지:</span> ${order.recipient.address || '-'}</div>
              </div>
            </div>
          `;
        }

        if (order.memo) {
          detailHtml += `
            <div class="md:col-span-2">
              <h4 class="font-bold text-gray-800 mb-3">📝 관리자 메모</h4>
              <div class="bg-white rounded-lg p-3 text-sm">
                ${order.memo}
              </div>
            </div>
          `;
        }

        detailHtml += '</div>';
        
        detailContent.innerHTML = detailHtml;
        detailSection.classList.remove('hidden');
      }

      // 주문 상세 정보 닫기
      function closeOrderDetail() {
        document.getElementById('order-detail').classList.add('hidden');
      }

      // 페이지 로드 시 초기화
      window.addEventListener('DOMContentLoaded', function() {
        loadUserInfo();
        renderOrders();
      });
    </script>
  </body>
</html> 