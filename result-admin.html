<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>의뢰 결과 입력/관리 | PriceHunter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 프로덕션에서는 Tailwind CSS를 빌드하여 사용하는 것을 권장합니다 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Noto Sans KR', 'Inter', sans-serif; }
      .tab-btn.active {
        background-color: #ec4899;
        color: white;
      }
      .filter-btn.active {
        background-color: #6b7280;
        color: white;
      }
      #rich-editor {
        min-height: 200px;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        padding: 1rem;
        background: white;
      }
      #rich-editor:focus {
        outline: none;
        border-color: #ec4899;
        box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
      }
      .editor-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.5rem;
        background: #f9fafb;
        border-radius: 0.5rem;
      }
      .editor-btn {
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        background: white;
        cursor: pointer;
        font-size: 0.875rem;
      }
      .editor-btn:hover {
        background: #f3f4f6;
      }
      .editor-btn.active {
        background: #ec4899;
        color: white;
        border-color: #ec4899;
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-gray-50 via-blue-50 to-emerald-50 min-h-screen flex items-center justify-center px-2">
    <main class="w-full max-w-6xl bg-white/90 rounded-3xl shadow-2xl p-4 md:p-8 lg:p-12 flex flex-col items-center text-center backdrop-blur-md mt-4 md:mt-8 mb-4 md:mb-8">
      <h1 class="text-xl sm:text-2xl md:text-3xl font-extrabold text-pink-600 mb-3 md:mb-4">의뢰 결과 입력/관리 (관리자 전용)</h1>
      <div class="text-sm text-gray-500 mb-6">이 페이지는 관리자(개발자)만 접근 가능합니다.</div>
      
      <!-- 알림 설정 섹션 -->
      <div class="w-full mb-6 p-4 bg-blue-50 rounded-xl">
        <div class="font-bold text-blue-700 mb-3">📱 알림 발송 설정</div>
        <div class="flex flex-wrap gap-4 items-center justify-center">
          <select id="notify-method" class="px-3 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-pink-400 focus:outline-none">
            <option value="both">카카오톡 + 문자</option>
            <option value="kakao">카카오톡만</option>
            <option value="sms">문자만</option>
          </select>
        </div>
        <div class="text-xs text-gray-500 mt-2 text-center">
          결과 저장 후 "고객에게 알림 발송" 버튼을 눌러 고객에게 알림을 발송합니다.
        </div>
      </div>
      
      <!-- 회원별 탭 시스템 -->
      <div class="w-full mb-6">
        <div class="flex flex-wrap gap-2 justify-center mb-4">
          <button id="tab-all" class="tab-btn active px-4 py-2 bg-pink-500 text-white rounded-lg font-bold hover:bg-pink-600 transition" onclick="switchTab('all')">
            전체 <span id="count-all" class="ml-1 bg-white text-pink-500 px-2 py-1 rounded text-xs">0</span>
          </button>
          <!-- 회원별 탭은 동적으로 생성됨 -->
        </div>
        
        <!-- 진행상황 필터 -->
        <div class="flex flex-wrap gap-2 justify-center mb-4">
          <button id="filter-all" class="filter-btn active px-3 py-1 bg-gray-500 text-white rounded font-bold hover:bg-gray-600 transition text-sm" onclick="switchFilter('all')">전체</button>
          <button id="filter-new" class="filter-btn px-3 py-1 bg-red-500 text-white rounded font-bold hover:bg-red-600 transition text-sm" onclick="switchFilter('new')">신규의뢰</button>
          <button id="filter-progress" class="filter-btn px-3 py-1 bg-orange-500 text-white rounded font-bold hover:bg-orange-600 transition text-sm" onclick="switchFilter('progress')">진행중</button>
          <button id="filter-complete" class="filter-btn px-3 py-1 bg-green-500 text-white rounded font-bold hover:bg-green-600 transition text-sm" onclick="switchFilter('complete')">완료</button>
        </div>
      </div>
      
      <!-- 일괄 삭제 및 알림 발송 버튼 -->
      <div class="w-full mb-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="select-all" class="w-4 h-4 text-pink-600 bg-gray-100 border-gray-300 rounded focus:ring-pink-500 focus:ring-2" onchange="toggleSelectAll()">
            <span class="text-sm font-semibold text-gray-700">전체 선택</span>
          </label>
          <span id="selected-count" class="text-sm text-gray-600">선택됨: 0개</span>
        </div>
        <div class="flex gap-2">
          <button id="bulk-notify-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition text-sm hidden" onclick="bulkSendNotification()">
            선택 알림 발송 (<span id="notify-count">0</span>개)
          </button>
          <button id="bulk-delete-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition text-sm hidden" onclick="bulkDelete()">
            선택 삭제 (<span id="delete-count">0</span>개)
          </button>
        </div>
      </div>
      
      <!-- 의뢰 목록 -->
      <div class="w-full mb-8">
        <div class="font-bold text-gray-700 mb-2 text-left">접수된 의뢰 목록</div>
        <div class="flex justify-between items-center px-4 py-2 bg-pink-100 rounded-t-xl text-sm font-bold text-pink-700 flex-wrap">
          <span class="w-8">선택</span>
          <span class="flex-1">의뢰번호/회원명</span>
          <span class="w-1/6 text-center">의뢰일시</span>
          <span class="w-1/6 text-center">진행상황</span>
          <span class="w-1/6 text-center">구매방식</span>
          <span class="w-1/6 text-center">구매상태</span>
          <span class="w-1/6 text-center">알림상태</span>
          <span class="w-1/4 text-right">제품명</span>
        </div>
        <ul id="request-list" class="bg-pink-50 rounded-b-xl shadow-inner divide-y divide-pink-100 text-left"></ul>
      </div>
      
      <!-- 의뢰 상세 및 답변 입력 -->
      <div id="detail-section" class="w-full hidden">
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-4 text-left">
          <div class="mb-2 text-gray-700 font-bold">의뢰 상세</div>
          <div class="mb-2 text-gray-600"><span class="font-semibold">의뢰번호:</span> <span id="detail-num"></span></div>
          <div class="mb-2 text-gray-600"><span class="font-semibold">회원명:</span> <span id="detail-name"></span></div>
          <div class="mb-2 text-gray-600"><span class="font-semibold">제품명:</span> <span id="detail-product"></span></div>
          <div class="mb-2 text-gray-600"><span class="font-semibold">희망가격:</span> <span id="detail-price"></span></div>
          <div class="mb-2 text-gray-600"><span class="font-semibold">제품설명:</span> <span id="detail-description"></span></div>
          <div class="mb-2 text-gray-600"><span class="font-semibold">참고사이트:</span> <span id="detail-reference"></span></div>
          <div class="mb-2 text-gray-600"><span class="font-semibold">의뢰일시:</span> <span id="detail-date"></span></div>
        </div>
        
        <!-- 답변 입력 폼 -->
        <div class="bg-white rounded-2xl shadow-lg p-6 text-left">
          <div class="mb-4 text-gray-700 font-bold">답변 입력</div>
          
          <form id="result-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">최저가</label>
                <input type="text" id="admin-price" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:outline-none" placeholder="예: 45,000원">
              </div>
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">원산지/공급처</label>
                <input type="text" id="admin-origin" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:outline-none" placeholder="예: 🇰🇷 대한민국">
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">구매 링크</label>
              <input type="url" id="admin-link" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-400 focus:outline-none" placeholder="https://example.com">
            </div>
            
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-2">종합설명</label>
              <div class="editor-toolbar">
                <button type="button" class="editor-btn" onclick="execCommand('bold')">굵게</button>
                <button type="button" class="editor-btn" onclick="execCommand('italic')">기울임</button>
                <button type="button" class="editor-btn" onclick="execCommand('underline')">밑줄</button>
                <button type="button" class="editor-btn" onclick="execCommand('insertUnorderedList')">목록</button>
                <button type="button" class="editor-btn" onclick="execCommand('insertOrderedList')">번호목록</button>
                <button type="button" class="editor-btn" onclick="setFontSize()">글자크기</button>
                <button type="button" class="editor-btn" onclick="insertImage()">이미지</button>
                <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
              </div>
              <div id="rich-editor" contenteditable="true" class="w-full"></div>
              <textarea id="admin-summary" style="display: none;"></textarea>
            </div>
            
            <div class="flex gap-2">
              <button type="submit" class="px-6 py-2 bg-pink-500 text-white rounded-lg font-bold hover:bg-pink-600 transition">
                결과 저장
              </button>
              <button type="button" id="admin-delete" class="px-6 py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition">
                결과 삭제
              </button>
            </div>
          </form>
          
          <div id="admin-msg" class="mt-4"></div>
        </div>
      </div>
    </main>

    <script>
      // 전역 변수
      let currentTab = 'all';
      let currentFilter = 'all';
      let currentReqKey = null;
      let currentRequest = null;
      let selectedRequests = new Set();

      // 관리자 권한 확인
      function isAdmin() {
        // localStorage에서 직접 isAdmin 키 확인
        const isAdminValue = localStorage.getItem('isAdmin');
        const adminModeValue = localStorage.getItem('adminMode');
        
        // 둘 중 하나라도 true이면 관리자로 인식
        return isAdminValue === 'true' || adminModeValue === 'true';
      }

      // 탭 전환
      function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        renderRequestList();
      }

      // 필터 전환
      function switchFilter(filter) {
        currentFilter = filter;
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('filter-' + filter).classList.add('active');
        renderRequestList();
      }

      // 전체 선택/해제
      function toggleSelectAll() {
        const selectAll = document.getElementById('select-all');
        const checkboxes = document.querySelectorAll('.request-checkbox');
        
        checkboxes.forEach(checkbox => {
          checkbox.checked = selectAll.checked;
          if (selectAll.checked) {
            selectedRequests.add(checkbox.value);
          } else {
            selectedRequests.delete(checkbox.value);
          }
        });
        
        updateSelectedCount();
        updateBulkButtons();
      }

      // 선택된 개수 업데이트
      function updateSelectedCount() {
        const count = selectedRequests.size;
        document.getElementById('selected-count').textContent = `선택됨: ${count}개`;
        document.getElementById('notify-count').textContent = count;
        document.getElementById('delete-count').textContent = count;
      }

      // 일괄 버튼 업데이트
      function updateBulkButtons() {
        const count = selectedRequests.size;
        const notifyBtn = document.getElementById('bulk-notify-btn');
        const deleteBtn = document.getElementById('bulk-delete-btn');
        
        if (count > 0) {
          notifyBtn.classList.remove('hidden');
          deleteBtn.classList.remove('hidden');
        } else {
          notifyBtn.classList.add('hidden');
          deleteBtn.classList.add('hidden');
        }
      }

      // 의뢰 목록 렌더링
      function renderRequestList() {
        console.log('=== 의뢰 목록 렌더링 ===');
        
        const allKeys = Object.keys(localStorage);
        const requestKeys = allKeys.filter(key => key.startsWith('request-'));
        
        console.log('전체 의뢰 수:', requestKeys.length);
        console.log('의뢰 목록:', requestKeys);
        
        let requests = [];
        
        requestKeys.forEach(key => {
          try {
            const request = JSON.parse(localStorage.getItem(key));
            if (request) {
              request.key = key;
              requests.push(request);
            }
          } catch (e) {
            console.error('의뢰 데이터 파싱 오류:', key, e);
          }
        });
        
        // 필터링
        let filteredRequests = requests;
        
        if (currentTab !== 'all') {
          filteredRequests = requests.filter(req => req.userName === currentTab);
        }
        
        if (currentFilter !== 'all') {
          filteredRequests = filteredRequests.filter(req => {
            const result = localStorage.getItem('result-' + req.key.replace('request-', ''));
            if (currentFilter === 'new') return !result;
            if (currentFilter === 'progress') return result && !JSON.parse(result).summary;
            if (currentFilter === 'complete') return result && JSON.parse(result).summary;
            return true;
          });
        }
        
        console.log('필터링된 의뢰 수:', filteredRequests.length);
        console.log('현재 탭:', currentTab);
        console.log('현재 필터:', currentFilter);
        
        // 목록 렌더링
        const list = document.getElementById('request-list');
        list.innerHTML = '';
        
        filteredRequests.forEach(request => {
          const reqNum = request.key.replace('request-', '');
          const result = localStorage.getItem('result-' + reqNum);
          const resultData = result ? JSON.parse(result) : null;
          
          const li = document.createElement('li');
          li.className = 'flex items-center px-4 py-3 hover:bg-pink-100 transition cursor-pointer';
          li.onclick = () => showDetail(request.key);
          
          const status = resultData ? (resultData.summary ? '완료' : '진행중') : '신규의뢰';
          const statusColor = resultData ? (resultData.summary ? 'text-green-600' : 'text-orange-600') : 'text-red-600';
          
          li.innerHTML = `
            <div class="w-8">
              <input type="checkbox" class="request-checkbox w-4 h-4 text-pink-600 bg-gray-100 border-gray-300 rounded focus:ring-pink-500 focus:ring-2" 
                     value="${request.key}" 
                     ${selectedRequests.has(request.key) ? 'checked' : ''}
                     onclick="event.stopPropagation(); toggleRequestSelection('${request.key}')">
            </div>
            <div class="flex-1">
              <div class="font-semibold text-gray-800">${reqNum}</div>
              <div class="text-sm text-gray-600">${request.userName || '알 수 없음'}</div>
            </div>
            <div class="w-1/6 text-center text-sm text-gray-600">${new Date(request.date).toLocaleDateString()}</div>
            <div class="w-1/6 text-center">
              <span class="px-2 py-1 rounded text-xs font-semibold ${statusColor}">${status}</span>
            </div>
            <div class="w-1/6 text-center text-sm text-gray-600">-</div>
            <div class="w-1/6 text-center text-sm text-gray-600">-</div>
            <div class="w-1/6 text-center text-sm text-gray-600">-</div>
            <div class="w-1/4 text-right">
              <div class="font-semibold text-gray-800">${request.name || request.productName || request.product || '제품명 없음'}</div>
              <div class="text-sm text-gray-600">${request.price || request.hopePrice || '가격 없음'}원</div>
            </div>
          `;
          
          list.appendChild(li);
        });
        
        // 카운트 업데이트
        document.getElementById('count-all').textContent = requests.length;
        
        console.log('의뢰 목록 렌더링 완료');
      }

      // 의뢰 선택 토글
      function toggleRequestSelection(key) {
        const checkbox = document.querySelector(`input[value="${key}"]`);
        if (checkbox.checked) {
          selectedRequests.add(key);
        } else {
          selectedRequests.delete(key);
        }
        updateSelectedCount();
        updateBulkButtons();
      }

      // 사용자 탭 생성
      function createUserTabs() {
        const allKeys = Object.keys(localStorage);
        const requestKeys = allKeys.filter(key => key.startsWith('request-'));
        
        const users = new Set();
        requestKeys.forEach(key => {
          try {
            const request = JSON.parse(localStorage.getItem(key));
            if (request && request.userName) {
              users.add(request.userName);
            }
          } catch (e) {
            console.error('사용자 데이터 파싱 오류:', key, e);
          }
        });
        
        const tabContainer = document.querySelector('.flex.flex-wrap.gap-2.justify-center.mb-4');
        
        users.forEach(userName => {
          const button = document.createElement('button');
          button.id = 'tab-' + userName;
          button.className = 'tab-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300 transition';
          button.onclick = () => switchTab(userName);
          button.innerHTML = `${userName} <span id="count-${userName}" class="ml-1 bg-white text-gray-700 px-2 py-1 rounded text-xs">0</span>`;
          tabContainer.appendChild(button);
        });
        
        console.log('사용자 탭 생성 완료');
      }

      // 상세 정보 표시
      function showDetail(reqKey) {
        currentReqKey = reqKey;
        currentRequest = JSON.parse(localStorage.getItem(reqKey));
        
        if (!currentRequest) {
          alert('의뢰 정보를 찾을 수 없습니다.');
          return;
        }
        
        // 상세 정보 채우기
        document.getElementById('detail-num').textContent = reqKey.replace('request-', '');
        document.getElementById('detail-name').textContent = currentRequest.userName || '알 수 없음';
        document.getElementById('detail-product').textContent = currentRequest.name || currentRequest.productName || currentRequest.product || '제품명 없음';
        document.getElementById('detail-price').textContent = (currentRequest.price || currentRequest.hopePrice) ? (currentRequest.price || currentRequest.hopePrice) + '원' : '희망가격 없음';
        document.getElementById('detail-description').textContent = currentRequest.desc || currentRequest.description || '설명 없음';
        document.getElementById('detail-reference').textContent = (currentRequest.urls && currentRequest.urls.length > 0) ? currentRequest.urls[0] : (currentRequest.reference || '참고사이트 없음');
        document.getElementById('detail-date').textContent = new Date(currentRequest.date).toLocaleString();
        
        // 기존 결과 로드
        const reqNum = reqKey.replace('request-', '');
        const result = localStorage.getItem('result-' + reqNum);
        if (result) {
          const resultData = JSON.parse(result);
          document.getElementById('admin-price').value = resultData.price || '';
          document.getElementById('admin-origin').value = resultData.origin || '';
          document.getElementById('admin-link').value = resultData.link || '';
          
          const richEditor = document.getElementById('rich-editor');
          if (richEditor && resultData.summary) {
            richEditor.innerHTML = resultData.summary;
          }
        } else {
          // 초기화
          document.getElementById('admin-price').value = '';
          document.getElementById('admin-origin').value = '';
          document.getElementById('admin-link').value = '';
          document.getElementById('rich-editor').innerHTML = '';
        }
        
        // 상세 섹션 표시
        document.getElementById('detail-section').classList.remove('hidden');
      }

      // 리치 텍스트 에디터 초기화
      function initRichEditor() {
        console.log('리치 에디터 초기화 시작');
        
        const editor = document.getElementById('rich-editor');
        const textarea = document.getElementById('admin-summary');
        
        if (!editor) {
          console.error('rich-editor 요소를 찾을 수 없습니다.');
          return;
        }
        
        // 에디터 이벤트 리스너
        editor.addEventListener('input', function() {
          if (textarea) {
            textarea.value = editor.innerHTML;
          }
        });
        
        // 이미지 붙여넣기 처리
        editor.addEventListener('paste', function(e) {
          const items = e.clipboardData.items;
          for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
              const file = item.getAsFile();
              const reader = new FileReader();
              reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.margin = '10px 0';
                editor.appendChild(img);
              };
              reader.readAsDataURL(file);
              e.preventDefault();
              break;
            }
          }
        });
        
        // 드래그 앤 드롭 이미지 처리
        editor.addEventListener('dragover', function(e) {
          e.preventDefault();
        });
        
        editor.addEventListener('drop', function(e) {
          e.preventDefault();
          const files = e.dataTransfer.files;
          for (let file of files) {
            if (file.type.startsWith('image/')) {
              const reader = new FileReader();
              reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.margin = '10px 0';
                editor.appendChild(img);
              };
              reader.readAsDataURL(file);
            }
          }
        });
        
        // 에디터 포커스
        editor.addEventListener('click', function() {
          editor.focus();
        });
        
        console.log('리치 에디터 초기화 완료');
      }

      // 에디터 명령어 실행
      function execCommand(command) {
        document.execCommand(command, false, null);
        document.getElementById('rich-editor').focus();
      }

      // 글자 크기 설정
      function setFontSize() {
        const size = prompt('글자 크기를 입력하세요 (예: 16px, 1.2em):', '16px');
        if (size) {
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            const span = document.createElement('span');
            span.style.fontSize = size;
            range.surroundContents(span);
          } else {
            // 선택된 텍스트가 없으면 현재 커서 위치에 적용
            const editor = document.getElementById('rich-editor');
            const span = document.createElement('span');
            span.style.fontSize = size;
            span.textContent = '새 텍스트';
            editor.appendChild(span);
          }
        }
        document.getElementById('rich-editor').focus();
      }

      // 이미지 삽입
      function insertImage() {
        document.getElementById('image-upload').click();
      }

      // 이미지 업로드 처리
      function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.margin = '10px 0';
            
            const editor = document.getElementById('rich-editor');
            editor.appendChild(img);
            editor.focus();
          };
          reader.readAsDataURL(file);
        }
        event.target.value = ''; // 파일 입력 초기화
      }

      // 의뢰 단일 삭제 함수
      function deleteSingleRequest(reqKey) {
        const reqNum = reqKey.replace('request-', '');
        const confirmMessage = `의뢰번호 ${reqNum}를 삭제하시겠습니까?\n\n⚠️ 삭제되는 데이터:\n• 의뢰 정보\n• 의뢰 결과\n• 주문 정보\n• 알림 발송 기록\n\n이 작업은 되돌릴 수 없습니다.`;
        
        if (confirm(confirmMessage)) {
          // 모든 관련 데이터 삭제
          localStorage.removeItem(reqKey); // 의뢰 정보
          localStorage.removeItem('result-' + reqNum); // 의뢰 결과
          localStorage.removeItem('order-' + reqNum); // 주문 정보
          localStorage.removeItem('notify-' + reqNum); // 알림 발송 기록
          
          // 현재 선택된 의뢰가 삭제된 경우 상세 섹션 숨기기
          if (currentReqKey === reqKey) {
            currentReqKey = null;
            document.getElementById('detail-section').classList.add('hidden');
          }
          
          alert(`의뢰번호 ${reqNum}와 관련 데이터가 완전히 삭제되었습니다.`);
          renderRequestList();
        }
      }

      // 일괄 삭제
      function bulkDelete() {
        if (selectedRequests.size === 0) {
          alert('삭제할 의뢰를 선택해주세요.');
          return;
        }
        
        const confirmMessage = `선택된 ${selectedRequests.size}개의 의뢰를 삭제하시겠습니까?\n\n⚠️ 삭제되는 데이터:\n• 의뢰 정보\n• 의뢰 결과\n• 주문 정보\n• 알림 발송 기록\n\n이 작업은 되돌릴 수 없습니다.`;
        
        if (confirm(confirmMessage)) {
          let deletedCount = 0;
          
          selectedRequests.forEach(reqKey => {
            const reqNum = reqKey.replace('request-', '');
            localStorage.removeItem(reqKey);
            localStorage.removeItem('result-' + reqNum);
            localStorage.removeItem('order-' + reqNum);
            localStorage.removeItem('notify-' + reqNum);
            deletedCount++;
          });
          
          selectedRequests.clear();
          document.getElementById('select-all').checked = false;
          updateSelectedCount();
          updateBulkButtons();
          
          alert(`${deletedCount}개의 의뢰가 삭제되었습니다.`);
          renderRequestList();
        }
      }

      // 수동 알림 발송
      function sendManualNotification() {
        if (!currentReqKey || !currentRequest) {
          alert('의뢰 정보가 없습니다.');
          return;
        }
        
        const reqNum = currentReqKey.replace('request-', '');
        const result = localStorage.getItem('result-' + reqNum);
        
        if (!result) {
          alert('저장된 결과가 없습니다.');
          return;
        }
        
        const resultData = JSON.parse(result);
        
        // 알림 발송 시뮬레이션
        console.log('📱 알림 발송:', {
          userName: currentRequest.userName,
          phone: currentRequest.phone,
          productName: currentRequest.productName,
          result: resultData
        });
        
        alert('알림이 발송되었습니다! (시뮬레이션)');
        
        // 알림 발송 기록 저장
        localStorage.setItem('notify-' + reqNum, JSON.stringify({
          date: new Date().toISOString(),
          method: document.getElementById('notify-method').value,
          status: 'sent'
        }));
      }

      // 일괄 알림 발송
      function bulkSendNotification() {
        if (selectedRequests.size === 0) {
          alert('알림을 발송할 의뢰를 선택해주세요.');
          return;
        }
        
        let sentCount = 0;
        
        selectedRequests.forEach(reqKey => {
          const reqNum = reqKey.replace('request-', '');
          const request = JSON.parse(localStorage.getItem(reqKey));
          const result = localStorage.getItem('result-' + reqNum);
          
          if (request && result) {
            console.log('📱 일괄 알림 발송:', reqNum);
            sentCount++;
            
            // 알림 발송 기록 저장
            localStorage.setItem('notify-' + reqNum, JSON.stringify({
              date: new Date().toISOString(),
              method: document.getElementById('notify-method').value,
              status: 'sent'
            }));
          }
        });
        
        alert(`${sentCount}개의 알림이 발송되었습니다! (시뮬레이션)`);
      }

      // 초기화
      window.addEventListener('DOMContentLoaded', function() {
        console.log('=== 관리자 페이지 초기화 시작 ===');
        
        // 관리자 권한 확인
        if (!isAdmin()) {
          alert('관리자 권한이 필요합니다.');
          window.location.href = 'index.html';
          return;
        }
        
        console.log('관리자 권한 확인 완료');
        
        // 탭 및 필터 초기화
        currentTab = 'all';
        currentFilter = 'all';
        
        console.log('탭/필터 초기화 완료');
        
        // 의뢰 목록 렌더링
        renderRequestList();
        
        console.log('의뢰 목록 렌더링 완료');
        
        // 탭 생성
        createUserTabs();
        
        console.log('사용자 탭 생성 완료');
        
        // 이벤트 리스너 등록
        const selectAllElement = document.getElementById('select-all');
        if (selectAllElement) {
          selectAllElement.addEventListener('change', toggleSelectAll);
          console.log('select-all 이벤트 리스너 등록 완료');
        }
        
        // 폼 이벤트 리스너 등록
        const resultForm = document.getElementById('result-form');
        if (resultForm) {
          resultForm.onsubmit = function(e) {
            e.preventDefault();
            if (!currentReqKey || !currentRequest) return;
            const reqNum = currentReqKey.replace('request-','');
            
            // 리치 에디터의 실제 내용을 가져오기
            const richEditor = document.getElementById('rich-editor');
            let summaryContent = '';
            
            if (richEditor) {
              summaryContent = richEditor.innerHTML;
              const textarea = document.getElementById('admin-summary');
              if (textarea) {
                textarea.value = summaryContent;
              }
            }
            
            // 입력 필드들 가져오기
            const adminPrice = document.getElementById('admin-price');
            const adminOrigin = document.getElementById('admin-origin');
            const adminLink = document.getElementById('admin-link');
            
            const data = {
              price: adminPrice ? adminPrice.value : '',
              origin: adminOrigin ? adminOrigin.value : '',
              summary: summaryContent,
              link: adminLink ? adminLink.value : ''
            };
            
            console.log('저장할 데이터:', data);
            
            // 여러 형식으로 저장하여 호환성 보장
            localStorage.setItem('result-' + reqNum, JSON.stringify(data));
            localStorage.setItem('result-PH-' + reqNum, JSON.stringify(data));
            
            console.log('결과 저장 완료:', {
              key: 'result-' + reqNum,
              data: data
            });
            
            // 알림 발송 버튼 표시
            const hasImages = summaryContent.includes('<img');
            const imageInfo = hasImages ? ' (이미지 포함)' : '';
            
            const adminMsg = document.getElementById('admin-msg');
            if (adminMsg) {
              adminMsg.innerHTML = `
                <div class="text-green-600 font-bold mb-2">✅ 결과가 저장되었습니다!${imageInfo}</div>
                <button id="send-notify-btn" onclick="sendManualNotification()" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition">
                  고객에게 알림 발송
                </button>
              `;
            }
            
            // 리스트 새로고침
            setTimeout(() => {
              renderRequestList();
            }, 500);
          };
          console.log('result-form 이벤트 리스너 등록 완료');
        }
        
        // 삭제 버튼 이벤트 리스너 등록
        const adminDeleteBtn = document.getElementById('admin-delete');
        if (adminDeleteBtn) {
          adminDeleteBtn.onclick = function() {
            if (!currentReqKey) return;
            const reqNum = currentReqKey.replace('request-','');
            localStorage.removeItem('result-' + reqNum);
            localStorage.removeItem('result-PH-' + reqNum);
            
            const adminMsg = document.getElementById('admin-msg');
            if (adminMsg) {
              adminMsg.textContent = '삭제되었습니다!';
            }
            
            // 리스트 새로고침
            setTimeout(() => {
              renderRequestList();
            }, 500);
          };
          console.log('admin-delete 이벤트 리스너 등록 완료');
        }
        
        // 리치 텍스트 에디터 초기화
        initRichEditor();
        
        console.log('이벤트 리스너 등록 완료');
        console.log('=== 관리자 페이지 초기화 완료 ===');
      });
    </script>
  </body>
</html>
